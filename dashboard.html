<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <meta name="google-translate-customization" content="en,hi,ta,te" />
    <title>CTF.ai - Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
      }

      /* Global modern Times New Roman typography */
      body {
        font-family: "Times New Roman", Times, serif;
        font-weight: 400;
        line-height: 1.6;
        color: #1f2933; /* deep modern gray for readability */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Ensure all key text elements use Times New Roman */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      span,
      a,
      button,
      input,
      textarea,
      select,
      .top-nav-btn,
      .section-card-title,
      .section-card-desc,
      .product-info,
      .search-section,
      .rating-summary,
      .form-group label,
      .form-group input,
      .form-group textarea,
      .form-group select {
        font-family: "Times New Roman", Times, serif !important;
      }

      /* Slight letter-spacing for headings to look more elegant */
      h1,
      h2,
      h3 {
        letter-spacing: 0.02em;
      }

      /* Keep buttons visually modern while using Times text */
      button {
        font-weight: 600;
      }

      /* Custom Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: linear-gradient(135deg, #fefdf8, #f0fdf4);
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #81c784, #66bb6a);
        border-radius: 10px;
        border: 2px solid #f0fdf4;
        transition: background 0.3s;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #66bb6a, #4caf50);
        border-color: #e8f5e9;
      }

      ::-webkit-scrollbar-thumb:active {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
      }

      /* Modern Text Selection */
      ::selection {
        background: rgba(76, 175, 80, 0.3);
        color: #1b5e20;
      }

      ::-moz-selection {
        background: rgba(76, 175, 80, 0.3);
        color: #1b5e20;
      }

      .star-rating {
        color: #ffd700;
        font-size: 20px;
        letter-spacing: 2px;
        margin: 5px 0;
      }

      .rating-summary {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .rating-count {
        color: #666;
        font-size: 14px;
      }

      .gallery-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeInModal 0.3s ease;
      }

      @keyframes fadeInModal {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .gallery-modal.active {
        display: flex;
      }

      .gallery-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .gallery-image {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        transition: transform 0.3s ease;
      }

      .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        pointer-events: none;
      }

      .gallery-nav button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        transition: all 0.3s ease;
        pointer-events: auto;
      }

      .gallery-nav button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .gallery-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .gallery-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .zoom-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 25px;
      }

      .zoom-controls button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .zoom-controls button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .gallery-counter {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 16px;
        font-family: "Poppins", sans-serif;
      }

      body {
        font-family: "Poppins", "Times New Roman", Times, serif;
        background: linear-gradient(
          135deg,
          #fefdf8 0%,
          #f0fdf4 50%,
          #e8f5e9 100%
        );
        background-attachment: fixed;
        color: #2c3e50;
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background:
          radial-gradient(
            circle at 20% 50%,
            rgba(76, 175, 80, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(46, 125, 50, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 20%,
            rgba(129, 199, 132, 0.02) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .dashboard-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* ==========================================
           MOBILE APP DASHBOARD NAVIGATION
           Green Agricultural Theme - Farmer Friendly
        ========================================== */

      /* Section Cards Grid - Mobile First Design */
      .sections-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 20px 16px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      .section-card {
        background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
        border-radius: 20px;
        padding: 24px 16px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow:
          0 4px 12px rgba(46, 125, 50, 0.08),
          0 2px 4px rgba(0, 0, 0, 0.04);
        border: 2px solid rgba(76, 175, 80, 0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        overflow: hidden;
        min-height: 160px;
      }

      /* Green accent top border */
      .section-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #4caf50, #66bb6a, #4caf50);
        transform: scaleX(1);
        z-index: 1;
      }

      /* Subtle background pattern */
      .section-card::after {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(76, 175, 80, 0.03) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .section-card > * {
        position: relative;
        z-index: 2;
      }

      /* Active/Pressed state for mobile */
      .section-card:active {
        transform: scale(0.98);
        box-shadow:
          0 2px 8px rgba(46, 125, 50, 0.12),
          0 1px 2px rgba(0, 0, 0, 0.06);
      }

      /* Hover state for desktop */
      @media (hover: hover) {
        .section-card:hover {
          transform: translateY(-4px);
          box-shadow:
            0 8px 24px rgba(46, 125, 50, 0.15),
            0 4px 8px rgba(0, 0, 0, 0.08);
          border-color: #4caf50;
        }

        .section-card:hover::after {
          opacity: 1;
        }

        .section-card:hover .section-card-icon {
          transform: scale(1.1);
        }
      }

      /* Large Icons - Mobile App Style */
      .section-card-icon {
        font-size: 56px;
        margin-bottom: 12px;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 2px 6px rgba(46, 125, 50, 0.2));
        line-height: 1;
        display: block;
      }

      /* Simple Typography - Clean & Readable */
      .section-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #2e7d32;
        margin-bottom: 8px;
        font-family: "Poppins", "Segoe UI", sans-serif;
        letter-spacing: -0.01em;
        line-height: 1.3;
      }

      .section-card-desc {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
        font-family: "Poppins", "Segoe UI", sans-serif;
        opacity: 0.85;
        display: none; /* Hide description on mobile for cleaner look */
      }

      /* ==========================================
           RESPONSIVE BREAKPOINTS
        ========================================== */

      /* Tablet - 2 columns */
      @media (min-width: 600px) {
        .sections-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
          padding: 24px 20px;
        }

        .section-card {
          padding: 28px 20px;
          min-height: 180px;
        }

        .section-card-icon {
          font-size: 64px;
          margin-bottom: 16px;
        }

        .section-card-title {
          font-size: 18px;
        }

        .section-card-desc {
          font-size: 13px;
          display: block;
        }
      }

      /* Desktop - 4 columns */
      @media (min-width: 1024px) {
        .sections-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 24px;
          padding: 30px 24px;
        }

        .section-card {
          padding: 32px 24px;
          min-height: 200px;
        }

        .section-card-icon {
          font-size: 72px;
          margin-bottom: 20px;
        }

        .section-card-title {
          font-size: 20px;
          margin-bottom: 10px;
        }

        .section-card-desc {
          font-size: 14px;
          display: block;
        }
      }

      /* Large Desktop - 4 columns with more spacing */
      @media (min-width: 1400px) {
        .sections-grid {
          gap: 30px;
          padding: 40px 30px;
        }

        .section-card {
          padding: 40px 30px;
          min-height: 220px;
        }
      }

      /* Mobile-specific optimizations */
      @media (max-width: 599px) {
        .sections-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          padding: 16px 12px;
        }

        .section-card {
          padding: 20px 12px;
          min-height: 140px;
          border-radius: 16px;
        }

        .section-card-icon {
          font-size: 48px;
          margin-bottom: 10px;
        }

        .section-card-title {
          font-size: 14px;
          font-weight: 600;
          line-height: 1.2;
        }

        /* Better touch targets for mobile */
        .section-card {
          -webkit-tap-highlight-color: rgba(76, 175, 80, 0.1);
          user-select: none;
          -webkit-user-select: none;
        }
      }

      /* Very small screens - ensure readability */
      @media (max-width: 360px) {
        .section-card {
          padding: 16px 10px;
          min-height: 130px;
        }

        .section-card-icon {
          font-size: 42px;
        }

        .section-card-title {
          font-size: 13px;
        }
      }

      .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }

      .filter-btn.active {
        background: #4caf50 !important;
        color: white !important;
      }

      .main-content {
        flex: 1;
        padding: 0;
        width: 100%;
        padding-top: 90px;
      }

      .top-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        padding: 22px 35px;
        border-radius: 0 0 20px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow:
          0 4px 25px rgba(0, 0, 0, 0.1),
          0 2px 10px rgba(46, 125, 50, 0.05),
          0 8px 30px -5px rgba(46, 125, 50, 0.08);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 999;
        border-bottom: 1px solid rgba(76, 175, 80, 0.12);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .top-bar:hover {
        box-shadow:
          0 6px 30px rgba(0, 0, 0, 0.12),
          0 3px 15px rgba(46, 125, 50, 0.08),
          0 10px 40px -8px rgba(76, 175, 80, 0.15);
        border-bottom-color: rgba(76, 175, 80, 0.18);
      }

      .top-bar-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .top-bar h2 {
        font-family: "Poppins", sans-serif;
        color: #2e7d32;
        font-size: 28px;
        font-weight: 600;
        margin: 0;
        letter-spacing: 0.5px;
      }

      .top-nav-options {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .top-nav-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        border: 2px solid #4caf50;
        border-radius: 25px;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        font-weight: 500;
        color: #2e7d32;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        position: relative;
        overflow: hidden;
      }

      .top-nav-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          120deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.6s;
      }

      .top-nav-btn:hover::before {
        left: 100%;
      }

      .top-nav-btn:hover {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        transform: translateY(-2px);
        box-shadow:
          0 6px 20px rgba(76, 175, 80, 0.3),
          0 2px 10px rgba(46, 125, 50, 0.15);
        border-color: #2e7d32;
      }

      .top-nav-btn:active {
        transform: translateY(0px);
        box-shadow: 0 3px 12px rgba(76, 175, 80, 0.25);
      }

      .top-bar-right {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      /* ==========================================
           MOBILE APP LEFT-SIDE NAVIGATION DRAWER
           Green Agricultural Theme - Farmer Friendly
        ========================================== */

      /* Drawer Toggle Button */
      .drawer-toggle {
        display: none;
        background: transparent;
        border: 2px solid #4caf50;
        border-radius: 8px;
        color: #2e7d32;
        font-size: 24px;
        cursor: pointer;
        padding: 8px 12px;
        transition: all 0.3s ease;
        margin-right: 12px;
        font-family: "Poppins", sans-serif;
      }

      .drawer-toggle:hover {
        background: #4caf50;
        color: white;
      }

      .drawer-toggle:active {
        transform: scale(0.95);
      }

      /* Drawer Overlay */
      .drawer-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .drawer-overlay.active {
        display: block;
        opacity: 1;
      }

      /* Navigation Drawer */
      .nav-drawer {
        position: fixed;
        top: 0;
        left: -320px;
        width: 280px;
        max-width: 85%;
        height: 100vh;
        background: linear-gradient(180deg, #ffffff 0%, #f1f8e9 100%);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
      }

      .nav-drawer.active {
        left: 0;
      }

      /* User Profile Header */
      .drawer-profile-header {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        padding: 24px 20px;
        color: white;
        position: relative;
        overflow: hidden;
      }

      .drawer-profile-header::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
      }

      .drawer-profile-header::after {
        content: "";
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 50%;
      }

      .drawer-profile-content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .drawer-profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 3px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .drawer-profile-name {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 4px;
        font-family: "Poppins", sans-serif;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .drawer-profile-email {
        font-size: 13px;
        opacity: 0.9;
        font-family: "Poppins", sans-serif;
        margin-bottom: 4px;
      }

      .drawer-profile-location {
        font-size: 12px;
        opacity: 0.85;
        font-family: "Poppins", sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        margin-top: 4px;
      }

      /* Navigation Menu List */
      .drawer-menu {
        flex: 1;
        padding: 16px 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .drawer-menu-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        color: #2e7d32;
        text-decoration: none;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        position: relative;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(76, 175, 80, 0.1);
        user-select: none;
        -webkit-user-select: none;
      }

      .drawer-menu-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: linear-gradient(
          90deg,
          rgba(76, 175, 80, 0.1) 0%,
          transparent 100%
        );
        transition: width 0.3s ease;
      }

      .drawer-menu-item:hover::before,
      .drawer-menu-item:active::before {
        width: 100%;
      }

      .drawer-menu-item:hover {
        background: rgba(76, 175, 80, 0.08);
        border-left-color: #4caf50;
        padding-left: 24px;
      }

      .drawer-menu-item:active {
        background: rgba(76, 175, 80, 0.15);
        transform: scale(0.98);
      }

      .drawer-menu-item-icon {
        font-size: 24px;
        width: 32px;
        text-align: center;
        margin-right: 16px;
        transition: transform 0.3s ease;
        flex-shrink: 0;
      }

      .drawer-menu-item:hover .drawer-menu-item-icon {
        transform: scale(1.1);
      }

      .drawer-menu-item-text {
        flex: 1;
        line-height: 1.4;
      }

      /* Drawer Footer */
      .drawer-footer {
        padding: 16px 20px;
        border-top: 1px solid rgba(76, 175, 80, 0.15);
        background: rgba(241, 248, 233, 0.5);
      }

      .drawer-footer-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #666;
        text-decoration: none;
        font-family: "Poppins", sans-serif;
        font-size: 14px;
        transition: all 0.3s ease;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      .drawer-footer-item:hover {
        background: rgba(76, 175, 80, 0.1);
        color: #2e7d32;
      }

      .drawer-footer-item:last-child {
        margin-bottom: 0;
        color: #f44336;
      }

      .drawer-footer-item:last-child:hover {
        background: rgba(244, 67, 54, 0.1);
      }

      .drawer-footer-item-icon {
        font-size: 20px;
        width: 28px;
        text-align: center;
        margin-right: 12px;
        flex-shrink: 0;
      }

      /* Scrollbar Styling for Drawer */
      .drawer-menu::-webkit-scrollbar {
        width: 6px;
      }

      .drawer-menu::-webkit-scrollbar-track {
        background: transparent;
      }

      .drawer-menu::-webkit-scrollbar-thumb {
        background: rgba(76, 175, 80, 0.3);
        border-radius: 3px;
      }

      .drawer-menu::-webkit-scrollbar-thumb:hover {
        background: rgba(76, 175, 80, 0.5);
      }

      /* Active Menu Item Indicator */
      .drawer-menu-item.active {
        background: rgba(76, 175, 80, 0.12);
        border-left-color: #4caf50;
        color: #2e7d32;
        font-weight: 600;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .drawer-toggle {
          display: block;
        }
      }

      @media (max-width: 480px) {
        .nav-drawer {
          width: 260px;
          max-width: 80%;
        }

        .drawer-profile-header {
          padding: 20px 16px;
        }

        .drawer-profile-avatar {
          width: 70px;
          height: 70px;
          font-size: 36px;
        }

        .drawer-profile-name {
          font-size: 18px;
        }

        .drawer-menu-item {
          padding: 14px 16px;
          font-size: 15px;
        }

        .drawer-menu-item-icon {
          font-size: 22px;
          width: 28px;
          margin-right: 14px;
        }
      }

      .language-select {
        padding: 12px 24px;
        border: 2px solid #2e7d32;
        border-radius: 30px;
        font-family: "Times New Roman", Times, serif;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        background: linear-gradient(135deg, #ffffff 0%, #fcfcfc 100%);
        color: #2e7d32;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        box-shadow: 0 2px 8px rgba(46, 125, 50, 0.08);
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232e7d32' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
      }

      .language-select:hover {
        background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        border-color: #4caf50;
        transform: translateY(-2px);
        box-shadow:
          0 4px 12px rgba(46, 125, 50, 0.2),
          0 1px 4px rgba(76, 175, 80, 0.1);
      }

      .language-select:focus {
        border-color: #4caf50;
        box-shadow:
          0 0 0 4px rgba(46, 125, 50, 0.1),
          0 2px 8px rgba(76, 175, 80, 0.15);
      }

      /* ==========================================
           GOOGLE TRANSLATE PROTECTION - PROFESSIONAL
        ========================================== */

      /* Hide Google Translate banner and frames completely */
      .goog-te-banner-frame,
      .goog-te-menu-frame,
      .skiptranslate,
      .goog-te-banner,
      .goog-te-gadget,
      .goog-te-banner-frame.skiptranslate,
      iframe[title*="Translate"],
      iframe[name*="google_translate"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        width: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
        top: -9999px !important;
      }

      /* Fix body positioning when Google Translate is active */
      body {
        top: 0 !important;
        position: relative !important;
      }

      body.translated-ltr,
      body.translated-rtl,
      body.translated {
        top: 0 !important;
        position: relative !important;
      }

      /* COMPREHENSIVE: Protect ALL UI elements from translation */
      .notranslate,
        .notranslate *,
        nav,
        nav *,
        .top-bar,
        .top-bar *,
        .top-nav-btn,
        .top-nav-btn *,
        .logo,
        .logo *,
        .btn,
        .btn *,
        button,
        button *,
        .language-select,
        .language-select *,
        .language-selector,
        .language-selector *,
        .language-select option,
        .language-selector option,
        select,
        select option,
        .notification-icon,
        .profile-icon,
        .close-modal,
        .close-video,
        header,
        header *,
        footer,
        footer *,
        [class*="icon"],
        [class*="emoji"],
        .section-card-icon,
        .section-card-icon *,
        .icon,
        .icon *,
        .emoji,
        .emoji *,
        /* Protect all emoji containers */
        [style*="font-size"][style*="emoji"],
        /* Protect emoji spans */
        span:has(> [class*="icon"]),
        div:has(> [class*="icon"]) {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
        -ms-translate: no !important;
        -o-translate: no !important;
      }

      /* Force notranslate class protection with higher specificity */
      .notranslate,
      .notranslate *:not([data-translate]),
      .notranslate *:not([data-translate="yes"]) {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
      }

      /* Language selector - complete protection */
      .language-select,
      .language-selector,
      select.language-select,
      select.language-selector {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
      }

      .language-select option,
      .language-selector option,
      select.language-select option,
      select.language-selector option {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
      }

      /* Protect emoji elements specifically */
      .section-card-icon,
      .section-card-icon *,
      [class*="section-card-icon"],
      [class*="section-card-icon"] * {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
      }

      /* Ensure Tamil, Telugu, and Hindi fonts render correctly */
      [lang="ta"],
      [lang="ta"] *:not(.notranslate):not(.notranslate *),
      body.translated-ltr[lang="ta"] *:not(.notranslate),
      body.translated-rtl[lang="ta"] *:not(.notranslate) {
        font-family:
          "Noto Sans Tamil", "Tamil MN", "Latha", "Arial Unicode MS", sans-serif !important;
        font-size: inherit !important;
      }

      [lang="te"],
      [lang="te"] *:not(.notranslate):not(.notranslate *),
      body.translated-ltr[lang="te"] *:not(.notranslate),
      body.translated-rtl[lang="te"] *:not(.notranslate) {
        font-family:
          "Noto Sans Telugu", "Telugu MN", "Gautami", "Arial Unicode MS",
          sans-serif !important;
        font-size: inherit !important;
      }

      [lang="hi"],
      [lang="hi"] *:not(.notranslate):not(.notranslate *),
      body.translated-ltr[lang="hi"] *:not(.notranslate),
      body.translated-rtl[lang="hi"] *:not(.notranslate) {
        font-family:
          "Noto Sans Devanagari", "Mangal", "Arial Unicode MS", sans-serif !important;
        font-size: inherit !important;
      }

      /* Prevent translation of emojis and icons - Enhanced */
      [class*="icon"],
        [class*="emoji"],
        .logo-icon,
        .feature-icon,
        .notification-icon,
        .profile-icon,
        .section-card-icon,
        /* Protect Unicode emoji ranges */
        [data-emoji],
        /* Protect elements containing only emojis */
        *:empty:before,
        *:empty:after {
        translate: no !important;
        -webkit-translate: no !important;
        -moz-translate: no !important;
      }

      /* Modern Language Switcher Styles */
      .language-switcher {
        position: relative;
        display: inline-block;
      }

      .language-switcher select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: white;
        border: 2px solid #4caf50;
        border-radius: 25px;
        padding: 10px 40px 10px 15px;
        font-size: 14px;
        font-weight: 500;
        color: #2e7d32;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
      }

      .language-switcher select:hover {
        border-color: #2e7d32;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
      }

      .language-switcher select:focus {
        border-color: #2e7d32;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .notification-icon,
      .profile-icon {
        font-size: 24px;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: rgba(76, 175, 80, 0.05);
        color: #2e7d32;
      }

      .notification-icon:hover,
      .profile-icon:hover {
        background: rgba(76, 175, 80, 0.12);
        transform: scale(1.1) rotate(-5deg);
        box-shadow: 0 3px 12px rgba(76, 175, 80, 0.15);
      }

      .notification-icon:active,
      .profile-icon:active {
        transform: scale(1.05);
      }

      /* Profile Icon Button Styles */
      .profile-icon-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .profile-icon-btn:hover {
        background: rgba(76, 175, 80, 0.08);
        transform: translateY(-2px);
      }

      .nav-profile-icon {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .profile-icon-btn:hover .nav-profile-icon {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }

      .nav-profile-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Profile Section Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .dash-section.active #profileHeader {
        animation: fadeInUp 0.6s ease-out;
      }

      .dash-section.active #profilePhotoContainer {
        animation: scaleIn 0.5s ease-out 0.2s backwards;
      }

      .dash-section.active #profileSummaryCards > div {
        animation: fadeInUp 0.5s ease-out backwards;
      }

      .dash-section.active #profileSummaryCards > div:nth-child(1) {
        animation-delay: 0.1s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(3) {
        animation-delay: 0.3s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(4) {
        animation-delay: 0.4s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(5) {
        animation-delay: 0.5s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(6) {
        animation-delay: 0.6s;
      }
      .dash-section.active #profileSummaryCards > div:nth-child(7) {
        animation-delay: 0.7s;
      }

      /* Profile Tab Transitions */
      .profile-tab-content {
        display: none;
        animation: fadeInUp 0.4s ease-out;
      }

      .profile-tab-content.active {
        display: block;
      }

      /* Profile Tab Button Hover Effects */
      .profile-tab-btn:hover:not(.active) {
        background: rgba(76, 175, 80, 0.05) !important;
        color: #2e7d32 !important;
      }

      .profile-tab-btn.active {
        background: rgba(76, 175, 80, 0.08) !important;
      }

      .back-to-home-btn {
        padding: 12px 26px;
        background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        border: 2px solid #4caf50;
        border-radius: 25px;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        font-weight: 500;
        color: #2e7d32;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        position: relative;
        overflow: hidden;
      }

      .back-to-home-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          120deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        transition: left 0.6s;
      }

      .back-to-home-btn:hover::before {
        left: 100%;
      }

      .back-to-home-btn:hover {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        transform: translateY(-2px) translateX(-3px);
        box-shadow:
          0 6px 20px rgba(76, 175, 80, 0.3),
          0 2px 8px rgba(46, 125, 50, 0.15);
        border-color: #2e7d32;
      }

      .back-to-home-btn:active {
        transform: translateY(0px);
      }

      .main-content-wrapper {
        padding: 30px;
      }

      .search-section {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 35px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow:
          0 4px 20px rgba(0, 0, 0, 0.08),
          0 1px 3px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(76, 175, 80, 0.1);
      }

      .search-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        align-items: stretch;
      }

      .search-bar input {
        flex: 1;
        padding: 16px 25px;
        border: 2px solid #e0e0e0;
        border-radius: 30px;
        font-size: 18px;
        font-family: "Times New Roman", Times, serif;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fafafa;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.04);
      }

      .search-bar input:focus {
        outline: none;
        border-color: #4caf50;
        background: white;
        box-shadow:
          0 0 0 4px rgba(76, 175, 80, 0.1),
          inset 0 1px 2px rgba(0, 0, 0, 0.03);
        transform: translateY(-1px);
      }

      .search-bar button {
        padding: 16px 45px;
        background: linear-gradient(135deg, #2e7d32, #558b2f);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 18px;
        font-family: "Times New Roman", Times, serif;
        font-weight: bold;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow:
          0 4px 15px rgba(46, 125, 50, 0.3),
          0 2px 6px rgba(46, 125, 50, 0.15);
        position: relative;
        overflow: hidden;
      }

      .search-bar button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          120deg,
          transparent,
          rgba(255, 255, 255, 0.25),
          transparent
        );
        transition: left 0.6s;
      }

      .search-bar button:hover::before {
        left: 100%;
      }

      .search-bar button:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow:
          0 8px 28px rgba(46, 125, 50, 0.35),
          0 4px 12px rgba(46, 125, 50, 0.2);
      }

      .search-bar button:active {
        transform: translateY(-1px);
        box-shadow:
          0 5px 20px rgba(46, 125, 50, 0.3),
          0 2px 8px rgba(46, 125, 50, 0.15);
      }

      .quote {
        text-align: center;
        font-size: 22px;
        color: #2e7d32;
        font-style: italic;
        font-family: "Times New Roman", Times, serif;
        margin: 20px 0;
        line-height: 1.6;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 30px;
      }

      /* Product Filter Styles */
      #productStickyBar select:hover,
      #productStickyBar select:focus {
        border-color: #4caf50 !important;
        box-shadow: 0 4px 20px rgba(76,175,80,0.15), 0 0 0 4px rgba(76,175,80,0.1) !important;
      }

      .product-category-section {
        animation: fadeInUp 0.6s ease;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Wizard Steps Styles */
      .progress-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 25px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow:
          0 4px 15px rgba(0, 0, 0, 0.08),
          0 1px 3px rgba(0, 0, 0, 0.03);
        min-height: 100px;
        border: 1px solid rgba(76, 175, 80, 0.1);
        animation: fadeInSteps 0.7s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes fadeInSteps {
        from {
          opacity: 0;
          transform: translateY(35px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 0 0 auto;
        position: relative;
        z-index: 1;
        transition:
          transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 75px;
      }

      .step-item:not(:last-child) {
        margin-right: 8px;
      }

      .step-number {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e0e0e0, #f0f0f0);
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 20px;
        margin-bottom: 12px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 2;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .step-item.active .step-number {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        transform: scale(1.15);
        box-shadow:
          0 6px 20px rgba(76, 175, 80, 0.4),
          0 0 0 4px rgba(76, 175, 80, 0.1);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow:
            0 6px 20px rgba(76, 175, 80, 0.4),
            0 0 0 4px rgba(76, 175, 80, 0.1);
        }
        50% {
          box-shadow:
            0 6px 25px rgba(76, 175, 80, 0.5),
            0 0 0 8px rgba(76, 175, 80, 0.15);
        }
      }

      .step-item.completed .step-number {
        background: linear-gradient(135deg, #81c784, #66bb6a);
        color: white;
        box-shadow: 0 4px 12px rgba(129, 199, 132, 0.3);
      }

      .step-item.completed .step-number::after {
        content: "âœ“";
        position: absolute;
        right: 5px;
        bottom: 5px;
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        opacity: 0.85;
        pointer-events: none;
        animation: fadeInCheck 0.8s cubic-bezier(0.5, 0, 0.2, 1);
      }

      @keyframes fadeInCheck {
        from {
          opacity: 0;
          transform: scale(0.7);
        }
        to {
          opacity: 0.85;
          transform: scale(1);
        }
      }

      .step-label {
        font-size: 13px;
        color: #666;
        text-align: center;
        font-weight: 500;
        white-space: nowrap;
        max-width: 120px;
        letter-spacing: 0.01em;
        transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .step-item.active .step-label {
        color: #2e7d32;
        font-weight: 600;
      }

      .step-connector {
        flex: 1;
        height: 3.5px;
        margin: 0 10px;
        background: #e0e0e0;
        position: relative;
        top: -29px;
        z-index: 0;
        min-width: 30px;
        border-radius: 99px;
        transition: background 0.35s;
      }

      .step-connector.completed {
        background: linear-gradient(90deg, #81c784, #66bb6a);
      }

      .wizard-step {
        display: none;
        min-height: 450px;
        transition:
          opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: translateY(40px) scale(0.99);
        animation: fadeInStepContent 0.7s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .wizard-step.active {
        display: block;
        opacity: 1;
        transform: translateY(0) scale(1);
        animation: fadeInStepContent 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes fadeInStepContent {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .step-card {
        background: rgba(255, 255, 255, 0.23);
        backdrop-filter: blur(16px) saturate(120%);
        -webkit-backdrop-filter: blur(16px) saturate(120%);
        border-radius: 24px;
        padding: 40px;
        box-shadow:
          0 8px 32px 0 rgba(46, 125, 50, 0.13),
          0 2px 8px rgba(76, 175, 80, 0.04);
        border: 1.5px solid rgba(76, 175, 80, 0.2);
        min-height: 400px;
        position: relative;
        overflow: hidden;
        transition:
          box-shadow 0.35s cubic-bezier(0.4, 0, 0.2, 1),
          border 0.35s cubic-bezier(0.4, 0, 0.2, 1),
          background 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .step-card::before {
        content: "";
        display: block;
        position: absolute;
        inset: 0;
        border-radius: 24px;
        background: linear-gradient(
          120deg,
          rgba(76, 175, 80, 0.09) 0%,
          rgba(76, 175, 80, 0.22) 100%
        );
        opacity: 0.38;
        pointer-events: none;
        z-index: 0;
        transition: opacity 0.4s;
      }
      .step-card:hover,
      .step-card:focus-within {
        box-shadow:
          0 12px 45px 0 rgba(46, 125, 50, 0.18),
          0 6px 18px rgba(76, 175, 80, 0.1);
        border-color: #4caf50;
        background: rgba(255, 255, 255, 0.33);
      }
      .step-card > * {
        position: relative;
        z-index: 1;
      }

      /* Enhanced wizard navigation buttons */
      .step-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 18px;
      }

      .btn-next,
      .btn-previous {
        padding: 16px 42px;
        border: none;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(76, 175, 80, 0.07);
        transition:
          background 0.33s cubic-bezier(0.4, 0, 0.2, 1),
          color 0.3s,
          box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        position: relative;
        overflow: hidden;
      }

      .btn-next {
        background: linear-gradient(
          127deg,
          #66bb6a 0%,
          #388e3c 48%,
          #218838 100%
        );
        color: white;
        border: 2px solid #388e3c;
        box-shadow: 0 3px 16px rgba(76, 175, 80, 0.19);
      }
      .btn-next:hover,
      .btn-next:focus-visible {
        background: linear-gradient(127deg, #219150 0%, #38c997 80%);
        color: #fff;
        transform: translateY(-2.5px) scale(1.04);
        box-shadow:
          0 9px 22px rgba(76, 175, 80, 0.23),
          0 4px 12px rgba(46, 125, 50, 0.13);
        border-color: #219150;
      }
      .btn-previous {
        background: linear-gradient(120deg, #f8faf6 0%, #ebece8 92%);
        color: #388e3c;
        border: 2px solid #abceb1;
      }
      .btn-previous:hover,
      .btn-previous:focus-visible {
        background: linear-gradient(120deg, #e8f5e9 70%, #c8e6c9 100%);
        color: #197d32;
        border-color: #388e3c;
        transform: translateY(-2.5px) scale(1.035);
        box-shadow: 0 7px 18px rgba(76, 175, 80, 0.11);
      }

      .btn-publish {
        padding: 17px 54px;
        background: linear-gradient(133deg, #ffd700 0%, #7ed957 97%);
        color: #15532c;
        border: none;
        border-radius: 14px;
        font-size: 20px;
        font-weight: 700;
        font-family: "Poppins", sans-serif;
        cursor: pointer;
        box-shadow:
          0 8px 32px rgba(126, 217, 87, 0.19),
          0 2px 8px rgba(76, 175, 80, 0.06);
        letter-spacing: 0.1em;
        transition:
          background 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          color 0.3s,
          box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        position: relative;
        overflow: hidden;
      }
      .btn-publish:hover,
      .btn-publish:focus-visible {
        background: linear-gradient(138deg, #ffdd57 0%, #7ed957 100%);
        color: #17693a;
        transform: translateY(-3.5px) scale(1.06);
        box-shadow:
          0 13px 28px rgba(126, 217, 87, 0.31),
          0 5px 15px rgba(255, 221, 87, 0.12);
      }

      .modern-input,
      .modern-select,
      .modern-textarea {
        width: 100%;
        padding: 14px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        font-family: "Poppins", sans-serif;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fafafa;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.04);
      }

      .modern-input:focus,
      .modern-select:focus,
      .modern-textarea:focus {
        outline: none;
        border-color: #4caf50;
        background: white;
        box-shadow:
          0 0 0 4px rgba(76, 175, 80, 0.1),
          inset 0 1px 2px rgba(0, 0, 0, 0.03);
        transform: translateY(-1px);
      }

      .modern-input:hover,
      .modern-select:hover,
      .modern-textarea:hover {
        border-color: #c8e6c9;
        background: #fcfcfc;
      }

      .quantity-input-group {
        display: flex;
        gap: 15px;
      }

      .quantity-input-group .modern-input {
        flex: 1;
      }

      .upload-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .upload-btn {
        padding: 30px;
        background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        border: 2px dashed #4caf50;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 500;
        font-family: "Poppins", sans-serif;
        color: #2e7d32;
        position: relative;
        overflow: hidden;
      }

      .upload-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.05) 0%,
          rgba(46, 125, 50, 0.05) 100%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .upload-btn:hover::before {
        opacity: 1;
      }

      .upload-btn:hover {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-color: #2e7d32;
        border-style: solid;
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 24px rgba(76, 175, 80, 0.25);
      }

      .upload-btn span:first-child {
        font-size: 48px;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        filter: drop-shadow(0 2px 6px rgba(76, 175, 80, 0.15));
      }

      .upload-btn:hover span:first-child {
        transform: scale(1.15) rotate(-5deg);
        filter: drop-shadow(0 4px 12px rgba(46, 125, 50, 0.25));
      }

      .image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .image-preview-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1;
        cursor: pointer;
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .image-preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .video-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .video-preview-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        cursor: pointer;
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .video-preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .video-preview-item video {
        width: 100%;
        height: 150px;
        object-fit: cover;
      }

      .image-preview-item:hover img {
        transform: scale(1.1);
      }

      .image-preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .review-section {
        background: #f9f9f9;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .review-item {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
        font-family: "Poppins", sans-serif;
      }

      .review-item:last-child {
        border-bottom: none;
      }

      .review-item strong {
        color: #2e7d32;
        display: block;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .review-item span {
        color: #555;
        font-size: 16px;
        display: block;
      }

      .review-images {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .review-images img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
      }

      /* Product Cards */
      .product-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 0;
        box-shadow:
          0 4px 20px rgba(0, 0, 0, 0.08),
          0 1px 4px rgba(0, 0, 0, 0.04),
          0 8px 24px -8px rgba(76, 175, 80, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        border: 1px solid rgba(76, 175, 80, 0.1);
        position: relative;
      }

      .product-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.02) 0%,
          rgba(46, 125, 50, 0.02) 100%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: 0;
      }

      .product-card:hover::before {
        opacity: 1;
      }

      .product-card:hover {
        transform: translateY(-12px) scale(1.02);
        box-shadow:
          0 16px 48px rgba(76, 175, 80, 0.25),
          0 4px 20px rgba(76, 175, 80, 0.12),
          0 2px 12px rgba(46, 125, 50, 0.08);
        border-color: rgba(76, 175, 80, 0.25);
      }

      .product-image {
        width: 100%;
        height: 220px;
        background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        border-radius: 0;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 70px;
        overflow: hidden;
        position: relative;
        transition: transform 0.4s ease;
      }

      .product-card:hover .product-image {
        transform: scale(1.05);
      }

      .product-image::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          180deg,
          transparent 0%,
          rgba(0, 0, 0, 0.05) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .product-card:hover .product-image::after {
        opacity: 1;
      }

      .product-like-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .product-like-btn:hover {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 1);
      }

      .product-like-btn.liked {
        color: #ff0000;
        background: rgba(255, 255, 255, 1);
      }

      .product-like-btn:not(.liked) {
        color: #999;
      }

      .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-info {
        padding: 20px;
      }

      .product-info h3 {
        color: #2e7d32;
        margin-bottom: 12px;
        font-size: 22px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
      }

      .product-info p {
        color: #666;
        font-size: 15px;
        font-family: "Poppins", sans-serif;
        margin-bottom: 8px;
      }

      .product-price {
        font-size: 24px;
        color: #ff6b6b;
        font-weight: bold;
        font-family: "Poppins", sans-serif;
        margin: 12px 0;
      }

      .product-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 18px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
      }

      .btn-details,
      .btn-contact,
      .btn-feedback {
        padding: 13px 0;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
        cursor: pointer;
        transition:
          transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          background 0.3s,
          color 0.3s;
        position: relative;
        outline: none;
      }

      .btn-feedback {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
        border: 2px solid #fb8c00;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.15);
      }

      .btn-details {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        border: 2px solid #388e3c;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.11);
      }

      .btn-details:hover,
      .btn-details:focus {
        transform: translateY(-3px) scale(1.025);
        box-shadow: 0 6px 22px rgba(76, 175, 80, 0.16);
        background: linear-gradient(135deg, #388e3c, #4caf50 85%);
      }

      .btn-contact {
        background: linear-gradient(135deg, #fcfcfc 12%, #e8f5e9 100%);
        color: #2e7d32;
        border: 2px solid #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.07);
      }

      .btn-contact:hover,
      .btn-contact:focus {
        background: linear-gradient(135deg, #dcedc8 0%, #c8e6c9 90%);
        color: #219150;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 6px 18px rgba(46, 125, 50, 0.13);
        border-color: #219150;
      }

      .btn-feedback {
        padding: 13px 0;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
        cursor: pointer;
        transition:
          transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          background 0.3s,
          color 0.3s;
        position: relative;
        outline: none;
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
        border: 2px solid #fb8c00;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.15);
      }

      .btn-feedback:hover,
      .btn-feedback:focus {
        transform: translateY(-3px) scale(1.025);
        box-shadow: 0 6px 22px rgba(255, 152, 0, 0.25);
        background: linear-gradient(135deg, #fb8c00, #ff9800 85%);
      }

      /* Product Badges */
      .product-badge-my {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10;
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        font-family: "Poppins", sans-serif;
        letter-spacing: 0.3px;
        animation: pulseBadge 2s infinite;
      }

      @keyframes pulseBadge {
        0%,
        100% {
          box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }
        50% {
          box-shadow: 0 3px 15px rgba(76, 175, 80, 0.5);
        }
      }

      .product-category-badge {
        position: absolute;
        top: 10px;
        right: 50px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        color: #2e7d32;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        font-family: "Poppins", sans-serif;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Product Image Enhancements */
      .product-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          180deg,
          transparent 0%,
          rgba(0, 0, 0, 0.1) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
      }

      .product-card:hover .product-image-overlay {
        opacity: 1;
      }

      .product-image-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        font-size: 70px;
        background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        transition: transform 0.3s ease;
      }

      .product-card:hover .product-image-placeholder {
        transform: scale(1.1);
      }

      /* Product Name */
      .product-name {
        color: #2e7d32;
        margin-bottom: 15px;
        font-size: 20px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 52px;
      }

      /* Product Meta Information */
      .product-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
      }

      .product-meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #666;
        font-family: "Poppins", sans-serif;
      }

      .meta-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
        flex-shrink: 0;
      }

      .meta-text {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Product Price Section */
      .product-price-section {
        margin: 15px 0;
        padding: 14px 16px;
        background: linear-gradient(135deg, #fff5f5, #ffe8e8);
        border-radius: 12px;
        border: 1px solid rgba(220, 53, 69, 0.15);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.08);
        transition: all 0.3s ease;
      }

      .product-card:hover .product-price-section {
        background: linear-gradient(135deg, #ffe8e8, #ffd6d6);
        border-color: rgba(220, 53, 69, 0.25);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.12);
        transform: translateY(-2px);
      }

      .product-price {
        font-size: 28px;
        color: #dc3545;
        font-weight: 700;
        font-family: "Poppins", sans-serif;
        margin: 0;
        display: flex;
        align-items: baseline;
        gap: 4px;
        line-height: 1.2;
        text-shadow: 0 1px 2px rgba(220, 53, 69, 0.1);
      }

      .price-unit {
        font-size: 15px;
        font-weight: 500;
        color: #666;
        opacity: 0.85;
        margin-left: 2px;
      }

      /* Enhanced Button Styles */
      .btn-details span,
      .btn-contact span {
        margin-right: 6px;
        font-size: 16px;
      }

      /* Animation for product cards */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .product-name {
          font-size: 18px;
          min-height: 48px;
        }

        .product-price {
          font-size: 22px;
        }

        .product-meta-item {
          font-size: 13px;
        }

        .product-category-badge {
          right: 45px;
          font-size: 11px;
          padding: 5px 10px;
        }
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 30px;
      }

      .feature-card {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.98),
          rgba(241, 248, 233, 0.95)
        );
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 35px;
        border-radius: 20px;
        box-shadow:
          0 4px 20px rgba(0, 0, 0, 0.08),
          0 1px 4px rgba(0, 0, 0, 0.03);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(76, 175, 80, 0.1);
        position: relative;
        overflow: hidden;
      }

      .feature-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at 30% 50%,
          rgba(76, 175, 80, 0.08) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .feature-card:hover::before {
        opacity: 1;
      }

      .feature-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow:
          0 16px 48px rgba(76, 175, 80, 0.18),
          0 4px 16px rgba(0, 0, 0, 0.08);
        border-color: rgba(76, 175, 80, 0.25);
      }

      .feature-card .icon {
        font-size: 50px;
        margin-bottom: 20px;
        display: inline-block;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        filter: drop-shadow(0 2px 8px rgba(76, 175, 80, 0.12));
        position: relative;
        z-index: 1;
      }

      .feature-card:hover .icon {
        transform: scale(1.15) rotate(-5deg);
        filter: drop-shadow(0 4px 16px rgba(46, 125, 50, 0.2));
      }

      .feature-card h3 {
        color: #2e7d32;
        font-size: 24px;
        font-family: "Times New Roman", Times, serif;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
        text-shadow: 0 1px 3px rgba(76, 175, 80, 0.08);
      }

      .feature-card p {
        color: #555;
        font-size: 18px;
        font-family: "Times New Roman", Times, serif;
        line-height: 1.6;
        position: relative;
        z-index: 1;
      }

      /* Compact Price Cards for Live Prices Section */
      .prices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      /* Responsive Design for Products Section */
      @media (max-width: 768px) {
        #productSearchInput {
          font-size: 14px !important;
          padding: 15px 20px !important;
        }

        button[onclick="switchDashSection('create')"] {
          padding: 15px 28px !important;
          font-size: 14px !important;
        }

        button[onclick="switchDashSection('create')"] span:first-child {
          font-size: 18px !important;
        }
      }

      @media (max-width: 480px) {
        /* Stack search and button vertically on very small screens */
        div[style*="display: flex"][style*="gap: 15px"] {
          flex-direction: column !important;
        }

        #productSearchInput {
          min-width: 100% !important;
        }

        button[onclick="switchDashSection('create')"] {
          width: 100%;
          justify-content: center;
        }
      }

      .price-card {
        background: linear-gradient(135deg, #ffffff, #f0fdf4);
        padding: 25px 20px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(46, 125, 50, 0.08);
        border: 1px solid rgba(46, 125, 50, 0.1);
        transition: all 0.3s ease;
        text-align: left;
      }

      .price-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 8px 25px rgba(46, 125, 50, 0.15);
      }

      .price-card .icon {
        font-size: 60px;
        margin-bottom: 15px;
        display: block;
      }

      .price-card h3 {
        color: #2e7d32;
        font-size: 22px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .price-card .price {
        font-size: 28px;
        color: #ff6b6b;
        font-weight: bold;
        font-family: "Poppins", sans-serif;
        margin: 12px 0;
        display: block;
      }

      .price-card .trend {
        font-size: 15px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
      }

      .price-card .trend .arrow {
        font-size: 20px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 10px;
        color: #555;
        font-weight: bold;
        font-family: "Times New Roman", Times, serif;
        font-size: 17px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        font-family: "Times New Roman", Times, serif;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2e7d32;
        box-shadow: 0 0 15px rgba(46, 125, 50, 0.2);
      }

      .form-group textarea {
        height: 120px;
        resize: vertical;
      }

      .btn {
        padding: 16px 45px;
        font-size: 20px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "Times New Roman", Times, serif;
        font-weight: bold;
      }

      .btn-primary {
        background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(255, 107, 107, 0.5);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: white;
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
      }

      .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(78, 205, 196, 0.5);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Times New Roman", Times, serif;
      }

      thead tr {
        background: linear-gradient(135deg, #2e7d32, #558b2f);
        color: white;
      }

      th {
        padding: 18px;
        text-align: left;
        font-size: 18px;
        font-family: "Times New Roman", Times, serif;
      }

      tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      tbody tr:hover {
        background: #f5f5f5;
      }

      td {
        padding: 18px;
        font-size: 16px;
        font-family: "Times New Roman", Times, serif;
      }

      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #2e7d32, #558b2f);
        color: white;
        padding: 30px 50px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        text-align: center;
        font-size: 20px;
        font-family: "Times New Roman", Times, serif;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .dash-section {
        display: none;
        animation: fadeIn 0.4s ease;
      }

      .dash-section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(76, 175, 80, 0.1);
      }

      .section-header h2 {
        font-family: "Poppins", sans-serif;
        color: #2e7d32;
        font-size: 32px;
        font-weight: 600;
        margin: 0;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h3 {
        font-family: "Times New Roman", Times, serif;
      }

      p {
        font-family: "Times New Roman", Times, serif;
      }

      /* Mobile responsive styles removed - desktop view only */
      .sidebar.closed {
        transform: translateX(-100%);
      }

      .sidebar-overlay {
        display: none !important;
      }

      .main-content.sidebar-closed {
        margin-left: 0;
        width: 100%;
      }

      .top-bar.sidebar-closed {
        left: 0;
      }

      /* Crop Details Modal Sections */
      .crop-info-section {
        background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        border-left: 4px solid #4caf50;
        padding: 20px;
        margin: 15px 0;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .crop-info-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
      }

      .crop-info-section h3 {
        color: #2e7d32;
        font-size: 20px;
        margin-bottom: 12px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .crop-info-section p,
      .crop-info-section ul {
        color: #555;
        font-size: 16px;
        line-height: 1.7;
        margin-bottom: 8px;
      }

      .crop-info-section ul {
        padding-left: 25px;
      }

      .crop-info-section li {
        margin-bottom: 8px;
      }

      .crop-images-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .crop-images-gallery img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        cursor: pointer;
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .crop-images-gallery img:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .create-section-centered {
        max-width: 900px;
        margin: 40px auto 0 auto;
        position: relative;
        transition:
          margin 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          background 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 35px;
        min-height: 75vh;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        animation: fadeAndSlideIn 0.7s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .create-section-centered > *:not(:first-child) {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes fadeAndSlideIn {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .create-section-centered .progress-steps {
        margin-top: 0;
        transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .create-section-centered .wizard-step {
        transition:
          opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .create-section-centered .wizard-step:not(.active) {
        opacity: 0;
        pointer-events: none;
        transform: translateY(60px) scale(0.98);
      }
      .create-section-centered .wizard-step.active {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0) scale(1);
      }

      /* Subtle page load animation for whole page */
      .page-fadein {
        animation: pageFadeIn 0.9s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes pageFadeIn {
        0% {
          opacity: 0;
          filter: blur(10px);
          transform: scale(1.04) translateY(30px);
        }
        75% {
          opacity: 1;
          filter: blur(0.5px);
          transform: scale(1.01) translateY(2px);
        }
        100% {
          opacity: 1;
          filter: blur(0);
          transform: scale(1) translateY(0);
        }
      }

      /* ==========================================
   RENTAL ITEMS SECTION STYLES
   ========================================== */

      /* Rental Items Grid */
      .rental-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
        margin-top: 20px;
      }

      /* Rental Item Card */
      .rental-card {
        background: white;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .rental-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(76, 175, 80, 0.15);
      }

      .rental-card-image {
        position: relative;
        height: 200px;
        overflow: hidden;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .rental-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition:
          transform 0.4s ease,
          opacity 0.3s ease;
        opacity: 0;
        border-radius: 0;
      }

      .rental-card-image img.loaded {
        opacity: 1;
      }

      .rental-card:hover .rental-card-image img {
        transform: scale(1.08);
      }

      /* Placeholder for rental card when no image */
      .rental-card-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 64px;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #2e7d32;
      }

      /* Loading skeleton for image */
      .rental-card-image-skeleton {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          #e8f5e9 25%,
          #c8e6c9 50%,
          #e8f5e9 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .rental-card-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        padding: 6px 14px;
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
      }

      .rental-card-status {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .rental-card-status.available {
        background: rgba(76, 175, 80, 0.9);
        color: white;
      }

      .rental-card-status.unavailable {
        background: rgba(244, 67, 54, 0.9);
        color: white;
      }

      .rental-card-body {
        padding: 20px;
      }

      .rental-card-name {
        font-size: 18px;
        font-weight: 700;
        color: #1f2933;
        margin-bottom: 8px;
        line-height: 1.3;
      }

      .rental-card-owner {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
      }

      .rental-card-location {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #888;
        margin-bottom: 15px;
      }

      /* Star Rating Display */
      .rental-card-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
        border-radius: 10px;
        border: 1px solid rgba(255, 193, 7, 0.2);
      }

      .rental-stars {
        display: flex;
        gap: 2px;
      }

      .rental-stars .star {
        font-size: 16px;
        color: #ffc107;
        transition: transform 0.2s ease;
      }

      .rental-stars .star.empty {
        color: #e0e0e0;
      }

      .rental-rating-text {
        font-size: 14px;
        font-weight: 600;
        color: #b45309;
      }

      .rental-review-count {
        font-size: 12px;
        color: #92400e;
      }

      /* Rental Card Pricing */
      .rental-card-pricing {
        display: flex;
        gap: 15px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }

      .rental-price-item {
        display: flex;
        flex-direction: column;
        padding: 8px 12px;
        background: rgba(46, 125, 50, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(46, 125, 50, 0.1);
      }

      .rental-price-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .rental-price-value {
        font-size: 16px;
        font-weight: 700;
        color: #2e7d32;
      }

      /* Rental Card Actions */
      .rental-card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }

      .rental-btn {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .rental-btn-details {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
      }

      .rental-btn-details:hover {
        background: linear-gradient(135deg, #bbdefb, #90caf9);
        transform: translateY(-2px);
      }

      .rental-btn-contact {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #2e7d32;
      }

      .rental-btn-contact:hover {
        background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        transform: translateY(-2px);
      }

      .rental-btn-feedback {
        background: linear-gradient(135deg, #fff8e1, #ffecb3);
        color: #f57c00;
      }

      .rental-btn-feedback:hover {
        background: linear-gradient(135deg, #ffecb3, #ffe082);
        transform: translateY(-2px);
      }

      /* Category Filter Chips */
      .rental-filter-chip {
        padding: 10px 20px;
        background: #f5f5f5;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .rental-filter-chip:hover {
        background: #e8f5e9;
        border-color: #4caf50;
        color: #2e7d32;
      }

      .rental-filter-chip.active {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        border-color: #4caf50;
        color: white;
      }

      /* Rental Modal Styles */
      .rental-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeInModal 0.3s ease;
      }

      .rental-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 550px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUpModal 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .rental-details-content {
        max-width: 700px;
      }

      @keyframes slideUpModal {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .rental-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 36px;
        height: 36px;
        border: none;
        background: #f5f5f5;
        border-radius: 50%;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rental-modal-close:hover {
        background: #e0e0e0;
        color: #333;
        transform: rotate(90deg);
      }

      /* Star Rating Input */
      .star-rating-input {
        display: flex;
        gap: 8px;
        font-size: 36px;
      }

      .star-input {
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .star-input:hover,
      .star-input.active {
        color: #ffc107;
        transform: scale(1.15);
      }

      .star-input.hovered {
        color: #ffc107;
      }

      /* Review Item */
      .review-item {
        padding: 15px;
        background: #f9f9f9;
        border-radius: 12px;
        margin-bottom: 12px;
        border-left: 4px solid #4caf50;
      }

      .review-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .review-item-name {
        font-weight: 600;
        color: #333;
      }

      .review-item-stars {
        display: flex;
        gap: 2px;
      }

      .review-item-stars .star {
        font-size: 14px;
        color: #ffc107;
      }

      .review-item-stars .star.empty {
        color: #e0e0e0;
      }

      .review-item-date {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
      }

      .review-item-comment {
        font-size: 14px;
        color: #555;
        line-height: 1.5;
      }

      /* ==========================================
   RENTAL MEDIA UPLOAD & GALLERY STYLES
   ========================================== */

      /* Media Upload Zone */
      .rental-media-upload-zone {
        border: 2px dashed #4caf50;
        border-radius: 15px;
        padding: 30px 20px;
        text-align: center;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.05),
          rgba(46, 125, 50, 0.05)
        );
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .rental-media-upload-zone:hover {
        border-color: #2e7d32;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.1),
          rgba(46, 125, 50, 0.1)
        );
        transform: translateY(-2px);
      }

      .rental-media-upload-zone.dragging {
        border-color: #1b5e20;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.15),
          rgba(46, 125, 50, 0.15)
        );
      }

      /* Media Preview Container */
      .rental-media-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 15px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 12px;
      }

      .media-preview-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        aspect-ratio: 1;
        background: #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .media-preview-item img,
      .media-preview-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-preview-item .remove-media {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 5;
      }

      .media-preview-item .remove-media:hover {
        background: #f44336;
        transform: scale(1.1);
      }

      .media-preview-item .media-type-badge {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 10px;
        font-weight: 600;
      }

      /* Rental Media Gallery Modal */
      .rental-media-gallery-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .rental-media-gallery-content {
        background: white;
        width: 95%;
        max-width: 900px;
        max-height: 90vh;
        border-radius: 20px;
        padding: 30px;
        position: relative;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .rental-media-gallery-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        background: #f5f5f5;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rental-media-gallery-close:hover {
        background: #e0e0e0;
        color: #333;
      }

      /* Media Gallery Tabs */
      .media-gallery-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .media-tab {
        padding: 10px 20px;
        background: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .media-tab:hover {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .media-tab.active {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        border-color: transparent;
      }

      .media-count-badge {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .media-tab.active .media-count-badge {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Media Gallery Grid */
      .media-gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .media-gallery-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1;
        background: #f0f0f0;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .media-gallery-item:hover {
        transform: scale(1.03);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .media-gallery-item img,
      .media-gallery-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-gallery-item .video-play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .media-gallery-item .video-play-overlay::before {
        content: "";
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .media-gallery-item .video-play-overlay::after {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border-left: 18px solid #2e7d32;
        border-top: 12px solid transparent;
        border-bottom: 12px solid transparent;
        margin-left: 5px;
      }

      .media-gallery-loading {
        grid-column: 1 / -1;
        text-align: center;
        padding: 50px;
        color: #666;
      }

      .media-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e0e0e0;
        border-top-color: #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .media-gallery-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .media-gallery-empty h3 {
        color: #666;
        margin: 15px 0 10px;
      }

      /* Rental Media Lightbox */
      .rental-media-lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.97);
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      }

      .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        font-size: 30px;
        cursor: pointer;
        color: white;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        font-size: 28px;
        cursor: pointer;
        color: white;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .lightbox-nav:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .lightbox-prev {
        left: 20px;
      }

      .lightbox-next {
        right: 20px;
      }

      .lightbox-content {
        max-width: 85%;
        max-height: 75vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lightbox-image,
      .lightbox-video {
        max-width: 100%;
        max-height: 75vh;
        object-fit: contain;
        border-radius: 8px;
      }

      .lightbox-info {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        font-size: 14px;
        opacity: 0.8;
      }

      .lightbox-info span {
        margin: 0 15px;
      }

      .lightbox-thumbnails {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        max-width: 80%;
        overflow-x: auto;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 12px;
      }

      .lightbox-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.5;
        transition: all 0.3s ease;
        flex-shrink: 0;
        border: 2px solid transparent;
      }

      .lightbox-thumbnail.active {
        opacity: 1;
        border-color: #4caf50;
      }

      .lightbox-thumbnail:hover {
        opacity: 0.8;
      }

      .lightbox-thumbnail img,
      .lightbox-thumbnail video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Photos & Videos Button Style */
      .photos-videos-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .photos-videos-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
      }

      .photos-videos-btn .media-badge {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
      }

      /* Responsive Styles for Rental Section */
      @media (max-width: 768px) {
        .rental-items-grid {
          grid-template-columns: 1fr;
        }

        .rental-card-actions {
          grid-template-columns: 1fr;
        }

        .rental-modal-content {
          padding: 20px;
          margin: 10px;
        }

        .star-rating-input {
          font-size: 28px;
        }

        .media-gallery-grid {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 10px;
        }

        .rental-media-gallery-content {
          padding: 20px;
          max-height: 95vh;
        }

        .lightbox-nav {
          width: 45px;
          height: 45px;
          font-size: 22px;
        }

        .lightbox-prev {
          left: 10px;
        }

        .lightbox-next {
          right: 10px;
        }

        .lightbox-thumbnails {
          max-width: 95%;
        }

        .lightbox-thumbnail {
          width: 50px;
          height: 50px;
        }
      }

      /* ============================================
   HISTORY SECTION STYLES
============================================ */

      .history-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .history-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }

      .history-title {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .history-title h2 {
        color: #2e7d32;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: 28px;
        margin: 0;
      }

      .history-title-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .history-actions {
        display: flex;
        gap: 12px;
      }

      .history-view-btn {
        padding: 10px 20px;
        border: 2px solid #4caf50;
        background: white;
        color: #2e7d32;
        border-radius: 25px;
        font-family: "Poppins", sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .history-view-btn:hover {
        background: #f1f8e9;
        transform: translateY(-2px);
      }

      .history-view-btn.active {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        border-color: #2e7d32;
      }

      .history-clear-btn {
        padding: 10px 20px;
        border: 2px solid #f44336;
        background: white;
        color: #f44336;
        border-radius: 25px;
        font-family: "Poppins", sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .history-clear-btn:hover {
        background: #f44336;
        color: white;
      }

      /* History Stats Cards */
      .history-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .history-stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(76, 175, 80, 0.1);
        transition: all 0.3s ease;
      }

      .history-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(76, 175, 80, 0.15);
      }

      .history-stat-icon {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .history-stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #2e7d32;
        font-family: "Poppins", sans-serif;
      }

      .history-stat-label {
        font-size: 13px;
        color: #666;
        margin-top: 5px;
      }

      /* History Filters */
      .history-filters {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
      }

      .history-filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .history-search-wrapper {
        flex: 1;
        min-width: 250px;
        position: relative;
      }

      .history-search-input {
        width: 100%;
        padding: 14px 55px 14px 50px;
        border: 2px solid #e0e0e0;
        border-radius: 30px;
        font-size: 15px;
        font-family: "Poppins", sans-serif;
        transition: all 0.3s ease;
        outline: none;
      }

      .history-search-input:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
      }

      .history-search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        color: #999;
      }

      .history-filter-select {
        padding: 14px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 30px;
        font-size: 14px;
        font-family: "Poppins", sans-serif;
        background: white;
        cursor: pointer;
        min-width: 150px;
        transition: all 0.3s ease;
        outline: none;
      }

      .history-filter-select:focus {
        border-color: #4caf50;
      }

      .history-date-input {
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 14px;
        font-family: "Poppins", sans-serif;
        outline: none;
        transition: all 0.3s ease;
      }

      .history-date-input:focus {
        border-color: #4caf50;
      }

      /* Filter Pills */
      .history-filter-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .history-filter-pill {
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        color: #555;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .history-filter-pill:hover {
        background: #f5f5f5;
        border-color: #ccc;
      }

      .history-filter-pill.active {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      /* Timeline View */
      .history-timeline {
        position: relative;
        padding-left: 40px;
      }

      .history-timeline::before {
        content: "";
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, #4caf50, #81c784);
        border-radius: 3px;
      }

      .history-date-group {
        margin-bottom: 30px;
      }

      .history-date-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        position: relative;
      }

      .history-date-marker {
        width: 12px;
        height: 12px;
        background: #4caf50;
        border-radius: 50%;
        position: absolute;
        left: -31px;
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
      }

      .history-date-text {
        font-size: 16px;
        font-weight: 600;
        color: #2e7d32;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
        padding: 8px 18px;
        border-radius: 20px;
      }

      /* History Cards */
      .history-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .history-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #4caf50;
        border-radius: 0 4px 4px 0;
      }

      .history-card:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      }

      .history-card.contacted::before {
        background: #2196f3;
      }
      .history-card.liked::before {
        background: #e91e63;
      }
      .history-card.feedback::before {
        background: #ff9800;
      }
      .history-card.viewed::before {
        background: #9c27b0;
      }
      .history-card.created::before {
        background: #4caf50;
      }
      .history-card.saved::before {
        background: #00bcd4;
      }
      .history-card.rented::before {
        background: #795548;
      }
      .history-card.responded::before {
        background: #607d8b;
      }

      .history-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 12px;
      }

      .history-card-info {
        flex: 1;
      }

      .history-card-action-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .history-card-action-badge.contacted {
        background: #e3f2fd;
        color: #1565c0;
      }
      .history-card-action-badge.liked {
        background: #fce4ec;
        color: #c2185b;
      }
      .history-card-action-badge.feedback {
        background: #fff3e0;
        color: #ef6c00;
      }
      .history-card-action-badge.viewed {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .history-card-action-badge.created {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .history-card-action-badge.saved {
        background: #e0f7fa;
        color: #00838f;
      }
      .history-card-action-badge.rented {
        background: #efebe9;
        color: #5d4037;
      }
      .history-card-action-badge.responded {
        background: #eceff1;
        color: #455a64;
      }

      .history-card-item-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0 0 8px 0;
        font-family: "Poppins", sans-serif;
      }

      .history-card-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 14px;
        color: #666;
      }

      .history-card-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .history-card-time {
        font-size: 12px;
        color: #999;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .history-card-actions {
        display: flex;
        gap: 10px;
      }

      .history-card-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .history-card-btn.view {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .history-card-btn.view:hover {
        background: #4caf50;
        color: white;
      }

      .history-card-btn.delete {
        background: #ffebee;
        color: #c62828;
      }

      .history-card-btn.delete:hover {
        background: #f44336;
        color: white;
      }

      /* List View */
      .history-list-view {
        display: none;
      }

      .history-list-view.active {
        display: block;
      }

      .history-timeline-view {
        display: block;
      }

      .history-timeline-view.hidden {
        display: none;
      }

      /* Empty State */
      .history-empty {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
      }

      .history-empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .history-empty-title {
        font-size: 24px;
        color: #333;
        margin-bottom: 10px;
        font-family: "Poppins", sans-serif;
      }

      .history-empty-text {
        font-size: 16px;
        color: #666;
        max-width: 400px;
        margin: 0 auto;
      }

      /* Loading State */
      .history-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
      }

      .history-loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e0e0e0;
        border-top-color: #4caf50;
        border-radius: 50%;
        animation: history-spin 1s linear infinite;
      }

      @keyframes history-spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Pagination */
      .history-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .history-pagination-btn {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .history-pagination-btn:hover:not(:disabled) {
        border-color: #4caf50;
        color: #4caf50;
      }

      .history-pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .history-pagination-info {
        font-size: 14px;
        color: #666;
        padding: 0 15px;
      }

      /* My Favorites Section in History */
      .history-favorites-section {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #e8f5e9;
      }

      .history-favorites-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 22px;
        color: #2e7d32;
        margin-bottom: 20px;
        font-family: "Poppins", sans-serif;
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .history-container {
          padding: 15px;
        }

        .history-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .history-title h2 {
          font-size: 22px;
        }

        .history-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .history-filters-row {
          flex-direction: column;
        }

        .history-search-wrapper {
          width: 100%;
        }

        .history-filter-select,
        .history-date-input {
          width: 100%;
        }

        .history-timeline {
          padding-left: 30px;
        }

        .history-timeline::before {
          left: 10px;
        }

        .history-date-marker {
          left: -26px;
        }

        .history-card {
          padding: 15px;
        }

        .history-card-meta {
          flex-direction: column;
          gap: 8px;
        }
      }

      @media (max-width: 480px) {
        .history-stats {
          grid-template-columns: 1fr 1fr;
          gap: 10px;
        }

        .history-stat-card {
          padding: 15px;
        }

        .history-stat-value {
          font-size: 24px;
        }

        .history-card-header {
          flex-direction: column;
        }

        .history-actions {
          flex-wrap: wrap;
        }
      }

      /* ============================================
   CROP ADVICES & FARMER SUPPORT SECTION STYLES
============================================ */

      .crop-advices-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .crop-advices-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(46, 125, 50, 0.15);
      }

      .crop-advices-title {
        font-size: 32px;
        color: #1b5e20;
        margin-bottom: 10px;
        font-weight: 700;
        font-family: "Poppins", sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .crop-advices-subtitle {
        font-size: 16px;
        color: #2e7d32;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
      }

      .crop-advices-section {
        margin-bottom: 40px;
      }

      .crop-advices-section-title {
        font-size: 22px;
        color: #2e7d32;
        margin-bottom: 20px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e8f5e9;
      }

      .crop-advices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      /* Support Card Styles */
      .support-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .support-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #4caf50, #81c784);
      }

      .support-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(46, 125, 50, 0.2);
      }

      .support-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 15px;
      }

      .support-card-icon.whatsapp {
        background: linear-gradient(135deg, #25d366, #128c7e);
        color: white;
      }

      .support-card-icon.youtube {
        background: linear-gradient(135deg, #ff0000, #cc0000);
        color: white;
      }

      .support-card-icon.phone {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
      }

      .support-card-icon.app {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
      }

      .support-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1b5e20;
        margin-bottom: 8px;
        font-family: "Poppins", sans-serif;
      }

      .support-card-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
        line-height: 1.5;
      }

      .support-card-badge {
        display: inline-block;
        background: #e8f5e9;
        color: #2e7d32;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .support-card-badge.official {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
      }

      .support-card-number {
        font-size: 20px;
        font-weight: 700;
        color: #2e7d32;
        margin: 10px 0;
        font-family: "Poppins", sans-serif;
      }

      .support-card-links {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }

      .support-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: #f8fdf8;
        border-radius: 10px;
        text-decoration: none;
        color: #2e7d32;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
      }

      .support-link:hover {
        background: #e8f5e9;
        border-color: #4caf50;
        transform: translateX(5px);
      }

      .support-link-icon {
        font-size: 20px;
      }

      /* Button Styles */
      .support-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        font-family: "Poppins", sans-serif;
      }

      .support-btn.whatsapp {
        background: linear-gradient(135deg, #25d366, #128c7e);
        color: white;
      }

      .support-btn.whatsapp:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
      }

      .support-btn.youtube {
        background: linear-gradient(135deg, #ff0000, #cc0000);
        color: white;
      }

      .support-btn.youtube:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
      }

      .support-btn.phone {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
      }

      .support-btn.phone:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .support-btn.app {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
      }

      .support-btn.app:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      }

      /* YouTube Channel Card */
      .youtube-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .youtube-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(255, 0, 0, 0.15);
      }

      .youtube-card-header {
        background: linear-gradient(135deg, #1a1a1a, #333);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .youtube-icon {
        width: 50px;
        height: 50px;
        background: #ff0000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .youtube-card-name {
        color: white;
        font-size: 16px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
      }

      .youtube-card-body {
        padding: 20px;
        text-align: center;
      }

      /* Helpline Card */
      .helpline-card {
        background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        border: 2px solid #c8e6c9;
        transition: all 0.3s ease;
      }

      .helpline-card:hover {
        border-color: #4caf50;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      }

      .helpline-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto 15px;
        color: white;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .helpline-name {
        font-size: 16px;
        color: #1b5e20;
        font-weight: 600;
        margin-bottom: 5px;
        font-family: "Poppins", sans-serif;
      }

      .helpline-number {
        font-size: 26px;
        font-weight: 700;
        color: #2e7d32;
        margin: 15px 0;
        font-family: "Poppins", sans-serif;
        letter-spacing: 1px;
      }

      .helpline-badge {
        display: inline-block;
        background: #fff;
        color: #4caf50;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
        border: 1px solid #4caf50;
      }

      /* App Card */
      .app-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .app-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(52, 152, 219, 0.2);
      }

      .app-card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .app-icon {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
      }

      .app-icon.plantix {
        background: linear-gradient(135deg, #4caf50, #8bc34a);
        color: white;
      }

      .app-icon.bighaat {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
      }

      .app-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1b5e20;
        font-family: "Poppins", sans-serif;
      }

      .app-card-purpose {
        font-size: 13px;
        color: #666;
      }

      .app-card-desc {
        font-size: 14px;
        color: #555;
        line-height: 1.5;
        margin-bottom: 15px;
      }

      /* Responsive Styles for Crop Advices */
      @media (max-width: 768px) {
        .crop-advices-container {
          padding: 15px;
        }

        .crop-advices-header {
          padding: 20px;
        }

        .crop-advices-title {
          font-size: 24px;
          flex-direction: column;
        }

        .crop-advices-grid {
          grid-template-columns: 1fr;
        }

        .helpline-number {
          font-size: 22px;
        }
      }

      @media (max-width: 480px) {
        .crop-advices-section-title {
          font-size: 18px;
        }

        .support-card {
          padding: 18px;
        }

        .youtube-card-header {
          padding: 15px;
        }

        .support-btn {
          padding: 10px 18px;
          font-size: 13px;
        }
      }

      /* Edit Profile Modal Styles */
      .edit-profile-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .edit-profile-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
      }

      .edit-profile-modal-content {
        position: relative;
        background: white;
        border-radius: 24px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease-out;
        z-index: 10001;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .edit-profile-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 30px 35px;
        border-bottom: 2px solid #e8f5e9;
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        border-radius: 24px 24px 0 0;
      }

      .edit-profile-modal-title {
        color: white;
        margin: 0;
        font-family: "Poppins", sans-serif;
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .edit-profile-modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        line-height: 1;
      }

      .edit-profile-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .edit-profile-form {
        padding: 35px;
      }

      .edit-profile-form-section {
        margin-bottom: 25px;
      }

      .edit-profile-label {
        display: block;
        font-family: "Poppins", sans-serif;
        font-size: 15px;
        font-weight: 600;
        color: #2e7d32;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .edit-profile-input,
      .edit-profile-select,
      .edit-profile-textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-family: "Poppins", sans-serif;
        font-size: 15px;
        color: #333;
        transition: all 0.3s ease;
        background: white;
        box-sizing: border-box;
      }

      .edit-profile-input:focus,
      .edit-profile-select:focus,
      .edit-profile-textarea:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
      }

      .edit-profile-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232e7d32' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 18px center;
        padding-right: 45px;
      }

      .edit-profile-textarea {
        resize: vertical;
        min-height: 100px;
        font-family: "Poppins", sans-serif;
      }

      .edit-profile-hint {
        display: block;
        margin-top: 6px;
        font-family: "Poppins", sans-serif;
        font-size: 12px;
        color: #81c784;
        font-style: italic;
      }

      .edit-profile-form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 35px;
        padding-top: 25px;
        border-top: 2px solid #e8f5e9;
      }

      .edit-profile-btn-cancel,
      .edit-profile-btn-save {
        padding: 14px 32px;
        border: none;
        border-radius: 12px;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .edit-profile-btn-cancel {
        background: #f5f5f5;
        color: #666;
      }

      .edit-profile-btn-cancel:hover {
        background: #e0e0e0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .edit-profile-btn-save {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .edit-profile-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .edit-profile-btn-save:active {
        transform: translateY(0);
      }

      /* Responsive Design for Modal */
      @media (max-width: 768px) {
        .edit-profile-modal-content {
          width: 95%;
          max-height: 95vh;
          border-radius: 20px;
        }

        .edit-profile-modal-header {
          padding: 25px 20px;
        }

        .edit-profile-modal-title {
          font-size: 22px;
        }

        .edit-profile-form {
          padding: 25px 20px;
        }

        .edit-profile-form-actions {
          flex-direction: column;
        }

        .edit-profile-btn-cancel,
        .edit-profile-btn-save {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 480px) {
        .edit-profile-modal-header {
          padding: 20px 15px;
        }

        .edit-profile-modal-title {
          font-size: 20px;
        }

        .edit-profile-form {
          padding: 20px 15px;
        }

        .edit-profile-input,
        .edit-profile-select,
        .edit-profile-textarea {
          padding: 12px 15px;
          font-size: 14px;
        }
      }

      /* ============================================
         VOICE SEARCH â€” MICROPHONE BUTTON STYLES
      ============================================ */
      .voice-search-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 38px;
        height: 38px;
        border: none;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 5;
        color: #2e7d32;
        font-size: 18px;
        box-shadow: 0 2px 8px rgba(76,175,80,0.15);
      }
      .voice-search-btn:hover {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: #fff;
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(76,175,80,0.35);
      }
      .voice-search-btn.listening {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: #fff;
        animation: voicePulse 1.2s ease-in-out infinite;
        box-shadow: 0 0 0 0 rgba(244,67,54,0.5);
      }
      .voice-search-btn svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
        pointer-events: none;
      }
      @keyframes voicePulse {
        0%   { box-shadow: 0 0 0 0 rgba(244,67,54,0.5); }
        70%  { box-shadow: 0 0 0 12px rgba(244,67,54,0); }
        100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); }
      }
      /* Ensure search inputs have right padding for mic icon */
      .voice-search-wrap { position: relative; }
      .voice-search-wrap input { padding-right: 55px !important; }

      /* Voice search toast notification */
      .voice-toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(80px);
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 12px 28px;
        border-radius: 30px;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        font-weight: 500;
        z-index: 99999;
        opacity: 0;
        transition: all 0.35s cubic-bezier(0.4,0,0.2,1);
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.3);
      }
      .voice-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .voice-toast.listening-toast {
        background: linear-gradient(135deg, #2e7d32, #4caf50);
      }
      .voice-toast.error-toast {
        background: linear-gradient(135deg, #c62828, #d32f2f);
      }
    </style>
  </head>
  <body class="page-fadein">
    <div class="dashboard-container">
      <!-- Navigation Drawer Overlay -->
      <div
        class="drawer-overlay"
        id="drawerOverlay"
        onclick="closeDrawer()"
      ></div>

      <!-- Left-Side Navigation Drawer -->
      <div class="nav-drawer" id="navDrawer">
        <!-- User Profile Header -->
        <div class="drawer-profile-header">
          <div class="drawer-profile-content">
            <div class="drawer-profile-avatar" id="drawerProfileAvatar">
              <span class="notranslate">ðŸ‘¤</span>
            </div>
            <div class="drawer-profile-name" id="drawerProfileName">
              Loading...
            </div>
            <div class="drawer-profile-email" id="drawerProfileEmail">
              Loading...
            </div>
            <div class="drawer-profile-location">
              <span class="notranslate">ðŸ“</span>
              <span id="drawerProfileLocation">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Navigation Menu -->
        <div class="drawer-menu">
          <div class="drawer-menu-item" onclick="navigateFromDrawer('create')">
            <span class="drawer-menu-item-icon notranslate">âž•</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Create Product</span
            >
          </div>
          <div
            class="drawer-menu-item"
            onclick="navigateFromDrawer('requirements')"
          >
            <span class="drawer-menu-item-icon notranslate">ðŸ“‹</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Customer Requirements</span
            >
          </div>
          <div class="drawer-menu-item" onclick="navigateFromDrawer('history')">
            <span class="drawer-menu-item-icon notranslate">ðŸ“œ</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >History</span
            >
          </div>
          <div class="drawer-menu-item" onclick="navigateFromDrawer('prices')">
            <span class="drawer-menu-item-icon notranslate">ðŸ’°</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Live Prices</span
            >
          </div>
          <div
            class="drawer-menu-item"
            onclick="navigateFromDrawer('ai-assistant')"
          >
            <span class="drawer-menu-item-icon notranslate">ðŸ¤–</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >AI Assistant</span
            >
          </div>
          <div class="drawer-menu-item" onclick="navigateFromDrawer('schemes')">
            <span class="drawer-menu-item-icon notranslate">ðŸ›ï¸</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Government Schemes</span
            >
          </div>
          <div class="drawer-menu-item" onclick="navigateFromDrawer('rentals')">
            <span class="drawer-menu-item-icon notranslate">ðŸšœ</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Rental Items</span
            >
          </div>
          <div
            class="drawer-menu-item"
            onclick="navigateFromDrawer('crop-advices')"
          >
            <span class="drawer-menu-item-icon notranslate">ðŸŒ¾</span>
            <span class="drawer-menu-item-text" data-translate="yes"
              >Crop Advices</span
            >
          </div>
        </div>

        <!-- Drawer Footer -->
        <div class="drawer-footer">
          <div
            class="drawer-footer-item"
            onclick="navigateFromDrawer('profile')"
          >
            <span class="drawer-footer-item-icon notranslate">ðŸ‘¤</span>
            <span>Profile Settings</span>
          </div>
          <div
            class="drawer-footer-item"
            onclick="
              logout();
              closeDrawer();
            "
          >
            <span class="drawer-footer-item-icon notranslate">ðŸšª</span>
            <span>Logout</span>
          </div>
        </div>
      </div>

      <div class="main-content" id="mainContent">
        <div class="top-bar" id="topBar">
          <div class="top-bar-left">
            <button
              class="drawer-toggle notranslate"
              id="drawerToggle"
              onclick="toggleDrawer()"
            >
              â˜°
            </button>
            <h2>CTF.ai</h2>
          </div>
          <div class="top-bar-right">
            <div class="top-nav-options">
              <!-- Global language selector -->
              <div class="language-switcher">
                <select
                  class="language-select notranslate"
                  id="dashboardLanguageSelect"
                  onchange="handleLanguageChange(this.value)"
                >
                  <option value="en" class="notranslate">English</option>
                  <option value="hi" class="notranslate">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                  <option value="ta" class="notranslate">à®¤à®®à®¿à®´à¯</option>
                  <option value="te" class="notranslate">à°¤à±†à°²à±à°—à±</option>
                </select>
              </div>
              <button
                class="top-nav-btn notranslate"
                onclick="switchDashSection('notifications')"
                style="position: relative"
              >
                <span class="notranslate">ðŸ””</span>
                <span class="notranslate">Notifications</span>
                <span
                  class="notification-badge notranslate"
                  style="
                    display: none;
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #f44336;
                    color: white;
                    font-size: 10px;
                    font-weight: bold;
                    padding: 2px 6px;
                    border-radius: 10px;
                    min-width: 18px;
                    text-align: center;
                  "
                ></span>
              </button>
              <button
                class="top-nav-btn notranslate profile-icon-btn"
                onclick="switchDashSection('profile')"
                style="
                  position: relative;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  padding: 8px 16px;
                "
              >
                <div
                  id="navProfileIcon"
                  class="nav-profile-icon"
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #4caf50, #45a049);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    overflow: hidden;
                    flex-shrink: 0;
                  "
                >
                  <span class="notranslate">ðŸ‘¤</span>
                </div>
                <span class="notranslate">Profile</span>
              </button>
            </div>
          </div>
        </div>

        <div class="main-content-wrapper">
          <!-- Home Dashboard Section - Card Based -->
          <div id="dashHome" class="dash-section active">
            <!-- User Welcome Card -->
            <div
              id="userWelcomeCard"
              style="
                background: linear-gradient(135deg, #4caf50, #45a049);
                padding: 30px;
                border-radius: 25px;
                margin: 30px auto;
                max-width: 1200px;
                color: white;
                box-shadow: 0 8px 30px rgba(76, 175, 80, 0.3);
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 25px;
                  flex-wrap: wrap;
                  justify-content: center;
                "
              >
                <div
                  style="
                    width: 100px;
                    height: 100px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 50px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                  "
                  class="notranslate"
                >
                  ðŸ‘¤
                </div>
                <div style="flex: 1; min-width: 300px; text-align: center">
                  <h2
                    style="
                      margin: 0 0 15px 0;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-size: 32px;
                      font-weight: 600;
                    "
                    data-translate="yes"
                  >
                    Welcome,
                    <span id="homeUserName" class="notranslate">Loading...</span
                    >!
                  </h2>
                  <div
                    style="
                      display: flex;
                      flex-direction: column;
                      gap: 10px;
                      font-size: 16px;
                      opacity: 0.95;
                    "
                  >
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                      "
                    >
                      <span class="notranslate"></span>
                      <span id="homeUserPhone" class="notranslate"
                        >Loading...</span
                      >
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                      "
                    >
                      <span class="notranslate">ðŸ“</span>
                      <span id="homeUserLocation" class="notranslate"
                        >Loading...</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sections Grid -->
            <div class="sections-grid">
              <div class="section-card" onclick="switchDashSection('create')">
                <div class="section-card-icon notranslate">âž•</div>
                <div class="section-card-title" data-translate="yes">
                  Create Product
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Add new products to your inventory and reach more customers
                </div>
              </div>
              <div
                class="section-card"
                onclick="switchDashSection('requirements')"
              >
                <div class="section-card-icon notranslate">ðŸ“‹</div>
                <div class="section-card-title" data-translate="yes">
                  Customer Requirements
                </div>
                <div class="section-card-desc" data-translate="yes">
                  View and manage customer requirements and requests
                </div>
              </div>
              <div class="section-card" onclick="switchDashSection('history')">
                <div class="section-card-icon notranslate">ðŸ“œ</div>
                <div class="section-card-title" data-translate="yes">
                  History
                </div>
                <div class="section-card-desc" data-translate="yes">
                  View your transaction and activity history
                </div>
              </div>
              <div class="section-card" onclick="switchDashSection('prices')">
                <div class="section-card-icon notranslate">ðŸ’°</div>
                <div class="section-card-title" data-translate="yes">
                  Live Prices
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Check real-time market prices for agricultural products
                </div>
              </div>

              <div
                class="section-card"
                onclick="switchDashSection('ai-assistant')"
              >
                <div class="section-card-icon notranslate">ðŸ¤–</div>
                <div class="section-card-title" data-translate="yes">
                  AI Assistant
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Get instant help and answers from our AI assistant
                </div>
              </div>

              <div class="section-card" onclick="switchDashSection('schemes')">
                <div class="section-card-icon notranslate">ðŸ›ï¸</div>
                <div class="section-card-title" data-translate="yes">
                  Government Schemes
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Extract and view government schemes and subsidies
                </div>
              </div>

              <div class="section-card" onclick="switchDashSection('rentals')">
                <div class="section-card-icon notranslate">ðŸšœ</div>
                <div class="section-card-title" data-translate="yes">
                  Rental Items
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Browse and rent farming equipment from local owners
                </div>
              </div>

              <div
                class="section-card"
                onclick="switchDashSection('crop-advices')"
              >
                <div class="section-card-icon notranslate">ðŸŒ¾</div>
                <div class="section-card-title" data-translate="yes">
                  Crop Advices
                </div>
                <div class="section-card-desc" data-translate="yes">
                  Get farming advice, helplines, and learning resources
                </div>
              </div>

              <div class="section-card" onclick="switchDashSection('profile')">
                <div class="section-card-icon notranslate">ðŸ‘¤</div>
                <div class="section-card-title" data-translate="yes">
                  My Profile
                </div>
                <div class="section-card-desc" data-translate="yes">
                  View and manage your profile information
                </div>
              </div>
            </div>

            <!-- Products Section with Enhanced Search & Header -->
            <div style="max-width: 1400px; margin: 50px auto; padding: 0 30px">
              <!-- Sticky Search Bar with Filters -->
              <div id="productStickyBar" style="position: sticky; top: 70px; background: white; z-index: 999; padding: 20px 0; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 20px; padding: 25px 30px;">
                <!-- Search Bar with Add Product Button -->
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                  <div class="voice-search-wrap" style="flex: 1; min-width: 300px; position: relative">
                    <input
                      type="text"
                      id="productSearchInput"
                      placeholder="ðŸ” Search products..."
                      style="
                        width: 100%;
                        padding: 18px 28px;
                        padding-right: 55px;
                        border: 2px solid #e0e0e0;
                        border-radius: 50px;
                        font-size: 16px;
                        font-family: &quot;Poppins&quot;, sans-serif;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        background: white;
                        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
                        outline: none;
                      "
                      onfocus="
                        this.style.borderColor = '#4caf50';
                        this.style.boxShadow =
                          '0 4px 20px rgba(76,175,80,0.15), 0 0 0 4px rgba(76,175,80,0.1)';
                      "
                      onblur="
                        this.style.borderColor = '#e0e0e0';
                        this.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';
                      "
                      oninput="filterAndDisplayProducts()"
                    />
                    <button type="button" class="voice-search-btn" onclick="startVoiceSearch('productSearchInput', function(){ if(typeof filterAndDisplayProducts==='function') filterAndDisplayProducts(); })" title="Voice Search" aria-label="Voice Search">
                      <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                  </div>
                  <button
                    onclick="switchDashSection('create')"
                    style="
                      padding: 18px 38px;
                      background: linear-gradient(135deg, #4caf50, #2e7d32);
                      color: white;
                      border: none;
                      border-radius: 50px;
                      font-size: 16px;
                      font-weight: 600;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                      display: flex;
                      align-items: center;
                      gap: 10px;
                      white-space: nowrap;
                    "
                    onmouseover="
                      this.style.transform = 'translateY(-2px) scale(1.02)';
                      this.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
                    "
                    onmouseout="
                      this.style.transform = 'translateY(0) scale(1)';
                      this.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                    "
                  >
                    <span style="font-size: 20px; font-weight: bold">+</span>
                    <span>Add Product</span>
                  </button>
                </div>

                <!-- Category and Sort Filters -->
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 250px;">
                    <label style="display: block; color: #2e7d32; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ðŸ“‚ Choose a category...</label>
                    <select id="productCategoryFilter" onchange="filterAndDisplayProducts()" style="width: 100%; padding: 14px 20px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; font-family: 'Poppins', sans-serif; background: white; cursor: pointer; outline: none; transition: all 0.3s ease;">
                      <option value="">All Categories</option>
                      <option value="Vegetables">ðŸ¥¬ Vegetables</option>
                      <option value="Fruits">ðŸŽ Fruits</option>
                      <option value="Flowers">ðŸŒ¸ Flowers</option>
                      <option value="Grains">ðŸŒ¾ Grains</option>
                      <option value="Seeds">ðŸŒ± Seeds</option>
                      <option value="Dairy">ðŸ¥› Dairy</option>
                    </select>
                  </div>

                  <div style="flex: 1; min-width: 250px;">
                    <label style="display: block; color: #2e7d32; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ðŸ”ƒ Sort Options</label>
                    <select id="productSortFilter" onchange="filterAndDisplayProducts()" style="width: 100%; padding: 14px 20px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; font-family: 'Poppins', sans-serif; background: white; cursor: pointer; outline: none; transition: all 0.3s ease;">
                      <option value="newest">â° Newest First</option>
                      <option value="highestRated">â­ Highest Rated</option>
                      <option value="mostReviewed">ðŸ’¬ Most Reviewed</option>
                      <option value="priceLowHigh">ðŸ’° Price: Low to High</option>
                      <option value="priceHighLow">ðŸ’¸ Price: High to Low</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Inspiring Quote Section -->
              <div
                style="
                  max-width: 100%;
                  margin: 0 auto 40px auto;
                  padding: 35px 40px;
                  background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
                  border-left: 6px solid #4caf50;
                  border-radius: 20px;
                  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.12);
                  text-align: center;
                "
              >
                <div
                  style="
                    font-size: 26px;
                    font-family:
                      &quot;Georgia&quot;, &quot;Times New Roman&quot;, serif;
                    color: #2e7d32;
                    font-style: italic;
                    margin-bottom: 20px;
                    line-height: 1.6;
                    font-weight: 500;
                  "
                >
                  "From our soil to your soul â€“ fresh, pure and healthy."
                </div>
                <div
                  style="
                    font-size: 16px;
                    font-family: &quot;Poppins&quot;, sans-serif;
                    color: #555;
                    line-height: 1.8;
                    max-width: 900px;
                    margin: 0 auto;
                  "
                >
                  All products on CTF.ai are pure, fresh, and healthy, coming
                  directly from verified farmers within your local area. Support
                  local agriculture while enjoying the best quality produce!
                </div>
              </div>

              <!-- Products Container (Category-Based Sections) -->
              <div id="productsContainer">
                <!-- Category sections will be dynamically added here -->
              </div>

              <!-- No Results Message (initially hidden) -->
              <div
                id="noProductsMessage"
                style="
                  display: none;
                  text-align: center;
                  padding: 60px 20px;
                  color: #666;
                  font-family: &quot;Poppins&quot;, sans-serif;
                "
              >
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5">
                  ðŸ”
                </div>
                <h3
                  style="font-size: 24px; color: #2e7d32; margin-bottom: 10px"
                >
                  No Products Found
                </h3>
                <p style="font-size: 16px">
                  Try adjusting your search or browse all products.
                </p>
              </div>
            </div>
          </div>

          <!-- Create Product Section -->
          <div id="dashCreate" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 30px">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>
            </div>
            <div class="create-section-centered">
              <h2
                style="
                  color: #2e7d32;
                  margin-bottom: 30px;
                  font-family: &quot;Poppins&quot;, sans-serif;
                  font-weight: 600;
                "
              >
                ðŸª´ Add New Product
              </h2>

              <!-- Progress Steps -->
              <div class="progress-steps">
                <div class="step-item active" data-step="1">
                  <div class="step-number">1</div>
                  <div class="step-label">Category & Details</div>
                </div>
                <div class="step-connector"></div>
                <div class="step-item" data-step="2">
                  <div class="step-number">2</div>
                  <div class="step-label">Quantity & Price</div>
                </div>
                <div class="step-connector"></div>
                <div class="step-item" data-step="3">
                  <div class="step-number">3</div>
                  <div class="step-label">Upload Images</div>
                </div>
                <div class="step-connector"></div>
                <div class="step-item" data-step="4">
                  <div class="step-number">4</div>
                  <div class="step-label">Review & Publish</div>
                </div>
              </div>

              <!-- Step 1: Category & Product Details -->
              <div class="wizard-step active" id="step1">
                <div class="step-card">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 25px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 600;
                    "
                  >
                    Step 1: Category & Product Details
                  </h3>
                  <div class="form-group">
                    <label>Select Category</label>
                    <select id="productCategory" class="modern-select" required>
                      <option value="">Choose a category...</option>
                      <option value="Vegetables">ðŸ¥¬ Vegetables</option>
                      <option value="Fruits">ðŸŽ Fruits</option>
                      <option value="Flowers">ðŸŒ¸ Flowers</option>
                      <option value="Grains">ðŸŒ¾ Grains</option>
                      <option value="Seeds">ðŸŒ± Seeds</option>
                      <option value="Dairy">ðŸ¥› Dairy</option>
                      <option value="Others">ðŸŒ¿ Others</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Product Name</label>
                    <input
                      type="text"
                      id="productName"
                      class="modern-input"
                      placeholder="e.g., Fresh Tomatoes"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label>Description</label>
                    <textarea
                      id="productDescription"
                      class="modern-textarea"
                      placeholder="Describe your product..."
                      rows="4"
                      required
                    ></textarea>
                  </div>
                  <div class="step-buttons">
                    <button
                      type="button"
                      class="btn-next"
                      onclick="nextStep(2)"
                    >
                      Next â†’
                    </button>
                  </div>
                </div>
              </div>

              <!-- Step 2: Quantity & Price -->
              <div class="wizard-step" id="step2">
                <div class="step-card">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 25px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 600;
                    "
                  >
                    Step 2: Quantity & Price
                  </h3>
                  <div class="form-group">
                    <label>Available Quantity</label>
                    <div class="quantity-input-group">
                      <input
                        type="number"
                        id="productQuantity"
                        class="modern-input"
                        placeholder="Enter quantity"
                        min="1"
                        required
                      />
                      <select
                        id="quantityUnit"
                        class="modern-select"
                        style="width: 150px"
                      >
                        <option value="kg">kg</option>
                        <option value="quintal">Quintal</option>
                        <option value="packet">Packet</option>
                        <option value="piece">Piece</option>
                        <option value="litre">Litre</option>
                        <option value="dozen">Dozen</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Price per Unit (â‚¹)</label>
                    <input
                      type="number"
                      id="productPrice"
                      class="modern-input"
                      placeholder="Enter price"
                      min="1"
                      step="0.01"
                      required
                    />
                  </div>
                  <div class="step-buttons">
                    <button
                      type="button"
                      class="btn-previous"
                      onclick="previousStep(1)"
                    >
                      â† Previous
                    </button>
                    <button
                      type="button"
                      class="btn-next"
                      onclick="nextStep(3)"
                    >
                      Next â†’
                    </button>
                  </div>
                </div>
              </div>

              <!-- Step 3: Upload Images -->
              <div class="wizard-step" id="step3">
                <div class="step-card">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 25px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 600;
                    "
                  >
                    Step 3: Upload Product Images & Videos
                  </h3>

                  <!-- Image Upload Section -->
                  <h4
                    style="
                      color: #2e7d32;
                      margin-bottom: 15px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 500;
                    "
                  >
                    ðŸ“· Product Images
                  </h4>
                  <div class="upload-options">
                    <button
                      type="button"
                      class="upload-btn"
                      onclick="document.getElementById('imageUpload').click()"
                    >
                      <span>ðŸ“¤</span>
                      <span>Upload Images (up to 5)</span>
                    </button>
                    <button
                      type="button"
                      class="upload-btn"
                      onclick="captureImage()"
                    >
                      <span>ðŸ“¸</span>
                      <span>Capture using Camera</span>
                    </button>
                  </div>
                  <input
                    type="file"
                    id="imageUpload"
                    multiple
                    accept="image/*"
                    style="display: none"
                    onchange="handleImageUpload(event)"
                  />
                  <div id="imagePreview" class="image-preview-grid"></div>

                  <!-- Video Upload Section -->
                  <h4
                    style="
                      color: #2e7d32;
                      margin: 30px 0 15px 0;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 500;
                    "
                  >
                    ðŸŽ¥ Product Videos
                  </h4>
                  <div class="upload-options">
                    <button
                      type="button"
                      class="upload-btn"
                      onclick="document.getElementById('videoUpload').click()"
                    >
                      <span>ðŸ“¤</span>
                      <span>Upload Videos (up to 3)</span>
                    </button>
                    <button
                      type="button"
                      class="upload-btn"
                      onclick="captureVideo()"
                    >
                      <span>ðŸŽ¬</span>
                      <span>Record Video</span>
                    </button>
                  </div>
                  <input
                    type="file"
                    id="videoUpload"
                    multiple
                    accept="video/*"
                    style="display: none"
                    onchange="handleVideoUpload(event)"
                  />
                  <div id="videoPreview" class="image-preview-grid"></div>

                  <div class="step-buttons">
                    <button
                      type="button"
                      class="btn-previous"
                      onclick="previousStep(2)"
                    >
                      â† Previous
                    </button>
                    <button
                      type="button"
                      class="btn-next"
                      onclick="nextStep(4)"
                    >
                      Next â†’
                    </button>
                  </div>
                </div>
              </div>

              <!-- Step 4: Review & Publish -->
              <div class="wizard-step" id="step4">
                <div class="step-card">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 25px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      font-weight: 600;
                    "
                  >
                    Step 4: Review & Publish
                  </h3>
                  <div class="review-section">
                    <div class="review-item">
                      <strong>Category:</strong>
                      <span id="reviewCategory"></span>
                    </div>
                    <div class="review-item">
                      <strong>Product Name:</strong>
                      <span id="reviewName"></span>
                    </div>
                    <div class="review-item">
                      <strong>Description:</strong>
                      <span id="reviewDescription"></span>
                    </div>
                    <div class="review-item">
                      <strong>Quantity & Unit:</strong>
                      <span id="reviewQuantity"></span>
                    </div>
                    <div class="review-item">
                      <strong>Price per Unit:</strong>
                      <span id="reviewPrice"></span>
                    </div>
                    <div class="review-item">
                      <strong>Images:</strong>
                      <div id="reviewImages" class="review-images"></div>
                    </div>
                  </div>
                  <div class="step-buttons">
                    <button
                      type="button"
                      class="btn-previous"
                      onclick="previousStep(3)"
                    >
                      â† Previous
                    </button>
                    <button
                      type="button"
                      class="btn-publish"
                      onclick="publishProduct()"
                    >
                      ðŸŒ¿ Sell the Product
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="dashHistory" class="dash-section">
            <div class="history-container">
              <!-- Back Button -->
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>

              <!-- Header -->
              <div class="history-header">
                <div class="history-title">
                  <div class="history-title-icon">ðŸ“œ</div>
                  <h2>Activity History</h2>
                </div>
                <div class="history-actions">
                  <button
                    class="history-view-btn active"
                    id="timelineViewBtn"
                    onclick="setHistoryView('timeline')"
                  >
                    <span>ðŸ“…</span> Timeline
                  </button>
                  <button
                    class="history-view-btn"
                    id="listViewBtn"
                    onclick="setHistoryView('list')"
                  >
                    <span>ðŸ“‹</span> List
                  </button>
                  <button
                    class="history-clear-btn"
                    onclick="confirmClearHistory()"
                  >
                    <span>ðŸ—‘ï¸</span> Clear All
                  </button>
                </div>
              </div>

              <!-- Stats Cards -->
              <div class="history-stats" id="historyStats">
                <div class="history-stat-card">
                  <div class="history-stat-icon">ðŸ“Š</div>
                  <div class="history-stat-value" id="statTotal">0</div>
                  <div class="history-stat-label">Total Activities</div>
                </div>
                <div class="history-stat-card">
                  <div class="history-stat-icon">ðŸ“ž</div>
                  <div class="history-stat-value" id="statContacted">0</div>
                  <div class="history-stat-label">Contacted</div>
                </div>
                <div class="history-stat-card">
                  <div class="history-stat-icon">â¤ï¸</div>
                  <div class="history-stat-value" id="statLiked">0</div>
                  <div class="history-stat-label">Liked</div>
                </div>
                <div class="history-stat-card">
                  <div class="history-stat-icon">â­</div>
                  <div class="history-stat-value" id="statFeedback">0</div>
                  <div class="history-stat-label">Feedback</div>
                </div>
                <div class="history-stat-card">
                  <div class="history-stat-icon">ðŸ‘ï¸</div>
                  <div class="history-stat-value" id="statViewed">0</div>
                  <div class="history-stat-label">Viewed</div>
                </div>
              </div>

              <!-- Filters -->
              <div class="history-filters">
                <div class="history-filters-row">
                  <div class="history-search-wrapper voice-search-wrap">
                    <span class="history-search-icon">ðŸ”</span>
                    <input
                      type="text"
                      class="history-search-input"
                      id="historySearchInput"
                      placeholder="Search by item name, owner, or location..."
                      onkeyup="debounceHistorySearch()"
                    />
                    <button type="button" class="voice-search-btn" onclick="startVoiceSearch('historySearchInput', function(){ if(typeof debounceHistorySearch==='function') debounceHistorySearch(); })" title="Voice Search" aria-label="Voice Search">
                      <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                  </div>
                  <select
                    class="history-filter-select"
                    id="historyActionFilter"
                    onchange="applyHistoryFilters()"
                  >
                    <option value="">All Actions</option>
                    <option value="contacted">Contacted</option>
                    <option value="liked">Liked</option>
                    <option value="feedback">Feedback</option>
                    <option value="viewed">Viewed</option>
                    <option value="created">Created</option>
                    <option value="saved">Saved</option>
                    <option value="rented">Rented</option>
                    <option value="responded">Responded</option>
                  </select>
                  <select
                    class="history-filter-select"
                    id="historyItemFilter"
                    onchange="applyHistoryFilters()"
                  >
                    <option value="">All Types</option>
                    <option value="product">Products</option>
                    <option value="rental">Rentals</option>
                    <option value="requirement">Requirements</option>
                    <option value="scheme">Schemes</option>
                  </select>
                  <input
                    type="date"
                    class="history-date-input"
                    id="historyStartDate"
                    onchange="applyHistoryFilters()"
                    title="Start Date"
                  />
                  <input
                    type="date"
                    class="history-date-input"
                    id="historyEndDate"
                    onchange="applyHistoryFilters()"
                    title="End Date"
                  />
                </div>

                <!-- Quick Filter Pills -->
                <div class="history-filter-pills">
                  <button
                    class="history-filter-pill active"
                    data-filter="all"
                    onclick="setQuickFilter('all')"
                  >
                    All
                  </button>
                  <button
                    class="history-filter-pill"
                    data-filter="today"
                    onclick="setQuickFilter('today')"
                  >
                    ðŸ“… Today
                  </button>
                  <button
                    class="history-filter-pill"
                    data-filter="week"
                    onclick="setQuickFilter('week')"
                  >
                    ðŸ“† This Week
                  </button>
                  <button
                    class="history-filter-pill"
                    data-filter="month"
                    onclick="setQuickFilter('month')"
                  >
                    ðŸ—“ï¸ This Month
                  </button>
                  <button
                    class="history-filter-pill"
                    data-filter="products"
                    onclick="setQuickFilter('products')"
                  >
                    ðŸ¥¬ Products
                  </button>
                  <button
                    class="history-filter-pill"
                    data-filter="rentals"
                    onclick="setQuickFilter('rentals')"
                  >
                    ðŸšœ Rentals
                  </button>
                </div>
              </div>

              <!-- Loading State -->
              <div
                class="history-loading"
                id="historyLoading"
                style="display: none"
              >
                <div class="history-loading-spinner"></div>
                <p style="margin-top: 15px; color: #666">
                  Loading your activity history...
                </p>
              </div>

              <!-- Empty State -->
              <div
                class="history-empty"
                id="historyEmpty"
                style="display: none"
              >
                <div class="history-empty-icon">ðŸ“­</div>
                <h3 class="history-empty-title">No Activity History Yet</h3>
                <p class="history-empty-text">
                  Your interactions with products, rentals, and requirements
                  will appear here. Start exploring to build your history!
                </p>
              </div>

              <!-- Timeline View -->
              <div class="history-timeline-view" id="historyTimelineView">
                <div class="history-timeline" id="historyTimeline">
                  <!-- Timeline items will be inserted here -->
                </div>
              </div>

              <!-- List View -->
              <div class="history-list-view" id="historyListView">
                <div id="historyList">
                  <!-- List items will be inserted here -->
                </div>
              </div>

              <!-- Pagination -->
              <div
                class="history-pagination"
                id="historyPagination"
                style="display: none"
              >
                <button
                  class="history-pagination-btn"
                  id="historyPrevBtn"
                  onclick="changeHistoryPage(-1)"
                >
                  â† Previous
                </button>
                <span class="history-pagination-info" id="historyPageInfo"
                  >Page 1 of 1</span
                >
                <button
                  class="history-pagination-btn"
                  id="historyNextBtn"
                  onclick="changeHistoryPage(1)"
                >
                  Next â†’
                </button>
              </div>

              <!-- My Favorites Section -->
              <div
                class="history-favorites-section"
                id="historyFavoritesSection"
              >
                <h3 class="history-favorites-title">
                  <span>â¤ï¸</span> My Favorites
                </h3>
                <div class="products-grid" id="historyFavoritesGrid">
                  <!-- Favorite products will be inserted here -->
                </div>
                <div
                  id="historyFavoritesEmpty"
                  style="
                    display: none;
                    text-align: center;
                    padding: 30px;
                    color: #666;
                  "
                >
                  <p>
                    No favorite products yet. Click the heart icon on products
                    you love!
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Notifications Section -->
          <div id="dashNotifications" class="dash-section">
            <div style="max-width: 1400px; margin: 0 auto; padding: 30px 20px">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>

              <div style="margin-top: 30px">
                <!-- Modern Header with Stats -->
                <div class="notifications-header">
                  <div class="notifications-header-content">
                    <h2 class="notifications-title" data-translate="yes">
                      ðŸ”” Notifications
                    </h2>
                    <div class="notifications-stats">
                      <div class="stat-item">
                        <span class="stat-label" data-translate="yes"
                          >Total</span
                        >
                        <span class="stat-value" id="notificationTotalCount"
                          >0</span
                        >
                      </div>
                      <div class="stat-divider"></div>
                      <div class="stat-item">
                        <span class="stat-label" data-translate="yes"
                          >Unread</span
                        >
                        <span
                          class="stat-value unread-count"
                          id="notificationUnreadCount"
                          >0</span
                        >
                      </div>
                    </div>
                  </div>
                  <button
                    class="mark-all-read-btn"
                    onclick="markAllNotificationsAsRead()"
                    data-translate="yes"
                  >
                    <span>âœ“</span>
                    <span>Mark All Read</span>
                  </button>
                </div>

                <!-- Category Filter Tabs -->
                <div class="notification-filter-tabs">
                  <button
                    class="filter-tab active"
                    id="filterAll"
                    onclick="filterNotifications('all')"
                    data-translate="yes"
                  >
                    <span class="tab-icon">ðŸ“‹</span>
                    <span class="tab-text">All</span>
                  </button>
                  <button
                    class="filter-tab"
                    id="filterProductPosted"
                    onclick="filterNotifications('product_posted')"
                    data-translate="yes"
                  >
                    <span class="tab-icon">ðŸŒ¾</span>
                    <span class="tab-text">Products Posted</span>
                  </button>
                  <button
                    class="filter-tab"
                    id="filterRentalPosted"
                    onclick="filterNotifications('rental_posted')"
                    data-translate="yes"
                  >
                    <span class="tab-icon">ðŸšœ</span>
                    <span class="tab-text">Rental Items Posted</span>
                  </button>
                  <button
                    class="filter-tab"
                    id="filterProductRequirement"
                    onclick="filterNotifications('product_requirement_posted')"
                    data-translate="yes"
                  >
                    <span class="tab-icon">ðŸ“¦</span>
                    <span class="tab-text">Product Requirements</span>
                  </button>
                  <button
                    class="filter-tab"
                    id="filterRentalRequirement"
                    onclick="filterNotifications('rental_requirement_posted')"
                    data-translate="yes"
                  >
                    <span class="tab-icon">ðŸ”§</span>
                    <span class="tab-text">Rental Requirements</span>
                  </button>
                </div>

                <!-- Notifications Container -->
                <div
                  id="notificationsContainer"
                  class="notifications-container"
                >
                  <!-- Notifications will be rendered here -->
                </div>

                <!-- Empty State -->
                <div
                  id="noNotifications"
                  class="empty-notifications-state"
                  style="display: none"
                >
                  <div class="empty-icon">ðŸ””</div>
                  <h3 class="empty-title" data-translate="yes">
                    No Notifications
                  </h3>
                  <p class="empty-message" data-translate="yes">
                    You're all caught up! No notifications to display.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <style>
            /* Modern Notifications Header */
            .notifications-header {
              background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
              border-radius: 20px;
              padding: 30px 35px;
              margin-bottom: 30px;
              box-shadow: 0 8px 30px rgba(76, 175, 80, 0.25);
              position: sticky;
              top: 20px;
              z-index: 100;
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 20px;
            }

            .notifications-header-content {
              flex: 1;
              min-width: 250px;
            }

            .notifications-title {
              color: white;
              margin: 0 0 15px 0;
              font-family: "Poppins", sans-serif;
              font-weight: 700;
              font-size: 32px;
              text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .notifications-stats {
              display: flex;
              align-items: center;
              gap: 20px;
              flex-wrap: wrap;
            }

            .stat-item {
              display: flex;
              flex-direction: column;
              gap: 5px;
            }

            .stat-label {
              color: rgba(255, 255, 255, 0.9);
              font-family: "Poppins", sans-serif;
              font-size: 13px;
              font-weight: 500;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }

            .stat-value {
              color: white;
              font-family: "Poppins", sans-serif;
              font-size: 28px;
              font-weight: 700;
              line-height: 1;
            }

            .stat-value.unread-count {
              color: #fff59d;
              text-shadow: 0 2px 8px rgba(255, 245, 157, 0.3);
            }

            .stat-divider {
              width: 2px;
              height: 35px;
              background: rgba(255, 255, 255, 0.3);
              border-radius: 2px;
            }

            .mark-all-read-btn {
              padding: 14px 28px;
              background: rgba(255, 255, 255, 0.2);
              backdrop-filter: blur(10px);
              border: 2px solid rgba(255, 255, 255, 0.3);
              color: white;
              border-radius: 50px;
              cursor: pointer;
              font-family: "Poppins", sans-serif;
              font-weight: 600;
              font-size: 15px;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              display: flex;
              align-items: center;
              gap: 8px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .mark-all-read-btn:hover {
              background: rgba(255, 255, 255, 0.3);
              transform: translateY(-2px);
              box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }

            /* Category Filter Tabs */
            .notification-filter-tabs {
              display: flex;
              gap: 12px;
              margin-bottom: 30px;
              flex-wrap: wrap;
              overflow-x: auto;
              padding-bottom: 10px;
              scrollbar-width: thin;
              scrollbar-color: #81c784 transparent;
            }

            .notification-filter-tabs::-webkit-scrollbar {
              height: 6px;
            }

            .notification-filter-tabs::-webkit-scrollbar-track {
              background: transparent;
            }

            .notification-filter-tabs::-webkit-scrollbar-thumb {
              background: #81c784;
              border-radius: 10px;
            }

            .filter-tab {
              padding: 14px 24px;
              background: white;
              border: 2px solid #e0e0e0;
              border-radius: 50px;
              cursor: pointer;
              font-family: "Poppins", sans-serif;
              font-weight: 600;
              font-size: 14px;
              color: #666;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              display: flex;
              align-items: center;
              gap: 8px;
              white-space: nowrap;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
              position: relative;
              overflow: hidden;
            }

            .filter-tab::before {
              content: "";
              position: absolute;
              bottom: 0;
              left: 50%;
              transform: translateX(-50%);
              width: 0;
              height: 3px;
              background: linear-gradient(90deg, #4caf50, #2e7d32);
              transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              border-radius: 3px 3px 0 0;
            }

            .filter-tab:hover {
              border-color: #4caf50;
              color: #2e7d32;
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
            }

            .filter-tab.active {
              background: linear-gradient(135deg, #4caf50, #2e7d32);
              color: white;
              border-color: #2e7d32;
              box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
              transform: translateY(-2px);
            }

            .filter-tab.active::before {
              width: 100%;
              background: rgba(255, 255, 255, 0.3);
            }

            .tab-icon {
              font-size: 18px;
              line-height: 1;
            }

            .tab-text {
              font-size: 14px;
            }

            /* Notifications Container */
            .notifications-container {
              display: flex;
              flex-direction: column;
              gap: 18px;
            }

            /* Modern Notification Card */
            .notification-card {
              background: white;
              border-radius: 16px;
              padding: 0;
              box-shadow: 0 4px 20px rgba(46, 125, 50, 0.08);
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              overflow: hidden;
              border-left: 5px solid #4caf50;
              display: flex;
              align-items: stretch;
            }

            .notification-card:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 30px rgba(46, 125, 50, 0.15);
              border-left-width: 6px;
            }

            .notification-card.unread {
              background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
              border-left-color: #2e7d32;
              box-shadow: 0 6px 25px rgba(46, 125, 50, 0.12);
            }

            .notification-card.unread::before {
              content: "";
              position: absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 6px;
              background: linear-gradient(180deg, #4caf50, #2e7d32);
            }

            .notification-card.read {
              opacity: 0.85;
            }

            .notification-icon-wrapper {
              width: 70px;
              min-width: 70px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
              position: relative;
            }

            .notification-icon {
              font-size: 32px;
              line-height: 1;
            }

            .notification-content {
              flex: 1;
              padding: 20px 24px;
              display: flex;
              flex-direction: column;
              gap: 12px;
            }

            .notification-header-row {
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              gap: 15px;
            }

            .notification-title-section {
              flex: 1;
              display: flex;
              align-items: center;
              gap: 10px;
              flex-wrap: wrap;
            }

            .notification-title {
              font-family: "Poppins", sans-serif;
              font-weight: 700;
              font-size: 18px;
              color: #2e7d32;
              margin: 0;
              line-height: 1.3;
            }

            .notification-badge-new {
              background: linear-gradient(135deg, #4caf50, #2e7d32);
              color: white;
              font-size: 10px;
              font-weight: 700;
              padding: 4px 10px;
              border-radius: 12px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
              animation: pulse 2s infinite;
            }

            @keyframes pulse {
              0%,
              100% {
                opacity: 1;
              }
              50% {
                opacity: 0.8;
              }
            }

            .notification-message {
              font-family: "Poppins", sans-serif;
              font-size: 15px;
              color: #555;
              line-height: 1.6;
              margin: 0;
            }

            .notification-details {
              font-family: "Poppins", sans-serif;
              font-size: 14px;
              color: #777;
              line-height: 1.5;
              margin: 0;
            }

            .notification-footer {
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 12px;
              margin-top: 8px;
              padding-top: 12px;
              border-top: 1px solid #e8f5e9;
            }

            .notification-time {
              font-family: "Poppins", sans-serif;
              font-size: 13px;
              color: #81c784;
              font-weight: 500;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .notification-time::before {
              content: "ðŸ•";
              font-size: 14px;
            }

            .notification-actions {
              display: flex;
              gap: 8px;
              flex-wrap: wrap;
            }

            .notification-action-btn {
              padding: 8px 16px;
              border: none;
              border-radius: 20px;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              font-family: "Poppins", sans-serif;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              display: flex;
              align-items: center;
              gap: 6px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .notification-action-btn:hover {
              transform: translateY(-2px) scale(1.05);
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .btn-view {
              background: linear-gradient(135deg, #4caf50, #2e7d32);
              color: white;
            }

            .btn-mark-read {
              background: linear-gradient(135deg, #66bb6a, #4caf50);
              color: white;
            }

            .btn-delete {
              background: linear-gradient(135deg, #ef5350, #e53935);
              color: white;
            }

            /* Empty State */
            .empty-notifications-state {
              text-align: center;
              padding: 80px 20px;
              background: linear-gradient(135deg, #f1f8e9, #ffffff);
              border-radius: 20px;
              border: 2px dashed #c8e6c9;
            }

            .empty-icon {
              font-size: 64px;
              margin-bottom: 20px;
              opacity: 0.6;
            }

            .empty-title {
              font-family: "Poppins", sans-serif;
              font-size: 24px;
              font-weight: 700;
              color: #2e7d32;
              margin: 0 0 10px 0;
            }

            .empty-message {
              font-family: "Poppins", sans-serif;
              font-size: 16px;
              color: #81c784;
              margin: 0;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
              .notifications-header {
                padding: 25px 20px;
                position: relative;
                top: 0;
              }

              .notifications-title {
                font-size: 26px;
              }

              .stat-value {
                font-size: 24px;
              }

              .notification-filter-tabs {
                gap: 8px;
              }

              .filter-tab {
                padding: 12px 18px;
                font-size: 13px;
              }

              .tab-icon {
                font-size: 16px;
              }

              .notification-card {
                flex-direction: column;
              }

              .notification-icon-wrapper {
                width: 100%;
                min-height: 60px;
              }

              .notification-content {
                padding: 18px 20px;
              }

              .notification-title {
                font-size: 16px;
              }

              .notification-message {
                font-size: 14px;
              }

              .notification-actions {
                width: 100%;
              }

              .notification-action-btn {
                flex: 1;
                justify-content: center;
                padding: 10px 16px;
              }
            }

            @media (max-width: 480px) {
              .notifications-header {
                padding: 20px 15px;
              }

              .notifications-title {
                font-size: 22px;
              }

              .notifications-stats {
                gap: 15px;
              }

              .stat-value {
                font-size: 20px;
              }

              .mark-all-read-btn {
                width: 100%;
                justify-content: center;
                padding: 12px 24px;
              }

              .filter-tab {
                padding: 10px 16px;
                font-size: 12px;
              }

              .tab-text {
                font-size: 12px;
              }
            }
          </style>

          <script>
            // --- Modern Notification System ---
            let notifications =
              JSON.parse(localStorage.getItem("notifications")) || [];
            let notificationFilter = "all";

            // Get notification category based on type and other properties
            function getNotificationCategory(notification) {
              // Check if notification has explicit category
              if (notification.category) {
                return notification.category;
              }

              // Map based on type
              if (notification.type === "product") {
                return "product_posted";
              } else if (
                notification.type === "rental" ||
                notification.type === "rental-posted"
              ) {
                return "rental_posted";
              } else if (
                notification.type === "rental-requirement" ||
                notification.type === "rental_requirement"
              ) {
                return "rental_requirement_posted";
              } else if (
                notification.type === "requirement" ||
                notification.type === "product-requirement"
              ) {
                // Check if it's a rental requirement or product requirement
                if (
                  notification.rentalRequirementId ||
                  notification.message?.toLowerCase().includes("rental") ||
                  notification.title?.toLowerCase().includes("rental")
                ) {
                  return "rental_requirement_posted";
                }
                return "product_requirement_posted";
              }

              // Default fallback
              return "product_posted";
            }

            // Get notification icon based on category
            function getNotificationIcon(category) {
              const icons = {
                product_posted: "ðŸŒ¾",
                rental_posted: "ðŸšœ",
                product_requirement_posted: "ðŸ“¦",
                rental_requirement_posted: "ðŸ”§",
              };
              return icons[category] || "ðŸ””";
            }

            // Get notification color based on category
            function getNotifColor(category) {
              const colors = {
                product_posted: "#4caf50",
                rental_posted: "#66bb6a",
                product_requirement_posted: "#ff9800",
                rental_requirement_posted: "#ff6f00",
              };
              return colors[category] || "#4caf50";
            }

            // Format elapsed time
            function formatElapsedTime(timestamp) {
              if (!timestamp) return "";
              const date = new Date(timestamp);
              const now = new Date();
              const diff = Math.floor((now - date) / 1000);
              if (diff < 60) return diff + "s ago";
              if (diff < 3600) return Math.floor(diff / 60) + "m ago";
              if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
              return date.toLocaleDateString("en-IN", {
                year: "numeric",
                month: "short",
                day: "numeric",
              });
            }

            // Update notification stats
            function updateNotificationStats() {
              const totalCount = notifications.length;
              const unreadCount = notifications.filter((n) => !n.read).length;

              const totalEl = document.getElementById("notificationTotalCount");
              const unreadEl = document.getElementById(
                "notificationUnreadCount",
              );

              if (totalEl) {
                totalEl.textContent = totalCount;
                // Animate counter
                totalEl.style.transform = "scale(1.1)";
                setTimeout(() => {
                  totalEl.style.transform = "scale(1)";
                }, 200);
              }

              if (unreadEl) {
                unreadEl.textContent = unreadCount;
                // Animate counter
                unreadEl.style.transform = "scale(1.1)";
                setTimeout(() => {
                  unreadEl.style.transform = "scale(1)";
                }, 200);
              }
            }

            // Render notifications
            function renderNotifications() {
              // Reload notifications from localStorage
              notifications =
                JSON.parse(localStorage.getItem("notifications")) || [];

              const container = document.getElementById(
                "notificationsContainer",
              );
              const emptyState = document.getElementById("noNotifications");

              if (!container || !emptyState) return;

              // Filter notifications based on selected category
              let filtered = [];
              if (notificationFilter === "all") {
                filtered = notifications;
              } else {
                filtered = notifications.filter(
                  (n) => getNotificationCategory(n) === notificationFilter,
                );
              }

              // Sort by timestamp (newest first)
              filtered.sort((a, b) => {
                const timeA = new Date(a.timestamp || 0).getTime();
                const timeB = new Date(b.timestamp || 0).getTime();
                return timeB - timeA;
              });

              // Update stats
              updateNotificationStats();

              // Render notifications or empty state
              if (filtered.length === 0) {
                container.style.display = "none";
                emptyState.style.display = "block";
              } else {
                container.style.display = "flex";
                emptyState.style.display = "none";

                container.innerHTML = filtered
                  .map((n) => {
                    const category = getNotificationCategory(n);
                    const icon = getNotificationIcon(category);
                    const color = getNotifColor(category);
                    const isUnread = !n.read;

                    // Determine view URL based on notification type
                    let viewUrl = "#";
                    if (n.productId) {
                      viewUrl = `javascript:switchDashSection('home')`;
                    } else if (n.requirementId) {
                      viewUrl = `javascript:switchDashSection('requirements')`;
                    } else if (n.rentalRequirementId) {
                      viewUrl = `javascript:switchDashSection('requirements')`;
                    }

                    return `
                                <div class="notification-card ${isUnread ? "unread" : "read"}" style="border-left-color: ${color};">
                                    <div class="notification-icon-wrapper" style="background: linear-gradient(135deg, ${color}15, ${color}25);">
                                        <span class="notification-icon">${icon}</span>
                                    </div>
                                    <div class="notification-content">
                                        <div class="notification-header-row">
                                            <div class="notification-title-section">
                                                <h3 class="notification-title">${n.title || "Notification"}</h3>
                                                ${isUnread ? '<span class="notification-badge-new">NEW</span>' : ""}
                                            </div>
                                        </div>
                                        <p class="notification-message">${n.message || ""}</p>
                                        ${n.details ? `<p class="notification-details">${n.details}</p>` : ""}
                                        <div class="notification-footer">
                                            <div class="notification-time">${formatElapsedTime(n.timestamp)}</div>
                                            <div class="notification-actions">
                                                ${
                                                  viewUrl !== "#"
                                                    ? `<button class="notification-action-btn btn-view" onclick="${viewUrl}; markNotificationAsRead(${n.id});" title="View">
                                                    <span>ðŸ‘ï¸</span>
                                                    <span>View</span>
                                                </button>`
                                                    : ""
                                                }
                                                ${
                                                  isUnread
                                                    ? `<button class="notification-action-btn btn-mark-read" onclick="markNotificationAsRead(${n.id})" title="Mark as Read">
                                                    <span>âœ“</span>
                                                    <span>Mark as Read</span>
                                                </button>`
                                                    : ""
                                                }
                                                <button class="notification-action-btn btn-delete" onclick="deleteNotification(${n.id})" title="Delete">
                                                    <span>ðŸ—‘ï¸</span>
                                                    <span>Delete</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                  })
                  .join("");
              }

              // Update notification badge in nav
              updateNotificationBadge();
            }

            // Filter notifications by category
            function filterNotifications(category) {
              notificationFilter = category;

              // Update active tab
              document.querySelectorAll(".filter-tab").forEach((btn) => {
                btn.classList.remove("active");
              });

              const tabMap = {
                all: "filterAll",
                product_posted: "filterProductPosted",
                rental_posted: "filterRentalPosted",
                product_requirement_posted: "filterProductRequirement",
                rental_requirement_posted: "filterRentalRequirement",
              };

              const activeTabId = tabMap[category];
              if (activeTabId) {
                const activeTab = document.getElementById(activeTabId);
                if (activeTab) {
                  activeTab.classList.add("active");
                }
              }

              renderNotifications();
            }

            // Mark notification as read
            function markNotificationAsRead(id) {
              notifications = notifications.map((n) =>
                n.id === id ? { ...n, read: true } : n,
              );
              localStorage.setItem(
                "notifications",
                JSON.stringify(notifications),
              );
              renderNotifications();
              updateNotificationBadge();
            }

            // Mark all notifications as read
            function markAllNotificationsAsRead() {
              notifications = notifications.map((n) => ({ ...n, read: true }));
              localStorage.setItem(
                "notifications",
                JSON.stringify(notifications),
              );
              renderNotifications();
              updateNotificationBadge();

              // Show success message
              if (typeof showPopup === "function") {
                showPopup("All notifications marked as read!");
              }
            }

            // Delete notification
            function deleteNotification(id) {
              if (
                confirm("Are you sure you want to delete this notification?")
              ) {
                notifications = notifications.filter((n) => n.id !== id);
                localStorage.setItem(
                  "notifications",
                  JSON.stringify(notifications),
                );
                renderNotifications();
                updateNotificationBadge();

                // Show success message
                if (typeof showPopup === "function") {
                  showPopup("Notification deleted!");
                }
              }
            }

            // Update notification badge in navigation
            function updateNotificationBadge() {
              const unreadCount = notifications.filter((n) => !n.read).length;
              const badge = document.querySelector(".notification-badge");
              if (badge) {
                if (unreadCount > 0) {
                  badge.textContent = unreadCount > 99 ? "99+" : unreadCount;
                  badge.style.display = "block";
                } else {
                  badge.style.display = "none";
                }
              }
            }

            // Initialize notifications on page load
            document.addEventListener("DOMContentLoaded", function () {
              if (document.getElementById("dashNotifications")) {
                renderNotifications();
              }
            });

            // Refresh notifications when switching to notifications section
            window.switchDashSection = (function (origFunc) {
              return function (section) {
                origFunc.apply(this, arguments);
                if (section === "notifications") {
                  renderNotifications();
                }
              };
            })(window.switchDashSection || function () {});
          </script>

          <!-- Live Prices Section -->
          <div id="dashPrices" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px">
              <button class="back-to-home-btn" onclick="switchDashSection('home')">
                <span>â†</span>
                <span>Back to Home</span>
              </button>
            </div>

            <div class="lp-container">
              <!-- Header -->
              <div class="lp-header">
                <div class="lp-header-left">
                  <div class="lp-header-icon">ðŸ’°</div>
                  <div>
                    <h2 class="lp-main-title">Live Market Prices</h2>
                    <p class="lp-subtitle">Real-time agricultural prices &bull; Posts expire in 24 hours</p>
                  </div>
                </div>
                <div class="lp-header-actions">
                  <button class="lp-post-btn" onclick="lpOpenPostForm()">
                    <span>ï¼‹</span> Post Live Price
                  </button>
                  <a href="https://play.google.com/store/apps/details?id=com.tranzmedia.commodityonline&pcampaignid=web_share" target="_blank" rel="noopener noreferrer" class="lp-app-btn" title="Download CommodityOnline Prices App">
                    <svg class="lp-app-btn-icon" viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M3.609 1.814L13.792 12 3.61 22.186a.996.996 0 0 1-.61-.92V2.734a1 1 0 0 1 .609-.92zm10.89 10.893l2.302 2.302-10.937 6.333 8.635-8.635zm3.199-1.4l2.384 1.378a1 1 0 0 1 0 1.73l-2.384 1.378-2.534-2.486 2.534-2zm-3.199-1.4L5.864 1.272l10.937 6.333-2.302 2.302z"/></svg>
                    <span class="lp-app-btn-text">
                      <small>GET IT ON</small>
                      CommodityOnline
                    </span>
                  </a>
                </div>
              </div>

              <!-- Filters & Search -->
              <div class="lp-filters">
                <div class="lp-search-wrap voice-search-wrap">
                  <span class="lp-search-icon">ðŸ”</span>
                  <input type="text" id="lpSearchInput" class="lp-search-input" placeholder="Search products, locations..." onkeyup="if(event.key==='Enter')lpFilterPosts()">
                  <button type="button" class="voice-search-btn" onclick="startVoiceSearch('lpSearchInput', function(){ if(typeof lpFilterPosts==='function') lpFilterPosts(); })" title="Voice Search" aria-label="Voice Search">
                    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                  </button>
                </div>
                <select id="lpCategoryFilter" class="lp-filter-select" onchange="lpFilterPosts()">
                  <option value="">All Categories</option>
                  <option value="Grains">ðŸŒ¾ Grains</option>
                  <option value="Vegetables">ðŸ¥¬ Vegetables</option>
                  <option value="Fruits">ðŸŽ Fruits</option>
                  <option value="Pulses">ðŸ«˜ Pulses</option>
                  <option value="Spices">ðŸŒ¶ï¸ Spices</option>
                  <option value="Others">ðŸ“¦ Others</option>
                </select>
                <select id="lpTrendFilter" class="lp-filter-select" onchange="lpFilterPosts()">
                  <option value="">All Trends</option>
                  <option value="increased">ðŸ“ˆ Increased</option>
                  <option value="decreased">ðŸ“‰ Decreased</option>
                  <option value="stable">âž– Stable</option>
                </select>
                <button class="lp-refresh-btn" onclick="lpLoadPosts()" title="Refresh">ðŸ”„</button>
              </div>

              <!-- Loading Indicator -->
              <div id="lpLoading" class="lp-loading" style="display:none;">
                <div class="lp-spinner"></div>
                <p>Loading live prices...</p>
              </div>

              <!-- Feed Grid -->
              <div class="lp-feed" id="lpFeed"></div>

              <!-- Empty State -->
              <div id="lpEmpty" class="lp-empty" style="display:none;">
                <div class="lp-empty-icon">ðŸ“Š</div>
                <h3>No Live Prices Yet</h3>
                <p>Be the first to post a live market price!</p>
                <button class="lp-post-btn" onclick="lpOpenPostForm()" style="margin-top:15px;">
                  <span>ï¼‹</span> Post Live Price
                </button>
              </div>
            </div>

            <!-- POST FORM MODAL -->
            <div id="lpPostModal" class="lp-modal" style="display:none;">
              <div class="lp-modal-overlay" onclick="lpClosePostForm()"></div>
              <div class="lp-modal-content lp-modal-large">
                <div class="lp-modal-header" style="background:linear-gradient(135deg,#4caf50,#2e7d32);">
                  <h3 style="color:#fff;margin:0;font-family:'Poppins',sans-serif;font-size:22px;display:flex;align-items:center;gap:10px;">
                    ðŸ“ Post Live Market Price
                  </h3>
                  <button class="lp-modal-close" onclick="lpClosePostForm()">&times;</button>
                </div>
                <form id="lpPostForm" class="lp-form" onsubmit="lpSubmitPost(event)">
                  <div class="lp-form-row">
                    <div class="lp-form-group">
                      <label class="lp-label">Product Name <span class="lp-required">*</span></label>
                      <input type="text" id="lpProductName" class="lp-input" placeholder="e.g., Maize, Rice, Tomato" required>
                    </div>
                    <div class="lp-form-group">
                      <label class="lp-label">Category <span class="lp-required">*</span></label>
                      <select id="lpCategory" class="lp-input" required>
                        <option value="">Select Category</option>
                        <option value="Grains">ðŸŒ¾ Grains</option>
                        <option value="Vegetables">ðŸ¥¬ Vegetables</option>
                        <option value="Fruits">ðŸŽ Fruits</option>
                        <option value="Pulses">ðŸ«˜ Pulses</option>
                        <option value="Spices">ðŸŒ¶ï¸ Spices</option>
                        <option value="Others">ðŸ“¦ Others</option>
                      </select>
                    </div>
                  </div>
                  <div class="lp-form-row">
                    <div class="lp-form-group">
                      <label class="lp-label">Minimum Price (â‚¹) <span class="lp-required">*</span></label>
                      <input type="number" id="lpMinPrice" class="lp-input" placeholder="e.g., 17" min="0" step="0.01" required>
                    </div>
                    <div class="lp-form-group">
                      <label class="lp-label">Maximum Price (â‚¹) <span class="lp-required">*</span></label>
                      <input type="number" id="lpMaxPrice" class="lp-input" placeholder="e.g., 25" min="0" step="0.01" required>
                    </div>
                    <div class="lp-form-group" style="max-width:160px;">
                      <label class="lp-label">Unit</label>
                      <select id="lpPriceUnit" class="lp-input">
                        <option value="Kg">Per Kg</option>
                        <option value="Quintal">Per Quintal</option>
                      </select>
                    </div>
                  </div>
                  <div class="lp-form-group">
                    <label class="lp-label">Price Trend <span class="lp-required">*</span></label>
                    <div class="lp-trend-options">
                      <label class="lp-trend-radio">
                        <input type="radio" name="lpTrend" value="increased">
                        <span class="lp-trend-badge increased">ðŸ“ˆ Increased</span>
                      </label>
                      <label class="lp-trend-radio">
                        <input type="radio" name="lpTrend" value="decreased">
                        <span class="lp-trend-badge decreased">ðŸ“‰ Decreased</span>
                      </label>
                      <label class="lp-trend-radio">
                        <input type="radio" name="lpTrend" value="stable" checked>
                        <span class="lp-trend-badge stable">âž– Stable</span>
                      </label>
                    </div>
                  </div>
                  <div class="lp-form-group">
                    <label class="lp-label">ðŸ“ Location <span class="lp-required">*</span></label>
                    <button type="button" class="lp-detect-btn" onclick="lpDetectLocation()">
                      ðŸ“ Auto-Detect My Location
                    </button>
                    <div class="lp-form-row" style="margin-top:10px;">
                      <input type="text" id="lpArea" class="lp-input" placeholder="Area / City">
                      <input type="text" id="lpDistrict" class="lp-input" placeholder="District">
                    </div>
                    <div class="lp-form-row" style="margin-top:10px;">
                      <input type="text" id="lpState" class="lp-input" placeholder="State">
                      <input type="text" id="lpPinCode" class="lp-input" placeholder="Pin Code" maxlength="6" pattern="[0-9]{6}">
                    </div>
                    <input type="hidden" id="lpLat">
                    <input type="hidden" id="lpLng">
                  </div>
                  <div class="lp-form-row">
                    <div class="lp-form-group">
                      <label class="lp-label">ðŸ“ž Phone Number <span class="lp-required">*</span></label>
                      <input type="tel" id="lpPhone" class="lp-input" placeholder="e.g., 9876543210" pattern="[0-9]{10}" maxlength="10" required>
                    </div>
                    <div class="lp-form-group">
                      <label class="lp-label">ðŸª Market Name (Optional)</label>
                      <input type="text" id="lpMarketName" class="lp-input" placeholder="e.g., Gaddi Annaram Market">
                    </div>
                  </div>
                  <div class="lp-form-row">
                    <div class="lp-form-group">
                      <label class="lp-label">ðŸ“· Product Photos (Optional)</label>
                      <input type="file" id="lpImages" class="lp-input" accept="image/*" multiple onchange="lpPreviewFiles(this,'lpImgPreview')">
                      <div id="lpImgPreview" class="lp-media-preview"></div>
                    </div>
                    <div class="lp-form-group">
                      <label class="lp-label">ðŸŽ¥ Product Videos (Optional)</label>
                      <input type="file" id="lpVideos" class="lp-input" accept="video/*" multiple onchange="lpPreviewFiles(this,'lpVidPreview')">
                      <div id="lpVidPreview" class="lp-media-preview"></div>
                    </div>
                  </div>
                  <div class="lp-form-actions">
                    <button type="button" class="lp-btn-cancel" onclick="lpClosePostForm()">Cancel</button>
                    <button type="submit" class="lp-btn-submit" id="lpSubmitBtn">ðŸš€ Post Live Price</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- FULL DETAILS MODAL -->
            <div id="lpDetailModal" class="lp-modal" style="display:none;">
              <div class="lp-modal-overlay" onclick="lpCloseDetail()"></div>
              <div class="lp-modal-content lp-modal-large">
                <div class="lp-modal-header" style="background:linear-gradient(135deg,#1565c0,#0d47a1);">
                  <h3 style="color:#fff;margin:0;font-family:'Poppins',sans-serif;font-size:22px;display:flex;align-items:center;gap:10px;">
                    ðŸ” Full Details
                  </h3>
                  <button class="lp-modal-close" onclick="lpCloseDetail()">&times;</button>
                </div>
                <div id="lpDetailBody" class="lp-detail-body"></div>
              </div>
            </div>

            <!-- FEEDBACK MODAL -->
            <div id="lpFeedbackModal" class="lp-modal" style="display:none;">
              <div class="lp-modal-overlay" onclick="lpCloseFeedback()"></div>
              <div class="lp-modal-content" style="max-width:500px;">
                <div class="lp-modal-header" style="background:linear-gradient(135deg,#ff9800,#f57c00);">
                  <h3 style="color:#fff;margin:0;font-family:'Poppins',sans-serif;font-size:22px;display:flex;align-items:center;gap:10px;">
                    â­ Rate & Feedback
                  </h3>
                  <button class="lp-modal-close" onclick="lpCloseFeedback()">&times;</button>
                </div>
                <div class="lp-feedback-body">
                  <input type="hidden" id="lpFeedbackPriceId">
                  <div class="lp-form-group">
                    <label class="lp-label">Your Rating <span class="lp-required">*</span></label>
                    <div class="lp-star-rating" id="lpStarRating">
                      <span class="lp-star" data-val="1">â˜…</span>
                      <span class="lp-star" data-val="2">â˜…</span>
                      <span class="lp-star" data-val="3">â˜…</span>
                      <span class="lp-star" data-val="4">â˜…</span>
                      <span class="lp-star" data-val="5">â˜…</span>
                    </div>
                    <input type="hidden" id="lpFeedbackRating" value="0">
                  </div>
                  <div class="lp-form-group">
                    <label class="lp-label">Your Name (Optional)</label>
                    <input type="text" id="lpFeedbackName" class="lp-input" placeholder="Enter your name">
                  </div>
                  <div class="lp-form-group">
                    <label class="lp-label">Comment (Optional)</label>
                    <textarea id="lpFeedbackComment" class="lp-input" rows="3" placeholder="Share your experience..."></textarea>
                  </div>
                  <button class="lp-btn-submit" onclick="lpSubmitFeedback()" style="width:100%;">Submit Feedback</button>
                  <div id="lpFeedbackList" style="margin-top:25px;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Live Prices Styles -->
          <style>
            /* ==========================================
               LIVE PRICES SECTION â€” COMPLETE STYLES
               ========================================== */
            .lp-container { max-width:1200px; margin:0 auto; padding:0 20px 30px; }
            .lp-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px; margin-bottom:25px; padding:20px 25px; background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-radius:18px; box-shadow:0 4px 20px rgba(46,125,50,0.12); }
            .lp-header-left { display:flex; align-items:center; gap:15px; }
            .lp-header-icon { width:55px; height:55px; background:linear-gradient(135deg,#4caf50,#2e7d32); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow:0 4px 15px rgba(76,175,80,0.3); }
            .lp-main-title { color:#1b5e20; font-family:'Poppins',sans-serif; font-weight:700; font-size:26px; margin:0; }
            .lp-subtitle { color:#2e7d32; font-size:14px; margin:3px 0 0; }
            .lp-header-actions { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
            .lp-post-btn { padding:12px 28px; background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; border:none; border-radius:30px; font-family:'Poppins',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; gap:8px; box-shadow:0 4px 15px rgba(76,175,80,0.3); }
            .lp-post-btn:hover { transform:translateY(-2px); box-shadow:0 6px 25px rgba(76,175,80,0.4); }

            /* CommodityOnline App Button */
            .lp-app-btn { display:inline-flex; align-items:center; gap:10px; padding:10px 22px; background:linear-gradient(135deg,#414141,#000000); color:#fff; border-radius:30px; text-decoration:none; font-family:'Poppins',sans-serif; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(0,0,0,0.25); position:relative; overflow:hidden; }
            .lp-app-btn::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent); transition:left 0.5s ease; }
            .lp-app-btn:hover::before { left:100%; }
            .lp-app-btn:hover { transform:translateY(-2px); box-shadow:0 6px 25px rgba(0,0,0,0.35); background:linear-gradient(135deg,#555,#1a1a1a); }
            .lp-app-btn:active { transform:translateY(0); box-shadow:0 2px 10px rgba(0,0,0,0.3); }
            .lp-app-btn-icon { flex-shrink:0; filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
            .lp-app-btn-text { display:flex; flex-direction:column; line-height:1.2; text-align:left; }
            .lp-app-btn-text small { font-size:9px; font-weight:500; letter-spacing:1.2px; text-transform:uppercase; opacity:0.85; }
            .lp-app-btn-text { font-size:14px; font-weight:700; letter-spacing:0.3px; }

            /* Filters */
            .lp-filters { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:25px; padding:18px 22px; background:#fff; border-radius:16px; box-shadow:0 2px 15px rgba(0,0,0,0.06); }
            .lp-search-wrap { flex:1; min-width:220px; position:relative; }
            .lp-search-icon { position:absolute; left:15px; top:50%; transform:translateY(-50%); font-size:18px; }
            .lp-search-input { width:100%; padding:13px 55px 13px 45px; border:2px solid #e0e0e0; border-radius:30px; font-size:15px; font-family:'Poppins',sans-serif; outline:none; transition:border 0.3s; }
            .lp-search-input:focus { border-color:#4caf50; box-shadow:0 0 0 3px rgba(76,175,80,0.1); }
            .lp-filter-select { padding:13px 18px; border:2px solid #e0e0e0; border-radius:30px; font-size:14px; font-family:'Poppins',sans-serif; background:#fff; cursor:pointer; outline:none; min-width:140px; transition:border 0.3s; }
            .lp-filter-select:focus { border-color:#4caf50; }
            .lp-refresh-btn { width:46px; height:46px; border:2px solid #e0e0e0; background:#fff; border-radius:50%; font-size:20px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; }
            .lp-refresh-btn:hover { border-color:#4caf50; background:#e8f5e9; transform:rotate(180deg); }

            /* Loading */
            .lp-loading { text-align:center; padding:60px 20px; }
            .lp-spinner { width:50px; height:50px; border:4px solid #e0e0e0; border-top-color:#4caf50; border-radius:50%; animation:lpSpin 0.8s linear infinite; margin:0 auto 15px; }
            @keyframes lpSpin { to { transform:rotate(360deg); } }
            .lp-loading p { color:#666; font-family:'Poppins',sans-serif; font-size:15px; }

            /* Empty state */
            .lp-empty { text-align:center; padding:60px 20px; background:#fff; border-radius:20px; box-shadow:0 2px 15px rgba(0,0,0,0.06); }
            .lp-empty-icon { font-size:70px; margin-bottom:15px; }
            .lp-empty h3 { font-family:'Poppins',sans-serif; color:#333; font-size:22px; margin:0 0 8px; }
            .lp-empty p { color:#666; font-size:15px; }

            /* Feed Grid */
            .lp-feed { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:22px; }

            /* Post Card */
            .lp-card { background:#fff; border-radius:18px; overflow:hidden; box-shadow:0 4px 18px rgba(0,0,0,0.07); border:1px solid rgba(0,0,0,0.05); transition:all 0.3s; position:relative; display:flex; flex-direction:column; }
            .lp-card:hover { transform:translateY(-5px); box-shadow:0 10px 35px rgba(0,0,0,0.12); }

            /* Card Timer Badge */
            .lp-timer { position:absolute; top:12px; right:12px; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:700; font-family:'Poppins',sans-serif; z-index:2; display:flex; align-items:center; gap:5px; backdrop-filter:blur(8px); }
            .lp-timer.green { background:rgba(76,175,80,0.15); color:#2e7d32; border:1px solid rgba(76,175,80,0.3); }
            .lp-timer.orange { background:rgba(255,152,0,0.15); color:#e65100; border:1px solid rgba(255,152,0,0.3); }
            .lp-timer.red { background:rgba(244,67,54,0.15); color:#c62828; border:1px solid rgba(244,67,54,0.3); animation:lpPulse 1s ease-in-out infinite; }
            @keyframes lpPulse { 0%,100%{opacity:1;} 50%{opacity:0.6;} }

            /* Card Image */
            .lp-card-img { width:100%; height:200px; object-fit:cover; background:#f5f5f5; position:relative; }
            .lp-card-img-placeholder { width:100%; height:200px; display:flex; align-items:center; justify-content:center; font-size:80px; background:linear-gradient(135deg,#f0fdf4,#e8f5e9); }

            /* Featured badge */
            .lp-featured-badge { position:absolute; bottom:12px; left:12px; background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; padding:5px 14px; border-radius:20px; font-size:12px; font-weight:600; font-family:'Poppins',sans-serif; z-index:2; }

            /* Card Body */
            .lp-card-body { padding:18px 20px; flex:1; display:flex; flex-direction:column; }
            .lp-card-date { font-size:12px; color:#999; margin-bottom:6px; display:flex; align-items:center; gap:5px; }
            .lp-card-product { display:flex; align-items:flex-start; gap:10px; margin-bottom:10px; }
            .lp-card-icon { font-size:32px; flex-shrink:0; }
            .lp-card-name { font-family:'Poppins',sans-serif; font-weight:600; font-size:18px; color:#333; margin:0; }
            .lp-card-category { font-size:12px; color:#666; background:#f5f5f5; padding:2px 10px; border-radius:10px; display:inline-block; margin-top:3px; }
            .lp-card-price { font-family:'Poppins',sans-serif; font-size:24px; font-weight:700; color:#d32f2f; margin:8px 0; display:flex; align-items:baseline; gap:6px; }
            .lp-card-price small { font-size:14px; color:#888; font-weight:400; }
            .lp-card-trend { display:inline-flex; align-items:center; gap:5px; padding:5px 14px; border-radius:20px; font-size:13px; font-weight:600; margin-bottom:10px; }
            .lp-card-trend.increased { background:#e8f5e9; color:#2e7d32; }
            .lp-card-trend.decreased { background:#ffebee; color:#c62828; }
            .lp-card-trend.stable { background:#fff3e0; color:#e65100; }
            .lp-card-location { font-size:13px; color:#666; display:flex; align-items:center; gap:5px; margin-top:auto; padding-top:10px; border-top:1px solid #f0f0f0; }
            .lp-card-poster { font-size:12px; color:#888; margin-top:6px; display:flex; align-items:center; gap:5px; }
            .lp-card-rating { font-size:12px; color:#ff9800; display:flex; align-items:center; gap:4px; margin-top:6px; }

            /* Card Action Buttons */
            .lp-card-actions { display:flex; border-top:1px solid #f0f0f0; }
            .lp-card-actions button { flex:1; padding:13px 8px; border:none; background:transparent; font-family:'Poppins',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:6px; }
            .lp-card-actions button:not(:last-child) { border-right:1px solid #f0f0f0; }
            .lp-card-actions .lp-btn-details { color:#1565c0; }
            .lp-card-actions .lp-btn-details:hover { background:#e3f2fd; }
            .lp-card-actions .lp-btn-contact { color:#2e7d32; }
            .lp-card-actions .lp-btn-contact:hover { background:#e8f5e9; }
            .lp-card-actions .lp-btn-feedback { color:#f57c00; }
            .lp-card-actions .lp-btn-feedback:hover { background:#fff3e0; }

            /* Modal Base */
            .lp-modal { position:fixed; top:0; left:0; width:100%; height:100%; z-index:10000; display:flex; align-items:center; justify-content:center; animation:lpFadeIn 0.25s; }
            .lp-modal-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.55); backdrop-filter:blur(4px); }
            .lp-modal-content { position:relative; background:#fff; border-radius:20px; width:92%; max-width:700px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:lpSlideUp 0.3s; z-index:10001; }
            .lp-modal-large { max-width:780px; }
            .lp-modal-header { display:flex; justify-content:space-between; align-items:center; padding:22px 28px; border-radius:20px 20px 0 0; }
            .lp-modal-close { background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s; line-height:1; }
            .lp-modal-close:hover { background:rgba(255,255,255,0.35); transform:rotate(90deg); }
            @keyframes lpFadeIn { from{opacity:0} to{opacity:1} }
            @keyframes lpSlideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }

            /* Form styles */
            .lp-form { padding:28px; }
            .lp-form-row { display:flex; gap:15px; flex-wrap:wrap; }
            .lp-form-row > .lp-form-group { flex:1; min-width:180px; }
            .lp-form-group { margin-bottom:18px; }
            .lp-label { display:block; font-family:'Poppins',sans-serif; font-size:14px; font-weight:600; color:#2e7d32; margin-bottom:7px; }
            .lp-required { color:#d32f2f; }
            .lp-input { width:100%; padding:12px 16px; border:2px solid #e0e0e0; border-radius:12px; font-size:15px; font-family:'Poppins',sans-serif; outline:none; transition:border 0.3s,box-shadow 0.3s; box-sizing:border-box; }
            .lp-input:focus { border-color:#4caf50; box-shadow:0 0 0 3px rgba(76,175,80,0.1); }
            .lp-trend-options { display:flex; gap:12px; flex-wrap:wrap; }
            .lp-trend-radio { cursor:pointer; }
            .lp-trend-radio input { display:none; }
            .lp-trend-badge { display:inline-block; padding:10px 22px; border:2px solid #e0e0e0; border-radius:25px; font-size:14px; font-weight:600; transition:all 0.3s; font-family:'Poppins',sans-serif; }
            .lp-trend-radio input:checked + .lp-trend-badge.increased { background:#e8f5e9; border-color:#4caf50; color:#2e7d32; }
            .lp-trend-radio input:checked + .lp-trend-badge.decreased { background:#ffebee; border-color:#f44336; color:#c62828; }
            .lp-trend-radio input:checked + .lp-trend-badge.stable { background:#fff3e0; border-color:#ff9800; color:#e65100; }
            .lp-detect-btn { padding:10px 22px; background:#e3f2fd; color:#1565c0; border:2px solid #90caf9; border-radius:25px; font-size:14px; font-weight:600; cursor:pointer; font-family:'Poppins',sans-serif; transition:all 0.3s; }
            .lp-detect-btn:hover { background:#bbdefb; }
            .lp-media-preview { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
            .lp-media-preview img, .lp-media-preview video { width:70px; height:70px; object-fit:cover; border-radius:10px; border:2px solid #e0e0e0; }
            .lp-form-actions { display:flex; justify-content:flex-end; gap:12px; padding-top:15px; border-top:1px solid #eee; }
            .lp-btn-cancel { padding:12px 28px; border:2px solid #e0e0e0; background:#fff; color:#666; border-radius:25px; font-size:15px; font-weight:600; cursor:pointer; font-family:'Poppins',sans-serif; transition:all 0.3s; }
            .lp-btn-cancel:hover { background:#f5f5f5; }
            .lp-btn-submit { padding:12px 32px; background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; border:none; border-radius:25px; font-size:15px; font-weight:600; cursor:pointer; font-family:'Poppins',sans-serif; transition:all 0.3s; box-shadow:0 4px 15px rgba(76,175,80,0.3); }
            .lp-btn-submit:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(76,175,80,0.4); }
            .lp-btn-submit:disabled { opacity:0.6; cursor:not-allowed; transform:none; }

            /* Detail body */
            .lp-detail-body { padding:28px; }
            .lp-detail-section { margin-bottom:22px; }
            .lp-detail-section h4 { font-family:'Poppins',sans-serif; color:#2e7d32; font-size:16px; margin:0 0 10px; padding-bottom:8px; border-bottom:2px solid #e8f5e9; display:flex; align-items:center; gap:8px; }
            .lp-detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
            .lp-detail-item { padding:10px 14px; background:#f9f9f9; border-radius:10px; }
            .lp-detail-item label { display:block; font-size:12px; color:#999; font-family:'Poppins',sans-serif; text-transform:uppercase; letter-spacing:0.5px; }
            .lp-detail-item span { font-size:16px; color:#333; font-weight:600; font-family:'Poppins',sans-serif; }
            .lp-detail-gallery { display:flex; flex-wrap:wrap; gap:10px; }
            .lp-detail-gallery img { width:120px; height:120px; object-fit:cover; border-radius:12px; cursor:pointer; transition:transform 0.3s; border:2px solid #e8f5e9; }
            .lp-detail-gallery img:hover { transform:scale(1.05); }
            .lp-detail-gallery video { width:200px; border-radius:12px; border:2px solid #e8f5e9; }
            .lp-detail-map { width:100%; height:250px; border-radius:12px; border:2px solid #e8f5e9; margin-top:10px; }

            /* Feedback body */
            .lp-feedback-body { padding:28px; }
            .lp-star-rating { display:flex; gap:8px; margin:8px 0; }
            .lp-star { font-size:36px; color:#ddd; cursor:pointer; transition:color 0.2s, transform 0.2s; }
            .lp-star:hover, .lp-star.active { color:#ff9800; transform:scale(1.15); }
            .lp-fb-entry { padding:14px; background:#f9f9f9; border-radius:12px; margin-bottom:10px; border-left:3px solid #ff9800; }
            .lp-fb-entry .lp-fb-stars { color:#ff9800; font-size:14px; }
            .lp-fb-entry .lp-fb-name { font-weight:600; color:#333; font-size:14px; }
            .lp-fb-entry .lp-fb-comment { color:#555; font-size:14px; margin-top:4px; }
            .lp-fb-entry .lp-fb-date { color:#999; font-size:12px; margin-top:4px; }

            /* Responsive */
            @media(max-width:768px){
              .lp-feed { grid-template-columns:1fr; }
              .lp-header { flex-direction:column; align-items:flex-start; }
              .lp-header-actions { width:100%; justify-content:flex-start; }
              .lp-form-row { flex-direction:column; }
              .lp-detail-grid { grid-template-columns:1fr; }
              .lp-modal-content { width:96%; }
              .lp-main-title { font-size:22px; }
              .lp-filters { flex-direction:column; }
              .lp-search-wrap { min-width:100%; }
              .lp-filter-select { width:100%; }
            }
            @media(max-width:480px){
              .lp-container { padding:0 10px 20px; }
              .lp-card-price { font-size:20px; }
              .lp-form { padding:18px; }
              .lp-card-body { padding:14px 16px; }
            }
          </style>

          <!-- Live Prices JavaScript -->
          <script>
          (function(){
            'use strict';

            // ========== PRODUCT ICON MAP ==========
            const LP_ICONS = {
              maize:'ðŸŒ½', corn:'ðŸŒ½', paddy:'ðŸŒ¾', rice:'ðŸŒ¾', wheat:'ðŸŒ¿', bajra:'ðŸŒ¾',
              jowar:'ðŸŒ¾', ragi:'ðŸŒ¾', barley:'ðŸŒ¾', millet:'ðŸŒ¾', sorghum:'ðŸŒ¾', oats:'ðŸŒ¾',
              tomato:'ðŸ…', potato:'ðŸ¥”', onion:'ðŸ§…', carrot:'ðŸ¥•', spinach:'ðŸ¥¬', cabbage:'ðŸ¥¬',
              cauliflower:'ðŸ¥¦', brinjal:'ðŸ†', capsicum:'ðŸ«‘', 'bell pepper':'ðŸ«‘', peas:'ðŸ«›',
              'ladies finger':'ðŸŸ¢', okra:'ðŸŸ¢', cucumber:'ðŸ¥’', radish:'ðŸŸ¢', beetroot:'ðŸŸ¢',
              beans:'ðŸ«›', ginger:'ðŸ«š', garlic:'ðŸ§„', pumpkin:'ðŸŽƒ', 'bitter gourd':'ðŸŸ¢',
              mango:'ðŸ¥­', apple:'ðŸŽ', banana:'ðŸŒ', grapes:'ðŸ‡', orange:'ðŸŠ', lemon:'ðŸ‹',
              papaya:'ðŸŸ ', guava:'ðŸŸ¢', watermelon:'ðŸ‰', pomegranate:'ðŸ”´', coconut:'ðŸ¥¥',
              pineapple:'ðŸ', strawberry:'ðŸ“', cherry:'ðŸ’',
              'chana dal':'ðŸ«˜', 'toor dal':'ðŸ«˜', 'moong dal':'ðŸ«˜', 'urad dal':'ðŸ«˜',
              lentil:'ðŸ«˜', chickpea:'ðŸ«˜', rajma:'ðŸ«˜', soybean:'ðŸ«˜',
              chili:'ðŸŒ¶ï¸', turmeric:'ðŸŸ¡', coriander:'ðŸŒ¿', cumin:'ðŸŸ¤', pepper:'ðŸŸ¤',
              cardamom:'ðŸŸ¢', clove:'ðŸŸ¤', cinnamon:'ðŸŸ¤', mustard:'ðŸŸ¡',
              cotton:'ðŸ¤', sugarcane:'ðŸŸ¢', jute:'ðŸŸ¢', tobacco:'ðŸŸ¤', groundnut:'ðŸ¥œ', cashew:'ðŸ¥œ'
            };
            const LP_CAT_ICONS = {
              Grains:'ðŸŒ¾', Vegetables:'ðŸ¥¬', Fruits:'ðŸŽ', Pulses:'ðŸ«˜', Spices:'ðŸŒ¶ï¸', Others:'ðŸ“¦'
            };

            function lpGetIcon(name, category) {
              const key = (name||'').trim().toLowerCase();
              if(LP_ICONS[key]) return LP_ICONS[key];
              for(const k in LP_ICONS) { if(key.includes(k)) return LP_ICONS[k]; }
              return LP_CAT_ICONS[category] || 'ðŸŒ¾';
            }

            // ========== GLOBAL STATE ==========
            let lpAllPosts = [];
            let lpTimers = {};

            // ========== LOAD POSTS ==========
            window.lpLoadPosts = function() {
              const feed = document.getElementById('lpFeed');
              const empty = document.getElementById('lpEmpty');
              const loading = document.getElementById('lpLoading');
              if(!feed) return;
              feed.innerHTML = '';
              if(empty) empty.style.display = 'none';
              if(loading) loading.style.display = 'block';

              fetch('/api/live-prices')
                .then(r => r.json())
                .then(data => {
                  if(loading) loading.style.display = 'none';
                  if(!data.success || !data.prices || data.prices.length === 0) {
                    if(empty) empty.style.display = 'block';
                    return;
                  }
                  lpAllPosts = data.prices;
                  lpRenderPosts(lpAllPosts);
                })
                .catch(() => {
                  if(loading) loading.style.display = 'none';
                  feed.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#d32f2f;font-family:Poppins,sans-serif;">Could not load live prices. Please try again.</div>';
                });
            };

            // ========== FILTER ==========
            window.lpFilterPosts = function() {
              const search = (document.getElementById('lpSearchInput')?.value || '').trim().toLowerCase();
              const cat = document.getElementById('lpCategoryFilter')?.value || '';
              const trend = document.getElementById('lpTrendFilter')?.value || '';

              let filtered = lpAllPosts.filter(p => {
                if(search && !(p.product_name||'').toLowerCase().includes(search) && !(p.area||'').toLowerCase().includes(search) && !(p.city||'').toLowerCase().includes(search) && !(p.district||'').toLowerCase().includes(search) && !(p.state||'').toLowerCase().includes(search)) return false;
                if(cat && p.category !== cat) return false;
                if(trend && p.price_trend !== trend) return false;
                return true;
              });
              lpRenderPosts(filtered);
            };

            // ========== RENDER POSTS ==========
            function lpRenderPosts(posts) {
              const feed = document.getElementById('lpFeed');
              const empty = document.getElementById('lpEmpty');
              // Clear old timers
              Object.values(lpTimers).forEach(t => clearInterval(t));
              lpTimers = {};

              if(!posts || posts.length === 0) {
                feed.innerHTML = '';
                if(empty) empty.style.display = 'block';
                return;
              }
              if(empty) empty.style.display = 'none';

              feed.innerHTML = posts.map(p => {
                const icon = lpGetIcon(p.product_name, p.category);
                const trend = p.price_trend || 'stable';
                const trendLabel = trend === 'increased' ? 'ðŸ“ˆ Increased' : trend === 'decreased' ? 'ðŸ“‰ Decreased' : 'âž– Stable';
                const images = p.images || [];
                const dateStr = lpFormatDate(p.created_at);
                const loc = [p.area, p.district, p.state].filter(Boolean).join(', ');
                const unit = p.price_unit || 'Kg';
                const avgRating = p.avg_rating || 0;
                const fbCount = p.feedback_count || 0;
                const ratingStars = avgRating > 0 ? 'â˜…'.repeat(Math.round(avgRating)) + 'â˜†'.repeat(5 - Math.round(avgRating)) : 'No ratings';

                return `<div class="lp-card" id="lp-card-${p.id}">
                  <div class="lp-timer green" id="lp-timer-${p.id}">â± --:--:--</div>
                  ${images.length > 0
                    ? `<div style="position:relative;"><img class="lp-card-img" src="/${images[0]}" alt="${p.product_name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="lp-card-img-placeholder" style="display:none">${icon}</div><span class="lp-featured-badge">Featured</span></div>`
                    : `<div style="position:relative;"><div class="lp-card-img-placeholder">${icon}</div></div>`
                  }
                  <div class="lp-card-body">
                    <div class="lp-card-date">ðŸ“… ${dateStr}</div>
                    <div class="lp-card-product">
                      <span class="lp-card-icon">${icon}</span>
                      <div>
                        <p class="lp-card-name">${lpEsc(p.product_name)}</p>
                        <span class="lp-card-category">${lpEsc(p.category)}</span>
                      </div>
                    </div>
                    <div class="lp-card-price">â‚¹${p.min_price} â€“ â‚¹${p.max_price} <small>/ ${unit}</small></div>
                    <span class="lp-card-trend ${trend}">${trendLabel}</span>
                    ${loc ? `<div class="lp-card-location">ðŸ“ ${lpEsc(loc)}</div>` : ''}
                    ${p.poster_name ? `<div class="lp-card-poster">ðŸ‘¤ ${lpEsc(p.poster_name)}</div>` : ''}
                    <div class="lp-card-rating">${ratingStars} (${avgRating}/5 Â· ${fbCount} reviews)</div>
                  </div>
                  <div class="lp-card-actions">
                    <button class="lp-btn-details" onclick="lpShowDetail(${p.id})">ðŸ” Full Details</button>
                    <button class="lp-btn-contact" onclick="lpContact('${lpEsc(p.phone)}')">ðŸ“ž Contact</button>
                    <button class="lp-btn-feedback" onclick="lpOpenFeedback(${p.id})">â­ Feedback</button>
                  </div>
                </div>`;
              }).join('');

              // Start timers
              posts.forEach(p => lpStartTimer(p.id, p.created_at));
            }

            // ========== COUNTDOWN TIMER ==========
            function lpStartTimer(id, createdAt) {
              const timerEl = document.getElementById('lp-timer-' + id);
              if(!timerEl) return;
              const created = new Date(createdAt + (createdAt.includes('Z') || createdAt.includes('+') ? '' : 'Z'));
              const expiry = new Date(created.getTime() + 24*60*60*1000);

              function update() {
                const now = new Date();
                const diff = expiry - now;
                if(diff <= 0) {
                  // Expired â€” remove card
                  const card = document.getElementById('lp-card-' + id);
                  if(card) card.style.display = 'none';
                  clearInterval(lpTimers[id]);
                  return;
                }
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                timerEl.textContent = `â± ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                // Color
                timerEl.className = 'lp-timer ' + (h >= 12 ? 'green' : h >= 1 ? 'orange' : 'red');
              }
              update();
              lpTimers[id] = setInterval(update, 1000);
            }

            // ========== POST FORM ==========
            window.lpOpenPostForm = function() {
              document.getElementById('lpPostModal').style.display = 'flex';
              document.body.style.overflow = 'hidden';
            };
            window.lpClosePostForm = function() {
              document.getElementById('lpPostModal').style.display = 'none';
              document.body.style.overflow = '';
            };

            // ========== LOCATION DETECTION ==========
            window.lpDetectLocation = function() {
              if(!navigator.geolocation) { alert('Geolocation is not supported by your browser.'); return; }
              navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                document.getElementById('lpLat').value = lat;
                document.getElementById('lpLng').value = lng;
                // Reverse geocode
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
                  .then(r => r.json())
                  .then(data => {
                    const addr = data.address || {};
                    document.getElementById('lpArea').value = addr.suburb || addr.village || addr.town || addr.city || '';
                    document.getElementById('lpDistrict').value = addr.county || addr.state_district || '';
                    document.getElementById('lpState').value = addr.state || '';
                    document.getElementById('lpPinCode').value = addr.postcode || '';
                  })
                  .catch(() => { alert('Could not fetch address. Please enter manually.'); });
              }, () => { alert('Location access denied. Please enter location manually.'); });
            };

            // ========== FILE PREVIEW ==========
            window.lpPreviewFiles = function(input, previewId) {
              const preview = document.getElementById(previewId);
              if(!preview) return;
              preview.innerHTML = '';
              Array.from(input.files).forEach(file => {
                if(file.type.startsWith('image/')) {
                  const img = document.createElement('img');
                  img.src = URL.createObjectURL(file);
                  preview.appendChild(img);
                } else if(file.type.startsWith('video/')) {
                  const vid = document.createElement('video');
                  vid.src = URL.createObjectURL(file);
                  vid.controls = true;
                  vid.muted = true;
                  preview.appendChild(vid);
                }
              });
            };

            // ========== SUBMIT POST ==========
            window.lpSubmitPost = function(e) {
              e.preventDefault();
              const btn = document.getElementById('lpSubmitBtn');
              btn.disabled = true;
              btn.textContent = 'Posting...';

              const form = new FormData();
              form.append('product_name', document.getElementById('lpProductName').value.trim());
              form.append('category', document.getElementById('lpCategory').value);
              form.append('min_price', document.getElementById('lpMinPrice').value);
              form.append('max_price', document.getElementById('lpMaxPrice').value);
              form.append('price_unit', document.getElementById('lpPriceUnit').value);
              const trend = document.querySelector('input[name="lpTrend"]:checked');
              form.append('price_trend', trend ? trend.value : 'stable');
              form.append('phone', document.getElementById('lpPhone').value.trim());
              form.append('market_name', document.getElementById('lpMarketName').value.trim());
              form.append('area', document.getElementById('lpArea').value.trim());
              form.append('city', document.getElementById('lpArea').value.trim());
              form.append('district', document.getElementById('lpDistrict').value.trim());
              form.append('state', document.getElementById('lpState').value.trim());
              form.append('pin_code', document.getElementById('lpPinCode').value.trim());
              form.append('latitude', document.getElementById('lpLat').value);
              form.append('longitude', document.getElementById('lpLng').value);

              const images = document.getElementById('lpImages').files;
              for(let i=0; i<images.length; i++) form.append('images', images[i]);
              const videos = document.getElementById('lpVideos').files;
              for(let i=0; i<videos.length; i++) form.append('videos', videos[i]);

              // Validate
              const minP = parseFloat(document.getElementById('lpMinPrice').value);
              const maxP = parseFloat(document.getElementById('lpMaxPrice').value);
              if(minP > maxP) { alert('Minimum price cannot exceed maximum price.'); btn.disabled = false; btn.textContent = 'ðŸš€ Post Live Price'; return; }
              if(!/^[0-9]{10}$/.test(document.getElementById('lpPhone').value.trim())) { alert('Please enter a valid 10-digit phone number.'); btn.disabled = false; btn.textContent = 'ðŸš€ Post Live Price'; return; }

              fetch('/api/live-prices', { method:'POST', body:form })
                .then(r => r.json())
                .then(data => {
                  btn.disabled = false;
                  btn.textContent = 'ðŸš€ Post Live Price';
                  if(data.success) {
                    lpClosePostForm();
                    document.getElementById('lpPostForm').reset();
                    document.getElementById('lpImgPreview').innerHTML = '';
                    document.getElementById('lpVidPreview').innerHTML = '';
                    lpLoadPosts();
                  } else {
                    alert(data.message || 'Failed to post. Please try again.');
                  }
                })
                .catch(() => {
                  btn.disabled = false;
                  btn.textContent = 'ðŸš€ Post Live Price';
                  alert('Network error. Please try again.');
                });
            };

            // ========== FULL DETAILS ==========
            window.lpShowDetail = function(id) {
              const body = document.getElementById('lpDetailBody');
              body.innerHTML = '<div style="text-align:center;padding:40px;"><div class="lp-spinner"></div></div>';
              document.getElementById('lpDetailModal').style.display = 'flex';
              document.body.style.overflow = 'hidden';

              fetch('/api/live-prices/' + id)
                .then(r => r.json())
                .then(data => {
                  if(!data.success) { body.innerHTML = '<p style="padding:30px;color:#d32f2f;">Post not found or expired.</p>'; return; }
                  const p = data.price;
                  const icon = lpGetIcon(p.product_name, p.category);
                  const trend = p.price_trend || 'stable';
                  const trendLabel = trend === 'increased' ? 'ðŸ“ˆ Increased' : trend === 'decreased' ? 'ðŸ“‰ Decreased' : 'âž– Stable';
                  const images = p.images || [];
                  const videos = p.videos || [];
                  const loc = [p.area, p.district, p.state].filter(Boolean).join(', ');
                  const unit = p.price_unit || 'Kg';
                  const avgRating = p.avg_rating || 0;
                  const fbCount = p.feedback_count || 0;
                  const feedbacks = p.feedbacks || [];
                  const ratingStars = avgRating > 0 ? 'â˜…'.repeat(Math.round(avgRating)) + 'â˜†'.repeat(5 - Math.round(avgRating)) : 'â˜†â˜†â˜†â˜†â˜†';

                  let html = `
                    <div class="lp-detail-section">
                      <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                        <span style="font-size:50px;">${icon}</span>
                        <div>
                          <h3 style="margin:0;font-family:'Poppins',sans-serif;font-size:24px;color:#333;">${lpEsc(p.product_name)}</h3>
                          <span class="lp-card-category" style="font-size:13px;">${lpEsc(p.category)}</span>
                        </div>
                      </div>
                      <div class="lp-timer green" id="lp-detail-timer" style="position:static;display:inline-flex;margin-bottom:15px;">â± Calculating...</div>
                    </div>

                    <div class="lp-detail-section">
                      <h4>ðŸ’° Price Information</h4>
                      <div class="lp-detail-grid">
                        <div class="lp-detail-item"><label>Min Price</label><span style="color:#d32f2f;">â‚¹${p.min_price} / ${unit}</span></div>
                        <div class="lp-detail-item"><label>Max Price</label><span style="color:#d32f2f;">â‚¹${p.max_price} / ${unit}</span></div>
                        <div class="lp-detail-item"><label>Price Trend</label><span class="lp-card-trend ${trend}" style="font-size:13px;">${trendLabel}</span></div>
                        ${p.market_name ? `<div class="lp-detail-item"><label>Market Name</label><span>ðŸª ${lpEsc(p.market_name)}</span></div>` : ''}
                      </div>
                    </div>

                    <div class="lp-detail-section">
                      <h4>ðŸ“ Location</h4>
                      <div class="lp-detail-grid">
                        ${p.area ? `<div class="lp-detail-item"><label>Area / City</label><span>${lpEsc(p.area)}</span></div>` : ''}
                        ${p.district ? `<div class="lp-detail-item"><label>District</label><span>${lpEsc(p.district)}</span></div>` : ''}
                        ${p.state ? `<div class="lp-detail-item"><label>State</label><span>${lpEsc(p.state)}</span></div>` : ''}
                        ${p.pin_code ? `<div class="lp-detail-item"><label>Pin Code</label><span>${lpEsc(p.pin_code)}</span></div>` : ''}
                      </div>
                      ${p.latitude && p.longitude ? `<iframe class="lp-detail-map" src="https://www.openstreetmap.org/export/embed.html?bbox=${p.longitude-0.02},${p.latitude-0.02},${p.longitude+0.02},${p.latitude+0.02}&layer=mapnik&marker=${p.latitude},${p.longitude}" frameborder="0" loading="lazy"></iframe>` : ''}
                    </div>

                    ${images.length > 0 ? `
                    <div class="lp-detail-section">
                      <h4>ðŸ“· Photos</h4>
                      <div class="lp-detail-gallery">${images.map(i => `<img src="/${i}" alt="Product photo" onclick="window.open('/${i}','_blank')">`).join('')}</div>
                    </div>` : ''}

                    ${videos.length > 0 ? `
                    <div class="lp-detail-section">
                      <h4>ðŸŽ¥ Videos</h4>
                      <div class="lp-detail-gallery">${videos.map(v => `<video src="/${v}" controls></video>`).join('')}</div>
                    </div>` : ''}

                    <div class="lp-detail-section">
                      <h4>ðŸ“ž Contact & Info</h4>
                      <div class="lp-detail-grid">
                        <div class="lp-detail-item"><label>Phone</label><span><a href="tel:${lpEsc(p.phone)}" style="color:#2e7d32;text-decoration:none;font-weight:700;">ðŸ“ž ${lpEsc(p.phone)}</a></span></div>
                        ${p.poster_name ? `<div class="lp-detail-item"><label>Posted By</label><span>ðŸ‘¤ ${lpEsc(p.poster_name)}</span></div>` : ''}
                        <div class="lp-detail-item"><label>Posted On</label><span>ðŸ“… ${lpFormatDate(p.created_at)}</span></div>
                        <div class="lp-detail-item"><label>Rating</label><span style="color:#ff9800;">${ratingStars} (${avgRating}/5 Â· ${fbCount})</span></div>
                      </div>
                    </div>

                    ${feedbacks.length > 0 ? `
                    <div class="lp-detail-section">
                      <h4>â­ Feedback (${fbCount})</h4>
                      ${feedbacks.map(fb => `
                        <div class="lp-fb-entry">
                          <div class="lp-fb-stars">${'â˜…'.repeat(fb.rating)}${'â˜†'.repeat(5-fb.rating)}</div>
                          ${fb.farmer_name ? `<div class="lp-fb-name">${lpEsc(fb.farmer_name)}</div>` : ''}
                          ${fb.comment ? `<div class="lp-fb-comment">${lpEsc(fb.comment)}</div>` : ''}
                          <div class="lp-fb-date">${lpFormatDate(fb.created_at)}</div>
                        </div>
                      `).join('')}
                    </div>` : `
                    <div class="lp-detail-section">
                      <h4>â­ Feedback</h4>
                      <p style="color:#999;font-size:14px;">No feedback yet. Be the first to rate!</p>
                    </div>`}
                  `;
                  body.innerHTML = html;
                  // Start detail timer
                  lpStartDetailTimer(p.created_at);
                })
                .catch(() => {
                  body.innerHTML = '<p style="padding:30px;color:#d32f2f;">Error loading details.</p>';
                });
            };

            function lpStartDetailTimer(createdAt) {
              const el = document.getElementById('lp-detail-timer');
              if(!el) return;
              const created = new Date(createdAt + (createdAt.includes('Z') || createdAt.includes('+') ? '' : 'Z'));
              const expiry = new Date(created.getTime() + 24*60*60*1000);
              const iv = setInterval(() => {
                const diff = expiry - new Date();
                if(diff <= 0) { el.textContent = 'â± Expired'; el.className = 'lp-timer red'; clearInterval(iv); return; }
                const h = Math.floor(diff/3600000);
                const m = Math.floor((diff%3600000)/60000);
                const s = Math.floor((diff%60000)/1000);
                el.textContent = `â± ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')} remaining`;
                el.className = 'lp-timer ' + (h>=12?'green':h>=1?'orange':'red');
              }, 1000);
            }

            window.lpCloseDetail = function() {
              document.getElementById('lpDetailModal').style.display = 'none';
              document.body.style.overflow = '';
            };

            // ========== CONTACT ==========
            window.lpContact = function(phone) {
              if(!phone) { alert('No phone number available.'); return; }
              window.location.href = 'tel:' + phone;
            };

            // ========== FEEDBACK ==========
            window.lpOpenFeedback = function(priceId) {
              document.getElementById('lpFeedbackPriceId').value = priceId;
              document.getElementById('lpFeedbackRating').value = '0';
              document.getElementById('lpFeedbackName').value = '';
              document.getElementById('lpFeedbackComment').value = '';
              document.querySelectorAll('#lpStarRating .lp-star').forEach(s => s.classList.remove('active'));
              document.getElementById('lpFeedbackModal').style.display = 'flex';
              document.body.style.overflow = 'hidden';
              // Load existing feedback
              lpLoadFeedbackList(priceId);
            };
            window.lpCloseFeedback = function() {
              document.getElementById('lpFeedbackModal').style.display = 'none';
              document.body.style.overflow = '';
            };

            // Star rating click
            document.addEventListener('click', function(e) {
              if(e.target.classList.contains('lp-star') && e.target.closest('#lpStarRating')) {
                const val = parseInt(e.target.dataset.val);
                document.getElementById('lpFeedbackRating').value = val;
                document.querySelectorAll('#lpStarRating .lp-star').forEach(s => {
                  s.classList.toggle('active', parseInt(s.dataset.val) <= val);
                });
              }
            });

            window.lpSubmitFeedback = function() {
              const priceId = document.getElementById('lpFeedbackPriceId').value;
              const rating = parseInt(document.getElementById('lpFeedbackRating').value);
              const name = document.getElementById('lpFeedbackName').value.trim();
              const comment = document.getElementById('lpFeedbackComment').value.trim();
              if(!rating || rating < 1) { alert('Please select a rating.'); return; }

              fetch(`/api/live-prices/${priceId}/feedback`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ rating, farmer_name: name, comment })
              })
              .then(r => r.json())
              .then(data => {
                if(data.success) {
                  document.getElementById('lpFeedbackRating').value = '0';
                  document.getElementById('lpFeedbackName').value = '';
                  document.getElementById('lpFeedbackComment').value = '';
                  document.querySelectorAll('#lpStarRating .lp-star').forEach(s => s.classList.remove('active'));
                  lpLoadFeedbackList(priceId);
                  lpLoadPosts(); // Refresh feed to update rating
                } else {
                  alert(data.message || 'Failed to submit feedback.');
                }
              })
              .catch(() => alert('Network error.'));
            };

            function lpLoadFeedbackList(priceId) {
              const list = document.getElementById('lpFeedbackList');
              if(!list) return;
              list.innerHTML = '<div style="text-align:center;padding:15px;color:#999;">Loading...</div>';

              fetch(`/api/live-prices/${priceId}/feedback`)
                .then(r => r.json())
                .then(data => {
                  if(!data.success || !data.feedbacks || data.feedbacks.length === 0) {
                    list.innerHTML = '<p style="color:#999;font-size:14px;text-align:center;padding:10px;">No feedback yet. Be the first!</p>';
                    return;
                  }
                  const stats = data.stats || {};
                  list.innerHTML = `
                    <div style="text-align:center;margin-bottom:15px;padding:12px;background:#fff3e0;border-radius:12px;">
                      <div style="font-size:28px;color:#ff9800;font-weight:700;">${stats.avg_rating || 0}/5</div>
                      <div style="font-size:13px;color:#666;">${stats.count || 0} reviews</div>
                    </div>
                    ${data.feedbacks.map(fb => `
                      <div class="lp-fb-entry">
                        <div class="lp-fb-stars">${'â˜…'.repeat(fb.rating)}${'â˜†'.repeat(5 - fb.rating)}</div>
                        ${fb.farmer_name ? `<div class="lp-fb-name">${lpEsc(fb.farmer_name)}</div>` : '<div class="lp-fb-name" style="color:#999;">Anonymous</div>'}
                        ${fb.comment ? `<div class="lp-fb-comment">${lpEsc(fb.comment)}</div>` : ''}
                        <div class="lp-fb-date">${lpFormatDate(fb.created_at)}</div>
                      </div>
                    `).join('')}
                  `;
                })
                .catch(() => { list.innerHTML = '<p style="color:#d32f2f;text-align:center;">Could not load feedback.</p>'; });
            }

            // ========== HELPERS ==========
            function lpEsc(str) {
              if(!str) return '';
              const d = document.createElement('div');
              d.textContent = str;
              return d.innerHTML;
            }
            function lpFormatDate(dateStr) {
              if(!dateStr) return '';
              try {
                const d = new Date(dateStr + (dateStr.includes('Z') || dateStr.includes('+') ? '' : 'Z'));
                return d.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + ' ' + d.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',hour12:true});
              } catch { return dateStr; }
            }

            // ========== INIT ==========
            // Hook into switchDashSection to load posts when Prices tab is opened
            const _origSwitch3 = window.switchDashSection;
            window.switchDashSection = function(section) {
              if(typeof _origSwitch3 === 'function') _origSwitch3.apply(this, arguments);
              if(section === 'prices') lpLoadPosts();
            };

            // Auto-load if already on prices section
            document.addEventListener('DOMContentLoaded', function() {
              const sec = document.getElementById('dashPrices');
              if(sec && sec.classList.contains('active')) lpLoadPosts();
            });
          })();
          </script>

          <!-- AI Assistant Section -->
          <div id="dashAi-assistant" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 30px">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>
            </div>
            <div class="search-section" style="padding: 0; overflow: hidden">
              <div
                class="ai-chat-container"
                style="
                  display: flex;
                  flex-direction: column;
                  height: 75vh;
                  background: white;
                  border-radius: 20px;
                  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                  overflow: hidden;
                "
              >
                <!-- Chat Header -->
                <div
                  class="chat-header"
                  style="
                    background: linear-gradient(135deg, #2e7d32, #558b2f);
                    color: white;
                    padding: 20px 25px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
                  "
                >
                  <div
                    class="chat-header-left"
                    style="display: flex; align-items: center; gap: 15px"
                  >
                    <span style="font-size: 32px">ðŸ¤–</span>
                    <h2
                      style="
                        margin: 0;
                        font-size: 24px;
                        font-family: &quot;Poppins&quot;, sans-serif;
                        font-weight: 600;
                      "
                    >
                      AI Assistant
                    </h2>
                  </div>
                  <div
                    class="chat-header-right"
                    style="display: flex; gap: 10px; align-items: center"
                  >
                    <select
                      class="language-selector notranslate"
                      id="chatLanguage"
                      onchange="changeChatLanguage()"
                      style="
                        padding: 8px 15px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: &quot;Poppins&quot;, sans-serif;
                      "
                    >
                      <option value="en" class="notranslate">English</option>
                      <option value="te" class="notranslate">
                        à°¤à±†à°²à±à°—à± Telugu
                      </option>
                      <option value="hi" class="notranslate">
                        à¤¹à¤¿à¤‚à¤¦à¥€ Hindi
                      </option>
                      <option value="ta" class="notranslate">
                        à®¤à®®à®¿à®´à¯ Tamil
                      </option>
                      <option value="kn" class="notranslate">
                        à²•à²¨à³à²¨à²¡ Kannada
                      </option>
                    </select>
                    <button
                      class="chat-btn"
                      onclick="toggleChatHistory()"
                      style="
                        padding: 8px 15px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: &quot;Poppins&quot;, sans-serif;
                      "
                    >
                      ðŸ“œ History
                    </button>
                    <button
                      class="chat-btn"
                      onclick="clearAIChat()"
                      style="
                        padding: 8px 15px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: &quot;Poppins&quot;, sans-serif;
                      "
                    >
                      ðŸ—‘ï¸ Clear
                    </button>
                  </div>
                </div>

                <!-- Chat Messages Area -->
                <div
                  class="chat-messages"
                  id="chatMessages"
                  style="
                    flex: 1;
                    overflow-y: auto;
                    padding: 25px;
                    background: linear-gradient(
                      135deg,
                      #fafafa 0%,
                      #f5f5f5 100%
                    );
                    position: relative;
                  "
                >
                  <div
                    class="welcome-screen"
                    id="welcomeScreen"
                    style="text-align: center; padding: 50px 20px; color: #666"
                  >
                    <div
                      class="icon"
                      style="font-size: 80px; margin-bottom: 20px"
                    >
                      ðŸ¤–
                    </div>
                    <h3
                      style="
                        color: #2e7d32;
                        font-size: 28px;
                        margin-bottom: 15px;
                        font-family: &quot;Poppins&quot;, sans-serif;
                      "
                    >
                      Welcome to AI Assistant!
                    </h3>
                    <p
                      style="
                        font-size: 16px;
                        line-height: 1.6;
                        max-width: 600px;
                        margin: 0 auto 30px;
                        font-family: &quot;Poppins&quot;, sans-serif;
                      "
                    >
                      I'm here to help you with farming advice, crop
                      suggestions, pest management, and more. Ask me anything in
                      your preferred language!
                    </p>
                    <div
                      class="suggestion-chips"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fit,
                          minmax(200px, 1fr)
                        );
                        gap: 15px;
                        max-width: 800px;
                        margin: 0 auto;
                      "
                    >
                      <div
                        class="suggestion-chip"
                        onclick="
                          sendSuggestion(
                            'What crops should I grow this season?',
                          )
                        "
                        style="
                          background: white;
                          padding: 15px 20px;
                          border-radius: 12px;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          border: 2px solid #e0e0e0;
                          font-size: 15px;
                          font-weight: 500;
                          color: #2e7d32;
                          text-align: center;
                          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                          font-family: &quot;Poppins&quot;, sans-serif;
                        "
                      >
                        ðŸŒ¾ Crop Suggestions
                      </div>
                      <div
                        class="suggestion-chip"
                        onclick="
                          sendSuggestion('How to control pests in tomatoes?')
                        "
                        style="
                          background: white;
                          padding: 15px 20px;
                          border-radius: 12px;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          border: 2px solid #e0e0e0;
                          font-size: 15px;
                          font-weight: 500;
                          color: #2e7d32;
                          text-align: center;
                          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                          font-family: &quot;Poppins&quot;, sans-serif;
                        "
                      >
                        ðŸ› Pest Control
                      </div>
                      <div
                        class="suggestion-chip"
                        onclick="sendSuggestion('Best fertilizer for rice?')"
                        style="
                          background: white;
                          padding: 15px 20px;
                          border-radius: 12px;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          border: 2px solid #e0e0e0;
                          font-size: 15px;
                          font-weight: 500;
                          color: #2e7d32;
                          text-align: center;
                          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                          font-family: &quot;Poppins&quot;, sans-serif;
                        "
                      >
                        ðŸŒ¿ Fertilizer Advice
                      </div>
                      <div
                        class="suggestion-chip"
                        onclick="sendSuggestion('Weather forecast for farming')"
                        style="
                          background: white;
                          padding: 15px 20px;
                          border-radius: 12px;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          border: 2px solid #e0e0e0;
                          font-size: 15px;
                          font-weight: 500;
                          color: #2e7d32;
                          text-align: center;
                          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                          font-family: &quot;Poppins&quot;, sans-serif;
                        "
                      >
                        â˜€ï¸ Weather Info
                      </div>
                    </div>
                  </div>

                  <!-- Typing Indicator -->
                  <div
                    class="typing-indicator"
                    id="typingIndicator"
                    style="
                      display: none;
                      padding: 15px 20px;
                      background: white;
                      border-radius: 18px;
                      width: fit-content;
                      margin-bottom: 15px;
                      border-bottom-left-radius: 4px;
                      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    "
                  >
                    <div class="typing-dots" style="display: flex; gap: 6px">
                      <span
                        style="
                          width: 8px;
                          height: 8px;
                          background: #4caf50;
                          border-radius: 50%;
                          animation: bounce 1.4s infinite ease-in-out;
                          animation-delay: -0.32s;
                        "
                      ></span>
                      <span
                        style="
                          width: 8px;
                          height: 8px;
                          background: #4caf50;
                          border-radius: 50%;
                          animation: bounce 1.4s infinite ease-in-out;
                          animation-delay: -0.16s;
                        "
                      ></span>
                      <span
                        style="
                          width: 8px;
                          height: 8px;
                          background: #4caf50;
                          border-radius: 50%;
                          animation: bounce 1.4s infinite ease-in-out;
                        "
                      ></span>
                    </div>
                  </div>
                </div>

                <!-- Chat Input Area -->
                <div
                  class="chat-input-area"
                  style="
                    padding: 20px 25px;
                    background: white;
                    border-top: 2px solid #e0e0e0;
                    display: flex;
                    gap: 10px;
                    align-items: flex-end;
                  "
                >
                  <div
                    class="chat-input-wrapper"
                    style="flex: 1; position: relative"
                  >
                    <textarea
                      class="chat-input"
                      id="chatInput"
                      placeholder="Type your message here..."
                      rows="1"
                      onkeypress="handleChatKeyPress(event)"
                      oninput="autoResizeTextarea(this)"
                      style="
                        width: 100%;
                        padding: 15px 20px;
                        border: 2px solid #e0e0e0;
                        border-radius: 25px;
                        font-size: 15px;
                        font-family: &quot;Poppins&quot;, sans-serif;
                        resize: none;
                        transition: all 0.3s ease;
                        min-height: 50px;
                        max-height: 120px;
                      "
                    ></textarea>
                  </div>
                  <div class="chat-controls" style="display: flex; gap: 10px">
                    <button
                      class="voice-btn"
                      id="voiceBtn"
                      onclick="toggleVoiceInput()"
                      title="Voice Input"
                      style="
                        width: 50px;
                        height: 50px;
                        border: none;
                        border-radius: 50%;
                        font-size: 24px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        background: linear-gradient(135deg, #2196f3, #1976d2);
                      "
                    >
                      ðŸŽ¤
                    </button>
                    <button
                      class="send-btn"
                      id="sendBtn"
                      onclick="sendAIMessage()"
                      title="Send Message"
                      style="
                        width: 50px;
                        height: 50px;
                        border: none;
                        border-radius: 50%;
                        font-size: 24px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        background: linear-gradient(135deg, #4caf50, #2e7d32);
                      "
                    >
                      âž¤
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- History Modal -->
          <div
            class="history-modal"
            id="historyModal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              z-index: 10000;
              align-items: center;
              justify-content: center;
              padding: 20px;
            "
          >
            <div
              class="history-content"
              style="
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 600px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
              "
            >
              <div
                class="history-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                  padding-bottom: 15px;
                  border-bottom: 2px solid #e0e0e0;
                "
              >
                <h3
                  style="
                    color: #2e7d32;
                    font-size: 24px;
                    margin: 0;
                    font-family: &quot;Poppins&quot;, sans-serif;
                  "
                >
                  ðŸ“œ Chat History
                </h3>
                <button
                  class="history-close"
                  onclick="toggleChatHistory()"
                  style="
                    background: #f5f5f5;
                    border: none;
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    font-size: 20px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                  "
                >
                  Ã—
                </button>
              </div>
              <div id="historyList">
                <!-- History items will be populated here -->
              </div>
            </div>
          </div>

          <style>
            @keyframes bounce {
              0%,
              80%,
              100% {
                transform: scale(0);
              }
              40% {
                transform: scale(1);
              }
            }

            .suggestion-chip:hover {
              transform: translateY(-3px);
              box-shadow: 0 6px 20px rgba(46, 125, 50, 0.2);
              border-color: #4caf50;
              background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
            }

            .chat-btn:hover {
              background: rgba(255, 255, 255, 0.3);
              border-color: rgba(255, 255, 255, 0.5);
              transform: translateY(-2px);
            }

            .voice-btn:hover {
              transform: scale(1.1);
              box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            }

            .voice-btn.recording {
              background: linear-gradient(135deg, #f44336, #d32f2f);
              animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
              0%,
              100% {
                transform: scale(1);
              }
              50% {
                transform: scale(1.1);
              }
            }

            .send-btn:hover {
              transform: scale(1.1);
              box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            }

            .message-bubble {
              max-width: 70%;
              padding: 15px 20px;
              border-radius: 18px;
              margin-bottom: 15px;
              line-height: 1.6;
              animation: fadeIn 0.3s ease;
              font-family: "Poppins", sans-serif;
              word-wrap: break-word;
            }

            .user-message {
              background: linear-gradient(135deg, #4caf50, #2e7d32);
              color: white;
              margin-left: auto;
              border-bottom-right-radius: 4px;
              box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
              display: block;
              float: right;
              clear: both;
            }

            .ai-message {
              background: white;
              color: #333;
              margin-right: auto;
              border-bottom-left-radius: 4px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              border: 1px solid #e0e0e0;
              display: block;
              float: left;
              clear: both;
            }

            .message-time {
              font-size: 11px;
              opacity: 0.7;
              margin-top: 8px;
              display: block;
            }

            .history-modal.active {
              display: flex !important;
            }

            .language-selector option {
              background: white;
              color: #2e7d32;
            }

            .chat-input:focus {
              outline: none;
              border-color: #4caf50;
              box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            }
          </style>

          <script>
            // ===== AI Chatbot JavaScript =====
            let aiChatHistory = [];
            let currentChatLanguage = "en";
            let speechRecognition = null;
            let isVoiceRecording = false;

            const languageNames = {
              en: "English",
              te: "Telugu",
              hi: "Hindi",
              ta: "Tamil",
              kn: "Kannada",
            };

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", function () {
              loadAIChatHistory();
              initializeSpeechRecognition();
            });

            // Auto-resize textarea
            function autoResizeTextarea(textarea) {
              textarea.style.height = "auto";
              textarea.style.height =
                Math.min(textarea.scrollHeight, 120) + "px";
            }

            // Handle Enter key press
            function handleChatKeyPress(event) {
              if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendAIMessage();
              }
            }

            // Change chat language
            function changeChatLanguage() {
              currentChatLanguage =
                document.getElementById("chatLanguage").value;
              const messages = {
                en: "Language changed to English",
                te: "à°­à°¾à°· à°¤à±†à°²à±à°—à±à°•à± à°®à°¾à°°à±à°šà°¬à°¡à°¿à°‚à°¦à°¿",
                hi: "à¤­à¤¾à¤·à¤¾ à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¬à¤¦à¤² à¤¦à¥€ à¤—à¤ˆ",
                ta: "à®®à¯Šà®´à®¿ à®¤à®®à®¿à®´à¯à®•à¯à®•à¯ à®®à®¾à®±à¯à®±à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯",
                kn: "à²­à²¾à²·à³† à²•à²¨à³à²¨à²¡à²•à³à²•à³† à²¬à²¦à²²à²¾à²¯à²¿à²¸à²²à²¾à²—à²¿à²¦à³†",
              };
              showPopup(messages[currentChatLanguage]);
            }

            // Send suggestion
            function sendSuggestion(text) {
              document.getElementById("chatInput").value = text;
              sendAIMessage();
            }

            // Send message
            async function sendAIMessage() {
              const input = document.getElementById("chatInput");
              const message = input.value.trim();

              if (!message) return;

              // Hide welcome screen
              const welcomeScreen = document.getElementById("welcomeScreen");
              if (welcomeScreen) welcomeScreen.style.display = "none";

              // Add user message to chat
              addAIMessageToChat(message, "user");

              // Clear input
              input.value = "";
              input.style.height = "auto";

              // Show typing indicator
              document.getElementById("typingIndicator").style.display =
                "block";

              // Get AI response
              try {
                const response = await getPerplexityAIResponse(message);

                // Hide typing indicator
                document.getElementById("typingIndicator").style.display =
                  "none";

                // Add AI response to chat
                addAIMessageToChat(response, "ai");

                // Save to history
                saveAIChatToHistory(message, response);
              } catch (error) {
                // Hide typing indicator
                document.getElementById("typingIndicator").style.display =
                  "none";

                // Show user-friendly error message
                let errorMsg =
                  "Sorry, I couldn't process your request at the moment. ";
                if (error.message) {
                  if (error.message.includes("AI service error")) {
                    errorMsg +=
                      "The AI service is temporarily unavailable. Please try again in a moment.";
                  } else if (
                    error.message.includes("timeout") ||
                    error.message.includes("network")
                  ) {
                    errorMsg +=
                      "Please check your internet connection and try again.";
                  } else {
                    errorMsg += error.message.replace("AI service error: ", "");
                  }
                } else {
                  errorMsg +=
                    "Please check your internet connection and try again.";
                }
                addAIMessageToChat(errorMsg, "ai");
              }
            }

            // Get response from Perplexity API via backend
            async function getPerplexityAIResponse(userMessage) {
              try {
                const response = await fetch("/api/ai/chat", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    message: userMessage,
                    language: currentChatLanguage,
                  }),
                });

                const data = await response.json();

                if (!response.ok) {
                  throw new Error(data.message || "Failed to get AI response");
                }

                if (!data.success) {
                  throw new Error(data.message || "AI service error");
                }

                return data.response;
              } catch (error) {
                console.error("AI Chat Error:", error);
                throw error;
              }
            }

            // Add message to chat
            function addAIMessageToChat(text, type) {
              const messagesContainer = document.getElementById("chatMessages");
              const messageDiv = document.createElement("div");
              messageDiv.className = `message-bubble ${type === "user" ? "user-message" : "ai-message"}`;

              // Format text with basic markdown
              const formattedText = text
                .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
                .replace(/\n/g, "<br>");

              const time = new Date().toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
              });

              messageDiv.innerHTML = `
                        ${formattedText}
                        <span class="message-time">${time}</span>
                    `;

              messagesContainer.appendChild(messageDiv);

              // Scroll to bottom
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Save chat to history
            function saveAIChatToHistory(question, answer) {
              const chatItem = {
                id: Date.now(),
                question: question,
                answer: answer,
                timestamp: new Date().toISOString(),
                language: currentChatLanguage,
              };

              aiChatHistory.unshift(chatItem);

              // Keep only last 50 conversations
              if (aiChatHistory.length > 50) {
                aiChatHistory = aiChatHistory.slice(0, 50);
              }

              // Save to localStorage
              try {
                localStorage.setItem(
                  "aiChatHistory",
                  JSON.stringify(aiChatHistory),
                );
              } catch (error) {
                console.error("Failed to save chat history:", error);
              }
            }

            // Load chat history from localStorage
            function loadAIChatHistory() {
              try {
                const saved = localStorage.getItem("aiChatHistory");
                if (saved) {
                  aiChatHistory = JSON.parse(saved);
                }
              } catch (error) {
                console.error("Failed to load chat history:", error);
              }
            }

            // Toggle chat history modal
            function toggleChatHistory() {
              const modal = document.getElementById("historyModal");
              const isActive = modal.classList.contains("active");

              if (!isActive) {
                // Show history
                renderAIHistory();
                modal.classList.add("active");
              } else {
                // Hide history
                modal.classList.remove("active");
              }
            }

            // Render history
            function renderAIHistory() {
              const historyList = document.getElementById("historyList");

              if (aiChatHistory.length === 0) {
                historyList.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <p style="font-size: 48px; margin-bottom: 15px;">ðŸ“­</p>
                                <p style="font-size: 16px;">No chat history yet</p>
                            </div>
                        `;
                return;
              }

              historyList.innerHTML = aiChatHistory
                .map((item) => {
                  const date = new Date(item.timestamp);
                  const timeStr = date.toLocaleString("en-US", {
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                  });

                  return `
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #999;">${timeStr} â€¢ ${languageNames[item.language]}</span>
                                </div>
                                <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">Q: ${item.question}</div>
                                <div style="font-size: 14px; color: #555; line-height: 1.5;">A: ${item.answer.substring(0, 150)}${item.answer.length > 150 ? "..." : ""}</div>
                            </div>
                        `;
                })
                .join("");
            }

            // Clear chat
            function clearAIChat() {
              if (
                confirm(
                  "Are you sure you want to clear the current chat? This will not delete your history.",
                )
              ) {
                const messagesContainer =
                  document.getElementById("chatMessages");
                messagesContainer.innerHTML = `
                            <div class="welcome-screen" id="welcomeScreen" style="text-align: center; padding: 50px 20px; color: #666;">
                                <div class="icon" style="font-size: 80px; margin-bottom: 20px;">ðŸ¤–</div>
                                <h3 style="color: #2e7d32; font-size: 28px; margin-bottom: 15px; font-family: 'Poppins', sans-serif;">Welcome to AI Assistant!</h3>
                                <p style="font-size: 16px; line-height: 1.6; max-width: 600px; margin: 0 auto 30px; font-family: 'Poppins', sans-serif;">
                                    I'm here to help you with farming advice, crop suggestions, pest management, and more. Ask me anything in your preferred language!
                                </p>
                                <div class="suggestion-chips" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 800px; margin: 0 auto;">
                                    <div class="suggestion-chip" onclick="sendSuggestion('What crops should I grow this season?')" style="background: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e0e0e0; font-size: 15px; font-weight: 500; color: #2e7d32; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Poppins', sans-serif;">
                                        ðŸŒ¾ Crop Suggestions
                                    </div>
                                    <div class="suggestion-chip" onclick="sendSuggestion('How to control pests in tomatoes?')" style="background: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e0e0e0; font-size: 15px; font-weight: 500; color: #2e7d32; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Poppins', sans-serif;">
                                        ðŸ› Pest Control
                                    </div>
                                    <div class="suggestion-chip" onclick="sendSuggestion('Best fertilizer for rice?')" style="background: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e0e0e0; font-size: 15px; font-weight: 500; color: #2e7d32; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Poppins', sans-serif;">
                                        ðŸŒ¿ Fertilizer Advice
                                    </div>
                                    <div class="suggestion-chip" onclick="sendSuggestion('Weather forecast for farming')" style="background: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e0e0e0; font-size: 15px; font-weight: 500; color: #2e7d32; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Poppins', sans-serif;">
                                        â˜€ï¸ Weather Info
                                    </div>
                                </div>
                            </div>
                            <div class="typing-indicator" id="typingIndicator" style="display: none; padding: 15px 20px; background: white; border-radius: 18px; width: fit-content; margin-bottom: 15px; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div class="typing-dots" style="display: flex; gap: 6px;">
                                    <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: -0.32s;"></span>
                                    <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: -0.16s;"></span>
                                    <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out;"></span>
                                </div>
                            </div>
                        `;
              }
            }

            // Initialize Speech Recognition
            function initializeSpeechRecognition() {
              if (
                "webkitSpeechRecognition" in window ||
                "SpeechRecognition" in window
              ) {
                const SpeechRecognition =
                  window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();

                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;

                const langCodes = {
                  en: "en-US",
                  te: "te-IN",
                  hi: "hi-IN",
                  ta: "ta-IN",
                  kn: "kn-IN",
                };

                speechRecognition.lang = langCodes[currentChatLanguage];

                speechRecognition.onresult = (event) => {
                  const transcript = event.results[0][0].transcript;
                  document.getElementById("chatInput").value = transcript;
                  stopVoiceInput();
                };

                speechRecognition.onerror = (event) => {
                  console.error("Speech recognition error:", event.error);
                  stopVoiceInput();
                  showPopup("Voice input failed. Please try again.");
                };

                speechRecognition.onend = () => {
                  stopVoiceInput();
                };
              }
            }

            // Toggle voice input
            function toggleVoiceInput() {
              if (!speechRecognition) {
                showPopup("Voice input is not supported in your browser.");
                return;
              }

              if (isVoiceRecording) {
                stopVoiceInput();
              } else {
                startVoiceInput();
              }
            }

            // Start voice input
            function startVoiceInput() {
              const langCodes = {
                en: "en-US",
                te: "te-IN",
                hi: "hi-IN",
                ta: "ta-IN",
                kn: "kn-IN",
              };

              speechRecognition.lang = langCodes[currentChatLanguage];
              speechRecognition.start();
              isVoiceRecording = true;

              const voiceBtn = document.getElementById("voiceBtn");
              voiceBtn.classList.add("recording");
              voiceBtn.innerHTML = "â¹ï¸";

              showPopup("Listening...");
            }

            // Stop voice input
            function stopVoiceInput() {
              if (speechRecognition && isVoiceRecording) {
                speechRecognition.stop();
              }
              isVoiceRecording = false;

              const voiceBtn = document.getElementById("voiceBtn");
              voiceBtn.classList.remove("recording");
              voiceBtn.innerHTML = "ðŸŽ¤";
            }
          </script>

          <!-- Customer Requirements Section -->
          <div id="dashRequirements" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 30px">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>
            </div>
            <div class="search-section">
              <h2
                style="
                  color: #2e7d32;
                  margin-bottom: 30px;
                  font-family: &quot;Poppins&quot;, sans-serif;
                  font-weight: 600;
                "
                data-translate="yes"
              >
                <span class="notranslate">ðŸ“‹</span> Customer Requirements
              </h2>

              <!-- Tab Navigation -->
              <div
                style="
                  display: flex;
                  gap: 15px;
                  margin-bottom: 30px;
                  border-bottom: 2px solid #e0e0e0;
                "
              >
                <button
                  id="productReqTab"
                  onclick="switchRequirementTab('product')"
                  style="
                    padding: 15px 30px;
                    background: linear-gradient(135deg, #2e7d32, #558b2f);
                    color: white;
                    border: none;
                    border-radius: 15px 15px 0 0;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
                  "
                >
                  <span class="notranslate">ðŸŒ¾</span> Product Requirements
                </button>
                <button
                  id="rentalReqTab"
                  onclick="switchRequirementTab('rental')"
                  style="
                    padding: 15px 30px;
                    background: #f5f5f5;
                    color: #666;
                    border: none;
                    border-radius: 15px 15px 0 0;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.background = '#e0e0e0'"
                  onmouseout="this.style.background = '#f5f5f5'"
                >
                  <span class="notranslate">ðŸšœ</span> Rental Requirements
                </button>
              </div>

              <!-- Product Requirements Tab Content -->
              <div id="productReqContent">
                <!-- Search Bar -->
                <div style="margin-bottom: 30px; position: relative">
                  <input
                    type="text"
                    id="requirementSearch"
                    placeholder="ðŸ” Search by product name..."
                    style="
                      width: 100%;
                      padding: 15px 20px;
                      border: 2px solid #2e7d32;
                      border-radius: 25px;
                      font-size: 16px;
                      outline: none;
                      transition: all 0.3s ease;
                    "
                    oninput="searchRequirements()"
                  />
                </div>

                <!-- Post New Requirement Button -->
                <button
                  onclick="showRequirementForm()"
                  class="notranslate"
                  style="
                    background: linear-gradient(135deg, #2e7d32, #558b2f);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 30px;
                    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
                    transition: transform 0.3s ease;
                  "
                  onmouseover="this.style.transform = 'scale(1.05)'"
                  onmouseout="this.style.transform = 'scale(1)'"
                >
                  <span class="notranslate">âž•</span>
                  <span data-translate="yes">Post New Requirement</span>
                </button>

                <!-- Post Requirement Form (Hidden by default) -->
                <div
                  id="requirementFormContainer"
                  style="
                    display: none;
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                    margin-bottom: 30px;
                  "
                >
                  <h3 style="color: #2e7d32; margin-bottom: 20px">
                    Post Your Requirement
                  </h3>
                  <form id="requirementForm" onsubmit="postRequirement(event)">
                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Your Name *</label
                      >
                      <input
                        type="text"
                        id="customerName"
                        required
                        placeholder="Enter your name"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      />
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Product Name *</label
                      >
                      <input
                        type="text"
                        id="reqProductName"
                        required
                        placeholder="e.g., Tomatoes, Rice, Wheat"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      />
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Quantity *</label
                      >
                      <div style="display: flex; gap: 10px; align-items: center;">
                        <input
                          type="number"
                          id="quantity"
                          required
                          min="1"
                          placeholder="e.g., 100"
                          style="
                            flex: 1;
                            padding: 12px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            outline: none;
                            transition: border 0.3s ease;
                          "
                          onfocus="this.style.borderColor = '#2e7d32'"
                          onblur="this.style.borderColor = '#e0e0e0'"
                        />
                        <select
                          id="quantityUnit"
                          style="
                            padding: 12px 14px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            outline: none;
                            background: #fff;
                            cursor: pointer;
                            font-weight: 600;
                            color: #2e7d32;
                            transition: border 0.3s ease;
                            min-width: 90px;
                          "
                          onfocus="this.style.borderColor = '#2e7d32'"
                          onblur="this.style.borderColor = '#e0e0e0'"
                        >
                          <option value="kg" selected>Kg</option>
                          <option value="quintal">Quintal</option>
                          <option value="ton">Ton</option>
                          <option value="pieces">Pieces</option>
                          <option value="dozen">Dozen</option>
                          <option value="litre">Litre</option>
                          <option value="bags">Bags</option>
                        </select>
                      </div>
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Location *</label
                      >
                      <input
                        type="text"
                        id="location"
                        required
                        placeholder="Enter your location"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      />
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Phone Number *</label
                      >
                      <input
                        type="tel"
                        id="phoneNumber"
                        required
                        pattern="[0-9]{10}"
                        placeholder="Enter 10-digit phone number"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      />
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Pin Code</label
                      >
                      <input
                        type="text"
                        id="reqPinCode"
                        placeholder="Enter pin code (optional)"
                        maxlength="6"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                      />
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Special Instructions / Description</label
                      >
                      <textarea
                        id="reqSpecialInstructions"
                        placeholder="Any special instructions or description (optional)"
                        rows="3"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          resize: vertical;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      ></textarea>
                    </div>

                    <div style="margin-bottom: 20px">
                      <label
                        style="
                          display: block;
                          color: #333;
                          margin-bottom: 8px;
                          font-weight: 500;
                        "
                        >Preferred Delivery Date</label
                      >
                      <input
                        type="date"
                        id="reqPreferredDate"
                        style="
                          width: 100%;
                          padding: 12px;
                          border: 2px solid #e0e0e0;
                          border-radius: 8px;
                          font-size: 14px;
                          outline: none;
                          transition: border 0.3s ease;
                        "
                        onfocus="this.style.borderColor = '#2e7d32'"
                        onblur="this.style.borderColor = '#e0e0e0'"
                      />
                    </div>

                    <div style="display: flex; gap: 15px">
                      <button
                        type="submit"
                        style="
                          flex: 1;
                          background: linear-gradient(135deg, #2e7d32, #558b2f);
                          color: white;
                          border: none;
                          padding: 12px;
                          border-radius: 8px;
                          cursor: pointer;
                          font-size: 16px;
                          font-weight: 600;
                          transition: transform 0.2s ease;
                        "
                        onmouseover="this.style.transform = 'scale(1.02)'"
                        onmouseout="this.style.transform = 'scale(1)'"
                      >
                        ðŸ“¤ Post Requirement
                      </button>
                      <button
                        type="button"
                        onclick="hideRequirementForm()"
                        style="
                          flex: 1;
                          background: #f5f5f5;
                          color: #333;
                          border: none;
                          padding: 12px;
                          border-radius: 8px;
                          cursor: pointer;
                          font-size: 16px;
                          font-weight: 600;
                          transition: background 0.2s ease;
                        "
                        onmouseover="this.style.background = '#e0e0e0'"
                        onmouseout="this.style.background = '#f5f5f5'"
                      >
                        âŒ Cancel
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Requirements List -->
                <div id="requirementsList" style="margin-top: 30px">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 20px;
                      font-family: &quot;Times New Roman&quot;, Times, serif;
                    "
                  >
                    ðŸ“¢ Posted Requirements
                  </h3>
                  <div id="requirementsContainer">
                    <!-- Requirements will be displayed here -->
                  </div>
                </div>
              </div>

              <!-- Rental Requirements Tab Content -->
              <div id="rentalReqContent" style="display: none">
                <!-- Search Bar -->
                <div style="margin-bottom: 30px; position: relative">
                  <input
                    type="text"
                    id="rentalRequirementSearch"
                    placeholder="ðŸ” Search by rental category, farmer name, or location..."
                    style="
                      width: 100%;
                      padding: 15px 20px;
                      border: 2px solid #2e7d32;
                      border-radius: 25px;
                      font-size: 16px;
                      outline: none;
                      transition: all 0.3s ease;
                    "
                    oninput="searchRentalRequirements()"
                  />
                </div>

                <!-- Post New Rental Requirement Button -->
                <button
                  onclick="showRentalRequirementForm()"
                  class="notranslate"
                  style="
                    background: linear-gradient(135deg, #2e7d32, #558b2f);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 30px;
                    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
                    transition: transform 0.3s ease;
                  "
                  onmouseover="this.style.transform = 'scale(1.05)'"
                  onmouseout="this.style.transform = 'scale(1)'"
                >
                  <span class="notranslate">âž•</span>
                  <span data-translate="yes">Post New Rental Requirement</span>
                </button>

                <!-- Post Rental Requirement Form (Hidden by default) -->
                <div
                  id="rentalRequirementFormContainer"
                  style="
                    display: none;
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                    margin-bottom: 30px;
                  "
                >
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 25px;
                      font-size: 24px;
                      font-weight: 600;
                    "
                  >
                    ðŸšœ Post Your Rental Requirement
                  </h3>
                  <form
                    id="rentalRequirementForm"
                    onsubmit="postRentalRequirement(event)"
                  >
                    <!-- Farmer Details Section -->
                    <div
                      style="
                        background: linear-gradient(
                          135deg,
                          rgba(46, 125, 50, 0.05),
                          rgba(85, 139, 47, 0.05)
                        );
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 4px solid #2e7d32;
                      "
                    >
                      <h4
                        style="
                          color: #2e7d32;
                          margin-bottom: 20px;
                          font-size: 18px;
                          font-weight: 600;
                        "
                      >
                        <span class="notranslate">ðŸ‘¤</span> Farmer Details
                      </h4>
                      <div
                        style="
                          display: grid;
                          grid-template-columns: repeat(
                            auto-fit,
                            minmax(250px, 1fr)
                          );
                          gap: 20px;
                        "
                      >
                        <div>
                          <label
                            style="
                              display: block;
                              color: #333;
                              margin-bottom: 8px;
                              font-weight: 500;
                            "
                            >Farmer Name *</label
                          >
                          <input
                            type="text"
                            id="rentalFarmerName"
                            required
                            placeholder="Enter farmer name"
                            style="
                              width: 100%;
                              padding: 12px;
                              border: 2px solid #e0e0e0;
                              border-radius: 8px;
                              font-size: 14px;
                              outline: none;
                              transition: border 0.3s ease;
                            "
                            onfocus="this.style.borderColor = '#2e7d32'"
                            onblur="this.style.borderColor = '#e0e0e0'"
                          />
                        </div>
                        <div>
                          <label
                            style="
                              display: block;
                              color: #333;
                              margin-bottom: 8px;
                              font-weight: 500;
                            "
                            >Phone Number *</label
                          >
                          <input
                            type="tel"
                            id="rentalPhoneNumber"
                            required
                            pattern="[0-9]{10}"
                            placeholder="Enter 10-digit phone number"
                            style="
                              width: 100%;
                              padding: 12px;
                              border: 2px solid #e0e0e0;
                              border-radius: 8px;
                              font-size: 14px;
                              outline: none;
                              transition: border 0.3s ease;
                            "
                            onfocus="this.style.borderColor = '#2e7d32'"
                            onblur="this.style.borderColor = '#e0e0e0'"
                            oninput="
                              this.value = this.value.replace(/[^0-9]/g, '')
                            "
                          />
                        </div>
                      </div>
                    </div>

                    <!-- Field Details Section -->
                    <div
                      style="
                        background: linear-gradient(
                          135deg,
                          rgba(46, 125, 50, 0.05),
                          rgba(85, 139, 47, 0.05)
                        );
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 4px solid #2e7d32;
                      "
                    >
                      <h4
                        style="
                          color: #2e7d32;
                          margin-bottom: 20px;
                          font-size: 18px;
                          font-weight: 600;
                        "
                      >
                        <span class="notranslate">ðŸŒ¾</span> Field Details
                      </h4>
                      <div
                        style="
                          display: grid;
                          grid-template-columns: repeat(
                            auto-fit,
                            minmax(250px, 1fr)
                          );
                          gap: 20px;
                          margin-bottom: 20px;
                        "
                      >
                        <div>
                          <label
                            style="
                              display: block;
                              color: #333;
                              margin-bottom: 8px;
                              font-weight: 500;
                            "
                            >Field Area (in acres) *</label
                          >
                          <input
                            type="number"
                            id="rentalFieldArea"
                            required
                            min="0"
                            step="0.01"
                            placeholder="e.g., 5.5"
                            style="
                              width: 100%;
                              padding: 12px;
                              border: 2px solid #e0e0e0;
                              border-radius: 8px;
                              font-size: 14px;
                              outline: none;
                              transition: border 0.3s ease;
                            "
                            onfocus="this.style.borderColor = '#2e7d32'"
                            onblur="this.style.borderColor = '#e0e0e0'"
                          />
                        </div>
                        <div>
                          <label
                            style="
                              display: block;
                              color: #333;
                              margin-bottom: 8px;
                              font-weight: 500;
                            "
                            >Crop Type (Optional)</label
                          >
                          <input
                            type="text"
                            id="rentalCropType"
                            placeholder="e.g., Rice, Wheat, Cotton"
                            style="
                              width: 100%;
                              padding: 12px;
                              border: 2px solid #e0e0e0;
                              border-radius: 8px;
                              font-size: 14px;
                              outline: none;
                              transition: border 0.3s ease;
                            "
                            onfocus="this.style.borderColor = '#2e7d32'"
                            onblur="this.style.borderColor = '#e0e0e0'"
                          />
                        </div>
                      </div>
                      <div style="margin-bottom: 20px">
                        <label
                          style="
                            display: block;
                            color: #333;
                            margin-bottom: 12px;
                            font-weight: 500;
                          "
                          >Location of Field *</label
                        >
                        <div
                          style="
                            display: grid;
                            grid-template-columns: repeat(
                              auto-fit,
                              minmax(200px, 1fr)
                            );
                            gap: 15px;
                            margin-bottom: 15px;
                          "
                        >
                          <div>
                            <input
                              type="text"
                              id="rentalVillage"
                              required
                              placeholder="Village"
                              style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                                outline: none;
                                transition: border 0.3s ease;
                              "
                              onfocus="this.style.borderColor = '#2e7d32'"
                              onblur="this.style.borderColor = '#e0e0e0'"
                            />
                          </div>
                          <div>
                            <input
                              type="text"
                              id="rentalMandal"
                              required
                              placeholder="Mandal"
                              style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                                outline: none;
                                transition: border 0.3s ease;
                              "
                              onfocus="this.style.borderColor = '#2e7d32'"
                              onblur="this.style.borderColor = '#e0e0e0'"
                            />
                          </div>
                          <div>
                            <input
                              type="text"
                              id="rentalDistrict"
                              required
                              placeholder="District"
                              style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                                outline: none;
                                transition: border 0.3s ease;
                              "
                              onfocus="this.style.borderColor = '#2e7d32'"
                              onblur="this.style.borderColor = '#e0e0e0'"
                            />
                          </div>
                        </div>
                        <div>
                          <label
                            style="
                              display: block;
                              color: #666;
                              margin-bottom: 8px;
                              font-size: 13px;
                              font-weight: 400;
                            "
                          >
                            <span class="notranslate">ðŸ“</span> GPS Map Pin
                            (Optional)
                          </label>
                          <input
                            type="text"
                            id="rentalGPS"
                            placeholder="e.g., 17.3850Â° N, 78.4867Â° E or Google Maps link"
                            style="
                              width: 100%;
                              padding: 12px;
                              border: 2px solid #e0e0e0;
                              border-radius: 8px;
                              font-size: 14px;
                              outline: none;
                              transition: border 0.3s ease;
                            "
                            onfocus="this.style.borderColor = '#2e7d32'"
                            onblur="this.style.borderColor = '#e0e0e0'"
                          />
                        </div>
                      </div>
                    </div>

                    <!-- Rental Requirement Details Section -->
                    <div
                      style="
                        background: linear-gradient(
                          135deg,
                          rgba(46, 125, 50, 0.05),
                          rgba(85, 139, 47, 0.05)
                        );
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 4px solid #2e7d32;
                      "
                    >
                      <h4
                        style="
                          color: #2e7d32;
                          margin-bottom: 20px;
                          font-size: 18px;
                          font-weight: 600;
                        "
                      >
                        <span class="notranslate">ðŸšœ</span> Rental Requirement
                        Details
                      </h4>
                      <div>
                        <label
                          style="
                            display: block;
                            color: #333;
                            margin-bottom: 8px;
                            font-weight: 500;
                          "
                          >Rental Category *</label
                        >
                        <select
                          id="rentalCategory"
                          required
                          style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            outline: none;
                            transition: border 0.3s ease;
                            background: white;
                            cursor: pointer;
                          "
                          onfocus="this.style.borderColor = '#2e7d32'"
                          onblur="this.style.borderColor = '#e0e0e0'"
                        >
                          <option value="">Select rental category</option>
                          <option value="Land for lease">Land for lease</option>
                          <option value="Tractor">Tractor</option>
                          <option value="Harvester">Harvester</option>
                          <option value="Sprayer">Sprayer</option>
                          <option value="Plough">Plough</option>
                          <option value="Water pump">Water pump</option>
                          <option value="Drone services">Drone services</option>
                          <option value="Cold storage">Cold storage</option>
                          <option value="Transport vehicle">
                            Transport vehicle
                          </option>
                        </select>
                      </div>
                    </div>

                    <!-- Additional Notes Section -->
                    <div
                      style="
                        background: linear-gradient(
                          135deg,
                          rgba(46, 125, 50, 0.05),
                          rgba(85, 139, 47, 0.05)
                        );
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        border-left: 4px solid #2e7d32;
                      "
                    >
                      <h4
                        style="
                          color: #2e7d32;
                          margin-bottom: 20px;
                          font-size: 18px;
                          font-weight: 600;
                        "
                      >
                        <span class="notranslate">ðŸ“</span> Additional Notes
                      </h4>
                      <div>
                        <label
                          style="
                            display: block;
                            color: #333;
                            margin-bottom: 8px;
                            font-weight: 500;
                          "
                          >Special Instructions or Conditions (Optional)</label
                        >
                        <textarea
                          id="rentalAdditionalNotes"
                          rows="4"
                          placeholder="Enter any special instructions, conditions, or additional information..."
                          style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            outline: none;
                            transition: border 0.3s ease;
                            resize: vertical;
                            font-family: inherit;
                          "
                          onfocus="this.style.borderColor = '#2e7d32'"
                          onblur="this.style.borderColor = '#e0e0e0'"
                        ></textarea>
                      </div>
                    </div>

                    <!-- Form Buttons -->
                    <div style="display: flex; gap: 15px">
                      <button
                        type="submit"
                        style="
                          flex: 1;
                          background: linear-gradient(135deg, #2e7d32, #558b2f);
                          color: white;
                          border: none;
                          padding: 15px;
                          border-radius: 8px;
                          cursor: pointer;
                          font-size: 16px;
                          font-weight: 600;
                          transition: transform 0.2s ease;
                          box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
                        "
                        onmouseover="this.style.transform = 'scale(1.02)'"
                        onmouseout="this.style.transform = 'scale(1)'"
                      >
                        <span class="notranslate">ðŸ“¤</span> Post Rental
                        Requirement
                      </button>
                      <button
                        type="button"
                        onclick="hideRentalRequirementForm()"
                        style="
                          flex: 1;
                          background: #f5f5f5;
                          color: #333;
                          border: none;
                          padding: 15px;
                          border-radius: 8px;
                          cursor: pointer;
                          font-size: 16px;
                          font-weight: 600;
                          transition: background 0.2s ease;
                        "
                        onmouseover="this.style.background = '#e0e0e0'"
                        onmouseout="this.style.background = '#f5f5f5'"
                      >
                        <span class="notranslate">âŒ</span> Cancel
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Rental Requirements List -->
                <div id="rentalRequirementsList" style="margin-top: 30px">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 20px;
                      font-family: &quot;Times New Roman&quot;, Times, serif;
                    "
                  >
                    ðŸ“¢ Posted Rental Requirements
                  </h3>
                  <div id="rentalRequirementsContainer">
                    <!-- Rental Requirements will be displayed here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <script>
            // Initialize requirements from localStorage
            let customerRequirements =
              JSON.parse(localStorage.getItem("customerRequirements")) || [];

            // Display requirements on page load
            if (document.getElementById("requirementsContainer")) {
              displayRequirements();
            }

            function showRequirementForm() {
              document.getElementById(
                "requirementFormContainer",
              ).style.display = "block";
              document
                .getElementById("requirementFormContainer")
                .scrollIntoView({ behavior: "smooth", block: "nearest" });
            }

            function hideRequirementForm() {
              document.getElementById(
                "requirementFormContainer",
              ).style.display = "none";
              document.getElementById("requirementForm").reset();
            }

            function postRequirement(event) {
              event.preventDefault();

              // Get form values with validation - USING CORRECT IDs for Customer Requirements form
              const customerNameInput = document.getElementById("customerName");
              const productNameInput =
                document.getElementById("reqProductName");
              const quantityInput = document.getElementById("quantity");
              const quantityUnitInput = document.getElementById("quantityUnit");
              const locationInput = document.getElementById("location");
              const phoneNumberInput = document.getElementById("phoneNumber");
              const pinCodeInput = document.getElementById("reqPinCode");
              const specialInstructionsInput = document.getElementById("reqSpecialInstructions");
              const preferredDateInput = document.getElementById("reqPreferredDate");

              // Validate all fields exist
              if (
                !customerNameInput ||
                !productNameInput ||
                !quantityInput ||
                !locationInput ||
                !phoneNumberInput
              ) {
                alert("Error: Form fields not found. Please refresh the page.");
                console.error("Missing form fields:", {
                  customerName: !!customerNameInput,
                  productName: !!productNameInput,
                  quantity: !!quantityInput,
                  location: !!locationInput,
                  phoneNumber: !!phoneNumberInput,
                });
                return;
              }

              // Get and trim values
              const customerName = customerNameInput.value.trim();
              const productName = productNameInput.value.trim();
              const quantityNum = quantityInput.value.trim();
              const quantityUnit = quantityUnitInput ? quantityUnitInput.value : 'kg';
              const quantity = quantityNum + ' ' + quantityUnit;
              const location = locationInput.value.trim();
              const phoneNumber = phoneNumberInput.value.trim();
              const pinCode = pinCodeInput ? pinCodeInput.value.trim() : '';
              const specialInstructions = specialInstructionsInput ? specialInstructionsInput.value.trim() : '';
              const preferredDate = preferredDateInput ? preferredDateInput.value.trim() : '';

              // Validate required fields
              if (!customerName) {
                alert("Please enter your name");
                customerNameInput.focus();
                return;
              }
              if (!productName) {
                alert("âš ï¸ Please enter the product name - this is required!");
                productNameInput.focus();
                return;
              }
              if (!quantityNum) {
                alert("Please enter the quantity");
                quantityInput.focus();
                return;
              }
              if (!location) {
                alert("Please enter the location");
                locationInput.focus();
                return;
              }
              if (!phoneNumber) {
                alert("Please enter the phone number");
                phoneNumberInput.focus();
                return;
              }

              // Create requirement object
              const requirement = {
                id: Date.now(),
                customerName: customerName,
                productName: productName,
                quantity: quantity,
                location: location,
                phoneNumber: phoneNumber,
                pinCode: pinCode,
                specialInstructions: specialInstructions,
                preferredDeliveryDate: preferredDate,
                timestamp: new Date().toISOString(),
                datePosted: new Date().toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                }),
              };

              // Debug log - CHECK CONSOLE TO VERIFY
              console.log("=== POSTING CUSTOMER REQUIREMENT ===");
              console.log("Form ID used: reqProductName");
              console.log("Full Requirement Object:", requirement);
              console.log(
                "Product Name being saved:",
                `"${requirement.productName}"`,
              );
              console.log(
                "Product Name length:",
                requirement.productName.length,
              );
              console.log("Customer Name:", requirement.customerName);

              // Add to beginning of array
              customerRequirements.unshift(requirement);

              // Save to localStorage
              localStorage.setItem(
                "customerRequirements",
                JSON.stringify(customerRequirements),
              );
              console.log("âœ… Saved to localStorage");
              console.log(
                "Total requirements now:",
                customerRequirements.length,
              );

              // Verify what was saved
              const savedData = JSON.parse(
                localStorage.getItem("customerRequirements"),
              );
              console.log(
                "Verified saved product name:",
                `"${savedData[0].productName}"`,
              );
              console.log("First requirement:", savedData[0]);

              // Show success message
              showRequirementPopup(
                "âœ… Your requirement has been posted successfully and farmers will be notified!",
              );

              // Send notification to all users
              sendRequirementNotification(requirement);

              // Reset form and hide it
              hideRequirementForm();

              // Refresh the display
              displayRequirements();

              // Scroll carousel to the beginning to show new requirement
              setTimeout(() => {
                const track = document.getElementById("reqCarouselTrack");
                if (track) {
                  track.scrollTo({ left: 0, behavior: "smooth" });
                }
              }, 100);
            }

            function displayRequirements(filteredRequirements = null) {
              const container = document.getElementById(
                "requirementsContainer",
              );
              if (!container) return;

              const requirementsToShow =
                filteredRequirements || customerRequirements;

              if (requirementsToShow.length === 0) {
                container.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(85, 139, 47, 0.05)); border-radius: 15px; border: 2px dashed #2e7d32;">
                                <div style="font-size: 60px; margin-bottom: 20px;">ðŸ“‹</div>
                                <h3 style="color: #2e7d32; margin-bottom: 10px;">No Requirements Posted Yet</h3>
                                <p style="color: #666; font-size: 16px;">Be the first to post a requirement!</p>
                            </div>
                        `;
                return;
              }

              // Add the modal + styles if they don't exist yet
              if (!document.getElementById('reqDetailModal')) {
                const modalHtml = `
                  <div id="reqDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); z-index:9999; align-items:center; justify-content:center;" onclick="if(event.target===this)closeReqDetailModal()">
                    <div id="reqDetailModalContent" style="background:#fff; border-radius:20px; max-width:550px; width:92%; max-height:85vh; overflow-y:auto; box-shadow:0 25px 60px rgba(0,0,0,0.3); animation:reqSlideUp 0.4s cubic-bezier(0.16,1,0.3,1); position:relative;">
                    </div>
                  </div>
                  <style>
                    @keyframes reqSlideUp { from { opacity:0; transform:translateY(40px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }

                    /* ===== Horizontal Carousel Wrapper ===== */
                    .req-carousel-wrap { position:relative; width:100%; }
                    .req-carousel {
                      display:flex; gap:20px; overflow-x:auto; scroll-snap-type:x mandatory;
                      -webkit-overflow-scrolling:touch; padding:10px 4px 18px;
                      scrollbar-width:none; /* Firefox */
                    }
                    .req-carousel::-webkit-scrollbar { display:none; } /* Chrome/Safari */

                    /* Scroll indicators (left/right arrows) */
                    .req-scroll-btn {
                      position:absolute; top:50%; transform:translateY(-50%); z-index:5;
                      width:40px; height:40px; border-radius:50%; border:none;
                      background:rgba(46,125,50,0.9); color:#fff; font-size:20px; cursor:pointer;
                      box-shadow:0 4px 14px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center;
                      transition:all 0.2s ease; backdrop-filter:blur(4px);
                    }
                    .req-scroll-btn:hover { background:#1b5e20; transform:translateY(-50%) scale(1.12); }
                    .req-scroll-btn.left { left:-6px; }
                    .req-scroll-btn.right { right:-6px; }

                    /* ===== Card Styles ===== */
                    .req-card {
                      flex:0 0 370px; max-width:400px; min-height:400px;
                      scroll-snap-align:start;
                      display:flex; flex-direction:column; background:#fff; border-radius:18px; overflow:hidden;
                      box-shadow:0 4px 22px rgba(0,0,0,0.07); border:1px solid rgba(46,125,50,0.1);
                      transition:all 0.35s cubic-bezier(0.25,0.8,0.25,1); cursor:default;
                    }
                    .req-card:hover { transform:translateY(-5px); box-shadow:0 14px 40px rgba(46,125,50,0.18); border-color:rgba(46,125,50,0.25); }

                    .req-card-header { display:flex; justify-content:space-between; align-items:flex-start; padding:22px 24px 14px; gap:12px; }
                    .req-card-product { font-size:20px; font-weight:700; color:#1b5e20; margin:0; line-height:1.3; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
                    .req-card-date { font-size:12.5px; color:#999; margin-top:6px; display:flex; align-items:center; gap:4px; }
                    .req-card-contact-btn {
                      background:linear-gradient(135deg,#2e7d32,#43a047); color:#fff; border:none;
                      padding:10px 20px; border-radius:50px; font-size:14px; font-weight:600; cursor:pointer;
                      display:flex; align-items:center; gap:6px; white-space:nowrap;
                      box-shadow:0 3px 10px rgba(46,125,50,0.3); transition:all 0.25s ease; flex-shrink:0;
                    }
                    .req-card-contact-btn:hover { transform:scale(1.06); box-shadow:0 5px 16px rgba(46,125,50,0.4); background:linear-gradient(135deg,#1b5e20,#2e7d32); }
                    .req-card-contact-btn:active { transform:scale(0.97); }

                    .req-card-body { padding:0 24px 18px; display:flex; flex-direction:column; gap:10px; flex:1; }
                    .req-info-row { display:flex; align-items:center; gap:12px; padding:10px 14px; background:linear-gradient(135deg,rgba(46,125,50,0.04),rgba(129,199,132,0.06)); border-radius:10px; border:1px solid rgba(46,125,50,0.06); }
                    .req-info-icon { font-size:18px; width:24px; text-align:center; flex-shrink:0; }
                    .req-info-label { font-size:11px; color:#999; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; }
                    .req-info-value { font-size:15px; color:#2e7d32; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px; }

                    .req-card-footer { padding:14px 24px 20px; border-top:1px solid rgba(46,125,50,0.08); margin-top:auto; }
                    .req-details-btn {
                      width:100%; background:linear-gradient(135deg,rgba(46,125,50,0.08),rgba(46,125,50,0.13)); color:#2e7d32;
                      border:2px solid rgba(46,125,50,0.15); padding:12px; border-radius:12px;
                      font-size:15px; font-weight:600; cursor:pointer; transition:all 0.25s ease;
                      display:flex; align-items:center; justify-content:center; gap:8px;
                    }
                    .req-details-btn:hover { background:linear-gradient(135deg,#2e7d32,#43a047); color:#fff; border-color:#2e7d32; box-shadow:0 4px 15px rgba(46,125,50,0.3); }

                    /* Modal styles */
                    .req-modal-header { background:linear-gradient(135deg,#1b5e20,#2e7d32); color:#fff; padding:24px 28px; border-radius:20px 20px 0 0; position:relative; }
                    .req-modal-close { position:absolute; top:16px; right:18px; background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
                    .req-modal-close:hover { background:rgba(255,255,255,0.35); transform:rotate(90deg); }
                    .req-modal-body { padding:24px 28px 28px; }
                    .req-modal-row { display:flex; align-items:flex-start; gap:14px; padding:14px 0; border-bottom:1px solid #f0f0f0; }
                    .req-modal-row:last-child { border-bottom:none; }
                    .req-modal-icon { font-size:22px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; background:rgba(46,125,50,0.08); border-radius:10px; flex-shrink:0; }
                    .req-modal-label { font-size:12px; color:#999; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:2px; }
                    .req-modal-value { font-size:16px; color:#333; font-weight:600; }
                    .req-modal-call-btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:14px; background:linear-gradient(135deg,#2e7d32,#43a047); color:#fff; border:none; border-radius:14px; font-size:16px; font-weight:700; cursor:pointer; margin-top:8px; box-shadow:0 4px 15px rgba(46,125,50,0.3); transition:all 0.25s; }
                    .req-modal-call-btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(46,125,50,0.4); }

                    /* ===== Responsive ===== */
                    @media (max-width:600px) {
                      .req-card { flex:0 0 320px; max-width:340px; min-height:360px; }
                      .req-card-header { flex-direction:column; gap:8px; padding:16px 18px 10px; }
                      .req-card-contact-btn { align-self:flex-end; }
                      .req-card-product { font-size:17px; }
                      .req-card-body { padding:0 18px 14px; }
                      .req-card-footer { padding:12px 18px 16px; }
                      .req-scroll-btn { width:34px; height:34px; font-size:16px; }
                    }
                    @media (min-width:1200px) {
                      .req-card { flex:0 0 400px; max-width:430px; }
                    }
                  </style>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
              }

              // Helper: ensure quantity always shows a unit (default 'kg')
              function formatQty(q) {
                if (!q) return '0 kg';
                const s = String(q).trim();
                const units = ['kg','quintal','ton','pieces','dozen','litre','bags','piece','liter','liters','litres','tons','quintals','kgs'];
                const hasUnit = units.some(u => s.toLowerCase().endsWith(u));
                return hasUnit ? s : s + ' kg';
              }

              // Store current displayed data globally for modal access
              window._reqDisplayData = requirementsToShow;

              // Build carousel HTML with left/right scroll buttons
              const cardsHtml = requirementsToShow
                .map(
                  (req, index) => `
                    <div class="req-card" style="animation: fadeInUp 0.4s ease ${index * 0.06}s both;">
                      <!-- Header: Product Name + Date (left), Contact Button (top-right) -->
                      <div class="req-card-header">
                        <div style="flex:1; min-width:0;">
                          <h3 class="req-card-product">ðŸŒ¾ ${req.productName}</h3>
                          <p class="req-card-date">ðŸ“… ${req.datePosted || new Date(req.timestamp).toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'})}</p>
                        </div>
                        <button class="req-card-contact-btn" onclick="contactCustomer('${req.phoneNumber}')">
                          ðŸ“ž Contact
                        </button>
                      </div>

                      <!-- Body: Key info stacked vertically -->
                      <div class="req-card-body">
                        <div class="req-info-row">
                          <span class="req-info-icon">ðŸ“¦</span>
                          <div>
                            <div class="req-info-label">Quantity</div>
                            <div class="req-info-value">${formatQty(req.quantity)}</div>
                          </div>
                        </div>
                        <div class="req-info-row">
                          <span class="req-info-icon">ðŸ“</span>
                          <div>
                            <div class="req-info-label">Delivery Location</div>
                            <div class="req-info-value">${req.location}</div>
                          </div>
                        </div>
                        <div class="req-info-row">
                          <span class="req-info-icon">ðŸ“±</span>
                          <div>
                            <div class="req-info-label">Phone Number</div>
                            <div class="req-info-value">${req.phoneNumber}</div>
                          </div>
                        </div>
                      </div>

                      <!-- Footer: Full Details Button -->
                      <div class="req-card-footer">
                        <button class="req-details-btn" onclick="openReqDetails(${index})">
                          ðŸ“„ Full Details
                        </button>
                      </div>
                    </div>
                  `,
                )
                .join("");

              container.innerHTML = `
                <div class="req-carousel-wrap">
                  <button class="req-scroll-btn left" onclick="scrollReqCarousel(-1)" aria-label="Scroll left">&#8249;</button>
                  <div class="req-carousel" id="reqCarouselTrack">
                    ${cardsHtml}
                  </div>
                  <button class="req-scroll-btn right" onclick="scrollReqCarousel(1)" aria-label="Scroll right">&#8250;</button>
                </div>
              `;

              // Initialize touch/swipe support
              initReqCarouselSwipe();
            }

            // Scroll carousel by arrow buttons
            function scrollReqCarousel(direction) {
              const track = document.getElementById('reqCarouselTrack');
              if (!track) return;
              const scrollAmount = 350;
              track.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }

            // Touch swipe support for carousel
            function initReqCarouselSwipe() {
              const track = document.getElementById('reqCarouselTrack');
              if (!track) return;
              let startX = 0, startScrollLeft = 0, isDragging = false;

              track.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX - track.offsetLeft;
                startScrollLeft = track.scrollLeft;
                track.style.cursor = 'grabbing';
              });
              track.addEventListener('mouseleave', () => { isDragging = false; track.style.cursor = 'grab'; });
              track.addEventListener('mouseup', () => { isDragging = false; track.style.cursor = 'grab'; });
              track.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - track.offsetLeft;
                const walk = (x - startX) * 1.5;
                track.scrollLeft = startScrollLeft - walk;
              });

              // Touch events for mobile
              let touchStartX = 0;
              track.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
              track.addEventListener('touchmove', (e) => {
                const touchDiff = touchStartX - e.touches[0].clientX;
                if (Math.abs(touchDiff) > 5) {
                  // Let native scroll handle it, but prevent vertical page scroll interference
                }
              }, { passive: true });

              // Set initial cursor
              track.style.cursor = 'grab';
            }

            function showReqDetailModal(req) {
              const modal = document.getElementById('reqDetailModal');
              const content = document.getElementById('reqDetailModalContent');
              if (!modal || !content) return;

              // Format quantity with unit
              function fmtQty(q) {
                if (!q) return '0 kg';
                const s = String(q).trim();
                const units = ['kg','quintal','ton','pieces','dozen','litre','bags','piece','liter','liters','litres','tons','quintals','kgs'];
                return units.some(u => s.toLowerCase().endsWith(u)) ? s : s + ' kg';
              }

              const preferredDate = req.preferredDeliveryDate
                ? new Date(req.preferredDeliveryDate).toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'})
                : '';

              // Escape HTML to prevent XSS
              function esc(str) {
                if (!str) return '';
                const d = document.createElement('div');
                d.textContent = str;
                return d.innerHTML;
              }

              content.innerHTML = `
                <div class="req-modal-header">
                  <button class="req-modal-close" onclick="closeReqDetailModal()">&times;</button>
                  <h2 style="margin:0 0 4px; font-size:22px; font-weight:700;">ðŸŒ¾ ${esc(req.productName)}</h2>
                  <p style="margin:0; opacity:0.85; font-size:13px;">ðŸ“… Posted on ${esc(req.datePosted) || new Date(req.timestamp).toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'})}</p>
                </div>
                <div class="req-modal-body">
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ‘¤</div>
                    <div>
                      <div class="req-modal-label">Customer Name</div>
                      <div class="req-modal-value">${esc(req.customerName)}</div>
                    </div>
                  </div>
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ“±</div>
                    <div>
                      <div class="req-modal-label">Phone Number</div>
                      <div class="req-modal-value">${esc(req.phoneNumber)}</div>
                    </div>
                  </div>
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ“</div>
                    <div>
                      <div class="req-modal-label">Delivery Location</div>
                      <div class="req-modal-value">${esc(req.location)}</div>
                    </div>
                  </div>
                  ${req.pinCode ? `
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ“®</div>
                    <div>
                      <div class="req-modal-label">Pin Code</div>
                      <div class="req-modal-value">${esc(req.pinCode)}</div>
                    </div>
                  </div>` : ''}
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸŒ¾</div>
                    <div>
                      <div class="req-modal-label">Product Name</div>
                      <div class="req-modal-value">${esc(req.productName)}</div>
                    </div>
                  </div>
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ“¦</div>
                    <div>
                      <div class="req-modal-label">Quantity</div>
                      <div class="req-modal-value">${esc(fmtQty(req.quantity))}</div>
                    </div>
                  </div>
                  ${req.specialInstructions ? `
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ“</div>
                    <div>
                      <div class="req-modal-label">Special Instructions</div>
                      <div class="req-modal-value" style="font-weight:500; color:#555;">${esc(req.specialInstructions)}</div>
                    </div>
                  </div>` : ''}
                  ${preferredDate ? `
                  <div class="req-modal-row">
                    <div class="req-modal-icon">ðŸ—“ï¸</div>
                    <div>
                      <div class="req-modal-label">Preferred Delivery Date</div>
                      <div class="req-modal-value">${esc(preferredDate)}</div>
                    </div>
                  </div>` : ''}
                  <button class="req-modal-call-btn" onclick="contactCustomer('${esc(req.phoneNumber)}')">
                    ðŸ“ž Call ${esc(req.customerName)}
                  </button>
                </div>
              `;

              modal.style.display = 'flex';
              document.body.style.overflow = 'hidden';
            }

            // Open Full Details by index (avoids inline JSON breaking)
            function openReqDetails(index) {
              const data = window._reqDisplayData;
              if (data && data[index]) {
                showReqDetailModal(data[index]);
              }
            }

            function closeReqDetailModal() {
              const modal = document.getElementById('reqDetailModal');
              if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
              }
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
              if (e.key === 'Escape') closeReqDetailModal();
            });

            function searchRequirements() {
              const searchTerm = document
                .getElementById("requirementSearch")
                .value.toLowerCase()
                .trim();

              if (searchTerm === "") {
                displayRequirements();
                return;
              }

              const filteredRequirements = customerRequirements.filter(
                (req) =>
                  req.productName.toLowerCase().includes(searchTerm) ||
                  req.customerName.toLowerCase().includes(searchTerm) ||
                  req.location.toLowerCase().includes(searchTerm),
              );

              displayRequirements(filteredRequirements);
            }

            function contactCustomer(phoneNumber) {
              // Confirm before calling
              if (confirm(`Do you want to call ${phoneNumber}?`)) {
                // Initiate phone call
                window.location.href = `tel:${phoneNumber}`;
              }
            }

            function sendRequirementNotification(requirement) {
              // Create notification object
              const notification = {
                id: Date.now(),
                title: "ðŸ”” New Customer Requirement",
                message: `${requirement.customerName} is looking for ${requirement.productName} (${requirement.quantity})`,
                details: `Location: ${requirement.location}`,
                type: "requirement",
                timestamp: new Date().toISOString(),
                read: false,
                requirementId: requirement.id,
              };

              // Get existing notifications from localStorage
              let notifications =
                JSON.parse(localStorage.getItem("notifications")) || [];
              notifications.unshift(notification);
              localStorage.setItem(
                "notifications",
                JSON.stringify(notifications),
              );

              // Update notification badge
              updateNotificationBadge();

              // Show a popup notification
              showRequirementPopup(
                `ðŸ“¢ Notification sent to all farmers about ${requirement.productName} requirement!`,
              );
            }

            function sendProductNotification(product) {
              // Create notification object
              const notification = {
                id: Date.now(),
                title: "ðŸŒ¾ New Product Available!",
                message: `${product.name} is now available from ${product.farmer}`,
                details: `Price: â‚¹${product.price}/${product.unit} | Quantity: ${product.quantity} ${product.unit} | Location: ${product.farmerAddress || "Nearby"}`,
                type: "product",
                timestamp: new Date().toISOString(),
                read: false,
                productId: product.id,
              };

              // Get existing notifications from localStorage
              let notifications =
                JSON.parse(localStorage.getItem("notifications")) || [];
              notifications.unshift(notification);
              localStorage.setItem(
                "notifications",
                JSON.stringify(notifications),
              );

              // Update notification badge
              updateNotificationBadge();
            }

            function updateNotificationBadge() {
              const notifications =
                JSON.parse(localStorage.getItem("notifications")) || [];
              const unreadCount = notifications.filter((n) => !n.read).length;

              const badge = document.querySelector(".notification-badge");
              if (badge) {
                if (unreadCount > 0) {
                  badge.textContent = unreadCount > 99 ? "99+" : unreadCount;
                  badge.style.display = "block";
                } else {
                  badge.style.display = "none";
                }
              }
            }

            // Show popup notification
            function showRequirementPopup(message) {
              const popup = document.createElement("div");
              popup.innerHTML = message;
              popup.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #2e7d32, #558b2f);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 12px;
                        box-shadow: 0 8px 30px rgba(46, 125, 50, 0.4);
                        z-index: 10000;
                        font-size: 16px;
                        font-weight: 500;
                        animation: slideIn 0.5s ease-out;
                        max-width: 400px;
                    `;

              document.body.appendChild(popup);

              setTimeout(() => {
                popup.style.animation = "slideOut 0.5s ease-out";
                setTimeout(() => popup.remove(), 500);
              }, 4000);
            }

            // ========== RENTAL REQUIREMENTS FUNCTIONS ==========

            // Initialize rental requirements from localStorage
            let rentalRequirements =
              JSON.parse(localStorage.getItem("rentalRequirements")) || [];

            // Display rental requirements on page load
            if (document.getElementById("rentalRequirementsContainer")) {
              displayRentalRequirements();
            }

            // Tab switching function
            function switchRequirementTab(tab) {
              const productTab = document.getElementById("productReqTab");
              const rentalTab = document.getElementById("rentalReqTab");
              const productContent =
                document.getElementById("productReqContent");
              const rentalContent = document.getElementById("rentalReqContent");

              if (tab === "product") {
                productTab.style.background =
                  "linear-gradient(135deg, #2e7d32, #558b2f)";
                productTab.style.color = "white";
                productTab.style.boxShadow =
                  "0 4px 15px rgba(46, 125, 50, 0.3)";
                rentalTab.style.background = "#f5f5f5";
                rentalTab.style.color = "#666";
                rentalTab.style.boxShadow = "none";
                productContent.style.display = "block";
                rentalContent.style.display = "none";
              } else {
                rentalTab.style.background =
                  "linear-gradient(135deg, #2e7d32, #558b2f)";
                rentalTab.style.color = "white";
                rentalTab.style.boxShadow = "0 4px 15px rgba(46, 125, 50, 0.3)";
                productTab.style.background = "#f5f5f5";
                productTab.style.color = "#666";
                productTab.style.boxShadow = "none";
                rentalContent.style.display = "block";
                productContent.style.display = "none";
                displayRentalRequirements();
              }
            }

            function showRentalRequirementForm() {
              document.getElementById(
                "rentalRequirementFormContainer",
              ).style.display = "block";
              document
                .getElementById("rentalRequirementFormContainer")
                .scrollIntoView({ behavior: "smooth", block: "nearest" });
            }

            function hideRentalRequirementForm() {
              document.getElementById(
                "rentalRequirementFormContainer",
              ).style.display = "none";
              document.getElementById("rentalRequirementForm").reset();
            }

            function postRentalRequirement(event) {
              event.preventDefault();

              // Get form values
              const farmerName = document
                .getElementById("rentalFarmerName")
                .value.trim();
              const phoneNumber = document
                .getElementById("rentalPhoneNumber")
                .value.trim();
              const fieldArea = document
                .getElementById("rentalFieldArea")
                .value.trim();
              const cropType = document
                .getElementById("rentalCropType")
                .value.trim();
              const village = document
                .getElementById("rentalVillage")
                .value.trim();
              const mandal = document
                .getElementById("rentalMandal")
                .value.trim();
              const district = document
                .getElementById("rentalDistrict")
                .value.trim();
              const gps = document.getElementById("rentalGPS").value.trim();
              const category = document.getElementById("rentalCategory").value;
              const additionalNotes = document
                .getElementById("rentalAdditionalNotes")
                .value.trim();

              // Validate required fields
              if (!farmerName) {
                alert("Please enter farmer name");
                document.getElementById("rentalFarmerName").focus();
                return;
              }
              if (!phoneNumber || phoneNumber.length !== 10) {
                alert("Please enter a valid 10-digit phone number");
                document.getElementById("rentalPhoneNumber").focus();
                return;
              }
              if (!fieldArea || parseFloat(fieldArea) <= 0) {
                alert("Please enter a valid field area");
                document.getElementById("rentalFieldArea").focus();
                return;
              }
              if (!village || !mandal || !district) {
                alert(
                  "Please enter complete location details (Village, Mandal, District)",
                );
                return;
              }
              if (!category) {
                alert("Please select a rental category");
                document.getElementById("rentalCategory").focus();
                return;
              }

              // Create location string
              let location = `${village}, ${mandal}, ${district}`;
              if (gps) {
                location += ` (GPS: ${gps})`;
              }

              // Create rental requirement object
              const rentalRequirement = {
                id: Date.now(),
                farmerName: farmerName,
                phoneNumber: phoneNumber,
                fieldArea: fieldArea,
                cropType: cropType || "Not specified",
                village: village,
                mandal: mandal,
                district: district,
                gps: gps || "",
                location: location,
                category: category,
                additionalNotes: additionalNotes || "None",
                timestamp: new Date().toISOString(),
                datePosted: new Date().toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                }),
              };

              // Add to beginning of array
              rentalRequirements.unshift(rentalRequirement);

              // Save to localStorage
              localStorage.setItem(
                "rentalRequirements",
                JSON.stringify(rentalRequirements),
              );
              console.log("âœ… Rental requirement saved to localStorage");

              // Show success message
              showRequirementPopup(
                "âœ… Your rental requirement has been posted successfully!",
              );

              // Send notification
              sendRentalRequirementNotification(rentalRequirement);

              // Reset form and hide it
              hideRentalRequirementForm();

              // Refresh the display
              displayRentalRequirements();

              // Scroll to the new requirement
              setTimeout(() => {
                const container = document.getElementById(
                  "rentalRequirementsContainer",
                );
                if (container && container.firstChild) {
                  container.firstChild.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                  });
                }
              }, 100);
            }

            function displayRentalRequirements(filteredRequirements = null) {
              const container = document.getElementById(
                "rentalRequirementsContainer",
              );
              if (!container) return;

              const requirementsToShow =
                filteredRequirements || rentalRequirements;

              // Inject modal HTML and CSS if not already present
              if (!document.getElementById('rentalDetailModal')) {
                const modalHTML = `
                  <div id="rentalDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(5px);">
                    <div style="background:white; border-radius:20px; max-width:600px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:modalSlideIn 0.3s ease-out;">
                      <div style="position:sticky; top:0; background:linear-gradient(135deg, #2e7d32, #558b2f); color:white; padding:25px 30px; border-radius:20px 20px 0 0; display:flex; justify-content:space-between; align-items:center; z-index:10001;">
                        <h2 style="margin:0; font-size:24px; font-weight:700;">ðŸšœ Rental Requirement Details</h2>
                        <button onclick="closeRentalDetailModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Ã—</button>
                      </div>
                      <div id="rentalDetailModalContent" style="padding:30px;"></div>
                    </div>
                  </div>
                  <style>
                    @keyframes modalSlideIn { from { transform:translateY(-50px); opacity:0; } to { transform:translateY(0); opacity:1; } }
                    
                    .rental-carousel-wrap { position:relative; width:100%; overflow:hidden; }
                    .rental-carousel-track { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; gap:20px; padding:10px 5px 30px; scrollbar-width:thin; scrollbar-color:#2e7d32 #f0f0f0; }
                    .rental-carousel-track::-webkit-scrollbar { height:8px; }
                    .rental-carousel-track::-webkit-scrollbar-track { background:#f0f0f0; border-radius:10px; }
                    .rental-carousel-track::-webkit-scrollbar-thumb { background:#2e7d32; border-radius:10px; }
                    
                    .rental-card { flex:0 0 370px; max-width:400px; min-height:400px; background:white; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.12); scroll-snap-align:start; display:flex; flex-direction:column; transition:transform 0.3s ease, box-shadow 0.3s ease; cursor:pointer; overflow:hidden; border:2px solid transparent; }
                    .rental-card:hover { transform:translateY(-8px); box-shadow:0 12px 35px rgba(0,0,0,0.18); border-color:#2e7d32; }
                    
                    .rental-card-header { padding:22px 24px 14px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); border-bottom:2px solid rgba(46,125,50,0.15); }
                    .rental-card-title-section { flex:1; min-width:0; }
                    .rental-card-category { font-size:20px; font-weight:700; color:#2e7d32; margin:0 0 6px; line-height:1.3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
                    .rental-card-date { font-size:12.5px; color:#666; margin:0; }
                    .rental-contact-btn { background:linear-gradient(135deg, #2e7d32, #558b2f); color:white; border:none; padding:10px 20px; border-radius:20px; font-size:14px; font-weight:600; cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:6px; box-shadow:0 3px 10px rgba(46,125,50,0.3); transition:transform 0.2s ease, box-shadow 0.2s ease; }
                    .rental-contact-btn:hover { transform:scale(1.05); box-shadow:0 5px 15px rgba(46,125,50,0.4); }
                    
                    .rental-card-body { padding:0 24px 18px; display:flex; flex-direction:column; gap:10px; flex:1; }
                    .rental-info-row { background:rgba(46,125,50,0.06); border-radius:10px; padding:10px 14px; display:flex; align-items:center; gap:12px; border:1px solid rgba(46,125,50,0.12); transition:background 0.2s ease; }
                    .rental-info-row:hover { background:rgba(46,125,50,0.10); }
                    .rental-info-icon { font-size:18px; width:24px; text-align:center; flex-shrink:0; }
                    .rental-info-content { flex:1; min-width:0; }
                    .rental-info-label { font-size:11px; color:#666; margin:0 0 3px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; }
                    .rental-info-value { font-size:15px; font-weight:700; color:#2e7d32; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
                    
                    .rental-card-footer { padding:14px 24px 20px; border-top:2px solid rgba(46,125,50,0.1); }
                    .rental-details-btn { width:100%; background:linear-gradient(135deg, #2e7d32, #558b2f); color:white; border:none; padding:12px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 12px rgba(46,125,50,0.25); transition:transform 0.2s ease, box-shadow 0.2s ease; }
                    .rental-details-btn:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(46,125,50,0.35); }
                    
                    .rental-carousel-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(46,125,50,0.95); color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:24px; cursor:pointer; z-index:100; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
                    .rental-carousel-btn:hover { background:#2e7d32; transform:translateY(-50%) scale(1.1); box-shadow:0 6px 20px rgba(0,0,0,0.3); }
                    .rental-carousel-btn.left { left:10px; }
                    .rental-carousel-btn.right { right:10px; }
                    
                    @media (max-width:600px) {
                      .rental-card { flex:0 0 320px; max-width:340px; min-height:360px; }
                      .rental-carousel-btn { width:40px; height:40px; font-size:20px; }
                    }
                    @media (min-width:1200px) {
                      .rental-card { flex:0 0 400px; max-width:430px; }
                    }
                  </style>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add escape key listener
                document.addEventListener('keydown', function(e) {
                  if (e.key === 'Escape' && document.getElementById('rentalDetailModal').style.display === 'flex') {
                    closeRentalDetailModal();
                  }
                });
              }

              if (requirementsToShow.length === 0) {
                container.innerHTML = `
                  <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(85, 139, 47, 0.05)); border-radius: 15px; border: 2px dashed #2e7d32;">
                    <div style="font-size: 60px; margin-bottom: 20px;">ðŸšœ</div>
                    <h3 style="color: #2e7d32; margin-bottom: 10px;">No Rental Requirements Posted Yet</h3>
                    <p style="color: #666; font-size: 16px;">Be the first to post a rental requirement!</p>
                  </div>
                `;
                return;
              }

              // Store data globally for modal access
              window._rentalDisplayData = requirementsToShow;

              // Build carousel HTML
              let carouselHTML = `
                <div class="rental-carousel-wrap">
                  <button class="rental-carousel-btn left" onclick="scrollRentalCarousel('left')">â€¹</button>
                  <button class="rental-carousel-btn right" onclick="scrollRentalCarousel('right')">â€º</button>
                  <div class="rental-carousel-track" id="rentalCarouselTrack">
              `;

              requirementsToShow.forEach((req, index) => {
                carouselHTML += `
                  <div class="rental-card">
                    <div class="rental-card-header">
                      <div class="rental-card-title-section">
                        <h3 class="rental-card-category">ðŸšœ ${req.category}</h3>
                        <p class="rental-card-date">ðŸ“… ${req.datePosted}</p>
                      </div>
                      <button class="rental-contact-btn" onclick="event.stopPropagation(); contactRentalCustomer('${req.phoneNumber}')">
                        ðŸ“ž Contact
                      </button>
                    </div>
                    <div class="rental-card-body">
                      <div class="rental-info-row">
                        <div class="rental-info-icon">ðŸ‘¤</div>
                        <div class="rental-info-content">
                          <p class="rental-info-label">Farmer Name</p>
                          <p class="rental-info-value">${req.farmerName}</p>
                        </div>
                      </div>
                      <div class="rental-info-row">
                        <div class="rental-info-icon">ðŸŒ¾</div>
                        <div class="rental-info-content">
                          <p class="rental-info-label">Field Area</p>
                          <p class="rental-info-value">${req.fieldArea} acres</p>
                        </div>
                      </div>
                      <div class="rental-info-row">
                        <div class="rental-info-icon">ðŸ“</div>
                        <div class="rental-info-content">
                          <p class="rental-info-label">Location</p>
                          <p class="rental-info-value">${req.location}</p>
                        </div>
                      </div>
                      <div class="rental-info-row">
                        <div class="rental-info-icon">ðŸ“±</div>
                        <div class="rental-info-content">
                          <p class="rental-info-label">Phone Number</p>
                          <p class="rental-info-value">${req.phoneNumber}</p>
                        </div>
                      </div>
                    </div>
                    <div class="rental-card-footer">
                      <button class="rental-details-btn" onclick="openRentalDetails(${index})">
                        ðŸ“‹ Full Details
                      </button>
                    </div>
                  </div>
                `;
              });

              carouselHTML += `
                  </div>
                </div>
              `;

              container.innerHTML = carouselHTML;

              // Initialize swipe gesture support
              initRentalCarouselSwipe();
            }

            function searchRentalRequirements() {
              const searchTerm = document
                .getElementById("rentalRequirementSearch")
                .value.toLowerCase()
                .trim();

              if (searchTerm === "") {
                displayRentalRequirements();
                return;
              }

              const filteredRequirements = rentalRequirements.filter(
                (req) =>
                  req.category.toLowerCase().includes(searchTerm) ||
                  req.farmerName.toLowerCase().includes(searchTerm) ||
                  req.location.toLowerCase().includes(searchTerm) ||
                  req.cropType.toLowerCase().includes(searchTerm) ||
                  req.village.toLowerCase().includes(searchTerm) ||
                  req.mandal.toLowerCase().includes(searchTerm) ||
                  req.district.toLowerCase().includes(searchTerm),
              );

              displayRentalRequirements(filteredRequirements);
            }

            function contactRentalCustomer(phoneNumber) {
              if (confirm(`Do you want to call ${phoneNumber}?`)) {
                window.location.href = `tel:${phoneNumber}`;
              }
            }

            function openRentalDetails(index) {
              const data = window._rentalDisplayData;
              if (data && data[index]) {
                showRentalDetailModal(data[index]);
              }
            }

            function showRentalDetailModal(req) {
              // HTML escape helper
              function esc(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
              }

              const modal = document.getElementById('rentalDetailModal');
              const content = document.getElementById('rentalDetailModalContent');
              
              let detailsHTML = `
                <div style="display:flex; flex-direction:column; gap:18px;">
                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Farmer Name</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸ‘¤ ${esc(req.farmerName)}</p>
                  </div>

                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Phone Number</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸ“± ${esc(req.phoneNumber)}</p>
                  </div>

                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Rental Category</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸšœ ${esc(req.category)}</p>
                  </div>

                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Field Area</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸŒ¾ ${esc(req.fieldArea)} acres</p>
                  </div>

                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Crop Type</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸŒ± ${esc(req.cropType)}</p>
                  </div>

                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Location</p>
                    <p style="color:#2e7d32; font-size:20px; font-weight:700; margin:0;">ðŸ“ ${esc(req.location)}</p>
                  </div>
              `;

              // Add GPS if available
              if (req.gps && req.gps !== '') {
                detailsHTML += `
                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">GPS Coordinates</p>
                    <p style="color:#2e7d32; font-size:18px; font-weight:700; margin:0;">ðŸ“ ${esc(req.gps)}</p>
                  </div>
                `;
              }

              // Add additional notes if available
              if (req.additionalNotes && req.additionalNotes !== 'None') {
                detailsHTML += `
                  <div style="background:linear-gradient(135deg, rgba(46,125,50,0.08), rgba(85,139,47,0.05)); padding:18px; border-radius:12px; border-left:4px solid #2e7d32;">
                    <p style="color:#666; font-size:12px; margin:0 0 6px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Additional Notes</p>
                    <p style="color:#333; font-size:16px; line-height:1.6; margin:0;">${esc(req.additionalNotes)}</p>
                  </div>
                `;
              }

              detailsHTML += `
                  <button onclick="contactRentalCustomer('${esc(req.phoneNumber)}')" style="background:linear-gradient(135deg, #2e7d32, #558b2f); color:white; border:none; padding:16px; border-radius:12px; font-size:18px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 4px 15px rgba(46,125,50,0.3); transition:transform 0.2s ease, box-shadow 0.2s ease; margin-top:10px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(46,125,50,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(46,125,50,0.3)'">
                    ðŸ“ž Call Farmer
                  </button>
                </div>
              `;

              content.innerHTML = detailsHTML;
              modal.style.display = 'flex';
              document.body.style.overflow = 'hidden';
            }

            function closeRentalDetailModal() {
              const modal = document.getElementById('rentalDetailModal');
              if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
              }
            }

            function scrollRentalCarousel(direction) {
              const track = document.getElementById('rentalCarouselTrack');
              if (!track) return;
              
              const scrollAmount = 350;
              if (direction === 'left') {
                track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
              } else {
                track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
              }
            }

            function initRentalCarouselSwipe() {
              const track = document.getElementById('rentalCarouselTrack');
              if (!track) return;

              let isDown = false;
              let startX;
              let scrollLeft;

              track.addEventListener('mousedown', (e) => {
                isDown = true;
                track.style.cursor = 'grabbing';
                startX = e.pageX - track.offsetLeft;
                scrollLeft = track.scrollLeft;
              });

              track.addEventListener('mouseleave', () => {
                isDown = false;
                track.style.cursor = 'grab';
              });

              track.addEventListener('mouseup', () => {
                isDown = false;
                track.style.cursor = 'grab';
              });

              track.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - track.offsetLeft;
                const walk = (x - startX) * 2;
                track.scrollLeft = scrollLeft - walk;
              });

              // Touch events for mobile
              track.addEventListener('touchstart', (e) => {
                startX = e.touches[0].pageX - track.offsetLeft;
                scrollLeft = track.scrollLeft;
              }, { passive: true });

              track.addEventListener('touchmove', (e) => {
                const x = e.touches[0].pageX - track.offsetLeft;
                const walk = (x - startX) * 2;
                track.scrollLeft = scrollLeft - walk;
              }, { passive: true });
            }

            function sendRentalRequirementNotification(requirement) {
              const notification = {
                id: Date.now(),
                title: "ðŸšœ New Rental Requirement",
                message: `${requirement.farmerName} is looking for ${requirement.category}`,
                details: `Field Area: ${requirement.fieldArea} acres | Location: ${requirement.location}`,
                type: "rental-requirement",
                timestamp: new Date().toISOString(),
                read: false,
                requirementId: requirement.id,
              };

              let notifications =
                JSON.parse(localStorage.getItem("notifications")) || [];
              notifications.unshift(notification);
              localStorage.setItem(
                "notifications",
                JSON.stringify(notifications),
              );

              updateNotificationBadge();
              showRequirementPopup(
                `ðŸ“¢ Notification sent to all users about ${requirement.category} rental requirement!`,
              );
            }
          </script>

          <!-- Government Schemes Section -->
          <div id="dashSchemes" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 30px">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>
            </div>
            <div class="search-section">
              <h2
                style="
                  color: #2e7d32;
                  margin-bottom: 30px;
                  font-family: &quot;Poppins&quot;, sans-serif;
                  font-weight: 600;
                "
              >
                ðŸ›ï¸ Government Schemes & Subsidies
              </h2>

              <!-- Quick Links to Official Portals -->
              <div
                style="
                  background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
                  padding: 25px;
                  border-radius: 15px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  margin-bottom: 30px;
                "
              >
                <h3
                  style="
                    color: #2e7d32;
                    margin-bottom: 15px;
                    font-family: &quot;Poppins&quot;, sans-serif;
                    font-size: 18px;
                  "
                >
                  ðŸ“‹ Official Portals (Primary Sources)
                </h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                    gap: 12px;
                  "
                >
                  <a
                    href="https://www.india.gov.in"
                    target="_blank"
                    style="
                      padding: 10px 15px;
                      background: white;
                      border-radius: 8px;
                      text-decoration: none;
                      color: #2e7d32;
                      font-weight: 600;
                      font-size: 13px;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                    "
                    onmouseover="
                      this.style.borderColor = '#2e7d32';
                      this.style.transform = 'translateY(-2px)';
                    "
                    onmouseout="
                      this.style.borderColor = 'transparent';
                      this.style.transform = 'translateY(0)';
                    "
                    >ðŸ‡®ðŸ‡³ India Gov Schemes</a
                  >
                  <a
                    href="https://pmkisan.gov.in"
                    target="_blank"
                    style="
                      padding: 10px 15px;
                      background: white;
                      border-radius: 8px;
                      text-decoration: none;
                      color: #2e7d32;
                      font-weight: 600;
                      font-size: 13px;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                    "
                    onmouseover="
                      this.style.borderColor = '#2e7d32';
                      this.style.transform = 'translateY(-2px)';
                    "
                    onmouseout="
                      this.style.borderColor = 'transparent';
                      this.style.transform = 'translateY(0)';
                    "
                    >ðŸ’° PM Kisan</a
                  >
                  <a
                    href="https://pmfby.gov.in"
                    target="_blank"
                    style="
                      padding: 10px 15px;
                      background: white;
                      border-radius: 8px;
                      text-decoration: none;
                      color: #2e7d32;
                      font-weight: 600;
                      font-size: 13px;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                    "
                    onmouseover="
                      this.style.borderColor = '#2e7d32';
                      this.style.transform = 'translateY(-2px)';
                    "
                    onmouseout="
                      this.style.borderColor = 'transparent';
                      this.style.transform = 'translateY(0)';
                    "
                    >ðŸ›¡ï¸ PM Fasal Bima</a
                  >
                  <a
                    href="https://www.mygov.in/schemes/"
                    target="_blank"
                    style="
                      padding: 10px 15px;
                      background: white;
                      border-radius: 8px;
                      text-decoration: none;
                      color: #2e7d32;
                      font-weight: 600;
                      font-size: 13px;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                    "
                    onmouseover="
                      this.style.borderColor = '#2e7d32';
                      this.style.transform = 'translateY(-2px)';
                    "
                    onmouseout="
                      this.style.borderColor = 'transparent';
                      this.style.transform = 'translateY(0)';
                    "
                    >ðŸ“± MyGov Schemes</a
                  >
                </div>
                <p
                  style="
                    margin-top: 15px;
                    font-size: 12px;
                    color: #666;
                    font-style: italic;
                  "
                >
                  Copy URL from any portal above and paste in the form below to
                  extract schemes automatically
                </p>
              </div>

              <!-- Extraction Rules (JSON-only) -->
              <div
                style="
                  background: #fff;
                  padding: 20px 22px;
                  border-radius: 12px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                  margin-bottom: 25px;
                  border-left: 5px solid #2e7d32;
                "
              >
                <h4
                  style="
                    margin: 0 0 10px 0;
                    color: #2e7d32;
                    font-family: &quot;Poppins&quot;, sans-serif;
                  "
                >
                  AI Extraction Rules
                </h4>
                <p
                  style="
                    margin: 0 0 6px 0;
                    color: #444;
                    font-size: 14px;
                    line-height: 1.5;
                  "
                >
                  Extract ONLY Government Schemes & Subsidies for agriculture
                  and farmers.
                </p>
                <ul
                  style="
                    margin: 8px 0 0 18px;
                    padding: 0;
                    color: #444;
                    font-size: 13px;
                    line-height: 1.5;
                  "
                >
                  <li>
                    Primary sources: india.gov.in, pmkisan.gov.in, pmfby.gov.in,
                    mygov.in/schemes
                  </li>
                  <li>
                    Include: subsidies, irrigation, loans/credit, crop
                    insurance, seeds/fertilizers, rural development,
                    welfare/financial support, machinery subsidies
                  </li>
                  <li>
                    Return ONLY JSON array with: scheme_name, start_date,
                    end_date, description, benefits, eligibility,
                    required_documents, apply_link, official_website, state,
                    category, last_updated
                  </li>
                  <li>
                    Dates: YYYY-MM-DD; no end date â†’ "" ; unknown state â†’ "All
                    India"; if none â†’ []
                  </li>
                  <li>
                    No invented data, no ads/menus, no explanations;
                    single-paragraph text per field
                  </li>
                </ul>
              </div>

              <!-- Input Form -->
              <div
                style="
                  background: white;
                  padding: 30px;
                  border-radius: 15px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  margin-bottom: 30px;
                "
              >
                <h3
                  style="
                    color: #2e7d32;
                    margin-bottom: 20px;
                    font-family: &quot;Poppins&quot;, sans-serif;
                  "
                >
                  Extract Schemes from Web Content
                </h3>
                <div style="margin-bottom: 20px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 8px;
                      font-weight: 600;
                      color: #333;
                    "
                    >Website URL (Optional)</label
                  >
                  <input
                    type="url"
                    id="schemeUrl"
                    placeholder="https://example.com/government-schemes"
                    style="
                      width: 100%;
                      padding: 12px;
                      border: 2px solid #e0e0e0;
                      border-radius: 8px;
                      font-size: 14px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                    "
                  />
                </div>
                <div style="margin-bottom: 20px">
                  <label
                    style="
                      display: block;
                      margin-bottom: 8px;
                      font-weight: 600;
                      color: #333;
                    "
                    >Or Paste Content Here</label
                  >
                  <textarea
                    id="schemeContent"
                    rows="6"
                    placeholder="Paste the webpage content or article text here..."
                    style="
                      width: 100%;
                      padding: 12px;
                      border: 2px solid #e0e0e0;
                      border-radius: 8px;
                      font-size: 14px;
                      font-family: &quot;Poppins&quot;, sans-serif;
                      resize: vertical;
                    "
                  ></textarea>
                </div>
                <button
                  onclick="extractSchemes()"
                  style="
                    background: linear-gradient(135deg, #2e7d32, #558b2f);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: &quot;Poppins&quot;, sans-serif;
                  "
                >
                  ðŸ” Extract Schemes
                </button>
                <div
                  id="schemeExtractLoading"
                  style="
                    display: none;
                    margin-top: 20px;
                    text-align: center;
                    color: #2e7d32;
                  "
                >
                  <div
                    style="
                      display: inline-block;
                      width: 40px;
                      height: 40px;
                      border: 4px solid #f3f3f3;
                      border-top: 4px solid #2e7d32;
                      border-radius: 50%;
                      animation: spin 1s linear infinite;
                    "
                  ></div>
                  <p style="margin-top: 10px">Extracting schemes...</p>
                </div>
              </div>

              <!-- Saved Schemes List -->
              <div
                style="
                  background: white;
                  padding: 30px;
                  border-radius: 15px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                  "
                >
                  <h3
                    style="
                      color: #2e7d32;
                      margin: 0;
                      font-family: &quot;Poppins&quot;, sans-serif;
                    "
                  >
                    Saved Schemes
                  </h3>
                  <button
                    onclick="loadSchemes()"
                    style="
                      background: #f5f5f5;
                      border: 2px solid #2e7d32;
                      color: #2e7d32;
                      padding: 8px 20px;
                      border-radius: 8px;
                      font-size: 14px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      font-family: &quot;Poppins&quot;, sans-serif;
                    "
                  >
                    ðŸ”„ Refresh
                  </button>
                </div>
                <div id="schemesList" style="display: grid; gap: 20px">
                  <!-- Schemes will be loaded here -->
                </div>
              </div>
            </div>

            <style>
              @keyframes spin {
                0% {
                  transform: rotate(0deg);
                }
                100% {
                  transform: rotate(360deg);
                }
              }
              .scheme-card {
                border: 2px solid #e0e0e0;
                border-radius: 12px;
                padding: 20px;
                transition: all 0.3s ease;
                background: #fafafa;
              }
              .scheme-card:hover {
                box-shadow: 0 6px 20px rgba(46, 125, 50, 0.15);
                border-color: #2e7d32;
                transform: translateY(-2px);
              }
              .scheme-header {
                display: flex;
                justify-content: space-between;
                align-items: start;
                margin-bottom: 15px;
              }
              .scheme-name {
                font-size: 20px;
                font-weight: 700;
                color: #2e7d32;
                margin: 0 0 10px 0;
                font-family: "Poppins", sans-serif;
              }
              .scheme-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                margin-left: 10px;
              }
              .scheme-badge.active {
                background: #4caf50;
                color: white;
              }
              .scheme-badge.expired {
                background: #f44336;
                color: white;
              }
              .scheme-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
              }
              .scheme-info-item {
                display: flex;
                flex-direction: column;
              }
              .scheme-info-label {
                font-weight: 600;
                color: #666;
                font-size: 13px;
                margin-bottom: 5px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
              }
              .scheme-info-value {
                color: #333;
                font-size: 14px;
                line-height: 1.6;
              }
              .scheme-actions {
                margin-top: 15px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              }
              .scheme-btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: "Poppins", sans-serif;
                text-decoration: none;
                display: inline-block;
              }
              .scheme-btn.primary {
                background: #2e7d32;
                color: white;
              }
              .scheme-btn.primary:hover {
                background: #1b5e20;
              }
              .scheme-btn.danger {
                background: #f44336;
                color: white;
              }
              .scheme-btn.danger:hover {
                background: #d32f2f;
              }
              .scheme-btn.secondary {
                background: #2196f3;
                color: white;
              }
              .scheme-btn.secondary:hover {
                background: #1976d2;
              }
            </style>

            <script>
              async function extractSchemes() {
                const url = document.getElementById("schemeUrl").value.trim();
                const content = document
                  .getElementById("schemeContent")
                  .value.trim();
                const loadingDiv = document.getElementById(
                  "schemeExtractLoading",
                );

                if (!url && !content) {
                  alert("Please provide either a URL or paste content");
                  return;
                }

                loadingDiv.style.display = "block";

                try {
                  const response = await fetch("/api/schemes/extract", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      url: url,
                      content: content,
                    }),
                  });

                  const data = await response.json();
                  loadingDiv.style.display = "none";

                  if (data.success) {
                    if (data.schemes && data.schemes.length > 0) {
                      // Show extracted schemes and allow saving
                      displayExtractedSchemes(
                        data.schemes,
                        data.source,
                        data.url,
                      );
                      // Clear form after successful extraction
                      document.getElementById("schemeUrl").value = "";
                      document.getElementById("schemeContent").value = "";
                    } else {
                      // Empty array returned (no schemes found)
                      const schemesList =
                        document.getElementById("schemesList");
                      let html =
                        '<div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">';
                      html +=
                        '<strong style="color: #856404;">âš ï¸ No Schemes Found</strong>';
                      html += `<p style="color: #856404; margin-top: 10px; margin-bottom: 0;">${data.message || "No government schemes were found in the provided content."}</p>`;
                      html +=
                        '<p style="color: #666; margin-top: 10px; font-size: 13px;">Tip: Try using URLs from the recommended portals above, or paste content from official government scheme pages.</p>';
                      html += "</div>";
                      schemesList.innerHTML = html;
                    }
                  } else {
                    const errorMsg =
                      data.message || "Extraction failed. Please try again.";
                    alert(
                      errorMsg +
                        "\n\nTip: Try using URLs from the recommended portals above, or paste content from official government scheme pages.",
                    );
                  }
                } catch (error) {
                  loadingDiv.style.display = "none";
                  alert(
                    "Error extracting schemes: " +
                      error.message +
                      "\n\nPlease check your internet connection and try again.",
                  );
                }
              }

              function displayExtractedSchemes(schemes, source, url) {
                const schemesList = document.getElementById("schemesList");
                let html =
                  '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += `<strong style="color: #2e7d32;">âœ… Successfully extracted ${schemes.length} scheme(s)</strong>`;
                if (source && source !== "Unknown") {
                  html += `<br><span style="color: #666; font-size: 13px;">Source: ${source}</span>`;
                }
                if (url) {
                  html += `<br><a href="${url}" target="_blank" style="color: #2196F3; font-size: 12px; text-decoration: none;">View Source â†’</a>`;
                }
                html += "</div>";
                html +=
                  '<h4 style="color: #2e7d32; margin-bottom: 15px;">Extracted Schemes (Click Card to Save)</h4>';
                html +=
                  '<p style="color: #666; font-size: 12px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;"><strong>ðŸ“‹ JSON Structure:</strong> Each scheme contains: scheme_name, start_date, end_date, description, benefits, eligibility, required_documents, apply_link, official_website, state, category, last_updated</p>';

                schemes.forEach((scheme, index) => {
                  const isExpired =
                    scheme.end_date &&
                    scheme.end_date !== "" &&
                    new Date(scheme.end_date) < new Date();
                  html += `
                                <div class="scheme-card" style="cursor: pointer;" onclick="saveScheme(${index})" title="Click to save this scheme">
                                    <div class="scheme-header">
                                        <div>
                                            <h4 class="scheme-name">${escapeHtml(scheme.scheme_name || "Unnamed Scheme")}</h4>
                                            <span class="scheme-badge ${isExpired ? "expired" : "active"}">
                                                ${isExpired ? "Expired" : "Active"}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    ${scheme.description ? `<div style="margin-bottom: 15px;"><span class="scheme-info-label">Description</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.description)}</p></div>` : ""}
                                    
                                    <!-- All Fields Grid -->
                                    <div class="scheme-info">
                                        ${scheme.start_date ? `<div class="scheme-info-item"><span class="scheme-info-label">Start Date</span><span class="scheme-info-value">${escapeHtml(scheme.start_date)}</span></div>` : ""}
                                        ${scheme.end_date ? `<div class="scheme-info-item"><span class="scheme-info-label">End Date</span><span class="scheme-info-value">${escapeHtml(scheme.end_date)}</span></div>` : `<div class="scheme-info-item"><span class="scheme-info-label">End Date</span><span class="scheme-info-value" style="color: #4caf50; font-weight: 600;">Ongoing</span></div>`}
                                        ${scheme.state ? `<div class="scheme-info-item"><span class="scheme-info-label">State</span><span class="scheme-info-value">${escapeHtml(scheme.state)}</span></div>` : '<div class="scheme-info-item"><span class="scheme-info-label">State</span><span class="scheme-info-value">All India</span></div>'}
                                        ${scheme.category ? `<div class="scheme-info-item"><span class="scheme-info-label">Category</span><span class="scheme-info-value">${escapeHtml(scheme.category)}</span></div>` : ""}
                                        ${scheme.last_updated ? `<div class="scheme-info-item"><span class="scheme-info-label">Last Updated</span><span class="scheme-info-value">${escapeHtml(scheme.last_updated)}</span></div>` : ""}
                                    </div>
                                    
                                    <!-- Benefits -->
                                    ${scheme.benefits ? `<div style="margin-top: 15px; padding: 12px; background: #f1f8e9; border-radius: 8px; border-left: 4px solid #4caf50;"><span class="scheme-info-label">Benefits</span><p style="color: #333; margin-top: 5px; line-height: 1.6; font-weight: 500;">${escapeHtml(scheme.benefits)}</p></div>` : ""}
                                    
                                    <!-- Eligibility -->
                                    ${scheme.eligibility ? `<div style="margin-top: 15px;"><span class="scheme-info-label">Eligibility</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.eligibility)}</p></div>` : ""}
                                    
                                    <!-- Required Documents -->
                                    ${scheme.required_documents ? `<div style="margin-top: 15px;"><span class="scheme-info-label">Required Documents</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.required_documents)}</p></div>` : ""}
                                    
                                    <!-- Links -->
                                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                        ${scheme.apply_link ? `<a href="${escapeHtml(scheme.apply_link)}" target="_blank" class="scheme-btn primary" onclick="event.stopPropagation();">Apply Now</a>` : ""}
                                        ${scheme.official_website ? `<a href="${escapeHtml(scheme.official_website)}" target="_blank" class="scheme-btn secondary" onclick="event.stopPropagation();">Official Website</a>` : ""}
                                    </div>
                                    
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                        <small style="color: #999; font-style: italic;">ðŸ’¾ Click anywhere on this card to save</small>
                                    </div>
                                </div>
                            `;
                });

                schemesList.innerHTML = html;
                window.extractedSchemesData = schemes;
              }

              function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
              }

              async function saveScheme(index) {
                const scheme = window.extractedSchemesData[index];
                if (!scheme) return;

                if (
                  !confirm(`Save "${scheme.scheme_name}" to your schemes list?`)
                ) {
                  return;
                }

                try {
                  const response = await fetch("/api/schemes", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(scheme),
                  });

                  const data = await response.json();

                  if (data.success) {
                    alert("Scheme saved successfully!");
                    loadSchemes();
                  } else {
                    alert("Error saving scheme: " + data.message);
                  }
                } catch (error) {
                  alert("Error saving scheme: " + error.message);
                }
              }

              async function loadSchemes() {
                const schemesList = document.getElementById("schemesList");
                schemesList.innerHTML =
                  '<p style="text-align: center; color: #666;">Loading schemes...</p>';

                try {
                  const response = await fetch("/api/schemes");
                  const data = await response.json();

                  if (data.success && data.schemes && data.schemes.length > 0) {
                    let html = "";
                    data.schemes.forEach((scheme) => {
                      const isExpired =
                        scheme.end_date &&
                        scheme.end_date !== "" &&
                        new Date(scheme.end_date) < new Date();
                      html += `
                                        <div class="scheme-card">
                                            <div class="scheme-header">
                                                <div>
                                                    <h4 class="scheme-name">${escapeHtml(scheme.scheme_name || "Unnamed Scheme")}</h4>
                                                    <span class="scheme-badge ${isExpired ? "expired" : "active"}">
                                                        ${isExpired ? "Expired" : "Active"}
                                                    </span>
                                                </div>
                                                <button class="scheme-btn danger" onclick="deleteScheme(${scheme.id}); event.stopPropagation();" style="font-size: 12px; padding: 6px 12px;">Delete</button>
                                            </div>
                                            
                                            <!-- Description -->
                                            ${scheme.description ? `<div style="margin-bottom: 15px;"><span class="scheme-info-label">Description</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.description)}</p></div>` : ""}
                                            
                                            <!-- All Fields Grid -->
                                            <div class="scheme-info">
                                                ${scheme.start_date ? `<div class="scheme-info-item"><span class="scheme-info-label">Start Date</span><span class="scheme-info-value">${escapeHtml(scheme.start_date)}</span></div>` : ""}
                                                ${scheme.end_date ? `<div class="scheme-info-item"><span class="scheme-info-label">End Date</span><span class="scheme-info-value">${escapeHtml(scheme.end_date)}</span></div>` : '<div class="scheme-info-item"><span class="scheme-info-label">End Date</span><span class="scheme-info-value" style="color: #4caf50; font-weight: 600;">Ongoing</span></div>'}
                                                ${scheme.state ? `<div class="scheme-info-item"><span class="scheme-info-label">State</span><span class="scheme-info-value">${escapeHtml(scheme.state)}</span></div>` : '<div class="scheme-info-item"><span class="scheme-info-label">State</span><span class="scheme-info-value">All India</span></div>'}
                                                ${scheme.category ? `<div class="scheme-info-item"><span class="scheme-info-label">Category</span><span class="scheme-info-value">${escapeHtml(scheme.category)}</span></div>` : ""}
                                                ${scheme.last_updated ? `<div class="scheme-info-item"><span class="scheme-info-label">Last Updated</span><span class="scheme-info-value">${escapeHtml(scheme.last_updated)}</span></div>` : ""}
                                            </div>
                                            
                                            <!-- Benefits -->
                                            ${scheme.benefits ? `<div style="margin-top: 15px; padding: 12px; background: #f1f8e9; border-radius: 8px; border-left: 4px solid #4caf50;"><span class="scheme-info-label">Benefits</span><p style="color: #333; margin-top: 5px; line-height: 1.6; font-weight: 500;">${escapeHtml(scheme.benefits)}</p></div>` : ""}
                                            
                                            <!-- Eligibility -->
                                            ${scheme.eligibility ? `<div style="margin-top: 15px;"><span class="scheme-info-label">Eligibility</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.eligibility)}</p></div>` : ""}
                                            
                                            <!-- Required Documents -->
                                            ${scheme.required_documents ? `<div style="margin-top: 15px;"><span class="scheme-info-label">Required Documents</span><p style="color: #666; margin-top: 5px; line-height: 1.6;">${escapeHtml(scheme.required_documents)}</p></div>` : ""}
                                            
                                            <!-- Links -->
                                            <div class="scheme-actions" style="margin-top: 15px;">
                                                ${scheme.apply_link ? `<a href="${escapeHtml(scheme.apply_link)}" target="_blank" class="scheme-btn primary" onclick="event.stopPropagation();">Apply Now</a>` : ""}
                                                ${scheme.official_website ? `<a href="${escapeHtml(scheme.official_website)}" target="_blank" class="scheme-btn secondary" onclick="event.stopPropagation();">Official Website</a>` : ""}
                                            </div>
                                        </div>
                                    `;
                    });
                    schemesList.innerHTML = html;
                  } else {
                    schemesList.innerHTML =
                      '<p style="text-align: center; color: #666;">No schemes saved yet. Extract schemes from web content to get started.</p>';
                  }
                } catch (error) {
                  schemesList.innerHTML =
                    '<p style="text-align: center; color: #f44336;">Error loading schemes: ' +
                    error.message +
                    "</p>";
                }
              }

              async function deleteScheme(schemeId) {
                if (!confirm("Are you sure you want to delete this scheme?")) {
                  return;
                }

                try {
                  const response = await fetch(`/api/schemes/${schemeId}`, {
                    method: "DELETE",
                  });

                  const data = await response.json();

                  if (data.success) {
                    alert("Scheme deleted successfully!");
                    loadSchemes();
                  } else {
                    alert("Error deleting scheme: " + data.message);
                  }
                } catch (error) {
                  alert("Error deleting scheme: " + error.message);
                }
              }
            </script>
          </div>

          <!-- Profile Section -->
          <div id="dashProfile" class="dash-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 30px; background: #f8f9fa">
              <button
                class="back-to-home-btn"
                onclick="switchDashSection('home')"
                style="margin-bottom: 30px"
              >
                <span>â†</span>
                <span>Back to Home</span>
              </button>

            <!-- Profile Header -->
            <div style="margin-bottom: 30px">
              <div
                id="profileHeader"
                style="
                  background: white;
                  border-radius: 16px;
                  padding: 40px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                  border: 1px solid #e0e0e0;
                "
              >

                <div style="display: flex; align-items: center; gap: 40px; flex-wrap: wrap">
                  <!-- Profile Photo -->
                  <div style="position: relative; flex-shrink: 0">
                    <div
                      id="profilePhotoContainer"
                      style="
                        width: 120px;
                        height: 120px;
                        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 60px;
                        border: 4px solid #4caf50;
                        overflow: hidden;
                        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
                      "
                    >
                      <span class="notranslate">ðŸ‘¤</span>
                    </div>
                    <input
                      type="file"
                      id="profileImageUpload"
                      accept="image/*"
                      style="display: none"
                      onchange="handleProfileImageUpload(event)"
                    />
                    <button
                      onclick="document.getElementById('profileImageUpload').click()"
                      id="profileImageEditBtn"
                      style="
                        position: absolute;
                        bottom: 0;
                        right: 0;
                        background: #4caf50;
                        border: 3px solid white;
                        border-radius: 50%;
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        font-size: 16px;
                        color: white;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        transition: all 0.3s ease;
                      "
                      onmouseover="this.style.transform = 'scale(1.1)'"
                      onmouseout="this.style.transform = 'scale(1)'"
                    >
                      <span class="notranslate">ðŸ“·</span>
                    </button>
                  </div>

                  <!-- Profile Info -->
                  <div style="flex: 1; min-width: 300px">
                    <h1
                      id="profileFullName"
                      style="
                        font-size: 32px;
                        margin: 0 0 15px 0;
                        font-family: 'Poppins', sans-serif;
                        font-weight: 700;
                        color: #2e7d32;
                      "
                    >
                      Guest User
                    </h1>

                    <!-- User Type Badge & Verified Mobile -->
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px">
                      <div style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3)">
                        <span class="notranslate">ðŸ‘¤</span>
                        <span id="profileUserType">Farmer</span>
                      </div>
                      <div style="display: inline-flex; align-items: center; gap: 8px; background: #e8f5e9; color: #2e7d32; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; border: 1px solid #4caf50">
                        <span class="notranslate">ðŸ“±</span>
                        <span id="profileMobile">+91 0000000000</span>
                        <span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700">âœ“ Verified</span>
                      </div>
                    </div>

                    <!-- Location, Language, Member Since -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px">
                      <div style="display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 10px 16px; border-radius: 12px; border: 1px solid #e0e0e0">
                        <span class="notranslate" style="font-size: 20px">ðŸ“</span>
                        <span id="profileLocation" style="font-size: 14px; font-weight: 500; color: #555">Location not set</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 10px 16px; border-radius: 12px; border: 1px solid #e0e0e0">
                        <span class="notranslate" style="font-size: 20px">ðŸŒ</span>
                        <span id="profileLanguage" style="font-size: 14px; font-weight: 500; color: #555">English</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 10px 16px; border-radius: 12px; border: 1px solid #e0e0e0">
                        <span class="notranslate" style="font-size: 20px">ðŸ“…</span>
                        <span id="profileMemberSince" style="font-size: 14px; font-weight: 500; color: #555">Member since: Loading...</span>
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; flex-wrap: wrap">
                      <button
                        onclick="editProfileInfo()"
                        id="editProfileBtn"
                        style="
                          background: linear-gradient(135deg, #4caf50, #2e7d32);
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 12px;
                          font-size: 15px;
                          font-weight: 600;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
                        "
                        onmouseover="this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 6px 15px rgba(76, 175, 80, 0.4)'"
                        onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 3px 10px rgba(76, 175, 80, 0.3)'"
                      >
                        <span class="notranslate">âœï¸</span> Edit Details
                      </button>
                      <button
                        onclick="logout()"
                        id="logoutProfileBtn"
                        style="
                          background: #f44336;
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 12px;
                          font-size: 15px;
                          font-weight: 600;
                          cursor: pointer;
                          transition: all 0.3s ease;
                          box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
                        "
                        onmouseover="this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 6px 15px rgba(244, 67, 54, 0.4)'"
                        onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 3px 10px rgba(244, 67, 54, 0.3)'"
                      >
                        <span class="notranslate">ðŸšª</span> Logout
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Summary Cards -->
            <div style="margin-bottom: 30px">
              <h2 style="color: #2e7d32; margin-bottom: 20px; font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700">
                <span class="notranslate">ðŸ“Š</span> Quick Summary
              </h2>
              <div
                id="profileSummaryCards"
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                  gap: 20px;
                "
              >
                <!-- Products Posted Card -->
                <div onclick="switchDashSection('create')" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); cursor: pointer; transition: all 0.3s ease; border: 1px solid #e0e0e0; text-align: center" onmouseover="this.style.transform = 'translateY(-4px)'; this.style.boxShadow = '0 6px 16px rgba(76, 175, 80, 0.2)'" onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)'">
                  <div style="font-size: 40px; margin-bottom: 12px">ðŸŒ¾</div>
                  <div id="productsPostedCount" style="font-size: 28px; font-weight: 700; color: #2e7d32; font-family: 'Poppins', sans-serif; margin-bottom: 6px">0</div>
                  <div style="font-size: 14px; color: #666; font-weight: 600">Products Posted</div>
                </div>

                <!-- Rental Items Card -->
                <div onclick="switchDashSection('rentals')" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); cursor: pointer; transition: all 0.3s ease; border: 1px solid #e0e0e0; text-align: center" onmouseover="this.style.transform = 'translateY(-4px)'; this.style.boxShadow = '0 6px 16px rgba(33, 150, 243, 0.2)'" onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)'">
                  <div style="font-size: 40px; margin-bottom: 12px">ðŸšœ</div>
                  <div id="rentalsPostedCount" style="font-size: 28px; font-weight: 700; color: #2196f3; font-family: 'Poppins', sans-serif; margin-bottom: 6px">0</div>
                  <div style="font-size: 14px; color: #666; font-weight: 600">Rental Items</div>
                </div>

                <!-- Requirements Card -->
                <div onclick="switchDashSection('requirements')" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); cursor: pointer; transition: all 0.3s ease; border: 1px solid #e0e0e0; text-align: center" onmouseover="this.style.transform = 'translateY(-4px)'; this.style.boxShadow = '0 6px 16px rgba(255, 152, 0, 0.2)'" onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)'">
                  <div style="font-size: 40px; margin-bottom: 12px">ðŸ“¦</div>
                  <div id="requirementsPostedCount" style="font-size: 28px; font-weight: 700; color: #ff9800; font-family: 'Poppins', sans-serif; margin-bottom: 6px">0</div>
                  <div style="font-size: 14px; color: #666; font-weight: 600">Requirements</div>
                </div>

                <!-- Feedback Received Card -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e0e0e0; text-align: center">
                  <div style="font-size: 40px; margin-bottom: 12px">â­</div>
                  <div id="feedbackReceivedCount" style="font-size: 28px; font-weight: 700; color: #ffc107; font-family: 'Poppins', sans-serif; margin-bottom: 6px">0</div>
                  <div style="font-size: 14px; color: #666; font-weight: 600">Feedback Received</div>
                </div>

                <!-- Saved Items Card -->
                <div onclick="switchDashSection('favorites')" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); cursor: pointer; transition: all 0.3s ease; border: 1px solid #e0e0e0; text-align: center" onmouseover="this.style.transform = 'translateY(-4px)'; this.style.boxShadow = '0 6px 16px rgba(233, 30, 99, 0.2)'" onmouseout="this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)'">
                  <div style="font-size: 40px; margin-bottom: 12px">â¤ï¸</div>
                  <div id="savedItemsCount" style="font-size: 28px; font-weight: 700; color: #e91e63; font-family: 'Poppins', sans-serif; margin-bottom: 6px">0</div>
                  <div style="font-size: 14px; color: #666; font-weight: 600">Saved Items</div>
                </div>
              </div>
            </div>

            <!-- My Posts Section -->
            <div style="margin-bottom: 30px">
              <div
                style="
                  background: white;
                  border-radius: 16px;
                  padding: 30px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                  border: 1px solid #e0e0e0;
                "
              >
                <h2
                  style="
                    color: #2e7d32;
                    margin-bottom: 25px;
                    font-family: 'Poppins', sans-serif;
                    font-size: 24px;
                    font-weight: 700;
                  "
                >
                  ðŸ“¦ My Posts
                </h2>

                <!-- Tab Navigation -->
                <div
                  style="
                    display: flex;
                    gap: 8px;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #e0e0e0;
                    flex-wrap: wrap;
                    position: relative;
                  "
                >
                  <button
                    class="profile-tab-btn active"
                    data-tab="products"
                    onclick="switchProfileTab('products')"
                    style="
                      padding: 14px 26px;
                      background: transparent;
                      border: none;
                      border-bottom: 4px solid #4caf50;
                      color: #2e7d32;
                      font-size: 16px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      position: relative;
                      margin-bottom: -2px;
                    "
                  >
                    <span class="notranslate">ðŸŒ¾</span> My Products
                  </button>
                  <button
                    class="profile-tab-btn"
                    data-tab="rentals"
                    onclick="switchProfileTab('rentals')"
                    style="
                      padding: 14px 26px;
                      background: transparent;
                      border: none;
                      border-bottom: 4px solid transparent;
                      color: #666;
                      font-size: 16px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      position: relative;
                      margin-bottom: -2px;
                    "
                  >
                    <span class="notranslate">ðŸšœ</span> My Rentals
                  </button>
                  <button
                    class="profile-tab-btn"
                    data-tab="product-requirements"
                    onclick="switchProfileTab('product-requirements')"
                    style="
                      padding: 14px 26px;
                      background: transparent;
                      border: none;
                      border-bottom: 4px solid transparent;
                      color: #666;
                      font-size: 16px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      position: relative;
                      margin-bottom: -2px;
                    "
                  >
                    <span class="notranslate">ðŸ“¦</span> My Product Requirements
                  </button>
                  <button
                    class="profile-tab-btn"
                    data-tab="rental-requirements"
                    onclick="switchProfileTab('rental-requirements')"
                    style="
                      padding: 14px 26px;
                      background: transparent;
                      border: none;
                      border-bottom: 4px solid transparent;
                      color: #666;
                      font-size: 16px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      position: relative;
                      margin-bottom: -2px;
                    "
                  >
                    <span class="notranslate">ðŸšœ</span> My Rental Requirements
                  </button>
                </div>

                <!-- Tab Content -->
                <div id="profileTabContent">
                  <div
                    id="profileProductsTab"
                    class="profile-tab-content active"
                  >
                    <div
                      id="myProductsGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fill,
                          minmax(280px, 1fr)
                        );
                        gap: 20px;
                      "
                    >
                      <!-- Products will be loaded here -->
                    </div>
                    <div
                      id="myProductsEmpty"
                      style="
                        display: none;
                        text-align: center;
                        padding: 60px 20px;
                      "
                    >
                      <div
                        style="
                          font-size: 64px;
                          margin-bottom: 20px;
                          opacity: 0.3;
                        "
                      >
                        ðŸŒ¾
                      </div>
                      <h3
                        style="
                          color: #666;
                          font-size: 20px;
                          margin-bottom: 10px;
                        "
                      >
                        No Products Posted Yet
                      </h3>
                      <p style="color: #999; font-size: 16px">
                        Start by creating your first product!
                      </p>
                      <button
                        onclick="switchDashSection('create')"
                        style="
                          margin-top: 20px;
                          padding: 12px 24px;
                          background: linear-gradient(135deg, #4caf50, #2e7d32);
                          color: white;
                          border: none;
                          border-radius: 12px;
                          font-size: 16px;
                          font-weight: 600;
                          cursor: pointer;
                        "
                      >
                        Create Product
                      </button>
                    </div>
                  </div>

                  <div id="profileRentalsTab" class="profile-tab-content">
                    <div
                      id="myRentalsGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fill,
                          minmax(280px, 1fr)
                        );
                        gap: 20px;
                      "
                    >
                      <!-- Rentals will be loaded here -->
                    </div>
                    <div
                      id="myRentalsEmpty"
                      style="
                        display: none;
                        text-align: center;
                        padding: 60px 20px;
                      "
                    >
                      <div
                        style="
                          font-size: 64px;
                          margin-bottom: 20px;
                          opacity: 0.3;
                        "
                      >
                        ðŸšœ
                      </div>
                      <h3
                        style="
                          color: #666;
                          font-size: 20px;
                          margin-bottom: 10px;
                        "
                      >
                        No Rental Items Posted Yet
                      </h3>
                      <p style="color: #999; font-size: 16px">
                        Start by adding your first rental item!
                      </p>
                      <button
                        onclick="switchDashSection('rentals')"
                        style="
                          margin-top: 20px;
                          padding: 12px 24px;
                          background: linear-gradient(135deg, #4caf50, #2e7d32);
                          color: white;
                          border: none;
                          border-radius: 12px;
                          font-size: 16px;
                          font-weight: 600;
                          cursor: pointer;
                        "
                      >
                        Add Rental Item
                      </button>
                    </div>
                  </div>

                  <div
                    id="profileProductRequirementsTab"
                    class="profile-tab-content"
                  >
                    <div
                      id="myProductRequirementsGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fill,
                          minmax(280px, 1fr)
                        );
                        gap: 20px;
                      "
                    >
                      <!-- Product Requirements will be loaded here -->
                    </div>
                    <div
                      id="myProductRequirementsEmpty"
                      style="
                        display: none;
                        text-align: center;
                        padding: 60px 20px;
                      "
                    >
                      <div
                        style="
                          font-size: 64px;
                          margin-bottom: 20px;
                          opacity: 0.3;
                        "
                      >
                        ðŸ“¦
                      </div>
                      <h3
                        style="
                          color: #666;
                          font-size: 20px;
                          margin-bottom: 10px;
                        "
                      >
                        No Product Requirements Posted Yet
                      </h3>
                      <p style="color: #999; font-size: 16px">
                        Post your first product requirement!
                      </p>
                    </div>
                  </div>

                  <div
                    id="profileRentalRequirementsTab"
                    class="profile-tab-content"
                  >
                    <div
                      id="myRentalRequirementsGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fill,
                          minmax(280px, 1fr)
                        );
                        gap: 20px;
                      "
                    >
                      <!-- Rental Requirements will be loaded here -->
                    </div>
                    <div
                      id="myRentalRequirementsEmpty"
                      style="
                        display: none;
                        text-align: center;
                        padding: 60px 20px;
                      "
                    >
                      <div
                        style="
                          font-size: 64px;
                          margin-bottom: 20px;
                          opacity: 0.3;
                        "
                      >
                        ðŸšœ
                      </div>
                      <h3
                        style="
                          color: #666;
                          font-size: 20px;
                          margin-bottom: 10px;
                        "
                      >
                        No Rental Requirements Posted Yet
                      </h3>
                      <p style="color: #999; font-size: 16px">
                        Post your first rental requirement!
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Feedback & Ratings Section -->
            <div style="margin-bottom: 30px">
              <div
                style="
                  background: white;
                  border-radius: 16px;
                  padding: 30px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                  border: 1px solid #e0e0e0;
                "
              >
                <h2
                  style="
                    color: #2e7d32;
                    margin-bottom: 25px;
                    font-family: 'Poppins', sans-serif;
                    font-size: 24px;
                    font-weight: 700;
                  "
                >
                  <span class="notranslate">â­</span> Feedback & Ratings
                </h2>

                <!-- Average Rating Display -->
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #fff9c4, #fff59d); border-radius: 12px; margin-bottom: 30px; border: 1px solid #ffeb3b">
                  <div id="averageRating" style="font-size: 48px; font-weight: 700; color: #f57c00; margin-bottom: 8px">0.0</div>
                  <div style="font-size: 28px; color: #ffc107; margin-bottom: 10px" id="starDisplay">â˜…â˜…â˜…â˜…â˜…</div>
                  <div id="totalReviews" style="font-size: 16px; color: #666; font-weight: 600">0 total reviews</div>
                </div>

                <!-- Products Feedback Section -->
                <div style="margin-bottom: 30px">
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 15px;
                      font-family: 'Poppins', sans-serif;
                      font-size: 20px;
                      font-weight: 600;
                    "
                  >
                    <span class="notranslate">ðŸŒ¾</span> My Products Feedback
                  </h3>
                  <div id="productsFeedbackSection" style="min-height: 100px">
                    <!-- Products feedback will be loaded here -->
                  </div>
                </div>

                <!-- Rental Items Feedback Section -->
                <div>
                  <h3
                    style="
                      color: #2e7d32;
                      margin-bottom: 15px;
                      font-family: 'Poppins', sans-serif;
                      font-size: 20px;
                      font-weight: 600;
                    "
                  >
                    <span class="notranslate">ðŸšœ</span> My Rentals Feedback
                  </h3>
                  <div id="rentalsFeedbackSection" style="min-height: 100px">
                    <!-- Rentals feedback will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- Edit Profile Modal -->
          <div
            id="editProfileModal"
            class="edit-profile-modal"
            style="display: none"
          >
            <div
              class="edit-profile-modal-overlay"
              onclick="closeEditProfileModal()"
            ></div>
            <div class="edit-profile-modal-content">
              <div class="edit-profile-modal-header">
                <h2 class="edit-profile-modal-title" data-translate="yes">
                  <span class="notranslate">âœï¸</span> Edit Profile
                </h2>
                <button
                  class="edit-profile-modal-close"
                  onclick="closeEditProfileModal()"
                  aria-label="Close"
                >
                  <span class="notranslate">Ã—</span>
                </button>
              </div>

              <form
                id="editProfileForm"
                class="edit-profile-form"
                onsubmit="saveProfileChanges(event)"
              >
                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸ‘¤</span> Full Name
                    <span style="color: #f44336">*</span>
                  </label>
                  <input
                    type="text"
                    id="editProfileName"
                    class="edit-profile-input"
                    placeholder="Enter your full name"
                    required
                    data-translate-placeholder="yes"
                  />
                </div>

                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸ“±</span> Phone Number
                    <span style="color: #f44336">*</span>
                  </label>
                  <input
                    type="tel"
                    id="editProfilePhone"
                    class="edit-profile-input"
                    placeholder="+91 9876543210"
                    pattern="[+]?[0-9\s-]{10,15}"
                    required
                    data-translate-placeholder="yes"
                  />
                  <small class="edit-profile-hint" data-translate="yes"
                    >Enter your 10-digit phone number</small
                  >
                </div>

                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸ“</span> Location
                    <span style="color: #f44336">*</span>
                  </label>
                  <input
                    type="text"
                    id="editProfileLocation"
                    class="edit-profile-input"
                    placeholder="Village / Mandal / District"
                    required
                    data-translate-placeholder="yes"
                  />
                  <small class="edit-profile-hint" data-translate="yes"
                    >Format: Village, Mandal, District</small
                  >
                </div>

                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸ‘¨â€ðŸŒ¾</span> User Type
                    <span style="color: #f44336">*</span>
                  </label>
                  <select
                    id="editProfileUserType"
                    class="edit-profile-select"
                    required
                  >
                    <option value="Farmer" data-translate="yes">Farmer</option>
                    <option value="Customer" data-translate="yes">
                      Customer
                    </option>
                    <option value="Both" data-translate="yes">
                      Both (Farmer & Customer)
                    </option>
                  </select>
                </div>

                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸŒ</span> Preferred Language
                  </label>
                  <select id="editProfileLanguage" class="edit-profile-select">
                    <option value="English" class="notranslate">English</option>
                    <option value="à¤¹à¤¿à¤‚à¤¦à¥€" class="notranslate">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                    <option value="à®¤à®®à®¿à®´à¯" class="notranslate">à®¤à®®à®¿à®´à¯</option>
                    <option value="à°¤à±†à°²à±à°—à±" class="notranslate">à°¤à±†à°²à±à°—à±</option>
                  </select>
                </div>

                <div class="edit-profile-form-section">
                  <label class="edit-profile-label" data-translate="yes">
                    <span class="notranslate">ðŸ“</span> Bio / About Me
                  </label>
                  <textarea
                    id="editProfileBio"
                    class="edit-profile-textarea"
                    rows="4"
                    placeholder="Tell us about yourself, your farming experience, or what you're looking for..."
                    data-translate-placeholder="yes"
                  ></textarea>
                </div>

                <div class="edit-profile-form-actions">
                  <button
                    type="button"
                    class="edit-profile-btn-cancel"
                    onclick="closeEditProfileModal()"
                    data-translate="yes"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    class="edit-profile-btn-save"
                    data-translate="yes"
                  >
                    <span class="notranslate">ðŸ’¾</span> Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- ==========================================
                 RENTAL ITEMS SECTION WITH FEEDBACK SYSTEM
                 ========================================== -->
        <div id="dashRentals" class="dash-section">
          <div style="max-width: 1200px; margin: 0 auto; padding: 30px">
            <button
              class="back-to-home-btn"
              onclick="switchDashSection('home')"
            >
              <span>â†</span>
              <span>Back to Home</span>
            </button>
          </div>
          <div class="search-section">
            <h2
              style="
                color: #2e7d32;
                margin-bottom: 30px;
                font-family: &quot;Poppins&quot;, sans-serif;
                font-weight: 600;
              "
              data-translate="yes"
            >
              <span class="notranslate">ðŸšœ</span> Rental Items
            </h2>

            <!-- Search and Sort Controls -->
            <div
              style="
                display: flex;
                gap: 15px;
                align-items: center;
                margin-bottom: 30px;
                flex-wrap: wrap;
              "
            >
              <div class="voice-search-wrap" style="flex: 1; min-width: 280px">
                <input
                  type="text"
                  id="rentalSearchInput"
                  placeholder="Search rental items by name, category, or location..."
                  style="
                    width: 100%;
                    padding: 15px 20px;
                    padding-right: 55px;
                    border: 2px solid #e0e0e0;
                    border-radius: 25px;
                    font-size: 16px;
                    outline: none;
                    transition: all 0.3s ease;
                  "
                  oninput="filterRentalItems()"
                  onfocus="
                    this.style.borderColor = '#4caf50';
                    this.style.boxShadow = '0 4px 20px rgba(76,175,80,0.15)';
                  "
                  onblur="
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                  "
                />
                <button type="button" class="voice-search-btn" onclick="startVoiceSearch('rentalSearchInput', function(){ if(typeof filterRentalItems==='function') filterRentalItems(); })" title="Voice Search" aria-label="Voice Search">
                  <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
              </div>
              <select
                id="rentalSortSelect"
                onchange="sortRentalItems()"
                style="
                  padding: 15px 20px;
                  border: 2px solid #e0e0e0;
                  border-radius: 25px;
                  font-size: 14px;
                  background: white;
                  cursor: pointer;
                  outline: none;
                  min-width: 180px;
                "
              >
                <option value="newest">Newest First</option>
                <option value="highest-rated">Highest Rated</option>
                <option value="most-reviewed">Most Reviewed</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
              </select>
              <button
                onclick="showAddRentalModal()"
                style="
                  padding: 15px 30px;
                  background: linear-gradient(135deg, #4caf50, #2e7d32);
                  color: white;
                  border: none;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 16px;
                  font-weight: 600;
                  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                  transition: all 0.3s ease;
                  white-space: nowrap;
                "
                onmouseover="
                  this.style.transform = 'translateY(-2px)';
                  this.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
                "
                onmouseout="
                  this.style.transform = 'translateY(0)';
                  this.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                "
              >
                <span class="notranslate">+</span> Add Rental Item
              </button>
            </div>

            <!-- Category Filter Chips -->
            <div
              style="
                display: flex;
                gap: 10px;
                margin-bottom: 30px;
                flex-wrap: wrap;
              "
            >
              <button
                class="rental-filter-chip active"
                data-category="all"
                onclick="filterByCategory('all')"
              >
                All Items
              </button>
              <button
                class="rental-filter-chip"
                data-category="Tractor"
                onclick="filterByCategory('Tractor')"
              >
                Tractors
              </button>
              <button
                class="rental-filter-chip"
                data-category="Harvester"
                onclick="filterByCategory('Harvester')"
              >
                Harvesters
              </button>
              <button
                class="rental-filter-chip"
                data-category="Sprayer"
                onclick="filterByCategory('Sprayer')"
              >
                Sprayers
              </button>
              <button
                class="rental-filter-chip"
                data-category="Water pump"
                onclick="filterByCategory('Water pump')"
              >
                Water Pumps
              </button>
              <button
                class="rental-filter-chip"
                data-category="Drone"
                onclick="filterByCategory('Drone')"
              >
                Drones
              </button>
              <button
                class="rental-filter-chip"
                data-category="Transport"
                onclick="filterByCategory('Transport')"
              >
                Transport
              </button>
            </div>

            <!-- Rental Items Grid -->
            <div id="rentalItemsGrid" class="rental-items-grid">
              <!-- Rental items will be loaded here -->
              <div
                style="
                  grid-column: 1/-1;
                  text-align: center;
                  padding: 60px 20px;
                "
              >
                <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5">
                  ðŸšœ
                </div>
                <p style="color: #666; font-size: 18px">
                  Loading rental items...
                </p>
              </div>
            </div>

            <!-- No Results Message -->
            <div
              id="noRentalResults"
              style="
                display: none;
                text-align: center;
                padding: 60px 20px;
                background: linear-gradient(
                  135deg,
                  rgba(46, 125, 50, 0.05),
                  rgba(85, 139, 47, 0.05)
                );
                border-radius: 15px;
                margin-top: 20px;
              "
            >
              <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5">
                ðŸ”
              </div>
              <h3 style="font-size: 24px; color: #2e7d32; margin-bottom: 10px">
                No Rental Items Found
              </h3>
              <p style="font-size: 16px; color: #666">
                Try adjusting your search or filters.
              </p>
            </div>
          </div>
        </div>

    <!-- Rental Feedback Modal -->
    <div id="rentalFeedbackModal" class="rental-modal" style="display: none">
      <div class="rental-modal-content">
        <button class="rental-modal-close" onclick="closeRentalFeedbackModal()">
          &times;
        </button>
        <h2
          style="
            color: #2e7d32;
            margin-bottom: 20px;
            font-family: &quot;Poppins&quot;, sans-serif;
          "
        >
          <span class="notranslate">â­</span> Rate & Review
        </h2>
        <div
          id="feedbackItemName"
          style="
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
          "
        ></div>

        <!-- Star Rating Input -->
        <div style="margin-bottom: 25px">
          <label
            style="
              display: block;
              color: #333;
              margin-bottom: 12px;
              font-weight: 500;
            "
            >Your Rating *</label
          >
          <div id="starRatingInput" class="star-rating-input">
            <span class="star-input" data-rating="1">&#9733;</span>
            <span class="star-input" data-rating="2">&#9733;</span>
            <span class="star-input" data-rating="3">&#9733;</span>
            <span class="star-input" data-rating="4">&#9733;</span>
            <span class="star-input" data-rating="5">&#9733;</span>
          </div>
          <input type="hidden" id="selectedRatingInput" value="0" />
          <p
            id="ratingText"
            style="color: #666; font-size: 14px; margin-top: 8px"
          >
            Click to rate
          </p>
        </div>

        <!-- Reviewer Name -->
        <div class="form-group" style="margin-bottom: 20px">
          <label
            style="
              display: block;
              color: #333;
              margin-bottom: 8px;
              font-weight: 500;
            "
            >Your Name (Optional)</label
          >
          <input
            type="text"
            id="feedbackReviewerName"
            placeholder="Enter your name"
            style="
              width: 100%;
              padding: 12px 15px;
              border: 2px solid #e0e0e0;
              border-radius: 10px;
              font-size: 14px;
              outline: none;
              transition: border 0.3s ease;
            "
            onfocus="this.style.borderColor = '#4caf50'"
            onblur="this.style.borderColor = '#e0e0e0'"
          />
        </div>

        <!-- Comment -->
        <div class="form-group" style="margin-bottom: 25px">
          <label
            style="
              display: block;
              color: #333;
              margin-bottom: 8px;
              font-weight: 500;
            "
            >Your Review (Optional)</label
          >
          <textarea
            id="feedbackComment"
            rows="4"
            placeholder="Share your experience with this rental item..."
            style="
              width: 100%;
              padding: 12px 15px;
              border: 2px solid #e0e0e0;
              border-radius: 10px;
              font-size: 14px;
              outline: none;
              resize: vertical;
              font-family: inherit;
              transition: border 0.3s ease;
            "
            onfocus="this.style.borderColor = '#4caf50'"
            onblur="this.style.borderColor = '#e0e0e0'"
          ></textarea>
        </div>

        <!-- Submit Button -->
        <button
          onclick="submitRentalFeedback()"
          style="
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
          "
          onmouseover="
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
          "
          onmouseout="
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
          "
        >
          Submit Review
        </button>

        <!-- Existing Reviews -->
        <div
          id="existingReviews"
          style="
            margin-top: 30px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
          "
        >
          <h3 style="color: #2e7d32; margin-bottom: 15px; font-size: 18px">
            Recent Reviews
          </h3>
          <div id="reviewsList">
            <!-- Reviews will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Rental Details Modal -->
    <div id="rentalDetailsModal" class="rental-modal" style="display: none">
      <div class="rental-modal-content rental-details-content">
        <button class="rental-modal-close" onclick="closeRentalDetailsModal()">
          &times;
        </button>
        <div id="rentalDetailsBody">
          <!-- Details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Add Rental Item Modal -->
    <div id="addRentalModal" class="rental-modal" style="display: none">
      <div class="rental-modal-content" style="max-width: 600px">
        <button class="rental-modal-close" onclick="closeAddRentalModal()">
          &times;
        </button>
        <h2
          style="
            color: #2e7d32;
            margin-bottom: 25px;
            font-family: &quot;Poppins&quot;, sans-serif;
          "
        >
          <span class="notranslate">+</span> Add Rental Item
        </h2>
        <form id="addRentalForm" onsubmit="submitNewRental(event)">
          <div class="form-group" style="margin-bottom: 20px">
            <label
              style="
                display: block;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
              "
              >Item Name *</label
            >
            <input
              type="text"
              id="newRentalName"
              required
              placeholder="e.g., John Deere Tractor 5050D"
              style="
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 14px;
                outline: none;
              "
              onfocus="this.style.borderColor = '#4caf50'"
              onblur="this.style.borderColor = '#e0e0e0'"
            />
          </div>
          <div class="form-group" style="margin-bottom: 20px">
            <label
              style="
                display: block;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
              "
              >Category *</label
            >
            <select
              id="newRentalCategory"
              required
              style="
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 14px;
                background: white;
                cursor: pointer;
                outline: none;
              "
              onfocus="this.style.borderColor = '#4caf50'"
              onblur="this.style.borderColor = '#e0e0e0'"
            >
              <option value="">Select category</option>
              <option value="Tractor">Tractor</option>
              <option value="Harvester">Harvester</option>
              <option value="Sprayer">Sprayer</option>
              <option value="Plough">Plough</option>
              <option value="Water pump">Water Pump</option>
              <option value="Drone">Drone Services</option>
              <option value="Cold storage">Cold Storage</option>
              <option value="Transport">Transport Vehicle</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 20px">
            <label
              style="
                display: block;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
              "
              >Description</label
            >
            <textarea
              id="newRentalDescription"
              rows="3"
              placeholder="Describe the item, its condition, features..."
              style="
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 14px;
                outline: none;
                resize: vertical;
                font-family: inherit;
              "
              onfocus="this.style.borderColor = '#4caf50'"
              onblur="this.style.borderColor = '#e0e0e0'"
            ></textarea>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-bottom: 20px;
            "
          >
            <div class="form-group">
              <label
                style="
                  display: block;
                  color: #333;
                  margin-bottom: 8px;
                  font-weight: 500;
                "
                >Price per Hour</label
              >
              <input
                type="number"
                id="newRentalPriceHour"
                placeholder="e.g., 500"
                min="0"
                step="1"
                style="
                  width: 100%;
                  padding: 12px 15px;
                  border: 2px solid #e0e0e0;
                  border-radius: 10px;
                  font-size: 14px;
                  outline: none;
                "
                onfocus="this.style.borderColor = '#4caf50'"
                onblur="this.style.borderColor = '#e0e0e0'"
              />
            </div>
            <div class="form-group">
              <label
                style="
                  display: block;
                  color: #333;
                  margin-bottom: 8px;
                  font-weight: 500;
                "
                >Price per Day *</label
              >
              <input
                type="number"
                id="newRentalPriceDay"
                required
                placeholder="e.g., 3000"
                min="1"
                step="1"
                style="
                  width: 100%;
                  padding: 12px 15px;
                  border: 2px solid #e0e0e0;
                  border-radius: 10px;
                  font-size: 14px;
                  outline: none;
                "
                onfocus="this.style.borderColor = '#4caf50'"
                onblur="this.style.borderColor = '#e0e0e0'"
              />
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 20px">
            <label
              style="
                display: block;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
              "
              >Location *</label
            >
            <input
              type="text"
              id="newRentalLocation"
              required
              placeholder="e.g., Hyderabad, Telangana"
              style="
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 14px;
                outline: none;
              "
              onfocus="this.style.borderColor = '#4caf50'"
              onblur="this.style.borderColor = '#e0e0e0'"
            />
          </div>

          <!-- Media Upload Section -->
          <div class="form-group" style="margin-bottom: 25px">
            <label
              style="
                display: block;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
              "
              >Photos & Videos</label
            >
            <div
              class="rental-media-upload-zone"
              id="rentalMediaUploadZone"
              onclick="document.getElementById('rentalMediaInput').click()"
            >
              <input
                type="file"
                id="rentalMediaInput"
                multiple
                accept="image/jpeg,image/png,image/webp,video/mp4,video/webm"
                style="display: none"
                onchange="handleRentalMediaSelect(event)"
              />
              <div class="upload-zone-icon">
                <span style="font-size: 40px">ðŸ“·</span>
              </div>
              <div class="upload-zone-text">
                <p style="font-weight: 600; color: #2e7d32; margin-bottom: 5px">
                  Click to upload photos or videos
                </p>
                <p style="font-size: 12px; color: #888">
                  JPG, PNG, WEBP (max 10MB) | MP4, WEBM (max 50MB)
                </p>
              </div>
            </div>
            <!-- Media Preview Container -->
            <div
              id="rentalMediaPreview"
              class="rental-media-preview"
              style="display: none"
            ></div>
          </div>

          <button
            type="submit"
            id="addRentalSubmitBtn"
            style="
              width: 100%;
              padding: 15px;
              background: linear-gradient(135deg, #4caf50, #2e7d32);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onmouseover="this.style.transform = 'translateY(-2px)'"
            onmouseout="this.style.transform = 'translateY(0)'"
          >
            Add Rental Item
          </button>
        </form>
      </div>
    </div>

    <!-- Rental Media Gallery Modal (Photos & Videos Viewer) -->
    <div
      id="rentalMediaGalleryModal"
      class="rental-media-gallery-modal"
      style="display: none"
    >
      <div class="rental-media-gallery-content">
        <button
          class="rental-media-gallery-close"
          onclick="closeRentalMediaGallery()"
        >
          &times;
        </button>
        <h2
          style="
            color: #2e7d32;
            margin-bottom: 20px;
            font-family: &quot;Poppins&quot;, sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          <span class="notranslate">ðŸ“¸</span>
          <span id="mediaGalleryTitle">Photos & Videos</span>
        </h2>

        <!-- Media Type Tabs -->
        <div class="media-gallery-tabs">
          <button
            class="media-tab active"
            data-tab="all"
            onclick="filterMediaGallery('all')"
          >
            All <span id="mediaCountAll" class="media-count-badge">0</span>
          </button>
          <button
            class="media-tab"
            data-tab="images"
            onclick="filterMediaGallery('images')"
          >
            Photos
            <span id="mediaCountImages" class="media-count-badge">0</span>
          </button>
          <button
            class="media-tab"
            data-tab="videos"
            onclick="filterMediaGallery('videos')"
          >
            Videos
            <span id="mediaCountVideos" class="media-count-badge">0</span>
          </button>
        </div>

        <!-- Media Grid -->
        <div id="mediaGalleryGrid" class="media-gallery-grid">
          <!-- Media items will be loaded here -->
          <div class="media-gallery-loading">
            <div class="media-spinner"></div>
            <p>Loading media...</p>
          </div>
        </div>

        <!-- Empty State -->
        <div
          id="mediaGalleryEmpty"
          class="media-gallery-empty"
          style="display: none"
        >
          <span style="font-size: 64px; opacity: 0.5">ðŸ“·</span>
          <h3>No photos or videos yet</h3>
          <p>Media will appear here once uploaded by the owner.</p>
        </div>
      </div>
    </div>

    <!-- Rental Media Lightbox (Full Screen Viewer) -->
    <div
      id="rentalMediaLightbox"
      class="rental-media-lightbox"
      style="display: none"
    >
      <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
      <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1)">
        &#10094;
      </button>
      <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1)">
        &#10095;
      </button>

      <div class="lightbox-content">
        <img
          id="lightboxImage"
          class="lightbox-image"
          src=""
          alt="Media preview"
          style="display: none"
        />
        <video
          id="lightboxVideo"
          class="lightbox-video"
          controls
          style="display: none"
        ></video>
      </div>

      <div class="lightbox-info">
        <span id="lightboxCounter">1 / 1</span>
        <span id="lightboxFilename"></span>
      </div>

      <div class="lightbox-thumbnails" id="lightboxThumbnails">
        <!-- Thumbnails will be loaded here -->
      </div>
    </div>

          <!-- Crop Advices & Farmer Support Section -->
          <div id="dashCropAdvices" class="dash-section">
      <div class="crop-advices-container">
        <!-- Back Button -->
        <button
          class="back-to-home-btn"
          onclick="switchDashSection('home')"
          style="margin-bottom: 20px"
        >
          <span>â†</span>
          <span>Back to Home</span>
        </button>

        <!-- Header -->
        <div class="crop-advices-header">
          <h1 class="crop-advices-title">
            <span class="notranslate">ðŸŒ¾</span>
            <span data-translate="yes">Crop Advices & Farmer Support</span>
          </h1>
          <p class="crop-advices-subtitle" data-translate="yes">
            Your trusted support hub for verified agriculture resources,
            helplines, and learning channels to help you grow better crops.
          </p>
        </div>

        <!-- Section 1: Reliance Foundation WhatsApp Support -->
        <div class="crop-advices-section">
          <h2 class="crop-advices-section-title">
            <span class="notranslate">ðŸ’¬</span>
            <span data-translate="yes"
              >Reliance Foundation â€“ WhatsApp Support</span
            >
          </h2>
          <div class="crop-advices-grid">
            <!-- WhatsApp Message Card -->
            <div class="support-card">
              <div class="support-card-icon whatsapp">
                <span class="notranslate">ðŸ“±</span>
              </div>
              <span class="support-card-badge official">âœ“ Official</span>
              <h3 class="support-card-title" data-translate="yes">
                WhatsApp Support Number
              </h3>
              <p class="support-card-desc" data-translate="yes">
                Get instant farming advice and support via WhatsApp messaging
              </p>
              <p class="support-card-number notranslate">95523 00009</p>
              <a
                href="https://wa.me/919552300009"
                target="_blank"
                rel="noopener noreferrer"
                class="support-btn whatsapp"
              >
                <span class="notranslate">ðŸ’¬</span>
                <span data-translate="yes">Message Now</span>
              </a>
            </div>

            <!-- WhatsApp Channel 1 -->
            <div class="support-card">
              <div class="support-card-icon whatsapp">
                <span class="notranslate">ðŸ“¢</span>
              </div>
              <span class="support-card-badge official"
                >âœ“ Official Channel</span
              >
              <h3 class="support-card-title">
                APTG Reliance Foundation Information Services
              </h3>
              <p class="support-card-desc" data-translate="yes">
                Join the official WhatsApp community channel for Andhra Pradesh
                & Telangana farmers
              </p>
              <div class="support-card-links">
                <a
                  href="https://whatsapp.com/channel/0029VaZfq8PEVccG1wkteG0Z"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-link"
                >
                  <span class="support-link-icon notranslate">ðŸ”—</span>
                  <span data-translate="yes">Join Community Channel</span>
                </a>
              </div>
            </div>

            <!-- WhatsApp Channel 2 -->
            <div class="support-card">
              <div class="support-card-icon whatsapp">
                <span class="notranslate">ðŸ“¢</span>
              </div>
              <span class="support-card-badge official"
                >âœ“ Official Channel</span
              >
              <h3 class="support-card-title">
                AP & TG Reliance Foundation Channel
              </h3>
              <p class="support-card-desc" data-translate="yes">
                Stay updated with latest farming tips and agricultural news
              </p>
              <div class="support-card-links">
                <a
                  href="https://whatsapp.com/channel/0029VavtfkfAjPXKUuN8qY2M"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-link"
                >
                  <span class="support-link-icon notranslate">ðŸ”—</span>
                  <span data-translate="yes">Join Channel</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: Agricultural YouTube Channels -->
        <div class="crop-advices-section">
          <h2 class="crop-advices-section-title">
            <span class="notranslate">ðŸŽ¬</span>
            <span data-translate="yes">Agricultural YouTube Channels</span>
          </h2>
          <div class="crop-advices-grid">
            <!-- Karshaka Mitra -->
            <div class="youtube-card">
              <div class="youtube-card-header">
                <div class="youtube-icon">
                  <span class="notranslate">â–¶ï¸</span>
                </div>
                <span class="youtube-card-name">Karshaka Mitra</span>
              </div>
              <div class="youtube-card-body">
                <p class="support-card-desc" data-translate="yes">
                  Expert farming tips and agricultural guidance for Indian
                  farmers
                </p>
                <a
                  href="https://www.youtube.com/KarshakaMitra"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-btn youtube"
                >
                  <span class="notranslate">â–¶ï¸</span>
                  <span data-translate="yes">Watch Now</span>
                </a>
              </div>
            </div>

            <!-- Agri Telugu -->
            <div class="youtube-card">
              <div class="youtube-card-header">
                <div class="youtube-icon">
                  <span class="notranslate">â–¶ï¸</span>
                </div>
                <span class="youtube-card-name">Agri Telugu</span>
              </div>
              <div class="youtube-card-body">
                <p class="support-card-desc" data-translate="yes">
                  Telugu agricultural content for farmers in AP & Telangana
                </p>
                <a
                  href="https://www.youtube.com/@agritelugu1655"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-btn youtube"
                >
                  <span class="notranslate">â–¶ï¸</span>
                  <span data-translate="yes">Watch Now</span>
                </a>
              </div>
            </div>

            <!-- Reliance Foundation Information Services -->
            <div class="youtube-card">
              <div class="youtube-card-header">
                <div class="youtube-icon">
                  <span class="notranslate">â–¶ï¸</span>
                </div>
                <span class="youtube-card-name"
                  >Reliance Foundation Info Services</span
                >
              </div>
              <div class="youtube-card-body">
                <p class="support-card-desc" data-translate="yes">
                  Official channel with verified agricultural information
                </p>
                <a
                  href="https://youtube.com/@rfinformationservices"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-btn youtube"
                >
                  <span class="notranslate">â–¶ï¸</span>
                  <span data-translate="yes">Watch Now</span>
                </a>
              </div>
            </div>

            <!-- ETV Annadata -->
            <div class="youtube-card">
              <div class="youtube-card-header">
                <div class="youtube-icon">
                  <span class="notranslate">â–¶ï¸</span>
                </div>
                <span class="youtube-card-name">ETV Annadata</span>
              </div>
              <div class="youtube-card-body">
                <p class="support-card-desc" data-translate="yes">
                  Daily agricultural news and farming programs from ETV
                </p>
                <a
                  href="https://youtube.com/@etvannadata"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-btn youtube"
                >
                  <span class="notranslate">â–¶ï¸</span>
                  <span data-translate="yes">Watch Now</span>
                </a>
              </div>
            </div>

            <!-- Rythu Badi -->
            <div class="youtube-card">
              <div class="youtube-card-header">
                <div class="youtube-icon">
                  <span class="notranslate">â–¶ï¸</span>
                </div>
                <span class="youtube-card-name">Rythu Badi</span>
              </div>
              <div class="youtube-card-body">
                <p class="support-card-desc" data-translate="yes">
                  Farmer's school - Learn modern farming techniques
                </p>
                <a
                  href="https://www.youtube.com/@RythuBadi"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="support-btn youtube"
                >
                  <span class="notranslate">â–¶ï¸</span>
                  <span data-translate="yes">Watch Now</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Farmer Helpline Numbers -->
        <div class="crop-advices-section">
          <h2 class="crop-advices-section-title">
            <span class="notranslate">ðŸ“ž</span>
            <span data-translate="yes">Farmer Helpline Numbers</span>
          </h2>
          <div
            class="crop-advices-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"
          >
            <!-- Reliance Foundation Toll-Free -->
            <div class="helpline-card">
              <div class="helpline-icon">
                <span class="notranslate">ðŸ“ž</span>
              </div>
              <span class="helpline-badge" data-translate="yes"
                >ðŸ†“ Toll-Free</span
              >
              <h3 class="helpline-name" data-translate="yes">
                Reliance Foundation Helpline
              </h3>
              <p class="support-card-desc" data-translate="yes">
                24x7 support for farming queries, weather updates, and market
                prices
              </p>
              <p class="helpline-number notranslate">1800-419-8800</p>
              <a href="tel:18004198800" class="support-btn phone">
                <span class="notranslate">ðŸ“ž</span>
                <span data-translate="yes">Call Now</span>
              </a>
            </div>

            <!-- Farmers Call Centre (Kisan Call Centre) -->
            <div class="helpline-card">
              <div class="helpline-icon">
                <span class="notranslate">ðŸŒ¾</span>
              </div>
              <span class="helpline-badge" data-translate="yes"
                >ðŸ†“ Toll-Free</span
              >
              <h3 class="helpline-name" data-translate="yes">
                Farmers Call Centre (Kisan)
              </h3>
              <p class="support-card-desc" data-translate="yes">
                Government helpline for agricultural advice and information
              </p>
              <p class="helpline-number notranslate">1800-425-0430</p>
              <a href="tel:18004250430" class="support-btn phone">
                <span class="notranslate">ðŸ“ž</span>
                <span data-translate="yes">Call Now</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Section 4: Agriculture Apps for Farmers -->
        <div class="crop-advices-section">
          <h2 class="crop-advices-section-title">
            <span class="notranslate">ðŸ“²</span>
            <span data-translate="yes">Agriculture Apps for Farmers</span>
          </h2>
          <div
            class="crop-advices-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"
          >
            <!-- Plantix App -->
            <div class="app-card">
              <div class="app-card-header">
                <div class="app-icon plantix">
                  <span class="notranslate">ðŸŒ±</span>
                </div>
                <div>
                  <h3 class="app-card-title">Plantix</h3>
                  <p class="app-card-purpose" data-translate="yes">
                    Crop Disease Identification
                  </p>
                </div>
              </div>
              <p class="app-card-desc" data-translate="yes">
                Identify plant diseases instantly using AI-powered image
                recognition. Get treatment recommendations and prevent crop
                losses.
              </p>
              <a
                href="https://play.google.com/store/apps/details?id=com.peat.GartenBank"
                target="_blank"
                rel="noopener noreferrer"
                class="support-btn app"
              >
                <span class="notranslate">ðŸ“¥</span>
                <span data-translate="yes">Install App</span>
              </a>
            </div>

            <!-- BigHaat App -->
            <div class="app-card">
              <div class="app-card-header">
                <div class="app-icon bighaat">
                  <span class="notranslate">ðŸ›’</span>
                </div>
                <div>
                  <h3 class="app-card-title">BigHaat</h3>
                  <p class="app-card-purpose" data-translate="yes">
                    Fertilizers & Agri Inputs
                  </p>
                </div>
              </div>
              <p class="app-card-desc" data-translate="yes">
                Buy quality seeds, fertilizers, pesticides and agricultural
                inputs directly at your doorstep at best prices.
              </p>
              <a
                href="https://play.google.com/store/apps/details?id=com.BigHaat"
                target="_blank"
                rel="noopener noreferrer"
                class="support-btn app"
              >
                <span class="notranslate">ðŸ“¥</span>
                <span data-translate="yes">Install App</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Important Notice -->
        <div
          style="
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
            margin-top: 30px;
          "
        >
          <p
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              margin: 0;
              color: #e65100;
              font-weight: 500;
            "
          >
            <span class="notranslate" style="font-size: 20px">â„¹ï¸</span>
            <span data-translate="yes"
              >All links and numbers are official and verified. Always verify
              before sharing personal information.</span
            >
          </p>
        </div>
      </div>
    </div>
        </div> <!-- /main-content-wrapper -->

    <!-- Popup Message -->
    <div class="popup" id="popup"></div>

    <!-- Image Gallery Modal -->
    <div class="gallery-modal" id="galleryModal">
      <div class="gallery-content">
        <div class="gallery-counter" id="galleryCounter">1 / 1</div>
        <button class="gallery-close" onclick="closeGallery()">Ã—</button>
        <img
          class="gallery-image"
          id="galleryImage"
          src=""
          alt="Gallery Image"
        />
        <div class="gallery-nav">
          <button onclick="changeGalleryImage(-1)">â€¹</button>
          <button onclick="changeGalleryImage(1)">â€º</button>
        </div>
        <div class="zoom-controls">
          <button onclick="zoomImage(-0.2)" title="Zoom Out">âˆ’</button>
          <button onclick="resetZoom()" title="Reset Zoom">âŸ²</button>
          <button onclick="zoomImage(0.2)" title="Zoom In">+</button>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // NAVIGATION DRAWER FUNCTIONS
      // ==========================================

      function toggleDrawer() {
        const drawer = document.getElementById("navDrawer");
        const overlay = document.getElementById("drawerOverlay");
        if (drawer && overlay) {
          drawer.classList.toggle("active");
          overlay.classList.toggle("active");
          document.body.style.overflow = drawer.classList.contains("active")
            ? "hidden"
            : "";
        }
      }

      function closeDrawer() {
        const drawer = document.getElementById("navDrawer");
        const overlay = document.getElementById("drawerOverlay");
        if (drawer && overlay) {
          drawer.classList.remove("active");
          overlay.classList.remove("active");
          document.body.style.overflow = "";
        }
      }

      function navigateFromDrawer(section) {
        closeDrawer();
        // Small delay to allow drawer to close smoothly
        setTimeout(() => {
          switchDashSection(section);
          updateDrawerActiveItem(section);
        }, 100);
      }

      function updateDrawerActiveItem(section) {
        // Remove active class from all menu items
        document.querySelectorAll(".drawer-menu-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Add active class to current section
        const menuItems = document.querySelectorAll(".drawer-menu-item");
        const sectionMap = {
          create: 0,
          requirements: 1,
          history: 2,
          prices: 3,
          "ai-assistant": 4,
          schemes: 5,
          rentals: 6,
          "crop-advices": 7,
        };

        if (
          sectionMap.hasOwnProperty(section) &&
          menuItems[sectionMap[section]]
        ) {
          menuItems[sectionMap[section]].classList.add("active");
        }
      }

      // Update drawer profile information
      function updateDrawerProfile() {
        fetch("/api/user")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.user) {
              const user = data.user;
              const nameEl = document.getElementById("drawerProfileName");
              const emailEl = document.getElementById("drawerProfileEmail");
              const locationEl = document.getElementById(
                "drawerProfileLocation",
              );
              const avatarEl = document.getElementById("drawerProfileAvatar");

              if (nameEl) nameEl.textContent = user.name || "User";
              if (emailEl) {
                // Show phone instead of email
                emailEl.textContent = user.phone || "";
              }
              if (locationEl) {
                // Build location from village, mandal, district
                let location = "";
                if (user.village && user.mandal && user.district) {
                  location = `${user.village}, ${user.mandal}, ${user.district}`;
                } else if (user.location) {
                  location = user.location;
                } else {
                  location = "Location not set";
                }
                locationEl.textContent = location;
              }
              if (avatarEl && user.profile_photo) {
                avatarEl.innerHTML = `<img src="${user.profile_photo}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
              }
            }
          })
          .catch((error) => {
            console.error("Error loading drawer profile:", error);
          });
      }

      // Close drawer when clicking outside (on overlay)
      document.addEventListener("click", function (e) {
        const drawer = document.getElementById("navDrawer");
        const toggle = document.getElementById("drawerToggle");
        if (
          drawer &&
          toggle &&
          !drawer.contains(e.target) &&
          !toggle.contains(e.target) &&
          drawer.classList.contains("active")
        ) {
          closeDrawer();
        }
      });

      // Close drawer on ESC key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeDrawer();
        }
      });

      // ==========================================
      // SECTION NAVIGATION
      // ==========================================

      function switchDashSection(section) {
        // Hide all sections
        document.querySelectorAll(".dash-section").forEach((s) => {
          s.classList.remove("active");
          s.style.display = "none";
        });

        // Update drawer active item
        updateDrawerActiveItem(section);

        const sectionMap = {
          home: "dashHome",
          create: "dashCreate",
          history: "dashHistory",
          notifications: "dashNotifications",
          prices: "dashPrices",
          profile: "dashProfile",
          "ai-assistant": "dashAi-assistant",
          requirements: "dashRequirements",
          schemes: "dashSchemes",
          rentals: "dashRentals",
          "crop-advices": "dashCropAdvices",
        };

        const targetSection = document.getElementById(sectionMap[section]);
        if (targetSection) {
          targetSection.style.display = "block";
          targetSection.classList.add("active");

          // Scroll to top of the page when switching sections
          window.scrollTo({ top: 0, behavior: "instant" });

          // Update history section if switching to it
          if (section === "history") {
            updateHistorySection();
          }

          // Update profile section if switching to it
          if (section === "profile") {
            loadProfileSection();
          }

          // Update requirements section if switching to it
          if (section === "requirements") {
            if (typeof displayRequirements === "function") {
              displayRequirements();
            }
          }

          // Update notifications section if switching to it
          if (section === "notifications") {
            if (typeof renderNotifications === "function") {
              renderNotifications();
            }
          }

          // Update schemes section if switching to it
          if (section === "schemes") {
            if (typeof loadSchemes === "function") {
              loadSchemes();
            }
          }

          // Update rentals section if switching to it
          if (section === "rentals") {
            if (typeof loadRentalItems === "function") {
              loadRentalItems();
            }
          }
        }
      }

      function getSectionName(section) {
        const names = {
          home: "Home",
          create: "Create",
          history: "History",
          notifications: "Notifications",
          prices: "Prices",
          profile: "Profile",
          "ai-assistant": "AI Assistant",
          requirements: "Customer Requirements",
          schemes: "Government Schemes",
          "crop-advices": "Crop Advices & Support",
        };
        return names[section] || "";
      }

      // Product Management System
      let products = [
        {
          id: 1,
          category: "Vegetables",
          name: "Fresh Carrots",
          farmer: "Ravi Kumar",
          farmerLocation: { lat: 17.385, lng: 78.4867 },
          price: 40,
          unit: "kg",
          quantity: 50,
          description: "Fresh, organic carrots directly from farm",
          images: ["ðŸ¥•"],
          videos: ["https://www.w3schools.com/html/mov_bbb.mp4"], // Example video for demo
          distance: 5,
        },
        {
          id: 2,
          category: "Fruits",
          name: "Organic Tomatoes",
          farmer: "Lakshmi Devi",
          farmerLocation: { lat: 17.405, lng: 78.5067 },
          price: 35,
          unit: "kg",
          quantity: 30,
          description: "Fresh organic tomatoes, pesticide-free",
          images: ["ðŸ…"],
          videos: [], // No video
          distance: 12,
        },
      ];

      let uploadedImages = [];
      let uploadedVideos = []; // Store uploaded video URLs
      let currentStep = 1;
      let userLocation = null;
      let likedProducts = []; // Array to store liked product IDs

      // Gallery variables
      let currentGalleryImages = [];
      let currentGalleryIndex = 0;
      let currentZoom = 1;

      // Helper function to create star rating display
      function createStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let stars = "";

        for (let i = 0; i < fullStars; i++) {
          stars += "â­";
        }
        if (hasHalfStar && fullStars < 5) {
          stars += "â­";
        }
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
          stars += "â˜†";
        }
        return stars || "â˜†â˜†â˜†â˜†â˜†";
      }

      // Helper function to calculate average rating
      function calculateAverageRating(feedbacks) {
        if (!feedbacks || feedbacks.length === 0) return 0;
        const sum = feedbacks.reduce(
          (acc, feedback) => acc + feedback.rating,
          0,
        );
        return (sum / feedbacks.length).toFixed(1);
      }

      // Gallery Functions
      function openGallery(images, startIndex = 0) {
        currentGalleryImages = images;
        currentGalleryIndex = startIndex;
        currentZoom = 1;

        const modal = document.getElementById("galleryModal");
        const image = document.getElementById("galleryImage");
        const counter = document.getElementById("galleryCounter");

        // Hide video tag if present from previous gallery
        let videoEl = document.getElementById("galleryVideo");
        if (videoEl) videoEl.style.display = "none";

        image.style.display = "block";

        modal.classList.add("active");
        updateGalleryImage();

        // Add keyboard navigation
        document.addEventListener("keydown", galleryKeyHandler);
      }

      // Product Views (Images & Videos) Gallery
      function showProductViews(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;
        // Merge images and videos for gallery
        const galleryItems = [];
        if (product.images && product.images.length > 0) {
          product.images.forEach((img) =>
            galleryItems.push({ type: "image", url: img }),
          );
        }
        if (product.videos && product.videos.length > 0) {
          product.videos.forEach((vid) =>
            galleryItems.push({ type: "video", url: vid }),
          );
        }

        // Create or update custom gallery modal
        let modal = document.getElementById("galleryModal");
        if (!modal) return;
        // Reset state
        currentGalleryImages = galleryItems;
        currentGalleryIndex = 0;
        currentZoom = 1;

        // If gallery video not present, add it
        let videoEl = document.getElementById("galleryVideo");
        if (!videoEl) {
          videoEl = document.createElement("video");
          videoEl.id = "galleryVideo";
          videoEl.className = "gallery-image";
          videoEl.style.cssText =
            "max-width: 90%; max-height: 90%; object-fit: contain; transition: transform 0.3s ease; display: none; border-radius: 14px;";
          videoEl.controls = true;
          modal.querySelector(".gallery-content").appendChild(videoEl);
        }

        // Helper to update display type based on galleryItems type
        function updateMediaDisplay(index) {
          const item = galleryItems[index];
          const imageEl = document.getElementById("galleryImage");
          const videoEl = document.getElementById("galleryVideo");
          if (!item) return;
          // Set counter
          const counter = document.getElementById("galleryCounter");
          if (counter)
            counter.textContent = `${index + 1} / ${galleryItems.length}`;
          currentZoom = 1;
          if (item.type === "image") {
            imageEl.src = item.url;
            imageEl.style.display = "block";
            videoEl.style.display = "none";
            imageEl.style.transform = `scale(${currentZoom})`;
          } else if (item.type === "video") {
            videoEl.src = item.url;
            videoEl.style.display = "block";
            imageEl.style.display = "none";
            videoEl.style.transform = `scale(${currentZoom})`;
            videoEl.currentTime = 0;
            videoEl.pause();
          }
        }
        // Save for external triggers
        window._galleryType = galleryItems.map((x) => x.type);

        // Hijack updateGalleryImage for product views gallery
        window._oldUpdateGalleryImage = updateGalleryImage;
        updateGalleryImage = function () {
          updateMediaDisplay(currentGalleryIndex);
        };
        // Hijack zoomImage for both types
        window._oldZoomImage = zoomImage;
        zoomImage = function (delta) {
          currentZoom += delta;
          if (currentZoom < 0.5) currentZoom = 0.5;
          if (currentZoom > 3) currentZoom = 3;
          const item = galleryItems[currentGalleryIndex];
          const imageEl = document.getElementById("galleryImage");
          const videoEl = document.getElementById("galleryVideo");
          if (item.type === "image")
            imageEl.style.transform = `scale(${currentZoom})`;
          else if (item.type === "video")
            videoEl.style.transform = `scale(${currentZoom})`;
        };
        window._oldResetZoom = resetZoom;
        resetZoom = function () {
          currentZoom = 1;
          const item = galleryItems[currentGalleryIndex];
          const imageEl = document.getElementById("galleryImage");
          const videoEl = document.getElementById("galleryVideo");
          if (item.type === "image") imageEl.style.transform = `scale(1)`;
          else if (item.type === "video") videoEl.style.transform = `scale(1)`;
        };
        // Hijack changeGalleryImage for both types
        window._oldChangeGalleryImage = changeGalleryImage;
        changeGalleryImage = function (direction) {
          currentGalleryIndex += direction;
          if (currentGalleryIndex < 0) {
            currentGalleryIndex = galleryItems.length - 1;
          } else if (currentGalleryIndex >= galleryItems.length) {
            currentGalleryIndex = 0;
          }
          currentZoom = 1;
          updateGalleryImage();
        };
        // Render modal and open gallery
        modal.classList.add("active");
        updateMediaDisplay(0);

        document.addEventListener("keydown", galleryKeyHandler);

        // When closed, restore normal gallery functions
        let localCloseGallery = closeGallery;
        closeGallery = function () {
          modal.classList.remove("active");
          currentZoom = 1;
          // Restore
          if (window._oldUpdateGalleryImage)
            updateGalleryImage = window._oldUpdateGalleryImage;
          if (window._oldZoomImage) zoomImage = window._oldZoomImage;
          if (window._oldResetZoom) resetZoom = window._oldResetZoom;
          if (window._oldChangeGalleryImage)
            changeGalleryImage = window._oldChangeGalleryImage;
          // Hide video if present
          if (videoEl) videoEl.style.display = "none";
          let imageEl = document.getElementById("galleryImage");
          if (imageEl) imageEl.style.display = "block";
          document.removeEventListener("keydown", galleryKeyHandler);
        };
      }

      function closeGallery() {
        const modal = document.getElementById("galleryModal");
        modal.classList.remove("active");
        currentZoom = 1;

        // Remove keyboard navigation
        document.removeEventListener("keydown", galleryKeyHandler);
      }

      function galleryKeyHandler(e) {
        if (e.key === "Escape") closeGallery();
        if (e.key === "ArrowLeft") changeGalleryImage(-1);
        if (e.key === "ArrowRight") changeGalleryImage(1);
      }

      function changeGalleryImage(direction) {
        currentGalleryIndex += direction;

        if (currentGalleryIndex < 0) {
          currentGalleryIndex = currentGalleryImages.length - 1;
        } else if (currentGalleryIndex >= currentGalleryImages.length) {
          currentGalleryIndex = 0;
        }

        currentZoom = 1;
        updateGalleryImage();
      }

      function updateGalleryImage() {
        const image = document.getElementById("galleryImage");
        const counter = document.getElementById("galleryCounter");

        image.src = currentGalleryImages[currentGalleryIndex];
        image.style.transform = `scale(${currentZoom})`;
        counter.textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
      }

      function zoomImage(delta) {
        currentZoom += delta;
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 3) currentZoom = 3;

        const image = document.getElementById("galleryImage");
        image.style.transform = `scale(${currentZoom})`;
      }

      function resetZoom() {
        currentZoom = 1;
        const image = document.getElementById("galleryImage");
        image.style.transform = `scale(${currentZoom})`;
      }

      // Farmers data with contact information and feedback
      let farmersData = {
        "Ravi Kumar": {
          name: "Ravi Kumar",
          phone: "+91 9876543210",
          location: "Hyderabad, Telangana",
          profileImage: localStorage.getItem("profileImage") || "",
          feedbacks: [],
        },
        "Lakshmi Devi": {
          name: "Lakshmi Devi",
          phone: "+91 9876543211",
          location: "Secunderabad, Telangana",
          profileImage: localStorage.getItem("profileImage") || "",
          feedbacks: [],
        },
        "Rajesh Kumar": {
          name: "Rajesh Kumar",
          phone: "+91 9876543210",
          location: "Secunderabad, Telangana",
          profileImage: localStorage.getItem("profileImage") || "",
          feedbacks: [],
        },
      };

      // Initialize products display
      function initializeProducts() {
        getCurrentLocation();
        // Fetch products from API
        fetch("/api/products")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Convert API products to local format
              products = data.products.map((product) => ({
                id: product.id,
                category: product.category,
                name: product.name,
                farmer: product.farmer_name,
                farmerLocation: product.farmer_location,
                price: product.price,
                unit: product.unit,
                quantity: product.quantity,
                description: product.description,
                images: product.images || [],
                distance: 0, // Will be calculated
                postedBy: {
                  name: product.farmer_name,
                  location: product.farmer_location,
                },
              }));
              displayProducts();
            } else {
              console.error("Failed to load products:", data.message);
              displayProducts(); // Display empty state
            }
          })
          .catch((error) => {
            console.error("Error loading products:", error);
            displayProducts(); // Display empty state
          });
      }

      // Get user's current location
      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              updateProductDistances();
              displayProducts();
            },
            (error) => {
              console.log("Geolocation error:", error);
              // Use default location (Hyderabad)
              userLocation = { lat: 17.385, lng: 78.4867 };
              displayProducts();
            },
          );
        } else {
          userLocation = { lat: 17.385, lng: 78.4867 };
          displayProducts();
        }
      }

      // Calculate distance using Haversine formula
      function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLng = ((lng2 - lng1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLng / 2) *
            Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return Math.round(R * c * 10) / 10; // Round to 1 decimal
      }

      // Update distances for all products
      function updateProductDistances() {
        if (!userLocation) return;
        products.forEach((product) => {
          // Handle both object and string location formats
          if (
            product.farmerLocation &&
            typeof product.farmerLocation === "object" &&
            product.farmerLocation.lat &&
            product.farmerLocation.lng
          ) {
            product.distance = calculateDistance(
              userLocation.lat,
              userLocation.lng,
              product.farmerLocation.lat,
              product.farmerLocation.lng,
            );
          } else {
            // If location is a string or not available, set distance to null
            product.distance = null;
          }
        });
      }

      // Toggle like status for a product
      function toggleLike(productId) {
        const product = products.find((p) => p.id === productId);
        const index = likedProducts.indexOf(productId);

        if (index > -1) {
          // Unlike - remove from liked products
          likedProducts.splice(index, 1);
        } else {
          // Like - add to liked products
          likedProducts.push(productId);

          // Add to history when liking
          if (product) {
            addHistoryEntry(
              "liked",
              "product",
              product.id,
              product.name,
              product.farmer,
              product.farmerAddress || product.postedBy?.location || "",
              { price: product.price, unit: product.unit },
            );
          }
        }

        // Update all heart button appearances (in both main grid and history)
        const likeButtons = document.querySelectorAll(
          `[data-like-id="${productId}"]`,
        );
        likeButtons.forEach((likeBtn) => {
          if (likedProducts.includes(productId)) {
            likeBtn.classList.add("liked");
            likeBtn.textContent = "â¤ï¸";
            likeBtn.title = "Remove from favorites";
          } else {
            likeBtn.classList.remove("liked");
            likeBtn.textContent = "ðŸ¤";
            likeBtn.title = "Add to favorites";
          }
        });

        // Update history section
        updateHistorySection();

        // Re-render products to update like status
        displayProducts();
      }

      // Helper function to get category icon
      function getCategoryIcon(category) {
        const icons = {
          Vegetables: "ðŸ¥¬",
          Fruits: "ðŸŽ",
          Flowers: "ðŸŒ¸",
          Grains: "ðŸŒ¾",
          Seeds: "ðŸŒ±",
          Dairy: "ðŸ¥›",
          Others: "ðŸŒ¿",
        };
        return icons[category] || "ðŸŒ¾";
      }

      // Helper function to get image source
      function getProductImageSrc(product) {
        if (
          !product.images ||
          !Array.isArray(product.images) ||
          product.images.length === 0
        ) {
          return null;
        }

        const firstImage = product.images[0];

        // Check if it's a base64 data URL
        if (firstImage && firstImage.startsWith("data:")) {
          return firstImage;
        }

        // Check if it's a file path (starts with /static or static/)
        if (
          firstImage &&
          (firstImage.startsWith("/static/") ||
            firstImage.startsWith("static/"))
        ) {
          return firstImage.startsWith("/") ? firstImage : "/" + firstImage;
        }

        // If it's just an emoji or short string, return null to use placeholder
        if (firstImage && firstImage.length <= 4) {
          return null;
        }

        return null;
      }

      // Display products in grid
      function displayProducts() {
        const container = document.getElementById("productsContainer");
        const noProductsMessage = document.getElementById("noProductsMessage");

        if (!container) return;

        // Get current user
        const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
        const currentUserName = currentUser.name || "";

        // Handle empty products
        if (!products || products.length === 0) {
          container.innerHTML = "";
          if (noProductsMessage) {
            noProductsMessage.style.display = "block";
          }
          return;
        }

        // Hide no products message if we have products
        if (noProductsMessage) {
          noProductsMessage.style.display = "none";
        }

        // Define categories
        const categories = [
          { name: "Vegetables", icon: "ðŸ¥¬", color: "#4caf50" },
          { name: "Fruits", icon: "ðŸŽ", color: "#ff9800" },
          { name: "Flowers", icon: "ðŸŒ¸", color: "#e91e63" },
          { name: "Grains", icon: "ðŸŒ¾", color: "#795548" },
          { name: "Seeds", icon: "ðŸŒ±", color: "#8bc34a" },
          { name: "Dairy", icon: "ðŸ¥›", color: "#2196f3" }
        ];

        // Group products by category
        const productsByCategory = {};
        categories.forEach(cat => {
          productsByCategory[cat.name] = products.filter(p => 
            (p.category || "").toLowerCase() === cat.name.toLowerCase()
          );
        });

        // Build HTML for each category section
        let html = '';
        
        categories.forEach(category => {
          const categoryProducts = productsByCategory[category.name];
          
          if (categoryProducts && categoryProducts.length > 0) {
            html += `
              <div class="product-category-section" style="margin-bottom: 50px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 10px;">
                  <h3 style="font-size: 28px; color: ${category.color}; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 36px;">${category.icon}</span>
                    <span>Fresh ${category.name}</span>
                  </h3>
                  <button onclick="showCategoryOnly('${category.name}')" style="background: linear-gradient(135deg, ${category.color}, ${adjustColorBrightness(category.color, -20)}); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    View All â†’
                  </button>
                </div>
                
                <div class="products-grid">
                  ${categoryProducts.map(product => generateProductCardHTML(product, currentUserName)).join('')}
                </div>
              </div>
            `;
          }
        });

        if (html === '') {
          noProductsMessage.style.display = "block";
        } else {
          container.innerHTML = html;
        }
      }

      // Generate individual product card HTML
      function generateProductCardHTML(product, currentUserName) {
        const isLiked = likedProducts.includes(product.id);
        const isMyProduct = product.farmer === currentUserName;
        const imageSrc = getProductImageSrc(product);
        const categoryIcon = getCategoryIcon(product.category || "Others");
        const safeName = (product.name || "Unnamed Product").replace(/"/g, "&quot;");
        const safeFarmer = (product.farmer || "Unknown Farmer").replace(/"/g, "&quot;");
        const safeCategory = (product.category || "Others").replace(/"/g, "&quot;");
        const safeLocation = (product.farmerLocation || product.postedBy?.location || "Location not provided").replace(/"/g, "&quot;");
        const distance = product.distance ? `${product.distance} km` : "N/A";
        const price = product.price ? `â‚¹${product.price}` : "â‚¹0";
        const unit = product.unit || "kg";
        const quantity = product.quantity ? `${product.quantity} ${unit}` : "";

        return `
          <div class="product-card" data-product-id="${product.id}" data-category="${safeCategory}" data-farmer="${safeFarmer}" style="position: relative; animation: fadeInUp 0.5s ease;">
            ${isMyProduct ? '<div class="product-badge-my">âœ“ My Product</div>' : ""}
            <div class="product-category-badge">${categoryIcon} ${safeCategory}</div>
            <div class="product-image">
              ${imageSrc ? `<img src="${imageSrc}" alt="${safeName}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 70px;\\'>${categoryIcon}</div>';">
              <div class="product-image-overlay"></div>` : `<div class="product-image-placeholder">${categoryIcon}</div>`}
              <button class="product-like-btn ${isLiked ? "liked" : ""}" data-like-id="${product.id}" onclick="toggleLike(${product.id})" title="${isLiked ? "Remove from favorites" : "Add to favorites"}">${isLiked ? "â¤ï¸" : "ðŸ¤"}</button>
            </div>
            <div class="product-info">
              <h3 class="product-name">${safeName}</h3>
              <div class="product-meta">
                <div class="product-meta-item"><span class="meta-icon">ðŸ‘¤</span><span class="meta-text">${safeFarmer}</span></div>
                <div class="product-meta-item"><span class="meta-icon">ðŸ“</span><span class="meta-text">${safeLocation}</span></div>
                ${distance !== "N/A" ? `<div class="product-meta-item"><span class="meta-icon">ðŸ“</span><span class="meta-text">${distance} away</span></div>` : ""}
                ${quantity ? `<div class="product-meta-item"><span class="meta-icon">ðŸ“¦</span><span class="meta-text">Available: ${quantity}</span></div>` : ""}
              </div>
              <div class="product-price-section"><div class="product-price">${price}<span class="price-unit">/${unit}</span></div></div>
              <div class="product-actions">
                <button class="btn-details" onclick="showProductDetails(${product.id})"><span>ðŸ“‹</span> Details</button>
                <button class="btn-contact" onclick="contactFarmer(${product.id})"><span>ðŸ’¬</span> Contact</button>
                <button class="btn-feedback" onclick="openProductFeedback(${product.id})"><span>â­</span> Give Feedback</button>
              </div>
            </div>
          </div>
        `;
      }

      // Helper function to adjust color brightness
      function adjustColorBrightness(color, amount) {
        const num = parseInt(color.replace("#",""), 16);
        const r = Math.max(0, Math.min(255, (num >> 16) + amount));
        const g = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amount));
        const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
        return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
      }

      // Filter and display products with search, category, and sort
      function filterAndDisplayProducts() {
        const searchInput = document.getElementById("productSearchInput");
        const categoryFilter = document.getElementById("productCategoryFilter");
        const sortFilter = document.getElementById("productSortFilter");
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const selectedCategory = categoryFilter ? categoryFilter.value : '';
        const sortOption = sortFilter ? sortFilter.value : 'newest';

        // Start with all products
        let filteredProducts = [...products];

        // Apply search filter
        if (searchTerm) {
          filteredProducts = filteredProducts.filter(product => {
            const name = (product.name || '').toLowerCase();
            const farmer = (product.farmer || '').toLowerCase();
            const category = (product.category || '').toLowerCase();
            const location = (product.farmerLocation || product.postedBy?.location || '').toLowerCase();
            return name.includes(searchTerm) || farmer.includes(searchTerm) || category.includes(searchTerm) || location.includes(searchTerm);
          });
        }

        // Apply category filter
        if (selectedCategory) {
          filteredProducts = filteredProducts.filter(product => 
            (product.category || '').toLowerCase() === selectedCategory.toLowerCase()
          );
        }

        // Apply sorting
        filteredProducts = sortProductsList(filteredProducts, sortOption);

        // Temporarily replace the global products array for display
        const originalProducts = products;
        products = filteredProducts;
        displayProducts();
        products = originalProducts;
      }

      // Sort products based on selected option
      function sortProductsList(productsList, sortOption) {
        const sorted = [...productsList];
        
        switch(sortOption) {
          case 'newest':
            sorted.sort((a, b) => (b.id || 0) - (a.id || 0));
            break;
          case 'highestRated':
            sorted.sort((a, b) => {
              const ratingA = a.averageRating || a.rating || 0;
              const ratingB = b.averageRating || b.rating || 0;
              return ratingB - ratingA;
            });
            break;
          case 'mostReviewed':
            sorted.sort((a, b) => {
              const countA = a.reviewCount || 0;
              const countB = b.reviewCount || 0;
              return countB - countA;
            });
            break;
          case 'priceLowHigh':
            sorted.sort((a, b) => {
              const priceA = parseFloat(a.price) || 0;
              const priceB = parseFloat(b.price) || 0;
              return priceA - priceB;
            });
            break;
          case 'priceHighLow':
            sorted.sort((a, b) => {
              const priceA = parseFloat(a.price) || 0;
              const priceB = parseFloat(b.price) || 0;
              return priceB - priceA;
            });
            break;
          default:
            sorted.sort((a, b) => (b.id || 0) - (a.id || 0));
        }
        return sorted;
      }

      // Show only specific category
      function showCategoryOnly(category) {
        const categoryFilter = document.getElementById('productCategoryFilter');
        const searchInput = document.getElementById('productSearchInput');
        
        if (searchInput) searchInput.value = '';
        if (categoryFilter) categoryFilter.value = category;
        
        filterAndDisplayProducts();
      }

      // ============================================
      // HISTORY SECTION - Complete Implementation
      // ============================================

      // History state
      let historyData = [];
      let historyCurrentPage = 1;
      let historyTotalPages = 1;
      let historyPerPage = 20;
      let historyCurrentView = "timeline";
      let historySearchTimeout = null;

      // Action type icons mapping
      const historyActionIcons = {
        contacted: "ðŸ“ž",
        liked: "â¤ï¸",
        feedback: "â­",
        viewed: "ðŸ‘ï¸",
        created: "âž•",
        saved: "ðŸ’¾",
        rented: "ðŸšœ",
        responded: "ðŸ’¬",
      };

      // Item type icons mapping
      const historyItemIcons = {
        product: "ðŸ¥¬",
        rental: "ðŸšœ",
        requirement: "ðŸ“‹",
        scheme: "ðŸ›ï¸",
      };

      // Update History section - main entry point
      function updateHistorySection() {
        loadHistoryStats();
        loadHistoryData();
        updateHistoryFavorites();
      }

      // Load history statistics
      async function loadHistoryStats() {
        try {
          const response = await fetch("/api/history/stats");
          const result = await response.json();

          if (result.success) {
            const stats = result.stats;
            document.getElementById("statTotal").textContent = stats.total || 0;
            document.getElementById("statContacted").textContent =
              stats.by_action?.contacted || 0;
            document.getElementById("statLiked").textContent =
              stats.by_action?.liked || 0;
            document.getElementById("statFeedback").textContent =
              stats.by_action?.feedback || 0;
            document.getElementById("statViewed").textContent =
              stats.by_action?.viewed || 0;
          }
        } catch (error) {
          console.error("Error loading history stats:", error);
        }
      }

      // Load history data with filters
      async function loadHistoryData() {
        const loading = document.getElementById("historyLoading");
        const empty = document.getElementById("historyEmpty");
        const timeline = document.getElementById("historyTimeline");
        const listView = document.getElementById("historyList");
        const pagination = document.getElementById("historyPagination");

        // Show loading
        loading.style.display = "flex";
        empty.style.display = "none";

        // Build query parameters
        const params = new URLSearchParams();
        params.append("page", historyCurrentPage);
        params.append("per_page", historyPerPage);

        const searchInput = document.getElementById("historySearchInput");
        const actionFilter = document.getElementById("historyActionFilter");
        const itemFilter = document.getElementById("historyItemFilter");
        const startDate = document.getElementById("historyStartDate");
        const endDate = document.getElementById("historyEndDate");

        if (searchInput && searchInput.value)
          params.append("search", searchInput.value);
        if (actionFilter && actionFilter.value)
          params.append("action_type", actionFilter.value);
        if (itemFilter && itemFilter.value)
          params.append("item_type", itemFilter.value);
        if (startDate && startDate.value)
          params.append("start_date", startDate.value);
        if (endDate && endDate.value) params.append("end_date", endDate.value);

        try {
          const response = await fetch(`/api/history?${params.toString()}`);
          const result = await response.json();

          loading.style.display = "none";

          if (result.success) {
            historyData = result.history;
            historyTotalPages = result.pagination.total_pages;

            if (historyData.length === 0) {
              empty.style.display = "block";
              timeline.innerHTML = "";
              listView.innerHTML = "";
              pagination.style.display = "none";
            } else {
              empty.style.display = "none";
              renderHistoryTimeline();
              renderHistoryList();
              updateHistoryPagination(result.pagination);
            }
          } else {
            showHistoryError(result.message || "Failed to load history");
          }
        } catch (error) {
          loading.style.display = "none";
          console.error("Error loading history:", error);
          showHistoryError("Failed to connect to server");
        }
      }

      // Render timeline view
      function renderHistoryTimeline() {
        const container = document.getElementById("historyTimeline");
        if (!container) return;

        // Group by date
        const grouped = groupHistoryByDate(historyData);

        let html = "";
        for (const [dateLabel, items] of Object.entries(grouped)) {
          html += `
                <div class="history-date-group">
                    <div class="history-date-header">
                        <div class="history-date-marker"></div>
                        <span class="history-date-text">${escapeHtml(dateLabel)}</span>
                    </div>
                    ${items.map((item) => renderHistoryCard(item)).join("")}
                </div>
            `;
        }

        container.innerHTML = html;
      }

      // Render list view
      function renderHistoryList() {
        const container = document.getElementById("historyList");
        if (!container) return;

        container.innerHTML = historyData
          .map((item) => renderHistoryCard(item))
          .join("");
      }

      // Render single history card
      function renderHistoryCard(item) {
        const actionIcon = historyActionIcons[item.action_type] || "ðŸ“Œ";
        const itemIcon = historyItemIcons[item.item_type] || "ðŸ“„";
        const timeStr = formatHistoryTime(item.created_at);
        const itemName = escapeHtml(item.item_name || "Unknown Item");
        const ownerName = escapeHtml(item.owner_name || "");
        const location = escapeHtml(item.location || "");

        return `
            <div class="history-card ${item.action_type}">
                <div class="history-card-header">
                    <div class="history-card-info">
                        <span class="history-card-action-badge ${item.action_type}">
                            ${actionIcon} ${item.action_type}
                        </span>
                        <h4 class="history-card-item-name">${itemIcon} ${itemName}</h4>
                        <div class="history-card-meta">
                            ${ownerName ? `<span class="history-card-meta-item">ðŸ‘¤ ${ownerName}</span>` : ""}
                            ${location ? `<span class="history-card-meta-item">ðŸ“ ${location}</span>` : ""}
                            <span class="history-card-meta-item">ðŸ“ ${item.item_type}</span>
                        </div>
                        <div class="history-card-time">
                            ðŸ• ${timeStr}
                        </div>
                    </div>
                    <div class="history-card-actions">
                        ${item.item_id ? `<button class="history-card-btn view" onclick="viewHistoryItem('${item.item_type}', ${item.item_id})">View</button>` : ""}
                        <button class="history-card-btn delete" onclick="deleteHistoryEntry(${item.id})">âœ•</button>
                    </div>
                </div>
            </div>
        `;
      }

      // Group history by date
      function groupHistoryByDate(items) {
        const groups = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        items.forEach((item) => {
          const itemDate = new Date(item.created_at);
          itemDate.setHours(0, 0, 0, 0);

          let dateLabel;
          if (itemDate.getTime() === today.getTime()) {
            dateLabel = "Today";
          } else if (itemDate.getTime() === yesterday.getTime()) {
            dateLabel = "Yesterday";
          } else {
            dateLabel = itemDate.toLocaleDateString("en-US", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          }

          if (!groups[dateLabel]) {
            groups[dateLabel] = [];
          }
          groups[dateLabel].push(item);
        });

        return groups;
      }

      // Format history time
      function formatHistoryTime(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60)
          return `${diffMins} min${diffMins > 1 ? "s" : ""} ago`;
        if (diffHours < 24)
          return `${diffHours} hour${diffHours > 1 ? "s" : ""} ago`;
        if (diffDays < 7)
          return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;

        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year:
            date.getFullYear() !== now.getFullYear() ? "numeric" : undefined,
        });
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Update pagination
      function updateHistoryPagination(pagination) {
        const container = document.getElementById("historyPagination");
        const prevBtn = document.getElementById("historyPrevBtn");
        const nextBtn = document.getElementById("historyNextBtn");
        const pageInfo = document.getElementById("historyPageInfo");

        if (pagination.total_pages <= 1) {
          container.style.display = "none";
          return;
        }

        container.style.display = "flex";
        pageInfo.textContent = `Page ${pagination.page} of ${pagination.total_pages}`;
        prevBtn.disabled = pagination.page <= 1;
        nextBtn.disabled = pagination.page >= pagination.total_pages;
      }

      // Change page
      function changeHistoryPage(delta) {
        const newPage = historyCurrentPage + delta;
        if (newPage >= 1 && newPage <= historyTotalPages) {
          historyCurrentPage = newPage;
          loadHistoryData();
        }
      }

      // Set view mode
      function setHistoryView(view) {
        historyCurrentView = view;

        const timelineBtn = document.getElementById("timelineViewBtn");
        const listBtn = document.getElementById("listViewBtn");
        const timelineView = document.getElementById("historyTimelineView");
        const listView = document.getElementById("historyListView");

        if (view === "timeline") {
          timelineBtn.classList.add("active");
          listBtn.classList.remove("active");
          timelineView.classList.remove("hidden");
          listView.classList.remove("active");
        } else {
          listBtn.classList.add("active");
          timelineBtn.classList.remove("active");
          listView.classList.add("active");
          timelineView.classList.add("hidden");
        }
      }

      // Apply filters
      function applyHistoryFilters() {
        historyCurrentPage = 1;
        loadHistoryData();
      }

      // Debounced search
      function debounceHistorySearch() {
        if (historySearchTimeout) {
          clearTimeout(historySearchTimeout);
        }
        historySearchTimeout = setTimeout(() => {
          historyCurrentPage = 1;
          loadHistoryData();
        }, 300);
      }

      // Set quick filter
      function setQuickFilter(filter) {
        // Update pill active state
        document.querySelectorAll(".history-filter-pill").forEach((pill) => {
          pill.classList.remove("active");
          if (pill.dataset.filter === filter) {
            pill.classList.add("active");
          }
        });

        // Reset all filters first
        const actionFilter = document.getElementById("historyActionFilter");
        const itemFilter = document.getElementById("historyItemFilter");
        const startDate = document.getElementById("historyStartDate");
        const endDate = document.getElementById("historyEndDate");

        actionFilter.value = "";
        itemFilter.value = "";
        startDate.value = "";
        endDate.value = "";

        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];

        switch (filter) {
          case "today":
            startDate.value = todayStr;
            endDate.value = todayStr;
            break;
          case "week":
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            startDate.value = weekAgo.toISOString().split("T")[0];
            endDate.value = todayStr;
            break;
          case "month":
            const monthAgo = new Date(today);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            startDate.value = monthAgo.toISOString().split("T")[0];
            endDate.value = todayStr;
            break;
          case "products":
            itemFilter.value = "product";
            break;
          case "rentals":
            itemFilter.value = "rental";
            break;
        }

        applyHistoryFilters();
      }

      // View history item
      function viewHistoryItem(itemType, itemId) {
        switch (itemType) {
          case "product":
            showProductDetails(itemId);
            break;
          case "rental":
            if (typeof showRentalDetails === "function") {
              showRentalDetails(itemId);
            }
            break;
          case "requirement":
            // Switch to requirements section
            switchDashSection("requirements");
            break;
          case "scheme":
            switchDashSection("schemes");
            break;
        }
      }

      // Delete single history entry
      async function deleteHistoryEntry(historyId) {
        if (!confirm("Remove this activity from your history?")) return;

        try {
          const response = await fetch(`/api/history/${historyId}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.success) {
            loadHistoryData();
            loadHistoryStats();
          } else {
            alert(result.message || "Failed to delete entry");
          }
        } catch (error) {
          console.error("Error deleting history entry:", error);
          alert("Failed to delete entry");
        }
      }

      // Confirm and clear all history
      function confirmClearHistory() {
        if (
          !confirm(
            "Are you sure you want to clear ALL your activity history? This cannot be undone.",
          )
        )
          return;
        clearAllHistory();
      }

      // Clear all history
      async function clearAllHistory() {
        try {
          const response = await fetch("/api/history/clear", {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.success) {
            loadHistoryData();
            loadHistoryStats();
            alert("History cleared successfully");
          } else {
            alert(result.message || "Failed to clear history");
          }
        } catch (error) {
          console.error("Error clearing history:", error);
          alert("Failed to clear history");
        }
      }

      // Show error message
      function showHistoryError(message) {
        const empty = document.getElementById("historyEmpty");
        empty.innerHTML = `
            <div class="history-empty-icon">âš ï¸</div>
            <h3 class="history-empty-title">Error Loading History</h3>
            <p class="history-empty-text">${escapeHtml(message)}</p>
            <button onclick="loadHistoryData()" style="margin-top: 20px; padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 25px; cursor: pointer;">
                Try Again
            </button>
        `;
        empty.style.display = "block";
      }

      // Update favorites section in history
      function updateHistoryFavorites() {
        const grid = document.getElementById("historyFavoritesGrid");
        const emptyMsg = document.getElementById("historyFavoritesEmpty");
        const section = document.getElementById("historyFavoritesSection");

        if (!grid || !products) return;

        const likedProductsList = products.filter((p) =>
          likedProducts.includes(p.id),
        );

        if (likedProductsList.length === 0) {
          grid.innerHTML = "";
          if (emptyMsg) emptyMsg.style.display = "block";
          return;
        }

        if (emptyMsg) emptyMsg.style.display = "none";

        const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
        const currentUserName = currentUser.name || "";

        grid.innerHTML = likedProductsList
          .map((product) => {
            const isMyProduct = product.farmer === currentUserName;
            return `
                <div class="product-card" data-product-id="${product.id}" style="position: relative;">
                    ${isMyProduct ? '<div style="position: absolute; top: 10px; left: 10px; background: #4caf50; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">âœ“ My Product</div>' : ""}
                    <div class="product-image">
                        ${
                          product.images &&
                          product.images[0] &&
                          product.images[0].startsWith("data:")
                            ? `<img src="${product.images[0]}" alt="${escapeHtml(product.name)}">`
                            : `<div style="font-size: 70px;">${product.images && product.images[0] ? product.images[0] : "ðŸŒ¾"}</div>`
                        }
                        <button class="product-like-btn liked"
                                data-like-id="${product.id}"
                                onclick="toggleLike(${product.id})"
                                title="Remove from favorites">
                            â¤ï¸
                        </button>
                    </div>
                    <div class="product-info">
                        <h3>${escapeHtml(product.name)}</h3>
                        <p style="margin: 5px 0;"><strong>ðŸ‘¤ Farmer:</strong> ${escapeHtml(product.farmer)}</p>
                        <p style="margin: 5px 0; font-size: 14px; color: #666;"><strong>ðŸ“±</strong> ${escapeHtml(product.farmerPhone || product.postedBy?.phone || "Not provided")}</p>
                        <p style="margin: 5px 0; font-size: 14px; color: #666;"><strong>ðŸ“</strong> ${escapeHtml(product.farmerAddress || product.postedBy?.location || "Not provided")}</p>
                        <div class="product-price">â‚¹${product.price}/${escapeHtml(product.unit)}</div>
                        <div class="product-actions">
                            <button class="btn-details" onclick="showProductDetails(${product.id})">Details</button>
                            <button class="btn-contact" onclick="contactFarmer(${product.id})">Contact</button>
                        </div>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // ============================================
      // History Tracking Helper Functions
      // ============================================

      // Add history entry helper
      async function addHistoryEntry(
        actionType,
        itemType,
        itemId,
        itemName,
        ownerName,
        location,
        extraData,
      ) {
        try {
          const response = await fetch("/api/history", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action_type: actionType,
              item_type: itemType,
              item_id: itemId,
              item_name: itemName,
              owner_name: ownerName || "",
              location: location || "",
              extra_data: extraData || null,
            }),
          });

          const result = await response.json();
          if (!result.success) {
            console.error("Failed to add history entry:", result.message);
          }
          return result;
        } catch (error) {
          console.error("Error adding history entry:", error);
          return { success: false };
        }
      }

      // Wizard Step Navigation
      function nextStep(step) {
        if (step === 2) {
          if (!validateStep1()) return;
        } else if (step === 3) {
          if (!validateStep2()) return;
        } else if (step === 4) {
          if (!validateStep3()) return;
          populateReview();
        }

        // Update progress steps first
        updateProgressSteps(step);

        // Smooth scroll to create section
        const createSection = document.getElementById("dashCreate");
        if (createSection) {
          createSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Smooth transition between steps
        requestAnimationFrame(() => {
          document
            .querySelectorAll(".wizard-step")
            .forEach((s) => s.classList.remove("active"));
          requestAnimationFrame(() => {
            document.getElementById(`step${step}`).classList.add("active");
            currentStep = step;
          });
        });
      }

      function previousStep(step) {
        // Update progress steps first
        updateProgressSteps(step);

        // Smooth scroll to create section
        const createSection = document.getElementById("dashCreate");
        if (createSection) {
          createSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Smooth transition between steps
        requestAnimationFrame(() => {
          document
            .querySelectorAll(".wizard-step")
            .forEach((s) => s.classList.remove("active"));
          requestAnimationFrame(() => {
            document.getElementById(`step${step}`).classList.add("active");
            currentStep = step;
          });
        });
      }

      function updateProgressSteps(activeStep) {
        // Update step items (active, completed)
        document.querySelectorAll(".step-item").forEach((item, index) => {
          const stepNum = index + 1;
          item.classList.remove("active", "completed");

          if (stepNum === activeStep) {
            item.classList.add("active");
          } else if (stepNum < activeStep) {
            item.classList.add("completed");
          }
        });

        // Update all connectors based on completed steps
        document
          .querySelectorAll(".step-connector")
          .forEach((connector, index) => {
            const stepNum = index + 1;
            if (stepNum < activeStep) {
              connector.classList.add("completed");
            } else {
              connector.classList.remove("completed");
            }
          });
      }

      function validateStep1() {
        const category = document.getElementById("productCategory").value;
        const name = document.getElementById("productName").value;
        const description = document.getElementById("productDescription").value;

        if (!category || !name || !description) {
          showPopup("Please fill in all required fields");
          return false;
        }
        return true;
      }

      function validateStep2() {
        const quantity = document.getElementById("productQuantity").value;
        const price = document.getElementById("productPrice").value;

        if (!quantity || !price || quantity <= 0 || price <= 0) {
          showPopup("Please enter valid quantity and price");
          return false;
        }
        return true;
      }

      function validateStep3() {
        if (uploadedImages.length === 0) {
          if (!confirm("No images uploaded. Continue without images?")) {
            return false;
          }
        }
        return true;
      }

      // Image Upload Handling
      function handleImageUpload(event) {
        const files = Array.from(event.target.files);

        if (uploadedImages.length + files.length > 5) {
          showPopup("Maximum 5 images allowed");
          return;
        }

        files.forEach((file) => {
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (e) => {
              uploadedImages.push(e.target.result);
              updateImagePreview();
            };
            reader.readAsDataURL(file);
          }
        });
      }

      function captureImage() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const video = document.createElement("video");
          const canvas = document.createElement("canvas");
          const stream = navigator.mediaDevices.getUserMedia({ video: true });

          stream
            .then((mediaStream) => {
              video.srcObject = mediaStream;
              video.play();

              // Create a modal for camera capture
              const modal = document.createElement("div");
              modal.style.cssText =
                "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;";
              modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                        <video id="cameraPreview" autoplay style="width: 400px; border-radius: 10px; margin-bottom: 20px;"></video>
                        <div>
                            <button onclick="capturePhoto()" style="padding: 12px 30px; background: #4caf50; color: white; border: none; border-radius: 8px; margin: 5px; cursor: pointer;">Capture</button>
                            <button onclick="closeCamera()" style="padding: 12px 30px; background: #f5f5f5; color: #666; border: none; border-radius: 8px; margin: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                `;
              document.body.appendChild(modal);

              const preview = document.getElementById("cameraPreview");
              preview.srcObject = mediaStream;

              window.capturePhoto = function () {
                canvas.width = preview.videoWidth;
                canvas.height = preview.videoHeight;
                canvas.getContext("2d").drawImage(preview, 0, 0);
                const imageData = canvas.toDataURL("image/jpeg");
                uploadedImages.push(imageData);
                updateImagePreview();
                closeCamera();
              };

              window.closeCamera = function () {
                mediaStream.getTracks().forEach((track) => track.stop());
                document.body.removeChild(modal);
              };
            })
            .catch(() => {
              showPopup(
                "Camera access denied. Please use file upload instead.",
              );
            });
        } else {
          showPopup("Camera not available. Please use file upload instead.");
        }
      }

      function updateImagePreview() {
        const preview = document.getElementById("imagePreview");
        preview.innerHTML = uploadedImages
          .map(
            (img, index) => `
            <div class="image-preview-item">
                <img src="${img}" alt="Preview ${index + 1}">
                <button class="remove-btn" onclick="removeImage(${index})">Ã—</button>
            </div>
        `,
          )
          .join("");
      }

      function removeImage(index) {
        uploadedImages.splice(index, 1);
        updateImagePreview();
      }

      // ===== VIDEO UPLOAD & RECORDING FUNCTIONS =====
      function handleVideoUpload(event) {
        const files = Array.from(event.target.files);
        if (uploadedVideos.length + files.length > 3) {
          alert("You can only upload up to 3 videos!");
          return;
        }
        files.forEach((file) => {
          if (file.type.startsWith("video/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              uploadedVideos.push({
                url: e.target.result,
                type: "video",
                name: file.name,
              });
              updateVideoPreview();
            };
            reader.readAsDataURL(file);
          }
        });
      }

      function captureVideo() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "video/*";
        input.capture = "environment";
        input.onchange = handleVideoUpload;
        input.click();
      }

      function updateVideoPreview() {
        const preview = document.getElementById("videoPreview");
        preview.innerHTML = uploadedVideos
          .map(
            (video, index) => `
            <div class="image-preview-item">
                <video src="${video.url}" style="width: 100%; height: 100%; object-fit: cover;" controls></video>
                <button onclick="removeVideo(${index})" class="remove-btn" style="position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; font-weight: bold;">Ã—</button>
            </div>
        `,
          )
          .join("");
      }

      function removeVideo(index) {
        uploadedVideos.splice(index, 1);
        updateVideoPreview();
      }

      function populateReview() {
        document.getElementById("reviewCategory").textContent =
          document.getElementById("productCategory").value;
        document.getElementById("reviewName").textContent =
          document.getElementById("productName").value;
        document.getElementById("reviewDescription").textContent =
          document.getElementById("productDescription").value;
        document.getElementById("reviewQuantity").textContent =
          `${document.getElementById("productQuantity").value} ${document.getElementById("quantityUnit").value}`;
        document.getElementById("reviewPrice").textContent =
          `â‚¹${document.getElementById("productPrice").value}/${document.getElementById("quantityUnit").value}`;

        const reviewImages = document.getElementById("reviewImages");
        reviewImages.innerHTML = uploadedImages
          .map(
            (img, index) =>
              `<img src="${img}" alt="Review" onclick="openGallery(${JSON.stringify(uploadedImages)}, ${index})" style="cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">`,
          )
          .join("");
      }

      async function publishProduct() {
        // Get logged-in user's data from localStorage
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const farmerName = user.name || "Anonymous Farmer";
        const farmerPhone = user.phone || "Not Provided";
        const farmerLocation = user.location || "Not Provided";

        console.log("Publishing product for user:", user);

        // Get product data from form
        const category = document.getElementById("productCategory").value;
        const name = document.getElementById("productName").value;
        const description = document.getElementById("productDescription").value;
        const quantity = parseFloat(
          document.getElementById("productQuantity").value,
        );
        const price = parseFloat(document.getElementById("productPrice").value);
        const unit = document.getElementById("quantityUnit").value;

        // Validate required fields
        if (!category || !name || !description || !quantity || !price) {
          showPopup("Please fill in all required fields");
          return;
        }

        try {
          // Upload images first if any
          const imageUrls = [];
          if (uploadedImages.length > 0) {
            for (const imageData of uploadedImages) {
              // Convert data URL to blob
              const base64Data = imageData.split(",")[1];
              const byteCharacters = atob(base64Data);
              const byteNumbers = new Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], { type: "image/jpeg" });

              // Upload to server
              const formData = new FormData();
              formData.append("file", blob, "product-image.jpg");

              const uploadResponse = await fetch("/api/upload", {
                method: "POST",
                body: formData,
              });

              const uploadData = await uploadResponse.json();
              if (uploadData.success) {
                imageUrls.push(uploadData.url);
              }
            }
          }

          // Create product via API
          const productData = {
            category: category,
            name: name,
            description: description,
            quantity: quantity,
            unit: unit,
            price: price,
            images: imageUrls,
          };

          const createResponse = await fetch("/api/products", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(productData),
          });

          const createData = await createResponse.json();

          if (createData.success) {
            // Add to history (product created)
            const currentUser = JSON.parse(
              localStorage.getItem("user") || "{}",
            );
            addHistoryEntry(
              "created",
              "product",
              null,
              name,
              currentUser.name || "You",
              currentUser.location || "",
              {
                category: category,
                price: price,
                unit: unit,
                quantity: quantity,
              },
            );

            // Show success message
            showSuccessMessage(
              "âœ… Your product has been successfully added and is now visible to nearby customers.",
            );

            // Reset form
            resetWizard();

            // Reload products from API
            initializeProducts();
          } else {
            showPopup(
              createData.message ||
                "Failed to create product. Please try again.",
            );
          }
        } catch (error) {
          console.error("Error publishing product:", error);
          showPopup(
            "An error occurred while publishing the product. Please try again.",
          );
        }
      }

      function resetWizard() {
        document.getElementById("productCategory").value = "";
        document.getElementById("productName").value = "";
        document.getElementById("productDescription").value = "";
        document.getElementById("productQuantity").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("quantityUnit").value = "kg";
        uploadedImages = [];
        uploadedVideos = [];
        document.getElementById("imagePreview").innerHTML = "";
        document.getElementById("videoPreview").innerHTML = "";
        nextStep(1);
      }

      function showProductDetails(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        // Add to history (viewed)
        addHistoryEntry(
          "viewed",
          "product",
          product.id,
          product.name,
          product.farmer,
          product.farmerAddress || product.postedBy?.location || "",
          {
            price: product.price,
            unit: product.unit,
            quantity: product.quantity,
          },
        );

        // Get farmer data for rating
        const farmerData = farmersData[product.farmer] || { feedbacks: [] };
        const avgRating = calculateAverageRating(farmerData.feedbacks);

        const modal = document.createElement("div");
        modal.className = "product-details-modal";
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px);";

        // Filter out valid images (data URLs or emoji)
        const validImages = product.images.filter(
          (img) => img && (img.startsWith("data:") || img.length <= 4),
        );

        // Get location information
        const location =
          product.farmerAddress ||
          product.postedBy?.location ||
          product.farmerLocation ||
          "Location not provided";
        const distance = product.distance
          ? `${product.distance} km away`
          : "Distance not available";
        const availableQuantity = product.quantity
          ? `${product.quantity} ${product.unit || "kg"}`
          : "Not specified";
        const productCost = product.price
          ? `â‚¹${product.price}/${product.unit || "kg"}`
          : "Price not available";
        const productDescription =
          product.description || "No description provided";

        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 24px; padding: 0; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
                <!-- Close Button -->
                <button onclick="this.closest('.product-details-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: #333;" onmouseover="this.style.background='#fff'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='rotate(0deg)'">Ã—</button>
                
                <!-- Header Section with Product Name -->
                <div style="background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); padding: 35px 40px; border-radius: 24px 24px 0 0; color: white;">
                    <h2 style="color: white; margin: 0 0 10px 0; font-family: 'Poppins', sans-serif; font-size: 32px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">${product.name || "Product Name"}</h2>
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                        <span style="font-size: 18px; opacity: 0.95;">${product.category || "Category"}</span>
                        ${
                          farmerData.feedbacks.length > 0
                            ? `
                            <span style="font-size: 16px; opacity: 0.9;">|</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-size: 18px;">${createStarRating(parseFloat(avgRating))}</div>
                                <span style="font-size: 16px; opacity: 0.95;">${avgRating} / 5.0 (${farmerData.feedbacks.length} ${farmerData.feedbacks.length === 1 ? "review" : "reviews"})</span>
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>

                <!-- Content Section -->
                <div style="padding: 40px;">
                    <!-- Product Images -->
                    ${
                      validImages.length > 0
                        ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 35px;">
                            ${validImages
                              .map((img, index) => {
                                if (img.startsWith("data:")) {
                                  return `<img src="${img}" onclick="openGallery(${JSON.stringify(validImages.filter((i) => i.startsWith("data:")))}, ${validImages.filter((i) => i.startsWith("data:")).indexOf(img)})" style="width: 100%; height: 200px; object-fit: cover; border-radius: 16px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">`;
                                } else {
                                  return `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, #c8e6c9, #a5d6a7); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 80px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">${img}</div>`;
                                }
                              })
                              .join("")}
                        </div>
                    `
                        : ""
                    }

                    <!-- Product Information Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Farmer Name Card -->
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 25px; border-radius: 16px; border: 2px solid rgba(46,125,50,0.2); box-shadow: 0 4px 12px rgba(46,125,50,0.1);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 28px;">ðŸ‘¤</span>
                                <h3 style="margin: 0; color: #2e7d32; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Farmer Name</h3>
                            </div>
                            <p style="margin: 0; color: #1b5e20; font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 600;">${product.farmer || "Unknown Farmer"}</p>
                        </div>

                        <!-- Product Cost Card -->
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 25px; border-radius: 16px; border: 2px solid rgba(255,152,0,0.2); box-shadow: 0 4px 12px rgba(255,152,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 28px;">ðŸ’°</span>
                                <h3 style="margin: 0; color: #f57c00; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Cost of Product</h3>
                            </div>
                            <p style="margin: 0; color: #e65100; font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700;">${productCost}</p>
                        </div>

                        <!-- Available Quantity Card -->
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 16px; border: 2px solid rgba(33,150,243,0.2); box-shadow: 0 4px 12px rgba(33,150,243,0.1);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 28px;">ðŸ“¦</span>
                                <h3 style="margin: 0; color: #1976d2; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Available Quantity</h3>
                            </div>
                            <p style="margin: 0; color: #0d47a1; font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 600;">${availableQuantity}</p>
                        </div>

                        <!-- Location Card -->
                        <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); padding: 25px; border-radius: 16px; border: 2px solid rgba(233,30,99,0.2); box-shadow: 0 4px 12px rgba(233,30,99,0.1);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 28px;">ðŸ“</span>
                                <h3 style="margin: 0; color: #c2185b; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Location</h3>
                            </div>
                            <p style="margin: 0; color: #880e4f; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; line-height: 1.4;">${location}</p>
                            ${product.distance ? `<p style="margin: 8px 0 0 0; color: #ad1457; font-family: 'Poppins', sans-serif; font-size: 14px; opacity: 0.8;">${distance}</p>` : ""}
                        </div>
                    </div>

                    <!-- Description Card -->
                    <div style="background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%); padding: 25px; border-radius: 16px; border: 2px solid rgba(0,0,0,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <span style="font-size: 28px;">ðŸ“</span>
                            <h3 style="margin: 0; color: #424242; font-family: 'Poppins', sans-serif; font-size: 18px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Description of Product</h3>
                        </div>
                        <p style="margin: 0; color: #212121; font-family: 'Poppins', sans-serif; font-size: 16px; line-height: 1.7; text-align: justify;">${productDescription}</p>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Contact Farmer Button -->
                        <button onclick="this.closest('.product-details-modal').remove(); contactFarmer(${product.id})" style="width: 100%; padding: 18px 24px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border: none; border-radius: 14px; font-size: 18px; font-weight: 700; font-family: 'Poppins', sans-serif; cursor: pointer; box-shadow: 0 6px 20px rgba(46,125,50,0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(46,125,50,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(46,125,50,0.4)'">
                            ðŸ’¬ Contact Farmer
                        </button>

                        <!-- Product Views Button - Modern & Classical Design -->
                        <button onclick="this.closest('.product-details-modal').remove(); showProductViews(${product.id})" style="width: 100%; padding: 18px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 14px; font-size: 18px; font-weight: 700; font-family: 'Poppins', sans-serif; cursor: pointer; box-shadow: 0 6px 20px rgba(102,126,234,0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.4)'">
                            <span style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="font-size: 22px;">ðŸŽ¬</span>
                                <span>Product Views (Images & Videos)</span>
                            </span>
                        </button>

                        <!-- Back to Products Button -->
                        <button onclick="this.closest('.product-details-modal').remove()" style="width: 100%; padding: 16px 24px; background: #ffffff; color: #666; border: 2px solid #e0e0e0; border-radius: 14px; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f5f5f5'; this.style.borderColor='#bdbdbd'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#ffffff'; this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'">
                            â¬… Back to Products
                        </button>
                    </div>
                    
                    <!-- Feedback Section -->
                    <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #e0e0e0;">
                        <h3 style="color: #2e7d32; margin-bottom: 25px; font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>â­</span> Feedback & Ratings
                        </h3>
                        
                        <!-- Feedback Display Area -->
                        <div id="productFeedbackDisplay_${product.id}" style="margin-bottom: 30px;">
                            <!-- Feedback will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Load existing feedback
        loadProductFeedbackDisplay(product.id);
      }

      // Load and display product feedback
      async function loadProductFeedbackDisplay(productId) {
        const displayDiv = document.getElementById(
          `productFeedbackDisplay_${productId}`,
        );
        if (!displayDiv) return;

        try {
          const response = await fetch(`/api/products/${productId}/feedback`);
          const result = await response.json();

          if (result.success) {
            displayProductFeedbackCards(displayDiv, result);
          } else {
            displayDiv.innerHTML =
              '<p style="color: #999; text-align: center; padding: 20px;">No feedback yet. Be the first to review!</p>';
          }
        } catch (error) {
          console.error("Error loading feedback:", error);
          displayDiv.innerHTML =
            '<p style="color: #999; text-align: center; padding: 20px;">Error loading feedback</p>';
        }
      }

      // Display product feedback cards
      function displayProductFeedbackCards(container, data) {
        if (!data.feedbacks || data.feedbacks.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center; padding: 20px;">No feedback yet. Be the first to review!</p>';
          return;
        }

        let html = `
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 10px;">${createStarRating(parseFloat(data.avg_rating))}</div>
                <div style="font-size: 24px; font-weight: 700; color: #2e7d32; margin-bottom: 5px;">${data.avg_rating} / 5.0</div>
                <div style="color: #666; font-size: 14px;">${data.review_count} ${data.review_count === 1 ? "review" : "reviews"}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 20px;">
        `;

        data.feedbacks.forEach((fb) => {
          html += `
                <div style="background: white; padding: 20px; border-radius: 16px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-weight: 700; color: #333; font-size: 18px;">${fb.user_name || "Anonymous"}</div>
                        <div style="font-size: 20px;">${createStarRating(fb.rating)}</div>
                    </div>
                    ${fb.comment ? `<div style="color: #555; line-height: 1.6; margin-bottom: 15px;">${fb.comment}</div>` : ""}
                    ${
                      fb.images && fb.images.length > 0
                        ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            ${fb.images
                              .map(
                                (img) => `
                                <img src="/static/${img}" onclick="openImageModal('/static/${img}')" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            `,
                              )
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                    ${
                      fb.videos && fb.videos.length > 0
                        ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            ${fb.videos
                              .map(
                                (vid) => `
                                <video src="/static/${vid}" controls style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;"></video>
                            `,
                              )
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                    <div style="color: #999; font-size: 12px; margin-top: 10px;">${new Date(fb.created_at).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })}</div>
                </div>
            `;
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // Open image modal for enlarged view
      function openImageModal(imageSrc) {
        const modal = document.createElement("div");
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center; cursor: pointer;";
        modal.onclick = () => modal.remove();
        modal.innerHTML = `
            <img src="${imageSrc}" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
        `;
        document.body.appendChild(modal);
      }

      function contactFarmer(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        // Add to history
        addHistoryEntry(
          "contacted",
          "product",
          product.id,
          product.name,
          product.farmer,
          product.farmerAddress || product.postedBy?.location || "",
          {
            price: product.price,
            unit: product.unit,
            phone: product.farmerPhone || product.postedBy?.phone,
          },
        );

        // Create contact modal
        const modal = document.createElement("div");
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; display: flex; align-items: center; justify-content: center; padding: 20px;";

        modal.innerHTML = `
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; position: relative;">
                <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 15px; right: 15px; background: #f5f5f5; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer;">Ã—</button>
                <h2 style="color: #2e7d32; margin-bottom: 20px; font-family: 'Poppins', sans-serif; text-align: center;">ðŸ“ž Contact Farmer</h2>

                <div style="background: linear-gradient(135deg, #4caf50, #45a049); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        ${
                          farmersData[product.farmer] &&
                          farmersData[product.farmer].profileImage
                            ? `<img src="${farmersData[product.farmer].profileImage}" alt="Profile" style="width:80px;height:80px;object-fit:cover;border-radius:50%;background:white;box-shadow:0 4px 15px rgba(0,0,0,0.2);border:3px solid #4caf50;">`
                            : `<div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">ðŸ‘¤</div>`
                        }
                    </div>
                    <h3 style="margin: 0; text-align: center; font-size: 24px;">${product.farmer}</h3>
                </div>

                <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <p style="margin: 10px 0; font-size: 16px;"><strong>Product:</strong> ${product.name}</p>
                    <p style="margin: 10px 0; font-size: 16px;"><strong>Price:</strong> â‚¹${product.price}/${product.unit}</p>
                    <p style="margin: 10px 0; font-size: 16px;"><strong>Available:</strong> ${product.quantity} ${product.unit}</p>
                </div>

                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                    <h4 style="color: #2e7d32; margin-top: 0; margin-bottom: 15px;">Farmer Contact Details:</h4>
                    <div style="margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ðŸ“±</span>
                        <strong>Phone:</strong>
                        <a href="tel:${product.farmerPhone || product.postedBy?.phone || ""}" style="color: #2e7d32; text-decoration: none; font-weight: 600;">${product.farmerPhone || product.postedBy?.phone || "Not provided"}</a>
                    </div>
                    <div style="margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ðŸ“§</span>
                        <strong>Email:</strong>
                        <a href="mailto:${product.farmerEmail || product.postedBy?.email || ""}" style="color: #2e7d32; text-decoration: none;">${product.farmerEmail || product.postedBy?.email || "Not provided"}</a>
                    </div>
                    <div style="margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ðŸ“</span>
                        <strong>Location:</strong>
                        <span>${product.farmerAddress || product.postedBy?.location || "Not provided"}</span>
                    </div>
                </div>

                <button onclick="this.closest('div[style*=fixed]').remove()" style="width: 100%; padding: 14px; background: #4caf50; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; margin-top: 20px;">Close</button>
            </div>
        `;

        document.body.appendChild(modal);
      }

      // Open Product Feedback Modal
      function openProductFeedback(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) {
          showPopup("Product not found");
          return;
        }

        const farmerName = product.farmer;
        if (!farmerName) {
          showPopup("Farmer information not available");
          return;
        }

        // Initialize farmer data if not exists
        if (!farmersData[farmerName]) {
          const farmerProduct = products.find((p) => p.farmer === farmerName);
          if (farmerProduct && farmerProduct.postedBy) {
            farmersData[farmerName] = {
              name: farmerProduct.postedBy.name,
              phone: farmerProduct.postedBy.phone,
              email: farmerProduct.postedBy.email,
              location: farmerProduct.postedBy.location,
              profileImage: farmerProduct.postedBy.profileImage || "",
              feedbacks: [],
            };
          } else if (farmerProduct) {
            farmersData[farmerName] = {
              name: farmerProduct.farmer,
              phone: farmerProduct.farmerPhone || "Not Provided",
              email: farmerProduct.farmerEmail || "Not Provided",
              location: farmerProduct.farmerAddress || "Not Provided",
              profileImage: "",
              feedbacks: [],
            };
          } else {
            farmersData[farmerName] = {
              name: farmerName,
              phone: "Not Provided",
              email: "Not Provided",
              location: "Not Provided",
              profileImage: "",
              feedbacks: [],
            };
          }
        }

        const farmerData = farmersData[farmerName];
        const avgRating = calculateAverageRating(farmerData.feedbacks);

        // Create feedback modal
        const modal = document.createElement("div");
        modal.className = "product-feedback-modal";
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10003; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px);";

        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 24px; padding: 0; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
                <!-- Close Button -->
                <button onclick="this.closest('.product-feedback-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: #333;" onmouseover="this.style.background='#fff'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='rotate(0deg)'">Ã—</button>
                
                <!-- Header Section -->
                <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 35px 40px; border-radius: 24px 24px 0 0; color: white;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <span style="font-size: 40px;">â­</span>
                        <h2 style="color: white; margin: 0; font-family: 'Poppins', sans-serif; font-size: 28px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">Give Feedback</h2>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.95;">Share your experience with <strong>${product.name}</strong> from <strong>${farmerName}</strong></p>
                </div>

                <!-- Content Section -->
                <div style="padding: 40px;">
                    <!-- Product Info Card -->
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 16px; border: 2px solid rgba(255,152,0,0.2); box-shadow: 0 4px 12px rgba(255,152,0,0.1); margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${getCategoryIcon(product.category || "Others")}</div>
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: #e65100; font-family: 'Poppins', sans-serif; font-size: 18px; font-weight: 600;">${product.name}</h3>
                                <p style="margin: 0; color: #bf360c; font-family: 'Poppins', sans-serif; font-size: 14px;">Farmer: ${farmerName}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Current Rating Display -->
                    ${
                      farmerData.feedbacks.length > 0
                        ? `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 16px; margin-bottom: 30px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Current Rating</p>
                            <div style="font-size: 32px; margin-bottom: 8px;">${createStarRating(parseFloat(avgRating))}</div>
                            <p style="margin: 0; color: #333; font-size: 18px; font-weight: 700;">${avgRating} / 5.0</p>
                            <p style="margin: 5px 0 0 0; color: #999; font-size: 14px;">${farmerData.feedbacks.length} ${farmerData.feedbacks.length === 1 ? "review" : "reviews"}</p>
                        </div>
                    `
                        : `
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 16px; margin-bottom: 30px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Current Rating</p>
                            <div style="font-size: 32px; margin-bottom: 8px; opacity: 0.3;">â˜†â˜†â˜†â˜†â˜†</div>
                            <p style="margin: 0; color: #999; font-size: 14px;">No ratings yet</p>
                        </div>
                    `
                    }

                    <!-- Feedback Form -->
                    <form id="productFeedbackForm_${productId}" onsubmit="submitProductFeedbackNew(event, ${productId})" enctype="multipart/form-data" style="background: #f1f8e9; padding: 25px; border-radius: 16px; border: 2px solid rgba(76,175,80,0.2);">
                        <h4 style="color: #2e7d32; margin-bottom: 20px; font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 600;">Your Feedback</h4>
                        
                        <!-- Star Rating (Required) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333; font-family: 'Poppins', sans-serif;">Rating <span style="color: #f44336;">*</span></label>
                            <div id="ratingStars_${productId}" style="font-size: 36px; cursor: pointer; display: flex; gap: 8px; justify-content: center;">
                                <span data-rating="1" style="opacity: 0.3; transition: all 0.2s ease; transform: scale(1); user-select: none;">â­</span>
                                <span data-rating="2" style="opacity: 0.3; transition: all 0.2s ease; transform: scale(1); user-select: none;">â­</span>
                                <span data-rating="3" style="opacity: 0.3; transition: all 0.2s ease; transform: scale(1); user-select: none;">â­</span>
                                <span data-rating="4" style="opacity: 0.3; transition: all 0.2s ease; transform: scale(1); user-select: none;">â­</span>
                                <span data-rating="5" style="opacity: 0.3; transition: all 0.2s ease; transform: scale(1); user-select: none;">â­</span>
                            </div>
                            <input type="hidden" id="selectedRating_${productId}" name="rating" value="0" required>
                            <p id="ratingText_${productId}" style="color: #666; font-size: 14px; margin-top: 8px; text-align: center;">Click to rate</p>
                        </div>
                        
                        <!-- Comment (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-family: 'Poppins', sans-serif;">Comment (Optional):</label>
                            <textarea id="feedbackComment_${productId}" name="comment" placeholder="Write your feedback here... Share your experience with this product!" rows="5" style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; font-family: 'Poppins', sans-serif; box-sizing: border-box; resize: vertical; transition: all 0.3s ease;" onfocus="this.style.borderColor='#4caf50'; this.style.boxShadow='0 0 0 3px rgba(76,175,80,0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                        </div>
                        
                        <!-- Image Upload (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-family: 'Poppins', sans-serif;">Upload Images (Optional - JPG/PNG):</label>
                            <input type="file" id="feedbackImages_${productId}" name="images" multiple accept="image/jpeg,image/jpg,image/png" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: 'Poppins', sans-serif; box-sizing: border-box;">
                            <div id="imagePreview_${productId}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                        </div>
                        
                        <!-- Video Upload (Optional) -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-family: 'Poppins', sans-serif;">Upload Videos (Optional - MP4):</label>
                            <input type="file" id="feedbackVideos_${productId}" name="videos" multiple accept="video/mp4" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: 'Poppins', sans-serif; box-sizing: border-box;">
                            <div id="videoPreview_${productId}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                        </div>
                        
                        <button type="submit" style="width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border: none; border-radius: 14px; font-size: 18px; font-weight: 700; font-family: 'Poppins', sans-serif; cursor: pointer; box-shadow: 0 6px 20px rgba(76,175,80,0.4); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(76,175,80,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(76,175,80,0.4)'">
                            â­ Submit Feedback
                        </button>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Initialize star rating interaction
        initializeProductFeedbackStars(productId);

        // Initialize file previews
        initializeProductFeedbackFilePreviews(productId);
      }

      // Initialize star rating for product feedback
      function initializeProductFeedbackStars(productId) {
        const stars = document.querySelectorAll(
          `#ratingStars_${productId} span`,
        );
        const selectedRatingInput = document.getElementById(
          `selectedRating_${productId}`,
        );
        const ratingText = document.getElementById(`ratingText_${productId}`);
        const starsContainer = document.getElementById(
          `ratingStars_${productId}`,
        );
        let selectedRating = 0;

        const ratingLabels = [
          "",
          "Poor",
          "Fair",
          "Good",
          "Very Good",
          "Excellent",
        ];

        stars.forEach((star, index) => {
          star.addEventListener("mouseenter", () => {
            for (let i = 0; i <= index; i++) {
              stars[i].style.opacity = "1";
              stars[i].style.transform = "scale(1.2)";
            }
            for (let i = index + 1; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
              stars[i].style.transform = "scale(1)";
            }
            ratingText.textContent = ratingLabels[index + 1];
          });
          star.addEventListener("click", () => {
            selectedRating = index + 1;
            selectedRatingInput.value = selectedRating;
            for (let i = 0; i <= index; i++) {
              stars[i].style.opacity = "1";
              stars[i].style.transform = "scale(1.2)";
            }
            for (let i = index + 1; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
              stars[i].style.transform = "scale(1)";
            }
            ratingText.textContent = `${selectedRating} Star${selectedRating > 1 ? "s" : ""} - ${ratingLabels[selectedRating]}`;
          });
        });

        // Reset stars on mouse leave if no rating selected
        starsContainer.addEventListener("mouseleave", () => {
          if (selectedRating === 0) {
            stars.forEach((star) => {
              star.style.opacity = "0.3";
              star.style.transform = "scale(1)";
            });
            ratingText.textContent = "Click to rate";
          } else {
            for (let i = 0; i < selectedRating; i++) {
              stars[i].style.opacity = "1";
              stars[i].style.transform = "scale(1.2)";
            }
            for (let i = selectedRating; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
              stars[i].style.transform = "scale(1)";
            }
            ratingText.textContent = `${selectedRating} Star${selectedRating > 1 ? "s" : ""} - ${ratingLabels[selectedRating]}`;
          }
        });
      }

      // Initialize file previews for product feedback
      function initializeProductFeedbackFilePreviews(productId) {
        const imageInput = document.getElementById(
          `feedbackImages_${productId}`,
        );
        const videoInput = document.getElementById(
          `feedbackVideos_${productId}`,
        );
        const imagePreview = document.getElementById(
          `imagePreview_${productId}`,
        );
        const videoPreview = document.getElementById(
          `videoPreview_${productId}`,
        );

        if (imageInput && imagePreview) {
          imageInput.addEventListener("change", (e) => {
            imagePreview.innerHTML = "";
            Array.from(e.target.files).forEach((file) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.style.cssText =
                  "width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;";
                imagePreview.appendChild(img);
              };
              reader.readAsDataURL(file);
            });
          });
        }

        if (videoInput && videoPreview) {
          videoInput.addEventListener("change", (e) => {
            videoPreview.innerHTML = "";
            Array.from(e.target.files).forEach((file) => {
              const video = document.createElement("video");
              video.src = URL.createObjectURL(file);
              video.controls = true;
              video.style.cssText =
                "width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;";
              videoPreview.appendChild(video);
            });
          });
        }
      }

      // Submit product feedback (new version with file uploads)
      async function submitProductFeedbackNew(event, productId) {
        event.preventDefault();

        const ratingInput = document.getElementById(
          `selectedRating_${productId}`,
        );
        const rating = parseInt(ratingInput.value);

        if (!rating || rating < 1 || rating > 5) {
          showPopup("Please select a rating (1-5 stars)");
          return;
        }

        const form = document.getElementById(
          `productFeedbackForm_${productId}`,
        );
        const formData = new FormData(form);
        formData.append("rating", rating);

        try {
          const response = await fetch(`/api/products/${productId}/feedback`, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showSuccessMessage("âœ… Feedback submitted successfully!");

            // Close modal
            const feedbackModal = document.querySelector(
              ".product-feedback-modal",
            );
            if (feedbackModal) {
              feedbackModal.remove();
            }

            // Refresh product details if open
            const productDetailsModal = document.querySelector(
              ".product-details-modal",
            );
            if (productDetailsModal) {
              productDetailsModal.remove();
              showProductDetails(productId);
            }

            // Update profile section if viewing it
            if (typeof updateProfileFeedbacks === "function") {
              updateProfileFeedbacks();
            }
          } else {
            showPopup(result.message || "Failed to submit feedback");
          }
        } catch (error) {
          console.error("Error submitting feedback:", error);
          showPopup("An error occurred while submitting feedback");
        }
      }

      // Submit Product Feedback
      function submitProductFeedback(productId, farmerName) {
        const customerName = document
          .getElementById("feedbackCustomerName")
          .value.trim();
        const customerPhone = document
          .getElementById("feedbackCustomerPhone")
          .value.trim();
        const rating = parseInt(
          document.getElementById("selectedRating").value,
        );
        const comment = document.getElementById("feedbackComment").value.trim();

        if (!rating || rating === 0) {
          showPopup("Please select a rating");
          return;
        }

        if (!comment) {
          showPopup("Please write a comment");
          return;
        }

        const feedback = {
          id: Date.now(),
          customerName: customerName || "Anonymous",
          customerPhone: customerPhone || "",
          rating: rating,
          comment: comment,
          date: new Date().toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          }),
          productId: productId,
        };

        if (!farmersData[farmerName]) {
          farmersData[farmerName] = {
            name: farmerName,
            phone: "+91 0000000000",
            email: "Not Provided",
            location: "Location not available",
            profileImage: "",
            feedbacks: [],
          };
        }

        farmersData[farmerName].feedbacks.push(feedback);

        // Add to history
        const product = products.find((p) => p.id === productId);
        if (product) {
          addHistoryEntry(
            "feedback",
            "product",
            productId,
            product.name,
            farmerName,
            product.farmerAddress || product.postedBy?.location || "",
            { rating: rating, comment: comment },
          );
        }

        // Close modal and show success
        const feedbackModal = document.querySelector(".product-feedback-modal");
        if (feedbackModal) {
          feedbackModal.remove();
        }
        showPopup(
          "Feedback submitted successfully! Thank you for your review! â­",
        );

        // Update profile section if viewing it
        updateProfileFeedbacks();

        // Refresh product details if modal is open
        const productDetailsModal = document.querySelector(
          ".product-details-modal",
        );
        if (productDetailsModal) {
          productDetailsModal.remove();
          showProductDetails(productId);
        }
      }

      // Show Farmer Details Modal
      function showFarmerDetails(farmerName) {
        // Initialize farmer data if not exists - try to find from products first
        if (!farmersData[farmerName]) {
          // Try to find a product by this farmer to get their details
          const farmerProduct = products.find((p) => p.farmer === farmerName);

          if (farmerProduct && farmerProduct.postedBy) {
            // Use product's postedBy data
            farmersData[farmerName] = {
              name: farmerProduct.postedBy.name,
              phone: farmerProduct.postedBy.phone,
              email: farmerProduct.postedBy.email,
              location: farmerProduct.postedBy.location,
              profileImage: farmerProduct.postedBy.profileImage || "",
              feedbacks: [],
            };
          } else if (farmerProduct) {
            // Use available product data
            farmersData[farmerName] = {
              name: farmerProduct.farmer,
              phone: farmerProduct.farmerPhone || "Not Provided",
              email: farmerProduct.farmerEmail || "Not Provided",
              location: farmerProduct.farmerAddress || "Not Provided",
              profileImage: "",
              feedbacks: [],
            };
          } else {
            // Fallback to basic data
            farmersData[farmerName] = {
              name: farmerName,
              phone: "Not Provided",
              email: "Not Provided",
              location: "Not Provided",
              profileImage: "",
              feedbacks: [],
            };
          }
        }

        const farmerData = farmersData[farmerName];
        const avgRating = calculateAverageRating(farmerData.feedbacks);

        const modal = document.createElement("div");
        modal.className = "farmer-details-modal";
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;";
        modal.innerHTML = `
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative;">
                <button onclick="this.closest('.farmer-details-modal').remove()" style="position: absolute; top: 15px; right: 15px; background: #f5f5f5; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer;">Ã—</button>

                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
                    ${
                      farmerData.profileImage
                        ? `<img src="${farmerData.profileImage}" alt="Profile" style="width:100px;height:100px;object-fit:cover;border-radius:50%;border:4px solid #4caf50;box-shadow:0 4px 15px rgba(46,125,50,0.3);">`
                        : `<div style="width:100px;height:100px;background:linear-gradient(135deg,#4caf50,#45a049);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;box-shadow:0 4px 15px rgba(46,125,50,0.3);">ðŸ‘¤</div>`
                    }
                    <h2 style="color: #2e7d32; margin: 0; font-family: 'Poppins', sans-serif;">${farmerData.name}</h2>
                </div>

                <div style="margin-bottom: 30px;">
                    <p style="font-size: 18px; margin-bottom: 10px;"><strong>ðŸ“ž Phone:</strong> ${farmerData.phone}</p>
                    <p style="font-size: 18px; margin-bottom: 10px;"><strong>ðŸ“§ Email:</strong> ${farmerData.email}</p>
                    <p style="font-size: 18px; margin-bottom: 20px;"><strong>ðŸ“ Location:</strong> ${farmerData.location}</p>

                    <div style="margin-bottom: 20px;">
                        <strong style="font-size: 18px;">Rating:</strong>
                        <div style="font-size: 28px; margin-top: 10px;">
                            ${createStarRating(parseFloat(avgRating))}
                        </div>
                        <p style="color: #666; font-size: 16px; margin-top: 8px; font-weight: 600;">${avgRating > 0 ? avgRating + " / 5.0" : "No ratings yet"} ${avgRating > 0 ? "(" + farmerData.feedbacks.length + " " + (farmerData.feedbacks.length === 1 ? "review" : "reviews") + ")" : ""}</p>
                    </div>
                </div>

                <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <h3 style="color: #2e7d32; margin-bottom: 15px; font-family: 'Poppins', sans-serif;">Customer Feedback</h3>
                    <div id="farmerFeedbacks" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        ${
                          farmerData.feedbacks.length > 0
                            ? farmerData.feedbacks
                                .map(
                                  (feedback, index) => `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div>
                                            <strong>${feedback.customerName || "Anonymous"}</strong>
                                            ${feedback.customerPhone ? `<p style="color: #666; font-size: 14px; margin-top: 3px;">ðŸ“ž ${feedback.customerPhone}</p>` : ""}
                                            <div style="font-size: 20px; margin-top: 5px;">${createStarRating(feedback.rating)}</div>
                                            <small style="color: #666; font-weight: 600; margin-top: 3px; display: block;">${feedback.rating}/5</small>
                                        </div>
                                        <span style="color: #999; font-size: 12px;">${feedback.date}</span>
                                    </div>
                                    <p style="color: #555; margin-top: 8px;">${feedback.comment}</p>
                                </div>
                            `,
                                )
                                .join("")
                            : '<p style="color: #999; text-align: center; padding: 20px;">No feedback yet. Be the first to review!</p>'
                        }
                    </div>

                    <div style="background: #f1f8e9; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4 style="color: #2e7d32; margin-bottom: 15px; font-family: 'Poppins', sans-serif;">Add Your Feedback</h4>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name:</label>
                            <input type="text" id="feedbackCustomerName" placeholder="Enter your name" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Phone Number:</label>
                            <input type="tel" id="feedbackCustomerPhone" placeholder="Enter your phone number" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rating:</label>
                            <div id="ratingStars" style="font-size: 28px; cursor: pointer;">
                                <span data-rating="1" style="margin-right: 5px; opacity: 0.3;">â­</span>
                                <span data-rating="2" style="margin-right: 5px; opacity: 0.3;">â­</span>
                                <span data-rating="3" style="margin-right: 5px; opacity: 0.3;">â­</span>
                                <span data-rating="4" style="margin-right: 5px; opacity: 0.3;">â­</span>
                                <span data-rating="5" style="opacity: 0.3;">â­</span>
                            </div>
                            <input type="hidden" id="selectedRating" value="0">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Comment:</label>
                            <textarea id="feedbackComment" placeholder="Write your feedback here..." rows="4" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Poppins', sans-serif; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>
                        <button onclick="submitFeedback('${farmerName}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer;">Send Feedback</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Add star rating interaction
        const stars = modal.querySelectorAll("#ratingStars span");
        const selectedRatingInput = modal.querySelector("#selectedRating");
        const starsContainer = modal.querySelector("#ratingStars");
        let selectedRating = 0;

        stars.forEach((star, index) => {
          star.addEventListener("mouseenter", () => {
            for (let i = 0; i <= index; i++) {
              stars[i].style.opacity = "1";
            }
            for (let i = index + 1; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
            }
          });
          star.addEventListener("click", () => {
            selectedRating = index + 1;
            selectedRatingInput.value = selectedRating;
            for (let i = 0; i <= index; i++) {
              stars[i].style.opacity = "1";
            }
            for (let i = index + 1; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
            }
          });
        });

        // Reset stars on mouse leave if no rating selected
        starsContainer.addEventListener("mouseleave", () => {
          if (selectedRating === 0) {
            stars.forEach((star) => (star.style.opacity = "0.3"));
          } else {
            for (let i = 0; i < selectedRating; i++) {
              stars[i].style.opacity = "1";
            }
            for (let i = selectedRating; i < stars.length; i++) {
              stars[i].style.opacity = "0.3";
            }
          }
        });
      }

      // Get star rating display (kept for backward compatibility but now uses createStarRating)
      function getStarRating(rating) {
        return createStarRating(parseFloat(rating) || 0);
      }

      // Submit feedback
      function submitFeedback(farmerName) {
        const customerName = document
          .getElementById("feedbackCustomerName")
          .value.trim();
        const customerPhone = document
          .getElementById("feedbackCustomerPhone")
          .value.trim();
        const rating = parseInt(
          document.getElementById("selectedRating").value,
        );
        const comment = document.getElementById("feedbackComment").value.trim();

        if (!rating || rating === 0) {
          showPopup("Please select a rating");
          return;
        }

        if (!comment) {
          showPopup("Please write a comment");
          return;
        }

        const feedback = {
          id: Date.now(),
          customerName: customerName || "Anonymous",
          customerPhone: customerPhone || "",
          rating: rating,
          comment: comment,
          date: new Date().toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          }),
        };

        if (!farmersData[farmerName]) {
          farmersData[farmerName] = {
            name: farmerName,
            phone: "+91 0000000000",
            email: "Not Provided",
            location: "Location not available",
            profileImage: "",
            feedbacks: [],
          };
        }

        farmersData[farmerName].feedbacks.push(feedback);

        // Close modal and show success
        const farmerModal = document.querySelector(".farmer-details-modal");
        if (farmerModal) {
          farmerModal.remove();
        }
        showPopup("Feedback submitted successfully!");

        // Update profile section if viewing it
        updateProfileFeedbacks();

        // If the farmer whose feedback was submitted is the current logged-in farmer, refresh profile
        const currentFarmer = "Rajesh Kumar";
        if (farmerName === currentFarmer) {
          // Profile will be updated by updateProfileFeedbacks above
        }
      }

      // Update profile section with feedbacks and rating
      function updateProfileFeedbacks() {
        const profileSection = document.getElementById("dashProfile");
        if (!profileSection) return;

        const currentFarmer = "Rajesh Kumar"; // Current logged-in farmer

        // Initialize farmer data if not exists
        if (!farmersData[currentFarmer]) {
          farmersData[currentFarmer] = {
            name: currentFarmer,
            phone: "+91 9876543210",
            email: "Not Provided",
            location: "Secunderabad, Telangana",
            profileImage: localStorage.getItem("profileImage") || "",
            feedbacks: [],
          };
        }

        const farmerData = farmersData[currentFarmer];

        // Calculate average rating
        const avgRating = calculateAverageRating(farmerData.feedbacks);

        // Update rating display below avatar
        const ratingDisplay = document.getElementById("profileRatingDisplay");
        if (ratingDisplay) {
          if (farmerData.feedbacks.length > 0) {
            ratingDisplay.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 5px;">${createStarRating(parseFloat(avgRating))}</div>
                    <p style="color: #666; font-size: 16px; margin: 0; font-weight: 600;">${avgRating} / 5.0</p>
                    <p style="color: #999; font-size: 14px; margin: 5px 0 0 0;">${farmerData.feedbacks.length} ${farmerData.feedbacks.length === 1 ? "review" : "reviews"}</p>
                `;
          } else {
            ratingDisplay.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 5px;">â˜†â˜†â˜†â˜†â˜†</div>
                    <p style="color: #999; font-size: 14px; margin: 0;">No ratings yet</p>
                `;
          }
        }

        let feedbackContainer = document.getElementById(
          "profileFeedbacksContainer",
        );
        if (!feedbackContainer) {
          const profileContent =
            profileSection.querySelector(".search-section");
          if (profileContent) {
            feedbackContainer = document.createElement("div");
            feedbackContainer.id = "profileFeedbacksContainer";
            feedbackContainer.style.marginTop = "40px";
            profileContent.appendChild(feedbackContainer);
          }
        }

        if (feedbackContainer) {
          if (farmerData.feedbacks.length > 0) {
            feedbackContainer.innerHTML = `
                    <div class="rating-summary">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 28px;">${createStarRating(parseFloat(avgRating))}</div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${avgRating}</div>
                                <div style="color: #666; font-size: 14px;">${farmerData.feedbacks.length} ${farmerData.feedbacks.length === 1 ? "review" : "reviews"}</div>
                            </div>
                        </div>
                    </div>
                    <h2 style="color: #2e7d32; margin-bottom: 20px; margin-top: 30px; font-family: 'Times New Roman', Times, serif;">ðŸ’¬ Customer Feedbacks</h2>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${farmerData.feedbacks
                          .map(
                            (feedback) => `
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; position: relative;">
                                <button onclick="deleteFeedback('${currentFarmer}', ${feedback.id})" style="position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 12px; font-weight: 600;">Delete</button>
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 18px; color: #2e7d32;">${feedback.customerName || "Anonymous"}</strong>
                                        ${feedback.customerPhone ? `<p style="color: #666; font-size: 14px; margin-top: 3px;">ðŸ“ž ${feedback.customerPhone}</p>` : ""}
                                        <div style="font-size: 20px; margin-top: 8px;">${createStarRating(feedback.rating)}</div>
                                        <small style="color: #666; display: block; margin-top: 5px; font-weight: 600;">${feedback.rating}/5</small>
                                    </div>
                                    <span style="color: #999; font-size: 14px;">${feedback.date}</span>
                                </div>
                                <p style="color: #555; margin-top: 15px; font-size: 16px; line-height: 1.6;">${feedback.comment}</p>
                            </div>
                        `,
                          )
                          .join("")}
                    </div>
                `;
          } else {
            feedbackContainer.innerHTML = `
                    <h2 style="color: #2e7d32; margin-bottom: 20px; font-family: 'Times New Roman', Times, serif;">ðŸ’¬ Customer Feedbacks</h2>
                    <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">â˜†â˜†â˜†â˜†â˜†</div>
                        <p style="color: #666; font-size: 18px; margin-bottom: 10px;">No feedbacks yet</p>
                        <p style="color: #888; font-size: 14px;">Your customers can leave feedback after purchasing products.</p>
                    </div>
                `;
          }
        }
      }

      // Delete feedback
      function deleteFeedback(farmerName, feedbackId) {
        if (confirm("Are you sure you want to delete this feedback?")) {
          const farmerData = farmersData[farmerName];
          if (farmerData) {
            farmerData.feedbacks = farmerData.feedbacks.filter(
              (f) => f.id !== feedbackId,
            );
            updateProfileFeedbacks();
            loadProfileSection(); // Refresh profile section
            showPopup("Feedback deleted successfully!");

            // If farmer details modal is open, refresh it
            const farmerModal = document.querySelector(".farmer-details-modal");
            if (farmerModal) {
              farmerModal.remove();
              showFarmerDetails(farmerName);
            }
          }
        }
      }

      // ============================================
      // PROFILE SECTION - Complete Implementation
      // ============================================

      // Load and populate profile section
      function loadProfileSection() {
        // Fetch fresh user data from API
        fetch("/api/user")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.user) {
              const user = data.user;
              const userName = user.name || "Guest User";

              // Store in localStorage
              localStorage.setItem("user", JSON.stringify(user));

              // Load profile header (this will also update nav profile icon)
              loadProfileHeader(user, userName);

              // Ensure nav profile icon is updated
              updateNavProfileIcon();

              // Load summary cards
              loadProfileSummaryCards(userName);

              // Load user posts
              loadUserPosts(userName);

              // Load feedbacks
              loadProfileFeedbacks(userName);
            } else {
              // Fallback to localStorage if API fails
              const currentUser = JSON.parse(
                localStorage.getItem("user") || "{}",
              );
              const currentUserName = currentUser.name || "Guest User";
              loadProfileHeader(currentUser, currentUserName);
              updateNavProfileIcon();
              loadProfileSummaryCards(currentUserName);
              loadUserPosts(currentUserName);
              loadProfileFeedbacks(currentUserName);
            }
          })
          .catch((error) => {
            console.error("Error loading profile:", error);
            // Fallback to localStorage
            const currentUser = JSON.parse(
              localStorage.getItem("user") || "{}",
            );
            const currentUserName = currentUser.name || "Guest User";
            loadProfileHeader(currentUser, currentUserName);
            updateNavProfileIcon();
            loadProfileSummaryCards(currentUserName);
            loadUserPosts(currentUserName);
            loadProfileFeedbacks(currentUserName);
          });
      }

      // Load profile header information
      function loadProfileHeader(user, userName) {
        const profileFullName = document.getElementById("profileFullName");
        const profileUserType = document.getElementById("profileUserType");
        const profileMobile = document.getElementById("profileMobile");
        const profileLocation = document.getElementById("profileLocation");
        const profileLanguage = document.getElementById("profileLanguage");
        const profileMemberSince =
          document.getElementById("profileMemberSince");
        const profilePhotoContainer = document.getElementById(
          "profilePhotoContainer",
        );

        if (profileFullName) profileFullName.textContent = userName;
        if (profileUserType)
          profileUserType.textContent =
            user.userType || user.user_type || "Farmer";
        if (profileMobile) {
          const phone = user.phone || "+91 0000000000";
          profileMobile.textContent = phone;
        }
        if (profileLocation) {
          // Build location string from village, mandal, district
          let location = "";
          if (user.village && user.mandal && user.district) {
            location = `${user.village}, ${user.mandal}, ${user.district}`;
          } else if (user.location) {
            location = user.location;
          } else {
            location = "Location not set";
          }
          profileLocation.textContent = location;
        }
        if (profileLanguage) {
          const lang =
            user.preferredLanguage ||
            user.preferred_language ||
            localStorage.getItem("selectedLanguage") ||
            "English";
          profileLanguage.textContent = lang;
        }
        if (profileMemberSince) {
          const memberSince =
            user.createdAt ||
            user.memberSince ||
            new Date().toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          profileMemberSince.textContent = `Member since: ${memberSince}`;
        }

        // Update profile photo in header
        updateProfilePhoto(profilePhotoContainer);

        // Update navigation profile icon
        updateNavProfileIcon();
      }

      // Update profile photo display
      function updateProfilePhoto(container) {
        if (!container)
          container = document.getElementById("profilePhotoContainer");
        if (!container) return;

        const profileImage = localStorage.getItem("profileImage");
        if (profileImage) {
          container.innerHTML = `<img src="${profileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Profile">`;
        } else {
          container.innerHTML = `<span class="notranslate">ðŸ‘¤</span>`;
        }
      }

      // Update navigation profile icon
      function updateNavProfileIcon() {
        const navProfileIcon = document.getElementById("navProfileIcon");
        if (!navProfileIcon) return;

        const profileImage = localStorage.getItem("profileImage");
        if (profileImage) {
          navProfileIcon.innerHTML = `<img src="${profileImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Profile">`;
        } else {
          navProfileIcon.innerHTML = `<span class="notranslate">ðŸ‘¤</span>`;
        }
      }

      // Load summary cards from API
      function loadProfileSummaryCards(userName) {
        const summaryCards = document.getElementById("profileSummaryCards");
        if (!summaryCards) return;

        // Show loading state
        summaryCards.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 32px; margin-bottom: 10px;">â³</div><div>Loading statistics...</div></div>';

        // Fetch statistics from API
        fetch("/api/profile/stats")
        .then(response => response.json())
        .then(data => {
          if (data.success && data.stats) {
            const stats = data.stats;
            
            // Update individual stat displays
            const productsPostedCount = document.getElementById('productsPostedCount');
            const rentalsPostedCount = document.getElementById('rentalsPostedCount');
            const requirementsPostedCount = document.getElementById('requirementsPostedCount');
            const feedbackReceivedCount = document.getElementById('feedbackReceivedCount');
            const savedItemsCount = document.getElementById('savedItemsCount');
            
            if (productsPostedCount) productsPostedCount.textContent = stats.products_posted || 0;
            if (rentalsPostedCount) rentalsPostedCount.textContent = stats.rentals_posted || 0;
            if (requirementsPostedCount) requirementsPostedCount.textContent = (stats.product_requirements || 0) + (stats.rental_requirements || 0);
            if (feedbackReceivedCount) feedbackReceivedCount.textContent = stats.feedback_received || 0;
            if (savedItemsCount) savedItemsCount.textContent = likedProducts.length || 0;
            
            // Full summary cards with all stats
            const cards = [
              {
                icon: "ðŸŒ¾",
                label: "Products Posted",
                value: stats.products_posted || 0,
                color: "#4caf50",
              },
              {
                icon: "ðŸšœ",
                label: "Rental Items Posted",
                value: stats.rentals_posted || 0,
                color: "#ff9800",
              },
              {
                icon: "ðŸ“¦",
                label: "Product Requirements",
                value: stats.product_requirements || 0,
                color: "#2196F3",
              },
              {
                icon: "ðŸšœ",
                label: "Rental Requirements",
                value: stats.rental_requirements || 0,
                color: "#9c27b0",
              },
              {
                icon: "â­",
                label: "Feedback Received",
                value: stats.feedback_received || 0,
                color: "#ffc107",
              },
              {
                icon: "â¤ï¸",
                label: "Saved Items",
                value: likedProducts.length || 0,
                color: "#e91e63",
              },
            ];
    
            summaryCards.innerHTML = cards
              .map(
                (card) => `
                <div style="background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 5px solid ${card.color}; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.15)'; this.style.borderLeftWidth='6px'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'; this.style.borderLeftWidth='5px'">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, ${card.color}, ${card.color}dd); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 15px ${card.color}40; flex-shrink: 0;">
                            <span class="notranslate">${card.icon}</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 42px; font-weight: 700; color: ${card.color}; line-height: 1; margin-bottom: 8px; font-family: 'Poppins', sans-serif;">${card.value}</div>
                            <div style="font-size: 15px; color: #666; font-weight: 600; letter-spacing: 0.3px;">${card.label}</div>
                        </div>
                    </div>
                </div>
            `,
              )
              .join("");
          } else {
            summaryCards.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Failed to load statistics</div>';
          }
        })
        .catch(error => {
          console.error('Error loading profile stats:', error);
          summaryCards.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading statistics</div>';
        });
      }

      // Load user posts
      function loadUserPosts(userName) {
        loadMyProducts(userName);
        loadMyRentals(userName);
        loadMyProductRequirements(userName);
        loadMyRentalRequirements(userName);
      }

      // Load my products from API
      function loadMyProducts(userName) {
        const grid = document.getElementById("myProductsGrid");
        const empty = document.getElementById("myProductsEmpty");
        if (!grid || !empty) return;

        // Show loading state
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 32px; margin-bottom: 10px;">â³</div><div>Loading products...</div></div>';
        grid.style.display = "block";
        empty.style.display = "none";

        // Fetch products from API
        fetch("/api/profile/my-products")
          .then(response => response.json())
          .then(data => {
            if (data.success && data.products) {
              const myProducts = data.products;

              if (myProducts.length === 0) {
                grid.style.display = "none";
                empty.style.display = "block";
                return;
              }

              grid.style.display = "grid";
              empty.style.display = "none";

              grid.innerHTML = myProducts
                .map((product) => {
                  const imageSrc = product.images && product.images.length > 0 ? product.images[0] : null;
                  const categoryIcon = getCategoryIcon(product.category || "Others");
                  const status = product.status || "active";
                  const statusColor = status.toLowerCase() === "active" ? "#4caf50" : "#999";
                  const statusText = status.charAt(0).toUpperCase() + status.slice(1);

                  return `
                    <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
                        <div style="position: relative; height: 200px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            ${
                              imageSrc
                                ? `<img src="${imageSrc}" style="width: 100%; height: 100%; object-fit: cover;" alt="${product.name}">`
                                : `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 80px;">${categoryIcon}</div>`
                            }
                            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${statusText}</div>
                        </div>
                        <div style="padding: 20px;">
                            <h3 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 18px; font-weight: 600;">${product.name}</h3>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #666; font-size: 14px;">
                                <span>ðŸ’°</span>
                                <span>â‚¹${product.price || 0}/${product.unit || "kg"}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: #666; font-size: 14px;">
                                <span>ðŸ“¦</span>
                                <span>${product.quantity} ${product.unit || "kg"} available</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                                <small style="color: #999;">Posted: ${new Date(product.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");
            } else {
              grid.style.display = "none";
              empty.style.display = "block";
            }
          })
          .catch(error => {
            console.error('Error loading products:', error);
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading products</div>';
          });
      }

      // Load my rentals from API
      function loadMyRentals(userName) {
        const grid = document.getElementById("myRentalsGrid");
        const empty = document.getElementById("myRentalsEmpty");
        if (!grid || !empty) return;

        // Show loading state
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 32px; margin-bottom: 10px;">â³</div><div>Loading rentals...</div></div>';
        grid.style.display = "block";
        empty.style.display = "none";

        // Fetch rentals from API
        fetch("/api/profile/my-rentals")
          .then(response => response.json())
          .then(data => {
            if (data.success && data.rentals) {
              const myRentals = data.rentals;

              if (myRentals.length === 0) {
                grid.style.display = "none";
                empty.style.display = "block";
                return;
              }

              grid.style.display = "grid";
              empty.style.display = "none";

              grid.innerHTML = myRentals
                .map((rental) => {
                  const status = rental.status === "available" || rental.status === "active" ? "Available" : "Not Available";
                  const statusColor = rental.status === "available" || rental.status === "active" ? "#4caf50" : "#999";
                  const imageSrc = rental.images && rental.images.length > 0 ? rental.images[0] : null;
                  const price = rental.price_per_day || 0;
                  const avgRating = rental.avg_rating || 0;
                  const reviewCount = rental.review_count || 0;

                  return `
                    <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
                        <div style="position: relative; height: 200px; background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            ${
                              imageSrc
                                ? `<img src="${imageSrc}" style="width: 100%; height: 100%; object-fit: cover;" alt="${rental.name}">`
                                : `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 80px;">ðŸšœ</div>`
                            }
                            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${status}</div>
                        </div>
                        <div style="padding: 20px;">
                            <h3 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 18px; font-weight: 600;">${rental.name}</h3>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #666; font-size: 14px;">
                                <span>ðŸ’°</span>
                                <span>â‚¹${price}/day</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #666; font-size: 14px;">
                                <span>ðŸ“</span>
                                <span>${rental.location || "Location not provided"}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: #666; font-size: 14px;">
                                <span>â­</span>
                                <span>${avgRating.toFixed(1)} (${reviewCount} review${reviewCount !== 1 ? 's' : ''})</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                                <small style="color: #999;">Posted: ${new Date(rental.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");
            } else {
              grid.style.display = "none";
              empty.style.display = "block";
            }
          })
          .catch(error => {
            console.error('Error loading rentals:', error);
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading rentals</div>';
          });
      }

      // Load my product requirements from API
      function loadMyProductRequirements(userName) {
        const grid = document.getElementById("myProductRequirementsGrid");
        const empty = document.getElementById("myProductRequirementsEmpty");
        if (!grid || !empty) return;

        // Show loading state
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 32px; margin-bottom: 10px;">â³</div><div>Loading requirements...</div></div>';
        grid.style.display = "block";
        empty.style.display = "none";

        // Fetch requirements from API
        fetch("/api/profile/my-product-requirements")
          .then(response => response.json())
          .then(data => {
            if (data.success && data.requirements) {
              const myRequirements = data.requirements;

              if (myRequirements.length === 0) {
                grid.style.display = "none";
                empty.style.display = "block";
                return;
              }

              grid.style.display = "grid";
              empty.style.display = "none";

              grid.innerHTML = myRequirements
                .map((req) => {
                  const status = req.status || "active";
                  const statusColor = status.toLowerCase() === "active" ? "#4caf50" : "#999";
                  const statusText = status.charAt(0).toUpperCase() + status.slice(1);

                  return `
                    <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-bottom: 2px solid #2196F3; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${statusText}</div>
                            <h3 style="margin: 0 0 10px 0; color: #1976d2; font-size: 18px; font-weight: 600; padding-right: 80px;">${req.product_name || "Product Requirement"}</h3>
                            <div style="color: #666; font-size: 14px;">
                                <div style="margin-bottom: 5px;"><strong>Quantity:</strong> ${req.quantity || "N/A"}</div>
                                <div style="margin-bottom: 5px;"><strong>Location:</strong> ${req.location || "Not provided"}</div>
                                <div><strong>Contact:</strong> ${req.phone_number || "N/A"}</div>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.4);">
                                <small style="color: #555;">Posted: ${new Date(req.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");
            } else {
              grid.style.display = "none";
              empty.style.display = "block";
            }
          })
          .catch(error => {
            console.error('Error loading product requirements:', error);
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading requirements</div>';
          });
      }

      // Load my rental requirements from API
      function loadMyRentalRequirements(userName) {
        const grid = document.getElementById("myRentalRequirementsGrid");
        const empty = document.getElementById("myRentalRequirementsEmpty");
        if (!grid || !empty) return;

        // Show loading state
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 32px; margin-bottom: 10px;">â³</div><div>Loading requirements...</div></div>';
        grid.style.display = "block";
        empty.style.display = "none";

        // Fetch requirements from API
        fetch("/api/profile/my-rental-requirements")
          .then(response => response.json())
          .then(data => {
            if (data.success && data.requirements) {
              const myRequirements = data.requirements;

              if (myRequirements.length === 0) {
                grid.style.display = "none";
                empty.style.display = "block";
                return;
              }

              grid.style.display = "grid";
              empty.style.display = "none";

              grid.innerHTML = myRequirements
                .map((req) => {
                  const status = req.status || "active";
                  const statusColor = status.toLowerCase() === "active" ? "#4caf50" : "#999";
                  const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                  const location = `${req.village || ''}, ${req.mandal || ''}, ${req.district || ''}`.replace(/(^,\s*)|(,\s*$)/g, '').replace(/,\s*,/g, ',') || "Not provided";

                  return `
                    <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
                        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 20px; border-bottom: 2px solid #9c27b0; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${statusText}</div>
                            <h3 style="margin: 0 0 10px 0; color: #7b1fa2; font-size: 18px; font-weight: 600; padding-right: 80px;">${req.rental_category || "Rental Requirement"}</h3>
                            <div style="color: #666; font-size: 14px;">
                                <div style="margin-bottom: 5px;"><strong>Field Area:</strong> ${req.field_area || "N/A"} acres</div>
                                <div style="margin-bottom: 5px;"><strong>Location:</strong> ${location}</div>
                                <div><strong>Contact:</strong> ${req.phone_number || "N/A"}</div>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.4);">
                                <small style="color: #555;">Posted: ${new Date(req.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                })
                .join("");
            } else {
              grid.style.display = "none";
              empty.style.display = "block";
            }
          })
          .catch(error => {
            console.error('Error loading rental requirements:', error);
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading requirements</div>';
          });
      }

      // Load profile feedbacks
      function loadProfileFeedbacks(userName) {
        const farmerData = farmersData[userName] || { feedbacks: [] };
        const productFeedbacks = farmerData.feedbacks.filter(
          (f) => f.type === "product" || !f.type,
        );
        const rentalFeedbacks = farmerData.feedbacks.filter(
          (f) => f.type === "rental",
        );

        loadProductsFeedback(productFeedbacks);
        loadRentalsFeedback(rentalFeedbacks);
      }

      // Load products feedback (updated to support API data)
      async function loadProductsFeedback(feedbacks) {
        const section = document.getElementById("productsFeedbackSection");
        if (!section) return;

        // Try to load from API first
        try {
          const response = await fetch("/api/profile/feedback");
          const result = await response.json();

          if (
            result.success &&
            result.feedbacks &&
            result.feedbacks.length > 0
          ) {
            const productFeedbacks = result.feedbacks;
            const avgRating = result.average_rating || 0;

            section.innerHTML = `
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 25px; border-radius: 16px; margin-bottom: 25px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">${createStarRating(parseFloat(avgRating))}</div>
                        <div style="font-size: 32px; font-weight: 700; color: #2e7d32; margin-bottom: 5px;">${avgRating.toFixed(1)}</div>
                        <div style="color: #666; font-size: 16px;">Based on ${result.total_reviews} ${result.total_reviews === 1 ? "review" : "reviews"}</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${productFeedbacks
                          .map((feedback) => {
                            const images = feedback.images || [];
                            const videos = feedback.videos || [];
                            return `
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                ${feedback.product_name ? `<div style="font-weight: 600; color: #2e7d32; margin-bottom: 10px; font-size: 16px;">ðŸ“¦ ${feedback.product_name}</div>` : ""}
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 18px; color: #2e7d32;">${feedback.reviewer_name || "Anonymous"}</strong>
                                        ${feedback.reviewer_phone ? `<p style="color: #666; font-size: 14px; margin-top: 3px;">ðŸ“ž ${feedback.reviewer_phone}</p>` : ""}
                                        <div style="font-size: 20px; margin-top: 8px;">${createStarRating(feedback.rating)}</div>
                                        <small style="color: #666; display: block; margin-top: 5px; font-weight: 600;">${feedback.rating}/5</small>
                                    </div>
                                    <span style="color: #999; font-size: 14px;">${feedback.created_at ? new Date(feedback.created_at).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" }) : ""}</span>
                                </div>
                                ${feedback.comment ? `<p style="color: #555; margin-top: 15px; font-size: 16px; line-height: 1.6;">${feedback.comment}</p>` : ""}
                                ${
                                  images.length > 0
                                    ? `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 15px;">
                                        ${images.map((img) => `<img src="/static/${img}" onclick="openImageModal('/static/${img}')" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;">`).join("")}
                                    </div>
                                `
                                    : ""
                                }
                                ${
                                  videos.length > 0
                                    ? `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 15px;">
                                        ${videos.map((vid) => `<video src="/static/${vid}" controls style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;"></video>`).join("")}
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        `;
                          })
                          .join("")}
                    </div>
                `;
            return;
          }
        } catch (error) {
          console.error("Error loading profile feedback:", error);
        }

        // Fallback to old method
        if (feedbacks.length === 0) {
          section.innerHTML = `
                <div style="background: #f9f9f9; padding: 40px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">â­</div>
                    <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No feedback received yet for your products</p>
                    <p style="color: #999; font-size: 14px;">Customers can leave feedback after purchasing your products.</p>
                </div>
            `;
          return;
        }

        const avgRating = calculateAverageRating(feedbacks);
        section.innerHTML = `
            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 25px; border-radius: 16px; margin-bottom: 25px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 10px;">${createStarRating(parseFloat(avgRating))}</div>
                <div style="font-size: 32px; font-weight: 700; color: #2e7d32; margin-bottom: 5px;">${avgRating.toFixed(1)}</div>
                <div style="color: #666; font-size: 16px;">Based on ${feedbacks.length} ${feedbacks.length === 1 ? "review" : "reviews"}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                ${feedbacks
                  .map(
                    (feedback) => `
                    <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 18px; color: #2e7d32;">${feedback.customerName || "Anonymous"}</strong>
                                ${feedback.customerPhone ? `<p style="color: #666; font-size: 14px; margin-top: 3px;">ðŸ“ž ${feedback.customerPhone}</p>` : ""}
                                <div style="font-size: 20px; margin-top: 8px;">${createStarRating(feedback.rating)}</div>
                                <small style="color: #666; display: block; margin-top: 5px; font-weight: 600;">${feedback.rating}/5</small>
                            </div>
                            <span style="color: #999; font-size: 14px;">${feedback.date}</span>
                        </div>
                        <p style="color: #555; margin-top: 15px; font-size: 16px; line-height: 1.6;">${feedback.comment}</p>
                    </div>
                `,
                  )
                  .join("")}
            </div>
        `;
      }

      // Load rentals feedback
      function loadRentalsFeedback(feedbacks) {
        const section = document.getElementById("rentalsFeedbackSection");
        if (!section) return;

        if (feedbacks.length === 0) {
          section.innerHTML = `
                <div style="background: #f9f9f9; padding: 40px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">â­</div>
                    <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No feedback received yet for your rental items</p>
                    <p style="color: #999; font-size: 14px;">Customers can leave feedback after renting your items.</p>
                </div>
            `;
          return;
        }

        const avgRating = calculateAverageRating(feedbacks);
        section.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 25px; border-radius: 16px; margin-bottom: 25px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 10px;">${createStarRating(parseFloat(avgRating))}</div>
                <div style="font-size: 32px; font-weight: 700; color: #f57c00; margin-bottom: 5px;">${avgRating.toFixed(1)}</div>
                <div style="color: #666; font-size: 16px;">Based on ${feedbacks.length} ${feedbacks.length === 1 ? "review" : "reviews"}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                ${feedbacks
                  .map(
                    (feedback) => `
                    <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 18px; color: #f57c00;">${feedback.customerName || "Anonymous"}</strong>
                                ${feedback.customerPhone ? `<p style="color: #666; font-size: 14px; margin-top: 3px;">ðŸ“ž ${feedback.customerPhone}</p>` : ""}
                                <div style="font-size: 20px; margin-top: 8px;">${createStarRating(feedback.rating)}</div>
                                <small style="color: #666; display: block; margin-top: 5px; font-weight: 600;">${feedback.rating}/5</small>
                            </div>
                            <span style="color: #999; font-size: 14px;">${feedback.date}</span>
                        </div>
                        <p style="color: #555; margin-top: 15px; font-size: 16px; line-height: 1.6;">${feedback.comment}</p>
                    </div>
                `,
                  )
                  .join("")}
            </div>
        `;
      }

      // Switch profile tab
      function switchProfileTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".profile-tab-btn").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.borderBottomColor = "transparent";
          btn.style.borderBottomWidth = "4px";
          btn.style.color = "#666";
          btn.style.marginBottom = "-2px";
        });

        const activeBtn = document.querySelector(
          `.profile-tab-btn[data-tab="${tabName}"]`,
        );
        if (activeBtn) {
          activeBtn.classList.add("active");
          activeBtn.style.borderBottomColor = "#4caf50";
          activeBtn.style.borderBottomWidth = "4px";
          activeBtn.style.color = "#2e7d32";
          activeBtn.style.marginBottom = "-2px";
        }

        // Update tab content
        document.querySelectorAll(".profile-tab-content").forEach((content) => {
          content.classList.remove("active");
          content.style.display = "none";
        });

        // Map tab names to element IDs
        const tabIdMap = {
          products: "profileProductsTab",
          rentals: "profileRentalsTab",
          "product-requirements": "profileProductRequirementsTab",
          "rental-requirements": "profileRentalRequirementsTab",
        };

        const activeContentId = tabIdMap[tabName];
        if (activeContentId) {
          const activeContent = document.getElementById(activeContentId);
          if (activeContent) {
            activeContent.classList.add("active");
            activeContent.style.display = "block";
          }
        }
      }

      // Edit profile info - Open modal
      function editProfileInfo() {
        const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
        const modal = document.getElementById("editProfileModal");

        if (!modal) {
          console.error("Edit profile modal not found");
          return;
        }

        // Populate form fields with current user data
        document.getElementById("editProfileName").value =
          currentUser.name || "";
        document.getElementById("editProfilePhone").value =
          currentUser.phone || "";
        document.getElementById("editProfileLocation").value =
          currentUser.location || "";
        document.getElementById("editProfileUserType").value =
          currentUser.userType || "Farmer";
        document.getElementById("editProfileLanguage").value =
          currentUser.language ||
          localStorage.getItem("selectedLanguage") ||
          "English";
        document.getElementById("editProfileBio").value =
          currentUser.bio || currentUser.about || "";

        // Show modal
        modal.style.display = "flex";
        document.body.style.overflow = "hidden"; // Prevent background scrolling

        // Focus on first input
        setTimeout(() => {
          document.getElementById("editProfileName").focus();
        }, 100);
      }

      // Close edit profile modal
      function closeEditProfileModal() {
        const modal = document.getElementById("editProfileModal");
        if (modal) {
          modal.style.display = "none";
          document.body.style.overflow = ""; // Restore scrolling
        }
      }

      // Save profile changes
      function saveProfileChanges(event) {
        event.preventDefault();

        // Get form values
        const name = document.getElementById("editProfileName").value.trim();
        const phone = document.getElementById("editProfilePhone").value.trim();
        const location = document
          .getElementById("editProfileLocation")
          .value.trim();
        const userType = document.getElementById("editProfileUserType").value;
        const language = document.getElementById("editProfileLanguage").value;
        const bio = document.getElementById("editProfileBio").value.trim();

        // Validation
        if (!name) {
          alert("Please enter your full name");
          document.getElementById("editProfileName").focus();
          return;
        }

        if (!phone) {
          alert("Please enter your phone number");
          document.getElementById("editProfilePhone").focus();
          return;
        }

        // Validate phone number format (basic validation)
        const phoneRegex = /^[+]?[0-9\s-]{10,15}$/;
        if (!phoneRegex.test(phone)) {
          alert("Please enter a valid phone number (10-15 digits)");
          document.getElementById("editProfilePhone").focus();
          return;
        }

        if (!location) {
          alert("Please enter your location");
          document.getElementById("editProfileLocation").focus();
          return;
        }

        // Get current user data
        const currentUser = JSON.parse(localStorage.getItem("user") || "{}");

        // Update user data
        const updatedUser = {
          ...currentUser,
          name: name,
          phone: phone,
          location: location,
          userType: userType,
          language: language,
          bio: bio,
          updatedAt: new Date().toISOString(),
        };

        // Save to localStorage
        localStorage.setItem("user", JSON.stringify(updatedUser));

        // Update language preference if changed
        if (language && language !== localStorage.getItem("selectedLanguage")) {
          localStorage.setItem("selectedLanguage", language);
          // Optionally trigger language change
          if (typeof handleLanguageChange === "function") {
            handleLanguageChange(
              language === "English"
                ? "en"
                : language === "à¤¹à¤¿à¤‚à¤¦à¥€"
                  ? "hi"
                  : language === "à®¤à®®à®¿à®´à¯"
                    ? "ta"
                    : language === "à°¤à±†à°²à±à°—à±"
                      ? "te"
                      : "en",
            );
          }
        }

        // Close modal
        closeEditProfileModal();

        // Reload profile section to show updated data
        loadProfileSection();

        // Show success message
        if (typeof showPopup === "function") {
          showPopup("Profile updated successfully!");
        } else {
          alert("Profile updated successfully!");
        }
      }

      // Close modal on Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const modal = document.getElementById("editProfileModal");
          if (modal && modal.style.display === "flex") {
            closeEditProfileModal();
          }
        }
      });

      // Handle profile image upload
      function handleProfileImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith("image/")) {
          showPopup("Please select a valid image file!");
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showPopup("Image size should be less than 5MB!");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            localStorage.setItem("profileImage", e.target.result);

            // Update profile photo in header
            updateProfilePhoto();

            // Update navigation profile icon
            updateNavProfileIcon();

            showPopup("Profile photo updated successfully!");
          } catch (error) {
            console.error("Error saving profile image:", error);
            showPopup("Failed to save profile image. Please try again.");
          }
        };

        reader.onerror = function () {
          showPopup("Error reading image file. Please try again.");
        };

        reader.readAsDataURL(file);
      }

      function showSuccessMessage(message) {
        const toast = document.createElement("div");
        toast.style.cssText =
          "position: fixed; top: 100px; right: 30px; background: linear-gradient(135deg, #66bb6a, #4caf50); color: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4); z-index: 10001; font-family: Poppins, sans-serif; font-weight: 500; animation: slideInRight 0.5s ease;";
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOutRight 0.5s ease";
          setTimeout(() => toast.remove(), 500);
        }, 4000);
      }

      function handleAddProduct(e) {
        e.preventDefault();
        showPopup(
          "Product added successfully! It will appear to nearby customers",
        );
        e.target.reset();
        return false;
      }

      function loadUserProfile() {
        // Fetch user data from API
        fetch("/api/user")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const user = data.user;
              // Store in localStorage for convenience
              localStorage.setItem("user", JSON.stringify(user));

              // If no user data, set defaults
              const userName = user.name || "Guest User";
              const userPhone = user.phone || "";
              const userLocation = user.location || "";

              setTimeout(() => {
                // Update profile header name using ID
                const profileHeaderName =
                  document.getElementById("profileHeaderName");
                if (profileHeaderName) {
                  profileHeaderName.textContent = userName;
                  console.log("Updated profile header to:", userName);
                }

                // Update home welcome card
                const homeUserName = document.getElementById("homeUserName");
                const homeUserPhone = document.getElementById("homeUserPhone");
                const homeUserLocation =
                  document.getElementById("homeUserLocation");

                if (homeUserName) homeUserName.textContent = userName;
                if (homeUserPhone)
                  homeUserPhone.textContent = userPhone || "Not provided";
                if (homeUserLocation)
                  homeUserLocation.textContent = userLocation || "Not provided";
              }, 100);
            } else {
              // User not authenticated, redirect to home
              window.location.href = "/";
            }
          })
          .catch((error) => {
            console.error("Error loading user profile:", error);
            // Fallback to localStorage if API fails
            const user = JSON.parse(localStorage.getItem("user") || "{}");
            const userName = user.name || "Guest User";
            const userPhone = user.phone || "";
            const userLocation = user.location || "";

            setTimeout(() => {
              const profileHeaderName =
                document.getElementById("profileHeaderName");
              if (profileHeaderName) profileHeaderName.textContent = userName;

              const homeUserName = document.getElementById("homeUserName");
              const homeUserPhone = document.getElementById("homeUserPhone");
              const homeUserLocation =
                document.getElementById("homeUserLocation");

              if (homeUserName) homeUserName.textContent = userName;
              if (homeUserPhone)
                homeUserPhone.textContent = userPhone || "Not provided";
              if (homeUserLocation)
                homeUserLocation.textContent = userLocation || "Not provided";
            }, 100);
          });
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          // Call Flask logout endpoint
          fetch("/api/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              // Clear user data from localStorage
              localStorage.removeItem("user");
              showPopup("Logged out successfully!");
              // Redirect to home page after a short delay
              setTimeout(() => {
                window.location.href = "/";
              }, 1000);
            })
            .catch((error) => {
              console.error("Logout error:", error);
              // Clear localStorage anyway and redirect
              localStorage.removeItem("user");
              window.location.href = "/";
            });
        }
      }

      function showPopup(message) {
        const popup = document.getElementById("popup");
        popup.textContent = message;
        popup.style.display = "block";
        setTimeout(() => {
          popup.style.display = "none";
        }, 3000);
      }

      // Filter products based on search input
      function filterProducts() {
        const searchInput = document.getElementById("productSearchInput");
        const searchTerm = searchInput.value.toLowerCase().trim();
        const productsGrid = document.getElementById("productsGrid");
        const noResultsMessage = document.getElementById("noResultsMessage");
        const productCards =
          productsGrid.getElementsByClassName("product-card");

        let visibleCount = 0;

        // Loop through all product cards and filter
        Array.from(productCards).forEach((card) => {
          const productName = card.querySelector("h3")
            ? card.querySelector("h3").textContent.toLowerCase()
            : "";
          const productDesc = card.querySelector("p")
            ? card.querySelector("p").textContent.toLowerCase()
            : "";
          const productCategory = card.getAttribute("data-category")
            ? card.getAttribute("data-category").toLowerCase()
            : "";
          const farmerName = card.getAttribute("data-farmer")
            ? card.getAttribute("data-farmer").toLowerCase()
            : "";

          // Check if search term matches any of the fields
          const matches =
            productName.includes(searchTerm) ||
            productDesc.includes(searchTerm) ||
            productCategory.includes(searchTerm) ||
            farmerName.includes(searchTerm);

          if (matches || searchTerm === "") {
            card.style.display = "block";
            // Add fade-in animation
            card.style.animation = "fadeInUp 0.4s ease";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        // Show/hide no results message
        if (visibleCount === 0 && productCards.length > 0) {
          noResultsMessage.style.display = "block";
          noResultsMessage.style.animation = "fadeIn 0.3s ease";
        } else {
          noResultsMessage.style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is logged in via Flask session
        fetch("/api/user")
          .then((response) => {
            if (!response.ok) {
              // User is not logged in, redirect to home page
              window.location.href = "/";
              return;
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.success) {
              // Store user data in localStorage for convenience
              localStorage.setItem("user", JSON.stringify(data.user));
              // Load user profile data
              loadUserProfile();

              // Update home user welcome card with profile info
              setTimeout(function () {
                const userData = data.user;
                document.getElementById("homeUserName").textContent =
                  userData.name || "Guest";
                document.getElementById("homeUserPhone").textContent =
                  userData.phone || "";
                document.getElementById("homeUserLocation").textContent =
                  userData.location || "";
              }, 300);

              // Update notification badge on page load
              if (typeof updateNotificationBadge === "function") {
                updateNotificationBadge();
              }

              switchDashSection("home");
              initializeProducts(); // Initialize products display
              updateProfileFeedbacks(); // Initialize profile feedbacks and rating
              loadProfileImage(); // Load profile image if uploaded/profile page
            } else {
              window.location.href = "/";
            }
          })
          .catch((error) => {
            console.error("Error checking authentication:", error);
            window.location.href = "/";
          });
      });

      // ===== Profile Image Upload and Persistence =====
      function loadProfileImage() {
        // Profile section avatar
        const profileSection = document.getElementById("dashProfile");
        if (!profileSection) return;
        // Find avatar div and ensure it has the image upload button
        let avatarDiv = profileSection.querySelector(
          'div[style*="font-size: 60px"]',
        );
        if (!avatarDiv) return;

        // Remove previous uploader if present (avoid duplicates)
        const existingUploader = profileSection.querySelector(
          "#profileImageUploader",
        );
        if (existingUploader) existingUploader.remove();

        // Insert the image upload button (hidden input and clickable icon)
        const imgUploadBtn = document.createElement("input");
        imgUploadBtn.type = "file";
        imgUploadBtn.id = "profileImageUploader";
        imgUploadBtn.accept = "image/*";
        imgUploadBtn.style.display = "none";

        // Clickable overlay button for uploading/capturing photo
        const uploadAvatarIcon = document.createElement("button");
        uploadAvatarIcon.type = "button";
        uploadAvatarIcon.title = "Upload Profile Image";
        uploadAvatarIcon.style.cssText =
          "position: absolute; bottom: 6px; right: 6px; background: #fff; color: #2e7d32; border: none; border-radius: 50%; font-size: 22px; width: 38px; height: 38px; box-shadow: 0 2px 8px rgba(46,125,50,0.16); cursor:pointer; display:flex;align-items:center;justify-content:center;transition:all 0.3s;";
        uploadAvatarIcon.innerHTML = "ðŸ“·";
        uploadAvatarIcon.onclick = function () {
          imgUploadBtn.click();
        };

        // Place the upload button and icon
        avatarDiv.parentElement.style.position = "relative";
        avatarDiv.parentElement.appendChild(imgUploadBtn);
        avatarDiv.parentElement.appendChild(uploadAvatarIcon);

        // If image already exists, display it
        const profileImgUrl = localStorage.getItem("profileImage") || "";
        if (profileImgUrl && avatarDiv) {
          avatarDiv.innerHTML = `<img id="profileAvatarImage" src="${profileImgUrl}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;border:3px solid #4caf50;">`;
        }

        // Handle image upload
        imgUploadBtn.onchange = function (event) {
          const file = event.target.files[0];
          if (!file || !file.type.startsWith("image/")) {
            alert("Please select an image file!");
            return;
          }
          const reader = new FileReader();
          reader.onload = function (e) {
            const imageData = e.target.result;
            localStorage.setItem("profileImage", imageData);

            // Update farmersData if the current user has farmer data
            const user = JSON.parse(localStorage.getItem("user") || "{}");
            const currentFarmer = user.name || "";
            if (currentFarmer && farmersData[currentFarmer]) {
              farmersData[currentFarmer].profileImage = imageData;
            }

            // Display the uploaded image
            avatarDiv.innerHTML = `<img id="profileAvatarImage" src="${imageData}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;border:3px solid #4caf50;">`;
            showPopup("Profile image updated!");
          };
          reader.readAsDataURL(file);
        };

        // Optional: click on avatar image to view larger
        avatarDiv.onclick = function () {
          const profileImgUrl = localStorage.getItem("profileImage");
          if (profileImgUrl) {
            openGallery([profileImgUrl], 0);
          }
        };
      }
      // ===== Language switching using Google Translate =====
      function setGoogleTranslateCookie(lang) {
        var value = "/auto/" + lang;
        document.cookie = "googtrans=" + value + ";path=/";
        document.cookie =
          "googtrans=" +
          value +
          ";domain=" +
          window.location.hostname +
          ";path=/";
      }

      function getGoogleTranslateLanguage() {
        var match = document.cookie.match(/googtrans=\/auto\/([^;]+)/);
        return match ? match[1] : "en";
      }

      function handleLanguageChange(lang) {
        if (!lang) lang = "en";
        setGoogleTranslateCookie(lang);
        // Sync all language selects on the page
        var selects = document.querySelectorAll(".language-select");
        selects.forEach(function (sel) {
          sel.value = lang;
        });
        // Reload so Google Translate applies language
        window.location.reload();
      }

      // ===== PROFESSIONAL: Clean up unwanted symbols and emojis inserted by Google Translate =====
      function cleanTranslateSymbols() {
        // Comprehensive list of unwanted emojis and symbols that Google Translate adds
        var unwantedSymbols = [
          "âž•",
          "ðŸ™ï¸",
          "ðŸŒ",
          "ðŸ“‹",
          "ðŸŒ¾",
          "ðŸ§¬",
          "ðŸ¤–",
          "ðŸ“Š",
          "ðŸ“œ",
          "ðŸ’°",
          "â“",
          "â”",
          "??",
          "ðŸ”",
          "ðŸ‘¤",
          "ðŸ””",
          "ðŸ“§",
          "ðŸ“±",
          "ðŸ“",
          // Unicode ranges for common unwanted symbols
          /\u{1F4DD}/gu, // ðŸ“
          /\u{1F4C4}/gu, // ðŸ“„
          /\u{1F4CA}/gu, // ðŸ“Š
          /\u{1F4CB}/gu, // ðŸ“‹
          /\u{1F33D}/gu, // ðŸŒ½
          /\u{1F345}/gu, // ðŸ…
          /\u{1F955}/gu, // ðŸ¥•
          /\u{1F954}/gu, // ðŸ¥”
          /\u{1F96C}/gu, // ðŸ¥¬
          /\u{1FAD1}/gu, // ðŸ«‘
        ];

        // Function to check if element should be skipped
        function shouldSkip(node) {
          if (!node) return true;
          var element =
            node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
          if (!element) return false;

          // Skip if has notranslate class
          if (element.classList && element.classList.contains("notranslate")) {
            return true;
          }

          // Skip if parent has notranslate class
          var parent = element.parentElement;
          var depth = 0;
          while (parent && depth < 15) {
            if (parent.classList && parent.classList.contains("notranslate")) {
              return true;
            }
            // Check for icon/emoji classes
            if (parent.classList) {
              var classList = Array.from(parent.classList);
              if (
                classList.some(function (cls) {
                  return cls.includes("icon") || cls.includes("emoji");
                })
              ) {
                return true;
              }
            }
            parent = parent.parentElement;
            depth++;
          }

          // Skip Google Translate elements
          if (
            element.id &&
            (element.id.includes("google_translate") ||
              element.id.includes("goog"))
          ) {
            return true;
          }

          // Skip if element is inside a button, select, or input
          var checkParent = element;
          for (var i = 0; i < 5 && checkParent; i++) {
            var tagName = checkParent.tagName
              ? checkParent.tagName.toLowerCase()
              : "";
            if (["button", "select", "input", "option"].includes(tagName)) {
              return true;
            }
            checkParent = checkParent.parentElement;
          }

          return false;
        }

        // Function to clean text content
        function cleanText(node) {
          if (shouldSkip(node)) {
            return;
          }

          if (node.nodeType === Node.TEXT_NODE) {
            var text = node.textContent;
            if (!text || text.trim().length === 0) return;

            var originalText = text;
            var cleaned = text;

            // Remove all unwanted emojis and symbols
            cleaned = cleaned.replace(/âž•/g, "");
            cleaned = cleaned.replace(/ðŸ™ï¸/g, "");
            cleaned = cleaned.replace(/ðŸŒ/g, "");
            cleaned = cleaned.replace(/ðŸ“‹/g, "");
            cleaned = cleaned.replace(/ðŸŒ¾/g, "");
            cleaned = cleaned.replace(/ðŸ§¬/g, "");
            cleaned = cleaned.replace(/ðŸ¤–/g, "");
            cleaned = cleaned.replace(/ðŸ“Š/g, "");
            cleaned = cleaned.replace(/ðŸ“œ/g, "");
            cleaned = cleaned.replace(/ðŸ’°/g, "");
            cleaned = cleaned.replace(/â“/g, "");
            cleaned = cleaned.replace(/â”/g, "");
            cleaned = cleaned.replace(/\?\?/g, "");
            cleaned = cleaned.replace(/ðŸ”/g, "");
            cleaned = cleaned.replace(/ðŸ‘¤/g, "");
            cleaned = cleaned.replace(/ðŸ””/g, "");
            cleaned = cleaned.replace(/ðŸ“§/g, "");
            cleaned = cleaned.replace(/ðŸ“±/g, "");
            cleaned = cleaned.replace(/ðŸ“/g, "");

            // Fix incorrect patterns with language names
            // Tamil patterns
            cleaned = cleaned.replace(/âž•\s*âž•\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/âž•\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸ“‹\s*ðŸ“‹\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸ“‹\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸŒ¾\s*ðŸŒ¾\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸŒ¾\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸ§¬\s*ðŸ§¬\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");
            cleaned = cleaned.replace(/ðŸ§¬\s*à®¤à®®à®¿à®´à¯/gi, "à®¤à®®à®¿à®´à¯");

            // Telugu patterns
            cleaned = cleaned.replace(/ðŸ™ï¸\s*ðŸ™ï¸\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");
            cleaned = cleaned.replace(/ðŸ™ï¸\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");
            cleaned = cleaned.replace(/ðŸŒ¾\s*ðŸŒ¾\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");
            cleaned = cleaned.replace(/ðŸŒ¾\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");
            cleaned = cleaned.replace(/ðŸ“‹\s*ðŸ“‹\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");
            cleaned = cleaned.replace(/ðŸ“‹\s*à°¤à±†à°²à±à°—à±/gi, "à°¤à±†à°²à±à°—à±");

            // Hindi patterns
            cleaned = cleaned.replace(/âž•\s*âž•\s*à¤¹à¤¿à¤‚à¤¦à¥€/gi, "à¤¹à¤¿à¤‚à¤¦à¥€");
            cleaned = cleaned.replace(/âž•\s*à¤¹à¤¿à¤‚à¤¦à¥€/gi, "à¤¹à¤¿à¤‚à¤¦à¥€");
            cleaned = cleaned.replace(/ðŸŒ\s*ðŸŒ\s*à¤¹à¤¿à¤‚à¤¦à¥€/gi, "à¤¹à¤¿à¤‚à¤¦à¥€");
            cleaned = cleaned.replace(/ðŸŒ\s*à¤¹à¤¿à¤‚à¤¦à¥€/gi, "à¤¹à¤¿à¤‚à¤¦à¥€");

            // Remove globe emoji before language names
            cleaned = cleaned.replace(/ðŸŒ\s*(à®¤à®®à®¿à®´à¯|à°¤à±†à°²à±à°—à±|à¤¹à¤¿à¤‚à¤¦à¥€)/gi, "$1");

            // Remove duplicate language names
            cleaned = cleaned.replace(/(à®¤à®®à®¿à®´à¯|à°¤à±†à°²à±à°—à±|à¤¹à¤¿à¤‚à¤¦à¥€)\s+\1+/gi, "$1");

            // Remove duplicate emojis/symbols (any combination)
            cleaned = cleaned.replace(/([âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°])\s*\1+/g, "");

            // Remove leading/trailing symbols before/after language names
            cleaned = cleaned.replace(
              /^[âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°\s]+(à®¤à®®à®¿à®´à¯|à°¤à±†à°²à±à°—à±|à¤¹à¤¿à¤‚à¤¦à¥€)/gi,
              "$1",
            );
            cleaned = cleaned.replace(
              /(à®¤à®®à®¿à®´à¯|à°¤à±†à°²à±à°—à±|à¤¹à¤¿à¤‚à¤¦à¥€)[âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°\s]+$/gi,
              "$1",
            );

            // Remove patterns like "emoji emoji language" -> "language"
            cleaned = cleaned.replace(
              /^([âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°])\s*\1+\s*(à®¤à®®à®¿à®´à¯|à°¤à±†à°²à±à°—à±|à¤¹à¤¿à¤‚à¤¦à¥€)/gi,
              "$2",
            );

            // Remove multiple consecutive spaces
            cleaned = cleaned.replace(/\s{2,}/g, " ");

            // Remove standalone unwanted symbols (only symbols, no text)
            cleaned = cleaned.replace(/^[âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°\s]+$/g, "");

            // Remove emoji patterns at start/end of text
            cleaned = cleaned.replace(/^([âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°]+\s*)+/g, "");
            cleaned = cleaned.replace(/(\s*[âž•ðŸ™ï¸ðŸŒðŸ“‹ðŸŒ¾ðŸ§¬ðŸ¤–ðŸ“ŠðŸ“œðŸ’°]+)+$/g, "");

            // Trim whitespace
            cleaned = cleaned.trim();

            // Only update if text changed and cleaned text is not empty
            if (cleaned !== originalText && cleaned.length > 0) {
              node.textContent = cleaned;
            } else if (cleaned.length === 0 && originalText.trim().length > 0) {
              // If we removed everything but original had content, check if it was meaningful
              if (
                originalText.match(
                  /[a-zA-Z0-9\u0B80-\u0BFF\u0C00-\u0C7F\u0900-\u097F]/,
                )
              ) {
                // Restore original if it had actual text content
                node.textContent = originalText;
              }
            }
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            // Skip elements with notranslate class
            if (node.classList && node.classList.contains("notranslate")) {
              return;
            }

            // Skip elements with icon/emoji classes
            if (node.classList) {
              var classList = Array.from(node.classList);
              if (
                classList.some(function (cls) {
                  return cls.includes("icon") || cls.includes("emoji");
                })
              ) {
                return;
              }
            }

            // Skip Google Translate elements
            if (
              node.id &&
              (node.id.includes("google_translate") || node.id.includes("goog"))
            ) {
              return;
            }

            // Skip buttons, selects, inputs
            var tagName = node.tagName ? node.tagName.toLowerCase() : "";
            if (["button", "select", "input", "option"].includes(tagName)) {
              return;
            }

            // Clean child nodes recursively
            var children = Array.from(node.childNodes);
            children.forEach(function (child) {
              cleanText(child);
            });
          }
        }

        // Clean all text nodes in the document (except protected elements)
        try {
          var walker = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_TEXT,
            {
              acceptNode: function (node) {
                if (shouldSkip(node)) {
                  return NodeFilter.FILTER_REJECT;
                }
                return NodeFilter.FILTER_ACCEPT;
              },
            },
          );

          var nodesToClean = [];
          var node;
          while ((node = walker.nextNode())) {
            if (node.nodeType === Node.TEXT_NODE && !shouldSkip(node)) {
              nodesToClean.push(node);
            }
          }

          nodesToClean.forEach(function (node) {
            cleanText(node);
          });
        } catch (e) {
          console.warn("Error cleaning translate symbols:", e);
        }
      }

      // ===== PROFESSIONAL MutationObserver to monitor DOM changes and clean symbols =====
      function setupTranslateCleaner() {
        var cleaningInProgress = false;
        var lastCleanTime = 0;
        var CLEAN_THROTTLE = 150; // Minimum time between cleans (ms)
        var cleanCount = 0;
        var MAX_CLEANS = 50; // Maximum number of cleans to prevent infinite loops

        var observer = new MutationObserver(function (mutations) {
          if (cleaningInProgress || cleanCount >= MAX_CLEANS) return;

          var now = Date.now();
          if (now - lastCleanTime < CLEAN_THROTTLE) return;

          var shouldClean = false;

          mutations.forEach(function (mutation) {
            if (
              mutation.type === "childList" ||
              mutation.type === "characterData"
            ) {
              var target = mutation.target;

              // Skip if target or parent has notranslate class
              if (
                target &&
                target.classList &&
                target.classList.contains("notranslate")
              ) {
                return;
              }
              if (
                target &&
                target.parentElement &&
                target.parentElement.classList &&
                target.parentElement.classList.contains("notranslate")
              ) {
                return;
              }

              // Skip Google Translate elements
              if (
                target &&
                target.id &&
                (target.id.includes("google_translate") ||
                  target.id.includes("goog"))
              ) {
                return;
              }

              // Check if the change contains unwanted symbols or incorrect patterns
              var text = target.textContent || "";
              // Comprehensive pattern matching for unwanted symbols
              if (
                /âž•|ðŸ™ï¸|ðŸŒ|ðŸ“‹|ðŸŒ¾|ðŸ§¬|ðŸ¤–|ðŸ“Š|ðŸ“œ|ðŸ’°|\?\?|âž•\s*à®¤à®®à®¿à®´à¯|ðŸ™ï¸\s*à°¤à±†à°²à±à°—à±|ðŸŒ\s*à¤¹à¤¿à¤‚à¤¦à¥€|ðŸ“‹\s*à®¤à®®à®¿à®´à¯|ðŸŒ¾\s*à°¤à±†à°²à±à°—à±/.test(
                  text,
                )
              ) {
                shouldClean = true;
              }
            }
          });

          if (shouldClean) {
            cleaningInProgress = true;
            lastCleanTime = now;
            cleanCount++;
            setTimeout(function () {
              cleanTranslateSymbols();
              cleaningInProgress = false;
            }, 100);
          }
        });

        // Start observing with comprehensive filtering
        try {
          observer.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true,
            attributes: false,
          });
        } catch (e) {
          console.warn("Error setting up translate cleaner observer:", e);
        }

        // Initial clean after page load
        setTimeout(function () {
          cleanTranslateSymbols();
        }, 300);

        // Clean after Google Translate loads
        setTimeout(function () {
          cleanTranslateSymbols();
        }, 1500);

        // Clean after Google Translate processes content
        setTimeout(function () {
          cleanTranslateSymbols();
        }, 3000);

        // Additional cleanup after translation completes
        setTimeout(function () {
          cleanTranslateSymbols();
        }, 5000);

        // Periodic cleanup (every 2 seconds for first minute, then every 5 seconds)
        var periodicInterval = setInterval(function () {
          if (!cleaningInProgress && cleanCount < MAX_CLEANS) {
            cleanTranslateSymbols();
          }
          // Stop after 2 minutes to prevent performance issues
          if (cleanCount >= MAX_CLEANS) {
            clearInterval(periodicInterval);
          }
        }, 2000);

        // Reset clean count after 2 minutes
        setTimeout(function () {
          cleanCount = 0;
        }, 120000);
      }

      // ===== Function to automatically protect emoji elements =====
      function protectEmojiElements() {
        // Common emoji Unicode ranges
        var emojiPattern =
          /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;

        // Find all text nodes and protect emoji-only elements
        var walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
          null,
        );

        var node;
        var elementsToProtect = [];

        while ((node = walker.nextNode())) {
          if (node.nodeType === Node.ELEMENT_NODE) {
            var text = node.textContent || "";
            // If element contains only emojis or starts with emoji
            if (
              text.match(
                /^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\s]+$/u,
              ) &&
              text.trim().length > 0
            ) {
              if (!node.classList.contains("notranslate")) {
                elementsToProtect.push(node);
              }
            }
            // If element has icon/emoji class
            if (node.classList) {
              var classList = Array.from(node.classList);
              if (
                classList.some(function (cls) {
                  return (
                    cls.includes("icon") ||
                    cls.includes("emoji") ||
                    cls.includes("card-icon")
                  );
                })
              ) {
                if (!node.classList.contains("notranslate")) {
                  elementsToProtect.push(node);
                }
              }
            }
          }
        }

        // Add notranslate class to all emoji elements
        elementsToProtect.forEach(function (el) {
          el.classList.add("notranslate");
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Subtle fadein effect for the entire page
        document.body.classList.add("page-fadein");

        // Protect emoji elements first
        protectEmojiElements();

        var currentLang = getGoogleTranslateLanguage();
        var selects = document.querySelectorAll(".language-select");
        selects.forEach(function (sel) {
          if (currentLang) {
            sel.value = currentLang;
          }
        });

        // Setup translate cleaner
        setupTranslateCleaner();

        // Re-protect emojis after a short delay (in case of dynamic content)
        setTimeout(protectEmojiElements, 500);
        setTimeout(protectEmojiElements, 2000);
      });

      function googleTranslateElementInit() {
        try {
          if (
            typeof google === "undefined" ||
            !google.translate ||
            !google.translate.TranslateElement
          ) {
            console.warn("Google Translate API not loaded yet, retrying...");
            setTimeout(googleTranslateElementInit, 500);
            return;
          }

          new google.translate.TranslateElement(
            {
              pageLanguage: "en",
              includedLanguages: "en,hi,ta,te",
              autoDisplay: false,
              layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
            },
            "google_translate_element",
          );

          // Clean symbols after Google Translate initializes
          setTimeout(function () {
            cleanTranslateSymbols();
            setupTranslateCleaner();
          }, 800);

          // Additional cleanup after translation
          setTimeout(function () {
            cleanTranslateSymbols();
          }, 2000);

          // Final cleanup after all translations complete
          setTimeout(function () {
            cleanTranslateSymbols();
          }, 4000);

          // Listen for translation events
          if (window.addEventListener) {
            window.addEventListener("load", function () {
              setTimeout(cleanTranslateSymbols, 1000);
            });
          }
        } catch (e) {
          console.warn("Error initializing Google Translate:", e);
          // Retry after a delay
          setTimeout(function () {
            try {
              googleTranslateElementInit();
            } catch (err) {
              console.error(
                "Failed to initialize Google Translate after retry:",
                err,
              );
            }
          }, 1000);
        }
      }

      // ==========================================
      // RENTAL ITEMS FUNCTIONALITY
      // ==========================================

      let rentalItems = [];
      let filteredRentalItems = [];
      let currentRentalId = null;
      let currentRentalCategory = "all";

      // Sample rental data for demonstration
      const sampleRentalItems = [
        {
          id: 1,
          name: "John Deere 5050D Tractor",
          category: "Tractor",
          description:
            "Powerful 50HP tractor, well-maintained, suitable for plowing, tilling, and hauling.",
          price_per_hour: 500,
          price_per_day: 3500,
          location: "Hyderabad, Telangana",
          availability_status: "available",
          owner_name: "Ramesh Kumar",
          owner_phone: "9876543210",
          images: [
            "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?w=400&h=300&fit=crop",
          ],
          avg_rating: 4.5,
          review_count: 12,
          created_at: "2024-12-15",
        },
        {
          id: 2,
          name: "Mahindra Arjun 605 DI",
          category: "Tractor",
          description:
            "60HP tractor with excellent fuel efficiency. Great for large farms.",
          price_per_hour: 600,
          price_per_day: 4000,
          location: "Warangal, Telangana",
          availability_status: "available",
          owner_name: "Suresh Reddy",
          owner_phone: "9876543211",
          images: [
            "https://images.unsplash.com/photo-1592805144716-feeccccef5ac?w=400&h=300&fit=crop",
          ],
          avg_rating: 4.2,
          review_count: 8,
          created_at: "2024-12-14",
        },
        {
          id: 3,
          name: "Class Crop Tiger Harvester",
          category: "Harvester",
          description:
            "Modern combine harvester for wheat and paddy. High capacity.",
          price_per_hour: 1500,
          price_per_day: 12000,
          location: "Nizamabad, Telangana",
          availability_status: "available",
          owner_name: "Venkat Rao",
          owner_phone: "9876543212",
          images: [
            "https://images.unsplash.com/photo-1589923188651-268a9765e432?w=400&h=300&fit=crop",
          ],
          avg_rating: 4.8,
          review_count: 15,
          created_at: "2024-12-13",
        },
        {
          id: 4,
          name: "Agricultural Drone DJI Agras T30",
          category: "Drone",
          description:
            "Advanced spraying drone for pesticide and fertilizer application. 30L tank capacity.",
          price_per_hour: 800,
          price_per_day: 5000,
          location: "Karimnagar, Telangana",
          availability_status: "available",
          owner_name: "Prasad Tech Farm",
          owner_phone: "9876543213",
          images: [
            "https://images.unsplash.com/photo-1508614589041-895b88991e3e?w=400&h=300&fit=crop",
          ],
          avg_rating: 4.9,
          review_count: 22,
          created_at: "2024-12-12",
        },
        {
          id: 5,
          name: "Honda Water Pump 5HP",
          category: "Water pump",
          description:
            "Reliable petrol water pump. 2-inch outlet. Perfect for irrigation.",
          price_per_hour: 150,
          price_per_day: 800,
          location: "Khammam, Telangana",
          availability_status: "unavailable",
          owner_name: "Krishna Farms",
          owner_phone: "9876543214",
          images: [],
          avg_rating: 4.0,
          review_count: 5,
          created_at: "2024-12-11",
        },
        {
          id: 6,
          name: "Power Sprayer 20L",
          category: "Sprayer",
          description:
            "Battery-powered backpack sprayer with adjustable nozzle.",
          price_per_hour: 100,
          price_per_day: 500,
          location: "Adilabad, Telangana",
          availability_status: "available",
          owner_name: "Raju Agriculture",
          owner_phone: "9876543215",
          images: [],
          avg_rating: 3.8,
          review_count: 3,
          created_at: "2024-12-10",
        },
      ];

      // Load rental items from API or use sample data
      function loadRentalItems() {
        const grid = document.getElementById("rentalItemsGrid");
        if (!grid) return;

        // Show loading state
        grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px; animation: pulse 1.5s infinite;">ðŸšœ</div>
            <p style="color: #666; font-size: 18px;">Loading rental items...</p>
        </div>
    `;

        // Try to fetch from API
        fetch("/api/rentals")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.rentals && data.rentals.length > 0) {
              rentalItems = data.rentals;
            } else {
              // Use sample data if no items from API
              rentalItems = sampleRentalItems;
            }
            filteredRentalItems = [...rentalItems];
            displayRentalItems();
          })
          .catch((error) => {
            console.log("Using sample rental data:", error);
            rentalItems = sampleRentalItems;
            filteredRentalItems = [...rentalItems];
            displayRentalItems();
          });
      }

      // Display rental items in grid
      function displayRentalItems() {
        const grid = document.getElementById("rentalItemsGrid");
        const noResults = document.getElementById("noRentalResults");
        if (!grid) return;

        if (filteredRentalItems.length === 0) {
          grid.innerHTML = "";
          if (noResults) noResults.style.display = "block";
          return;
        }

        if (noResults) noResults.style.display = "none";

        grid.innerHTML = filteredRentalItems
          .map((item) => {
            // Get the first image from the item (images only, no videos)
            const firstImage = getFirstRentalImage(item);

            return `
        <div class="rental-card" data-id="${item.id}">
            <div class="rental-card-image">
                ${
                  firstImage
                    ? `<div class="rental-card-image-skeleton"></div>
                       <img src="${firstImage}" alt="${item.name}" onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';" onerror="handleRentalImageError(this, '${item.category}')">`
                    : `<div class="rental-card-placeholder">${getCategoryIcon(item.category)}</div>`
                }
                <span class="rental-card-badge">${item.category}</span>
                <span class="rental-card-status ${item.availability_status === "available" ? "available" : "unavailable"}">
                    ${item.availability_status === "available" ? "Available" : "Unavailable"}
                </span>
            </div>
            <div class="rental-card-body">
                <div class="rental-card-name">${item.name}</div>
                <div class="rental-card-owner">
                    <span class="notranslate">ðŸ‘¤</span> ${item.owner_name}
                </div>
                <div class="rental-card-location">
                    <span class="notranslate">ðŸ“</span> ${item.location}
                </div>
                
                <!-- Star Rating Display -->
                <div class="rental-card-rating">
                    <div class="rental-stars">
                        ${generateStarDisplay(item.avg_rating)}
                    </div>
                    <span class="rental-rating-text">${item.avg_rating.toFixed(1)}</span>
                    <span class="rental-review-count">(${item.review_count} reviews)</span>
                </div>

                <!-- Pricing -->
                <div class="rental-card-pricing">
                    ${
                      item.price_per_hour
                        ? `
                        <div class="rental-price-item">
                            <span class="rental-price-label">Per Hour</span>
                            <span class="rental-price-value">â‚¹${item.price_per_hour}</span>
                        </div>
                    `
                        : ""
                    }
                    <div class="rental-price-item">
                        <span class="rental-price-label">Per Day</span>
                        <span class="rental-price-value">â‚¹${item.price_per_day}</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="rental-card-actions">
                    <button class="rental-btn rental-btn-details" onclick="showRentalDetails(${item.id})">
                        <span class="notranslate">ðŸ“‹</span> Details
                    </button>
                    <button class="rental-btn rental-btn-contact" onclick="contactRentalOwner(${item.id})">
                        <span class="notranslate">ðŸ“ž</span> Contact
                    </button>
                    <button class="rental-btn rental-btn-feedback" onclick="openRentalFeedbackModal(${item.id})">
                        <span class="notranslate">â­</span> Feedback
                    </button>
                </div>
            </div>
        </div>
    `;
          })
          .join("");

        // Fetch images for each rental item from media API
        filteredRentalItems.forEach((item) => {
          fetchRentalFirstImage(item.id);
        });
      }

      // Get first image URL from rental item (images only, skip videos)
      function getFirstRentalImage(item) {
        // Check if item has images array with image URLs
        if (item.images && item.images.length > 0) {
          // Filter only image files (not videos)
          const imageExtensions = ["jpg", "jpeg", "png", "webp", "gif"];
          for (const img of item.images) {
            const ext = img.split(".").pop().toLowerCase();
            if (imageExtensions.includes(ext)) {
              return img;
            }
          }
        }

        // Check if item has first_image property (set by fetchRentalFirstImage)
        if (item.first_image) {
          return item.first_image;
        }

        return null;
      }

      // Sanitize and validate image URL to prevent XSS
      function sanitizeImageUrl(url) {
        if (!url || typeof url !== "string") return null;

        // Only allow safe URL protocols
        const safeProtocols = ["http:", "https:", "/"];
        const trimmedUrl = url.trim();

        // Check if URL starts with safe protocol or is a relative path
        const isRelative =
          trimmedUrl.startsWith("/") && !trimmedUrl.startsWith("//");
        const hasHttpProtocol =
          trimmedUrl.startsWith("http://") || trimmedUrl.startsWith("https://");

        if (!isRelative && !hasHttpProtocol) {
          return null; // Reject javascript:, data:, or other potentially dangerous URLs
        }

        // Additional check for image file extensions
        const imageExtensions = ["jpg", "jpeg", "png", "webp", "gif"];
        const urlLower = trimmedUrl.toLowerCase();
        const hasImageExt = imageExtensions.some((ext) => {
          const pattern = new RegExp(`\\.${ext}(\\?|$)`);
          return pattern.test(urlLower);
        });

        // Allow URLs that appear to be images or from trusted paths
        if (hasImageExt || trimmedUrl.startsWith("/static/uploads/")) {
          return trimmedUrl;
        }

        // For external URLs (Unsplash, etc.), allow if they have valid image extensions or are from known image CDNs
        if (
          hasHttpProtocol &&
          (hasImageExt ||
            urlLower.includes("unsplash.com") ||
            urlLower.includes("images."))
        ) {
          return trimmedUrl;
        }

        return null;
      }

      // Fetch first image from rental media API
      async function fetchRentalFirstImage(rentalId) {
        try {
          const response = await fetch(`/api/rentals/${rentalId}/media`);
          const data = await response.json();

          if (data.success && data.images && data.images.length > 0) {
            // Get first image only
            const firstImage = data.images[0];

            // Sanitize the media path to prevent XSS
            const safePath = sanitizeImageUrl(firstImage.media_path);
            if (!safePath) {
              console.warn(
                "Invalid image URL rejected:",
                firstImage.media_path,
              );
              return;
            }

            // Update the rental card image
            const card = document.querySelector(
              `.rental-card[data-id="${rentalId}"]`,
            );
            if (card) {
              const imageContainer = card.querySelector(".rental-card-image");
              const placeholder = imageContainer.querySelector(
                ".rental-card-placeholder",
              );

              if (placeholder) {
                // Safely create image element
                const badgeHTML =
                  imageContainer.querySelector(".rental-card-badge").outerHTML;
                const statusHTML = imageContainer.querySelector(
                  ".rental-card-status",
                ).outerHTML;

                // Clear and rebuild content safely
                imageContainer.innerHTML = "";

                const skeleton = document.createElement("div");
                skeleton.className = "rental-card-image-skeleton";
                imageContainer.appendChild(skeleton);

                const img = document.createElement("img");
                img.src = safePath;
                img.alt = "Rental Image";
                img.onload = function () {
                  this.classList.add("loaded");
                  skeleton.style.display = "none";
                };
                img.onerror = function () {
                  handleRentalImageError(this, "");
                };
                imageContainer.appendChild(img);

                // Re-add badge and status
                imageContainer.insertAdjacentHTML("beforeend", badgeHTML);
                imageContainer.insertAdjacentHTML("beforeend", statusHTML);
              }
            }

            // Update the item in the array for future reference
            const item = rentalItems.find((r) => r.id === rentalId);
            if (item) {
              item.first_image = safePath;
            }
          }
        } catch (error) {
          // Silently fail - placeholder will be shown
          console.log("Could not fetch rental image:", rentalId);
        }
      }

      // Handle image load error - show placeholder
      function handleRentalImageError(imgElement, category) {
        const parent = imgElement.parentElement;
        const skeleton = parent.querySelector(".rental-card-image-skeleton");
        if (skeleton) skeleton.style.display = "none";

        // Replace with placeholder
        imgElement.style.display = "none";

        // Add placeholder if not exists
        if (!parent.querySelector(".rental-card-placeholder")) {
          const placeholder = document.createElement("div");
          placeholder.className = "rental-card-placeholder";
          placeholder.innerHTML = getCategoryIcon(category || "Other");
          parent.insertBefore(placeholder, parent.firstChild);
        }
      }

      // Generate star display HTML
      function generateStarDisplay(rating) {
        let stars = "";
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        for (let i = 1; i <= 5; i++) {
          if (i <= fullStars) {
            stars += '<span class="star">&#9733;</span>';
          } else if (i === fullStars + 1 && hasHalfStar) {
            stars += '<span class="star">&#9733;</span>';
          } else {
            stars += '<span class="star empty">&#9733;</span>';
          }
        }
        return stars;
      }

      // Get category icon
      function getCategoryIcon(category) {
        const icons = {
          Tractor: "ðŸšœ",
          Harvester: "ðŸŒ¾",
          Sprayer: "ðŸ’¨",
          Plough: "âš™ï¸",
          "Water pump": "ðŸ’§",
          Drone: "ðŸ›¸",
          "Cold storage": "â„ï¸",
          Transport: "ðŸšš",
          Other: "ðŸ”§",
        };
        return icons[category] || "ðŸ”§";
      }

      // Filter rental items by search
      function filterRentalItems() {
        const searchInput = document.getElementById("rentalSearchInput");
        const searchTerm = searchInput
          ? searchInput.value.toLowerCase().trim()
          : "";

        filteredRentalItems = rentalItems.filter((item) => {
          const matchesSearch =
            !searchTerm ||
            item.name.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm) ||
            item.location.toLowerCase().includes(searchTerm) ||
            item.owner_name.toLowerCase().includes(searchTerm);

          const matchesCategory =
            currentRentalCategory === "all" ||
            item.category === currentRentalCategory;

          return matchesSearch && matchesCategory;
        });

        displayRentalItems();
      }

      // Filter by category
      function filterByCategory(category) {
        currentRentalCategory = category;

        // Update active chip
        document.querySelectorAll(".rental-filter-chip").forEach((chip) => {
          chip.classList.remove("active");
          if (chip.dataset.category === category) {
            chip.classList.add("active");
          }
        });

        filterRentalItems();
      }

      // Sort rental items
      function sortRentalItems() {
        const sortSelect = document.getElementById("rentalSortSelect");
        const sortBy = sortSelect ? sortSelect.value : "newest";

        switch (sortBy) {
          case "highest-rated":
            filteredRentalItems.sort((a, b) => b.avg_rating - a.avg_rating);
            break;
          case "most-reviewed":
            filteredRentalItems.sort((a, b) => b.review_count - a.review_count);
            break;
          case "price-low":
            filteredRentalItems.sort(
              (a, b) => a.price_per_day - b.price_per_day,
            );
            break;
          case "price-high":
            filteredRentalItems.sort(
              (a, b) => b.price_per_day - a.price_per_day,
            );
            break;
          case "newest":
          default:
            filteredRentalItems.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at),
            );
        }

        displayRentalItems();
      }

      // Show rental details modal
      function showRentalDetails(rentalId) {
        const item = rentalItems.find((r) => r.id === rentalId);
        if (!item) return;

        // Add to history (viewed rental)
        addHistoryEntry(
          "viewed",
          "rental",
          item.id,
          item.name,
          item.owner_name,
          item.location,
          { price_per_day: item.price_per_day, category: item.category },
        );

        const modal = document.getElementById("rentalDetailsModal");
        const body = document.getElementById("rentalDetailsBody");

        if (!modal || !body) return;

        // Store current rental ID for media operations
        currentRentalId = rentalId;

        body.innerHTML = `
        <div style="text-align: center; margin-bottom: 25px;">
            <div id="rentalDetailImage" style="width: 100%; height: 200px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 80px; margin-bottom: 20px; position: relative; overflow: hidden;">
                ${getCategoryIcon(item.category)}
            </div>
            <span style="display: inline-block; padding: 8px 20px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border-radius: 25px; font-size: 14px; font-weight: 600;">${item.category}</span>
        </div>
        
        <h2 style="color: #2e7d32; margin-bottom: 15px; font-size: 24px;">${item.name}</h2>
        
        <div class="rental-card-rating" style="margin-bottom: 20px;">
            <div class="rental-stars">
                ${generateStarDisplay(item.avg_rating)}
            </div>
            <span class="rental-rating-text">${item.avg_rating.toFixed(1)} / 5</span>
            <span class="rental-review-count">(${item.review_count} reviews)</span>
        </div>
        
        <p style="color: #555; line-height: 1.7; margin-bottom: 25px;">${item.description || "No description available."}</p>
        
        <!-- Photos & Videos Button -->
        <div style="margin-bottom: 25px;">
            <button onclick="openRentalMediaGallery(${item.id}, '${item.name.replace(/'/g, "\\'")}')" class="photos-videos-btn" style="width: 100%;">
                <span class="notranslate">ðŸ“¸</span> View Photos & Videos
                <span id="mediaCountBadge_${item.id}" class="media-badge" style="display: none;">0</span>
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
            <div style="padding: 15px; background: #f9f9f9; border-radius: 12px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Owner</div>
                <div style="font-weight: 600; color: #333;"><span class="notranslate">ðŸ‘¤</span> ${item.owner_name}</div>
            </div>
            <div style="padding: 15px; background: #f9f9f9; border-radius: 12px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Location</div>
                <div style="font-weight: 600; color: #333;"><span class="notranslate">ðŸ“</span> ${item.location}</div>
            </div>
            ${
              item.price_per_hour
                ? `
            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 12px;">
                <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;">Price per Hour</div>
                <div style="font-weight: 700; color: #1b5e20; font-size: 18px;">â‚¹${item.price_per_hour}</div>
            </div>
            `
                : ""
            }
            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 12px;">
                <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px;">Price per Day</div>
                <div style="font-weight: 700; color: #1b5e20; font-size: 18px;">â‚¹${item.price_per_day}</div>
            </div>
        </div>
        
        <div style="padding: 15px; background: ${item.availability_status === "available" ? "linear-gradient(135deg, #e8f5e9, #c8e6c9)" : "linear-gradient(135deg, #ffebee, #ffcdd2)"}; border-radius: 12px; text-align: center; margin-bottom: 25px;">
            <span style="font-weight: 600; color: ${item.availability_status === "available" ? "#2e7d32" : "#c62828"};">
                ${item.availability_status === "available" ? "âœ“ Available for Rent" : "âœ— Currently Unavailable"}
            </span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button onclick="contactRentalOwner(${item.id})" style="padding: 15px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <span class="notranslate">ðŸ“ž</span> Contact Owner
            </button>
            <button onclick="closeRentalDetailsModal(); openRentalFeedbackModal(${item.id});" style="padding: 15px; background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <span class="notranslate">â­</span> Write Review
            </button>
        </div>
    `;

        modal.style.display = "flex";

        // Load media count for badge
        loadRentalMediaCount(rentalId);
      }

      // Close rental details modal
      function closeRentalDetailsModal() {
        const modal = document.getElementById("rentalDetailsModal");
        if (modal) modal.style.display = "none";
      }

      // Contact rental owner
      function contactRentalOwner(rentalId) {
        const item = rentalItems.find((r) => r.id === rentalId);
        if (!item) return;

        // Create contact modal
        const contactModal = document.createElement("div");
        contactModal.className = "rental-modal";
        contactModal.id = "tempContactModal";
        contactModal.innerHTML = `
        <div class="rental-modal-content" style="max-width: 400px;">
            <button class="rental-modal-close" onclick="document.getElementById('tempContactModal').remove()">&times;</button>
            <h2 style="color: #2e7d32; margin-bottom: 20px;">
                <span class="notranslate">ðŸ“ž</span> Contact Owner
            </h2>
            <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ðŸ‘¤</div>
                <div style="font-size: 20px; font-weight: 600; color: #333; margin-bottom: 10px;">${item.owner_name}</div>
                <div style="font-size: 14px; color: #666;"><span class="notranslate">ðŸ“</span> ${item.location}</div>
            </div>
            <a href="tel:${item.owner_phone}" style="display: block; padding: 15px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; text-align: center; border-radius: 12px; font-size: 18px; font-weight: 600; text-decoration: none; margin-bottom: 10px;">
                <span class="notranslate">ðŸ“ž</span> Call ${item.owner_phone}
            </a>
            <a href="https://wa.me/91${item.owner_phone}?text=Hi, I'm interested in renting your ${item.name}" target="_blank" style="display: block; padding: 15px; background: linear-gradient(135deg, #25d366, #128c7e); color: white; text-align: center; border-radius: 12px; font-size: 18px; font-weight: 600; text-decoration: none;">
                <span class="notranslate">ðŸ’¬</span> WhatsApp
            </a>
        </div>
    `;
        document.body.appendChild(contactModal);
      }

      // Open rental feedback modal
      function openRentalFeedbackModal(rentalId) {
        currentRentalId = rentalId;
        const item = rentalItems.find((r) => r.id === rentalId);
        if (!item) return;

        const modal = document.getElementById("rentalFeedbackModal");
        const itemNameEl = document.getElementById("feedbackItemName");

        if (!modal) return;

        if (itemNameEl) {
          itemNameEl.textContent = item.name;
        }

        // Reset form
        document.getElementById("selectedRatingInput").value = "0";
        document.getElementById("feedbackReviewerName").value = "";
        document.getElementById("feedbackComment").value = "";
        document.getElementById("ratingText").textContent = "Click to rate";

        // Reset star display
        document.querySelectorAll(".star-input").forEach((star) => {
          star.classList.remove("active", "hovered");
        });

        // Load existing reviews
        loadRentalReviews(rentalId);

        modal.style.display = "flex";

        // Initialize star rating interaction
        initStarRatingInput();
      }

      // Initialize star rating input interaction
      function initStarRatingInput() {
        const stars = document.querySelectorAll(".star-input");
        const ratingText = document.getElementById("ratingText");
        const ratingInput = document.getElementById("selectedRatingInput");

        const ratingLabels = [
          "",
          "Poor",
          "Fair",
          "Good",
          "Very Good",
          "Excellent",
        ];

        stars.forEach((star, index) => {
          // Hover effect
          star.addEventListener("mouseenter", () => {
            stars.forEach((s, i) => {
              if (i <= index) {
                s.classList.add("hovered");
              } else {
                s.classList.remove("hovered");
              }
            });
            ratingText.textContent = ratingLabels[index + 1];
          });

          // Click to select
          star.addEventListener("click", () => {
            const rating = index + 1;
            ratingInput.value = rating;

            stars.forEach((s, i) => {
              if (i <= index) {
                s.classList.add("active");
              } else {
                s.classList.remove("active");
              }
            });
            ratingText.textContent = `${rating} Star${rating > 1 ? "s" : ""} - ${ratingLabels[rating]}`;
          });
        });

        // Reset hover on mouse leave
        document
          .getElementById("starRatingInput")
          .addEventListener("mouseleave", () => {
            const currentRating = parseInt(ratingInput.value) || 0;
            stars.forEach((s, i) => {
              s.classList.remove("hovered");
              if (i < currentRating) {
                s.classList.add("active");
              }
            });
            if (currentRating > 0) {
              ratingText.textContent = `${currentRating} Star${currentRating > 1 ? "s" : ""} - ${ratingLabels[currentRating]}`;
            } else {
              ratingText.textContent = "Click to rate";
            }
          });
      }

      // Load rental reviews
      function loadRentalReviews(rentalId) {
        const reviewsList = document.getElementById("reviewsList");
        if (!reviewsList) return;

        reviewsList.innerHTML =
          '<p style="color: #999; text-align: center;">Loading reviews...</p>';

        // Try to fetch from API
        fetch(`/api/rentals/${rentalId}/feedback`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.feedbacks && data.feedbacks.length > 0) {
              displayReviews(data.feedbacks);
            } else {
              // Show sample reviews for demo
              displayReviews(getSampleReviews());
            }
          })
          .catch((error) => {
            console.log("Using sample reviews:", error);
            displayReviews(getSampleReviews());
          });
      }

      // Get sample reviews for demo
      function getSampleReviews() {
        return [
          {
            id: 1,
            reviewer_name: "Venkat Reddy",
            rating: 5,
            comment:
              "Excellent equipment! The tractor was in perfect condition and the owner was very helpful.",
            created_at: "2024-12-14",
          },
          {
            id: 2,
            reviewer_name: "Lakshmi Devi",
            rating: 4,
            comment: "Good service. Equipment worked well for my farm needs.",
            created_at: "2024-12-10",
          },
          {
            id: 3,
            reviewer_name: "Krishna Rao",
            rating: 5,
            comment: "Highly recommended! Fair pricing and reliable equipment.",
            created_at: "2024-12-05",
          },
        ];
      }

      // Display reviews
      function displayReviews(reviews) {
        const reviewsList = document.getElementById("reviewsList");
        if (!reviewsList) return;

        if (reviews.length === 0) {
          reviewsList.innerHTML =
            '<p style="color: #999; text-align: center; padding: 20px;">No reviews yet. Be the first to review!</p>';
          return;
        }

        reviewsList.innerHTML = reviews
          .slice(0, 5)
          .map(
            (review) => `
        <div class="review-item">
            <div class="review-item-header">
                <span class="review-item-name">${review.reviewer_name || "Anonymous"}</span>
                <div class="review-item-stars">
                    ${generateStarDisplay(review.rating)}
                </div>
            </div>
            <div class="review-item-date">${formatDate(review.created_at)}</div>
            ${review.comment ? `<div class="review-item-comment">${review.comment}</div>` : ""}
        </div>
    `,
          )
          .join("");
      }

      // Format date
      function formatDate(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      // Close rental feedback modal
      function closeRentalFeedbackModal() {
        const modal = document.getElementById("rentalFeedbackModal");
        if (modal) modal.style.display = "none";
        currentRentalId = null;
      }

      // Submit rental feedback
      function submitRentalFeedback() {
        if (!currentRentalId) {
          showPopup("Error: No rental item selected");
          return;
        }

        const rating = parseInt(
          document.getElementById("selectedRatingInput").value,
        );
        const reviewerName = document
          .getElementById("feedbackReviewerName")
          .value.trim();
        const comment = document.getElementById("feedbackComment").value.trim();

        if (!rating || rating < 1 || rating > 5) {
          showPopup("Please select a rating (1-5 stars)");
          return;
        }

        // Get rental item for history tracking
        const item = rentalItems.find((r) => r.id === currentRentalId);

        // Submit to API
        fetch(`/api/rentals/${currentRentalId}/feedback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            rating: rating,
            reviewer_name: reviewerName,
            comment: comment,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showPopup("Thank you! Your review has been submitted.");

              // Add to history (feedback given)
              if (item) {
                addHistoryEntry(
                  "feedback",
                  "rental",
                  item.id,
                  item.name,
                  item.owner_name,
                  item.location,
                  { rating: rating, comment: comment },
                );
              }

              // Update local data
              if (item && data.avg_rating !== undefined) {
                item.avg_rating = data.avg_rating;
                item.review_count = data.review_count;
              }

              closeRentalFeedbackModal();
              displayRentalItems();
            } else {
              showPopup(
                data.message || "Failed to submit review. Please try again.",
              );
            }
          })
          .catch((error) => {
            console.log("Feedback submission error:", error);
            // For demo, show success anyway
            showPopup("Thank you! Your review has been submitted.");

            // Add to history (feedback given) even in demo mode
            if (item) {
              addHistoryEntry(
                "feedback",
                "rental",
                item.id,
                item.name,
                item.owner_name,
                item.location,
                { rating: rating, comment: comment },
              );
            }

            // Update local sample data
            if (item) {
              item.review_count += 1;
              item.avg_rating =
                (item.avg_rating * (item.review_count - 1) + rating) /
                item.review_count;
            }

            closeRentalFeedbackModal();
            displayRentalItems();
          });
      }

      // Show add rental modal
      function showAddRentalModal() {
        const modal = document.getElementById("addRentalModal");
        if (modal) {
          document.getElementById("addRentalForm").reset();
          // Clear media preview
          selectedRentalMedia = [];
          const preview = document.getElementById("rentalMediaPreview");
          if (preview) {
            preview.style.display = "none";
            preview.innerHTML = "";
          }
          modal.style.display = "flex";
        }
      }

      // Close add rental modal
      function closeAddRentalModal() {
        const modal = document.getElementById("addRentalModal");
        if (modal) modal.style.display = "none";
        selectedRentalMedia = [];
      }

      // Selected media files array
      let selectedRentalMedia = [];

      // Handle rental media selection
      function handleRentalMediaSelect(event) {
        const files = Array.from(event.target.files);
        const preview = document.getElementById("rentalMediaPreview");

        if (!files.length) return;

        // Validate and add files
        files.forEach((file) => {
          const ext = file.name.split(".").pop().toLowerCase();
          const isImage = ["jpg", "jpeg", "png", "webp"].includes(ext);
          const isVideo = ["mp4", "webm", "mov"].includes(ext);

          if (!isImage && !isVideo) {
            showPopup(`Invalid file type: ${file.name}`);
            return;
          }

          // Check size
          const maxSize = isVideo ? 50 * 1024 * 1024 : 10 * 1024 * 1024;
          if (file.size > maxSize) {
            showPopup(
              `File too large: ${file.name}. Max ${isVideo ? "50MB" : "10MB"}`,
            );
            return;
          }

          selectedRentalMedia.push({
            file: file,
            type: isImage ? "image" : "video",
            preview: URL.createObjectURL(file),
          });
        });

        // Update preview
        updateMediaPreview();
      }

      // Update media preview display
      function updateMediaPreview() {
        const preview = document.getElementById("rentalMediaPreview");
        if (!preview) return;

        if (selectedRentalMedia.length === 0) {
          preview.style.display = "none";
          preview.innerHTML = "";
          return;
        }

        preview.style.display = "grid";
        preview.innerHTML = selectedRentalMedia
          .map(
            (media, index) => `
        <div class="media-preview-item">
            ${
              media.type === "image"
                ? `<img src="${media.preview}" alt="Preview" />`
                : `<video src="${media.preview}" muted></video>`
            }
            <button type="button" class="remove-media" onclick="removeMediaPreview(${index})">&times;</button>
            <span class="media-type-badge">${media.type === "image" ? "IMG" : "VID"}</span>
        </div>
    `,
          )
          .join("");
      }

      // Remove media from preview
      function removeMediaPreview(index) {
        URL.revokeObjectURL(selectedRentalMedia[index].preview);
        selectedRentalMedia.splice(index, 1);
        updateMediaPreview();
      }

      // Submit new rental
      async function submitNewRental(event) {
        event.preventDefault();

        const name = document.getElementById("newRentalName").value.trim();
        const category = document.getElementById("newRentalCategory").value;
        const description = document
          .getElementById("newRentalDescription")
          .value.trim();
        const pricePerHour =
          document.getElementById("newRentalPriceHour").value;
        const pricePerDay = document.getElementById("newRentalPriceDay").value;
        const location = document
          .getElementById("newRentalLocation")
          .value.trim();

        if (!name || !category || !pricePerDay || !location) {
          showPopup("Please fill in all required fields");
          return;
        }

        const submitBtn = document.getElementById("addRentalSubmitBtn");
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Adding...";
        }

        const rentalData = {
          name: name,
          category: category,
          description: description,
          price_per_hour: pricePerHour ? parseFloat(pricePerHour) : null,
          price_per_day: parseFloat(pricePerDay),
          location: location,
          images: [],
        };

        try {
          // Submit rental data first
          const response = await fetch("/api/rentals", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(rentalData),
          });

          const data = await response.json();

          if (data.success && data.rental_id) {
            // Upload media if any
            if (selectedRentalMedia.length > 0) {
              await uploadRentalMediaFiles(data.rental_id);
            }

            showPopup("Rental item added successfully!");
            closeAddRentalModal();
            loadRentalItems();
          } else {
            showPopup(
              data.message || "Failed to add rental item. Please try again.",
            );
          }
        } catch (error) {
          console.log("Add rental error:", error);
          // For demo, add to local array
          const user = JSON.parse(localStorage.getItem("user") || "{}");
          const newItem = {
            id: Date.now(),
            ...rentalData,
            availability_status: "available",
            owner_name: user.name || "You",
            owner_phone: user.phone || "9999999999",
            avg_rating: 0,
            review_count: 0,
            created_at: new Date().toISOString(),
          };
          rentalItems.unshift(newItem);
          filteredRentalItems = [...rentalItems];

          showPopup("Rental item added successfully!");
          closeAddRentalModal();
          displayRentalItems();
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Add Rental Item";
          }
        }
      }

      // Upload rental media files
      async function uploadRentalMediaFiles(rentalId) {
        const formData = new FormData();
        selectedRentalMedia.forEach((media) => {
          formData.append("media", media.file);
        });

        try {
          const response = await fetch(`/api/rentals/${rentalId}/media`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          if (data.success) {
            console.log("Media uploaded:", data.uploaded);
          } else {
            console.error("Media upload failed:", data.message);
          }
        } catch (error) {
          console.error("Media upload error:", error);
        }
      }

      // ==========================================
      // RENTAL MEDIA GALLERY FUNCTIONS
      // ==========================================

      let currentMediaItems = [];
      let currentMediaFilter = "all";
      let currentLightboxIndex = 0;

      // Load media count for badge
      async function loadRentalMediaCount(rentalId) {
        try {
          const response = await fetch(`/api/rentals/${rentalId}/media`);
          const data = await response.json();

          if (data.success) {
            const badge = document.getElementById(
              `mediaCountBadge_${rentalId}`,
            );
            if (badge && data.total_count > 0) {
              badge.textContent = data.total_count;
              badge.style.display = "inline";
            }
          }
        } catch (error) {
          console.log("Could not load media count");
        }
      }

      // Open rental media gallery modal
      async function openRentalMediaGallery(rentalId, itemName) {
        const modal = document.getElementById("rentalMediaGalleryModal");
        const grid = document.getElementById("mediaGalleryGrid");
        const emptyState = document.getElementById("mediaGalleryEmpty");
        const titleEl = document.getElementById("mediaGalleryTitle");

        if (!modal || !grid) return;

        // Store current rental ID
        currentRentalId = rentalId;

        // Set title
        if (titleEl) titleEl.textContent = itemName || "Photos & Videos";

        // Show loading state
        grid.innerHTML = `
        <div class="media-gallery-loading">
            <div class="media-spinner"></div>
            <p>Loading media...</p>
        </div>
    `;
        emptyState.style.display = "none";
        modal.style.display = "flex";

        // Reset filter
        currentMediaFilter = "all";
        document.querySelectorAll(".media-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === "all");
        });

        try {
          const response = await fetch(`/api/rentals/${rentalId}/media`);
          const data = await response.json();

          if (data.success) {
            currentMediaItems = data.media || [];

            // Update counts
            document.getElementById("mediaCountAll").textContent =
              data.total_count || 0;
            document.getElementById("mediaCountImages").textContent =
              data.image_count || 0;
            document.getElementById("mediaCountVideos").textContent =
              data.video_count || 0;

            renderMediaGallery();
          } else {
            grid.innerHTML = "";
            emptyState.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading media:", error);
          // Show sample media for demo
          currentMediaItems = getSampleMedia(rentalId);
          document.getElementById("mediaCountAll").textContent =
            currentMediaItems.length;
          document.getElementById("mediaCountImages").textContent =
            currentMediaItems.filter((m) => m.media_type === "image").length;
          document.getElementById("mediaCountVideos").textContent =
            currentMediaItems.filter((m) => m.media_type === "video").length;
          renderMediaGallery();
        }
      }

      // Get sample media for demo
      function getSampleMedia(rentalId) {
        // Return sample placeholder media for demo purposes
        return [
          {
            id: 1,
            rental_id: rentalId,
            media_type: "image",
            media_path:
              "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?w=400",
            filename: "tractor-front.jpg",
          },
          {
            id: 2,
            rental_id: rentalId,
            media_type: "image",
            media_path:
              "https://images.unsplash.com/photo-1592805144716-feeccccef5ac?w=400",
            filename: "tractor-side.jpg",
          },
          {
            id: 3,
            rental_id: rentalId,
            media_type: "image",
            media_path:
              "https://images.unsplash.com/photo-1589923188651-268a9765e432?w=400",
            filename: "equipment-detail.jpg",
          },
        ];
      }

      // Render media gallery grid
      function renderMediaGallery() {
        const grid = document.getElementById("mediaGalleryGrid");
        const emptyState = document.getElementById("mediaGalleryEmpty");

        if (!grid) return;

        // Filter media
        let filteredMedia = currentMediaItems;
        if (currentMediaFilter === "images") {
          filteredMedia = currentMediaItems.filter(
            (m) => m.media_type === "image",
          );
        } else if (currentMediaFilter === "videos") {
          filteredMedia = currentMediaItems.filter(
            (m) => m.media_type === "video",
          );
        }

        if (filteredMedia.length === 0) {
          grid.innerHTML = "";
          emptyState.style.display = "block";
          return;
        }

        emptyState.style.display = "none";
        grid.innerHTML = filteredMedia
          .map(
            (media, index) => `
        <div class="media-gallery-item" onclick="openLightbox(${index}, '${currentMediaFilter}')">
            ${
              media.media_type === "image"
                ? `<img src="${media.media_path}" alt="${media.filename}" loading="lazy" />`
                : `<video src="${media.media_path}" preload="metadata"></video>
                   <div class="video-play-overlay"></div>`
            }
        </div>
    `,
          )
          .join("");
      }

      // Filter media gallery
      function filterMediaGallery(filter) {
        currentMediaFilter = filter;

        // Update active tab
        document.querySelectorAll(".media-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === filter);
        });

        renderMediaGallery();
      }

      // Close rental media gallery
      function closeRentalMediaGallery() {
        const modal = document.getElementById("rentalMediaGalleryModal");
        if (modal) modal.style.display = "none";
      }

      // ==========================================
      // LIGHTBOX FUNCTIONS
      // ==========================================

      // Open lightbox
      function openLightbox(index, filter) {
        const lightbox = document.getElementById("rentalMediaLightbox");
        if (!lightbox) return;

        // Get filtered media
        let media = currentMediaItems;
        if (filter === "images") {
          media = currentMediaItems.filter((m) => m.media_type === "image");
        } else if (filter === "videos") {
          media = currentMediaItems.filter((m) => m.media_type === "video");
        }

        if (media.length === 0) return;

        currentLightboxIndex = index;
        lightbox.style.display = "flex";

        // Build thumbnails
        const thumbnailsContainer =
          document.getElementById("lightboxThumbnails");
        if (thumbnailsContainer) {
          thumbnailsContainer.innerHTML = media
            .map(
              (m, i) => `
            <div class="lightbox-thumbnail ${i === index ? "active" : ""}" onclick="navigateToLightboxIndex(${i})">
                ${
                  m.media_type === "image"
                    ? `<img src="${m.media_path}" alt="Thumbnail" />`
                    : `<video src="${m.media_path}" preload="metadata"></video>`
                }
            </div>
        `,
            )
            .join("");
        }

        // Store filtered media for navigation
        lightbox.dataset.filteredMedia = JSON.stringify(media);

        showLightboxMedia(index);
      }

      // Navigate to specific lightbox index
      function navigateToLightboxIndex(index) {
        currentLightboxIndex = index;
        showLightboxMedia(index);

        // Update thumbnail active state
        document.querySelectorAll(".lightbox-thumbnail").forEach((thumb, i) => {
          thumb.classList.toggle("active", i === index);
        });
      }

      // Show specific media in lightbox
      function showLightboxMedia(index) {
        const lightbox = document.getElementById("rentalMediaLightbox");
        const image = document.getElementById("lightboxImage");
        const video = document.getElementById("lightboxVideo");
        const counter = document.getElementById("lightboxCounter");
        const filename = document.getElementById("lightboxFilename");

        if (!lightbox) return;

        const media = JSON.parse(lightbox.dataset.filteredMedia || "[]");
        if (index < 0 || index >= media.length) return;

        const item = media[index];

        // Hide both elements first
        image.style.display = "none";
        video.style.display = "none";

        // Stop any playing video
        video.pause();

        if (item.media_type === "image") {
          image.src = item.media_path;
          image.style.display = "block";
        } else {
          video.src = item.media_path;
          video.style.display = "block";
        }

        // Update counter and filename
        if (counter) counter.textContent = `${index + 1} / ${media.length}`;
        if (filename) filename.textContent = item.filename || "";
      }

      // Navigate lightbox
      function navigateLightbox(direction) {
        const lightbox = document.getElementById("rentalMediaLightbox");
        if (!lightbox) return;

        const media = JSON.parse(lightbox.dataset.filteredMedia || "[]");
        if (media.length === 0) return;

        let newIndex = currentLightboxIndex + direction;

        // Wrap around
        if (newIndex < 0) newIndex = media.length - 1;
        if (newIndex >= media.length) newIndex = 0;

        navigateToLightboxIndex(newIndex);
      }

      // Close lightbox
      function closeLightbox() {
        const lightbox = document.getElementById("rentalMediaLightbox");
        const video = document.getElementById("lightboxVideo");

        if (video) video.pause();
        if (lightbox) lightbox.style.display = "none";
      }

      // Close modals when clicking outside
      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("rental-modal")) {
          event.target.style.display = "none";
        }
        if (event.target.classList.contains("rental-media-gallery-modal")) {
          closeRentalMediaGallery();
        }
        if (event.target.classList.contains("rental-media-lightbox")) {
          closeLightbox();
        }
      });

      // Close modals with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          // Close lightbox first if open
          const lightbox = document.getElementById("rentalMediaLightbox");
          if (lightbox && lightbox.style.display !== "none") {
            closeLightbox();
            return;
          }

          // Close media gallery if open
          const mediaGallery = document.getElementById(
            "rentalMediaGalleryModal",
          );
          if (mediaGallery && mediaGallery.style.display !== "none") {
            closeRentalMediaGallery();
            return;
          }

          // Close other modals
          document.querySelectorAll(".rental-modal").forEach((modal) => {
            modal.style.display = "none";
          });
        }

        // Arrow key navigation in lightbox
        const lightbox = document.getElementById("rentalMediaLightbox");
        if (lightbox && lightbox.style.display !== "none") {
          if (event.key === "ArrowLeft") {
            navigateLightbox(-1);
          } else if (event.key === "ArrowRight") {
            navigateLightbox(1);
          }
        }
      });

      // Drag and drop support for media upload
      document.addEventListener("DOMContentLoaded", function () {
        const uploadZone = document.getElementById("rentalMediaUploadZone");
        if (uploadZone) {
          uploadZone.addEventListener("dragover", function (e) {
            e.preventDefault();
            this.classList.add("dragging");
          });

          uploadZone.addEventListener("dragleave", function (e) {
            e.preventDefault();
            this.classList.remove("dragging");
          });

          uploadZone.addEventListener("drop", function (e) {
            e.preventDefault();
            this.classList.remove("dragging");

            const files = Array.from(e.dataTransfer.files);
            const input = document.getElementById("rentalMediaInput");

            // Create a DataTransfer object to set files on input
            const dt = new DataTransfer();
            files.forEach((file) => dt.items.add(file));
            input.files = dt.files;

            // Trigger change event
            handleRentalMediaSelect({ target: input });
          });
        }
      });

      // Initialize rentals on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Load rental items if the section is visible
        if (document.getElementById("dashRentals")) {
          // Pre-load data
          rentalItems = sampleRentalItems;
          filteredRentalItems = [...rentalItems];
        }

        // Initialize navigation profile icon
        updateNavProfileIcon();

        // If profile section is active, load it
        if (
          document.getElementById("dashProfile") &&
          document.getElementById("dashProfile").classList.contains("active")
        ) {
          loadProfileSection();
        }
      });
    </script>

    <!-- Voice Search Engine -->
    <div class="voice-toast" id="voiceToast"></div>
    <script>
    (function() {
      'use strict';
      // Check browser support
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const voiceSupported = !!SpeechRecognition;
      let activeRecognition = null;
      let activeBtn = null;

      // Hide mic buttons if speech not supported
      if (!voiceSupported) {
        document.querySelectorAll('.voice-search-btn').forEach(function(btn) {
          btn.style.display = 'none';
        });
      }

      function showVoiceToast(msg, type, duration) {
        var toast = document.getElementById('voiceToast');
        if (!toast) return;
        toast.className = 'voice-toast';
        toast.textContent = '';
        if (type === 'listening') {
          toast.innerHTML = '<span style="font-size:18px">ðŸŽ™ï¸</span> ' + msg;
          toast.classList.add('listening-toast');
        } else if (type === 'error') {
          toast.innerHTML = '<span style="font-size:18px">âš ï¸</span> ' + msg;
          toast.classList.add('error-toast');
        } else {
          toast.innerHTML = '<span style="font-size:18px">âœ…</span> ' + msg;
        }
        setTimeout(function() { toast.classList.add('show'); }, 10);
        setTimeout(function() { toast.classList.remove('show'); }, duration || 2500);
      }

      window.startVoiceSearch = function(inputId, callback) {
        if (!voiceSupported) {
          showVoiceToast('Voice search is not supported in this browser', 'error', 3000);
          return;
        }

        var input = document.getElementById(inputId);
        if (!input) return;

        // Find the mic button associated with this input
        var btn = input.parentElement.querySelector('.voice-search-btn');

        // If already listening on THIS input, stop it
        if (activeRecognition && activeBtn === btn) {
          activeRecognition.stop();
          return;
        }

        // If listening on ANOTHER input, stop that first
        if (activeRecognition) {
          activeRecognition.abort();
          if (activeBtn) activeBtn.classList.remove('listening');
          activeRecognition = null;
          activeBtn = null;
        }

        var recognition = new SpeechRecognition();
        recognition.lang = 'en-IN'; // English India, works well for Indian accents + English
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;
        recognition.continuous = false;

        activeRecognition = recognition;
        activeBtn = btn;

        // UI: Listening state
        if (btn) btn.classList.add('listening');
        var origPlaceholder = input.placeholder;
        input.placeholder = 'ðŸŽ™ï¸ Listeningâ€¦ speak now';
        input.focus();
        showVoiceToast('Listeningâ€¦ speak now', 'listening', 4000);

        recognition.onresult = function(event) {
          var transcript = '';
          for (var i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          input.value = transcript;
          // Trigger input event for any listeners
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new Event('keyup', { bubbles: true }));

          // If final result
          if (event.results[event.results.length - 1].isFinal) {
            showVoiceToast('Got it: "' + transcript.trim() + '"', 'success', 2000);
          }
        };

        recognition.onerror = function(event) {
          if (btn) btn.classList.remove('listening');
          input.placeholder = origPlaceholder;
          activeRecognition = null;
          activeBtn = null;

          if (event.error === 'not-allowed' || event.error === 'permission-denied') {
            showVoiceToast('Microphone access is required for voice search', 'error', 3500);
          } else if (event.error === 'no-speech') {
            showVoiceToast('No voice detected, please try again', 'error', 2500);
          } else if (event.error === 'aborted') {
            // User or code aborted â€” silent
          } else {
            showVoiceToast('Voice error: ' + event.error, 'error', 2500);
          }
        };

        recognition.onend = function() {
          if (btn) btn.classList.remove('listening');
          input.placeholder = origPlaceholder;
          activeRecognition = null;
          activeBtn = null;

          // Auto-trigger the search callback
          if (callback && typeof callback === 'function') {
            try { callback(); } catch(e) {}
          }
        };

        try {
          recognition.start();
        } catch(e) {
          showVoiceToast('Could not start voice recognition', 'error', 2500);
          if (btn) btn.classList.remove('listening');
          input.placeholder = origPlaceholder;
          activeRecognition = null;
          activeBtn = null;
        }
      };
    })();
    </script>

    <!-- Hidden container for Google Translate widget -->
    <div id="google_translate_element" style="display: none"></div>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  </body>
</html>
